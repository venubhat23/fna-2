<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Payout #<%= @payout.id %></h2>
    <p class="text-muted mb-0">
      <span class="badge bg-<%=
        case @payout.status
        when 'pending' then 'warning'
        when 'processing' then 'info'
        when 'paid' then 'success'
        when 'cancelled' then 'danger'
        else 'secondary'
        end
      %>">
        <%= @payout.status.humanize %>
      </span>
      <span class="text-muted mx-2">•</span>
      Policy Type: <%= @payout.policy_type.humanize %>
    </p>
  </div>
  <div class="d-flex gap-2">
    <% if @payout.pending? %>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#markPaidModal">
        <i class="bi bi-check-circle me-1"></i>
        Mark as Paid
      </button>
      <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#markProcessingModal">
        <i class="bi bi-clock me-1"></i>
        Mark as Processing
      </button>
      <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
        <i class="bi bi-x-circle me-1"></i>
        Cancel
      </button>
    <% elsif @payout.processing? %>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#markPaidModal">
        <i class="bi bi-check-circle me-1"></i>
        Mark as Paid
      </button>
      <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
        <i class="bi bi-x-circle me-1"></i>
        Cancel
      </button>
    <% end %>
    <%= link_to edit_admin_payout_path(@payout), class: "btn btn-warning" do %>
      <i class="bi bi-pencil me-1"></i>
      Edit Payout
    <% end %>
    <%= link_to admin_payouts_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Payouts
    <% end %>
  </div>
</div>

<div class="row">
  <!-- Main Payout Information -->
  <div class="col-lg-8">
    <!-- Basic Information -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Payout Details</h5>
        <span class="badge bg-<%=
          case @payout.status
          when 'pending' then 'warning'
          when 'processing' then 'info'
          when 'paid' then 'success'
          when 'cancelled' then 'danger'
          else 'secondary'
          end
        %>">
          <%= @payout.status.humanize %>
        </span>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Policy Type</strong>
            <span class="badge bg-primary"><%= @payout.policy_type.humanize %></span>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Policy ID</strong>
            #<%= @payout.policy_id %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Payout To</strong>
            <%= @payout.payout_to.humanize %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Payout Amount</strong>
            <span class="fs-5 fw-bold text-success">₹<%= number_with_delimiter(@payout.payout_amount) %></span>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Scheduled Date</strong>
            <%= @payout.payout_date&.strftime("%B %d, %Y") || '-' %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Created On</strong>
            <%= @payout.created_at.strftime("%B %d, %Y at %I:%M %p") %>
          </div>
        </div>
      </div>
    </div>

    <!-- Policy Information -->
    <% if @policy %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Related Policy Information</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <strong class="text-muted d-block">Policy Number</strong>
              <%= @policy.policy_number || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Insurance Company</strong>
              <%= @policy.try(:insurance_company_name) || @policy.try(:insurance_company) || '-' %>
            </div>
            <% if @policy.respond_to?(:plan_name) %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Plan Name</strong>
                <%= @policy.plan_name || '-' %>
              </div>
            <% end %>
            <% if @policy.respond_to?(:sum_insured) %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Sum Insured</strong>
                ₹<%= number_with_delimiter(@policy.sum_insured) if @policy.sum_insured %>
              </div>
            <% end %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Premium Amount</strong>
              ₹<%= number_with_delimiter(@policy.try(:total_premium) || @policy.try(:premium_amount) || 0) %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Policy Start Date</strong>
              <%= @policy.try(:policy_start_date)&.strftime("%B %d, %Y") || '-' %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Customer Information -->
    <% if @customer %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Customer Information</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <strong class="text-muted d-block">Customer Name</strong>
              <%= @customer.display_name %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Customer Type</strong>
              <span class="badge bg-<%= @customer.customer_type == 'individual' ? 'primary' : 'success' %>">
                <%= @customer.customer_type.humanize %>
              </span>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Email</strong>
              <% if @customer.email.present? %>
                <a href="mailto:<%= @customer.email %>"><%= @customer.email %></a>
              <% else %>
                -
              <% end %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Mobile</strong>
              <% if @customer.mobile.present? %>
                <a href="tel:<%= @customer.mobile %>"><%= @customer.mobile %></a>
              <% else %>
                -
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Payment Information -->
    <% if @payout.paid? || @payout.payment_mode.present? %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Payment Information</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <% if @payout.payment_mode.present? %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Payment Mode</strong>
                <%= @payout.payment_mode.humanize %>
              </div>
            <% end %>
            <% if @payout.transaction_id.present? %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Transaction ID</strong>
                <code><%= @payout.transaction_id %></code>
              </div>
            <% end %>
            <% if @payout.reference_number.present? %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Reference Number</strong>
                <code><%= @payout.reference_number %></code>
              </div>
            <% end %>
            <% if @payout.processed_by.present? %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Processed By</strong>
                <%= @payout.processed_by %>
              </div>
            <% end %>
            <% if @payout.notes.present? %>
              <div class="col-12">
                <strong class="text-muted d-block">Notes</strong>
                <p class="mb-0"><%= simple_format(@payout.notes) %></p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Audit Trail -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Activity</h5>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadFullAuditTrail()">
          <i class="bi bi-clock-history me-1"></i>View Full History
        </button>
      </div>
      <div class="card-body">
        <% if @audit_logs.any? %>
          <div class="timeline">
            <% @audit_logs.each do |log| %>
              <div class="timeline-item">
                <div class="timeline-marker bg-<%=
                  case log.action
                  when 'created' then 'primary'
                  when 'updated' then 'info'
                  when 'paid' then 'success'
                  when 'cancelled' then 'danger'
                  else 'secondary'
                  end
                %>"></div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= log.action.humanize %></strong>
                      <p class="mb-1 text-muted small"><%= log.notes if log.notes.present? %></p>
                      <small class="text-muted">
                        by <%= log.performed_by %> • <%= log.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <i class="bi bi-clock-history fs-3 d-block mb-2"></i>
            <p class="mb-0">No activity recorded yet</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Quick Actions -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Quick Actions</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <% if @payout.pending? || @payout.processing? %>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#markPaidModal">
              <i class="bi bi-check-circle me-1"></i>Mark as Paid
            </button>
            <% if @payout.pending? %>
              <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#markProcessingModal">
                <i class="bi bi-clock me-1"></i>Mark as Processing
              </button>
            <% end %>
            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
              <i class="bi bi-x-circle me-1"></i>Cancel Payout
            </button>
          <% end %>

          <%= link_to edit_admin_payout_path(@payout), class: "btn btn-warning" do %>
            <i class="bi bi-pencil me-1"></i>Edit Payout
          <% end %>

          <%= link_to admin_payout_path(@payout), method: :delete,
              class: "btn btn-outline-danger",
              data: { confirm: "Are you sure you want to delete this payout? This action cannot be undone.", turbo_method: :delete } do %>
            <i class="bi bi-trash me-1"></i>Delete Payout
          <% end %>
        </div>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Summary</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <div class="text-center">
              <h4 class="text-success mb-1">₹<%= number_with_delimiter(@payout.payout_amount) %></h4>
              <small class="text-muted">Payout Amount</small>
            </div>
          </div>
        </div>
        <hr class="my-3">
        <div class="small">
          <div class="d-flex justify-content-between mb-1">
            <span class="text-muted">Status:</span>
            <span class="badge bg-<%=
              case @payout.status
              when 'pending' then 'warning'
              when 'processing' then 'info'
              when 'paid' then 'success'
              when 'cancelled' then 'danger'
              else 'secondary'
              end
            %>">
              <%= @payout.status.humanize %>
            </span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span class="text-muted">Created:</span>
            <span><%= @payout.created_at.strftime("%b %d, %Y") %></span>
          </div>
          <% if @payout.payout_date %>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-muted">Due Date:</span>
              <span><%= @payout.payout_date.strftime("%b %d, %Y") %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Related Information -->
    <% if @policy %>
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h6 class="mb-0">Related Policy</h6>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-file-earmark-text me-2 text-primary"></i>
            <div>
              <strong><%= @policy.policy_number || "Policy ##{@policy.id}" %></strong>
              <br>
              <small class="text-muted">
                <%= @policy.try(:insurance_company_name) || @policy.try(:insurance_company) || 'Unknown Company' %>
              </small>
            </div>
          </div>
          <% if @customer %>
            <div class="d-flex align-items-center">
              <i class="bi bi-person me-2 text-info"></i>
              <div>
                <strong><%= @customer.display_name %></strong>
                <br>
                <small class="text-muted"><%= @customer.email || @customer.mobile %></small>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Mark as Paid Modal -->
<div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: mark_as_paid_admin_payout_path(@payout), method: :patch, local: true, data: { turbo: false } do |form| %>
        <div class="modal-header">
          <h5 class="modal-title" id="markPaidModalLabel">Mark Payout as Paid</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <%= form.label :payout_date, "Payment Date", class: "form-label" %>
              <%= form.date_field :payout_date, value: Date.current, class: "form-control" %>
            </div>
            <div class="col-md-6">
              <%= form.label :payment_mode, "Payment Mode", class: "form-label" %>
              <%= form.select :payment_mode,
                  options_for_select([
                    ['Bank Transfer', 'bank_transfer'],
                    ['Cash', 'cash'],
                    ['Cheque', 'cheque'],
                    ['UPI', 'upi'],
                    ['Online Transfer', 'online_transfer']
                  ]),
                  { prompt: 'Select Payment Mode' },
                  { class: "form-control" } %>
            </div>
            <div class="col-12">
              <%= form.label :transaction_id, "Transaction/Reference ID", class: "form-label" %>
              <%= form.text_field :transaction_id, class: "form-control", placeholder: "Enter transaction ID" %>
            </div>
            <div class="col-12">
              <%= form.label :reference_number, "Reference Number", class: "form-label" %>
              <%= form.text_field :reference_number, class: "form-control", placeholder: "Enter reference number (optional)" %>
            </div>
            <div class="col-12">
              <%= form.label :notes, "Payment Notes", class: "form-label" %>
              <%= form.text_area :notes, rows: 3, class: "form-control", placeholder: "Add any payment notes..." %>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= form.submit "Mark as Paid", class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Mark as Processing Modal -->
<div class="modal fade" id="markProcessingModal" tabindex="-1" aria-labelledby="markProcessingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: mark_as_processing_admin_payout_path(@payout), method: :patch, local: true, data: { turbo: false } do |form| %>
        <div class="modal-header">
          <h5 class="modal-title" id="markProcessingModalLabel">Mark Payout as Processing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            Mark this payout as currently being processed. You can update it to "Paid" once the payment is completed.
          </p>
          <div class="col-12">
            <%= form.label :notes, "Processing Notes", class: "form-label" %>
            <%= form.text_area :notes, rows: 3, class: "form-control", placeholder: "Add any processing notes..." %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= form.submit "Mark as Processing", class: "btn btn-info" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Cancel Payout Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: cancel_payout_admin_payout_path(@payout), method: :patch, local: true, data: { turbo: false } do |form| %>
        <div class="modal-header">
          <h5 class="modal-title" id="cancelModalLabel">Cancel Payout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action will cancel the payout. This action can be reversed by editing the payout later.
          </div>
          <div class="col-12">
            <%= form.label :cancellation_reason, "Cancellation Reason", class: "form-label" %>
            <%= form.text_area :cancellation_reason, rows: 3, class: "form-control", placeholder: "Please provide a reason for cancellation...", required: true %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Payout</button>
          <%= form.submit "Cancel Payout", class: "btn btn-warning" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 20px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}

.timeline-item {
  position: relative;
  margin-bottom: 1rem;
}

.timeline-marker {
  position: absolute;
  left: -15px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
}

.timeline-content {
  padding-left: 10px;
}
</style>

<script>
function loadFullAuditTrail() {
  fetch('<%= audit_trail_admin_payout_path(@payout) %>')
    .then(response => response.json())
    .then(data => {
      // Handle full audit trail display
      console.log('Full audit trail:', data);
      // You can implement a modal or expand the timeline here
    })
    .catch(error => console.error('Error loading audit trail:', error));
}
</script>
