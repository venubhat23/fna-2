<% content_for :title, "Vendor Purchases" %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0"><i class="bi bi-cart-fill me-2"></i>Vendor Purchases</h2>
      <p class="text-muted mb-0">Manage your vendor purchase orders and inventory</p>
    </div>
    <div class="btn-group">
      <%= link_to "New Purchase", new_admin_vendor_purchase_path, class: "btn btn-primary" %>
      <%= link_to "Batch Inventory", batch_inventory_admin_vendor_purchases_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: admin_vendor_purchases_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.text_field :search, value: params[:search], placeholder: "Search by vendor name...", class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.select :vendor_id, options_from_collection_for_select(@vendors, :id, :name, params[:vendor_id]),
              { prompt: "All Vendors" }, { class: "form-select" } %>
        </div>
        <div class="col-md-2">
          <%= f.select :status, options_for_select([
            ['All Status', ''],
            ['Pending', 'pending'],
            ['Completed', 'completed'],
            ['Cancelled', 'cancelled']
          ], params[:status]), {}, { class: "form-select" } %>
        </div>
        <div class="col-md-2">
          <%= f.submit "Filter", class: "btn btn-outline-primary" %>
        </div>
        <div class="col-md-2 text-end">
          <%= link_to "Clear", admin_vendor_purchases_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <div class="h4 mb-1 text-primary"><%= @vendor_purchases.count %></div>
          <div class="text-muted">Total Purchases</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <div class="h4 mb-1 text-warning"><%= @vendor_purchases.pending.count %></div>
          <div class="text-muted">Pending Orders</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <div class="h4 mb-1 text-success">₹<%= number_with_delimiter(@vendor_purchases.sum(:total_amount).to_i) %></div>
          <div class="text-muted">Total Value</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <div class="h4 mb-1 text-info">₹<%= number_with_delimiter(@vendor_purchases.sum { |vp| vp.outstanding_amount }.to_i) %></div>
          <div class="text-muted">Outstanding</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendor Purchases Table -->
  <div class="card">
    <div class="card-body">
      <% if @vendor_purchases.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-dark">
              <tr>
                <th>Purchase #</th>
                <th>Vendor</th>
                <th>Purchase Date</th>
                <th>Items</th>
                <th>Total Amount</th>
                <th>Paid Amount</th>
                <th>Outstanding</th>
                <th>Payment Status</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @vendor_purchases.each do |purchase| %>
                <tr>
                  <td>
                    <div class="fw-bold"><%= purchase.purchase_number %></div>
                    <div class="small text-muted">ID: <%= purchase.id %></div>
                  </td>
                  <td>
                    <div class="fw-bold"><%= purchase.vendor.name %></div>
                    <div class="small text-muted"><%= purchase.vendor.phone if purchase.vendor.phone.present? %></div>
                  </td>
                  <td>
                    <div><%= purchase.purchase_date.strftime('%b %d, %Y') %></div>
                    <div class="small text-muted"><%= time_ago_in_words(purchase.purchase_date) %> ago</div>
                  </td>
                  <td>
                    <div class="fw-bold"><%= purchase.vendor_purchase_items.count %> items</div>
                    <div class="small text-muted">
                      <%= purchase.vendor_purchase_items.sum(:quantity) %> units
                    </div>
                  </td>
                  <td>
                    <div class="fw-bold">₹<%= number_with_delimiter(purchase.total_amount.to_i) %></div>
                  </td>
                  <td>
                    <div class="fw-bold text-success">₹<%= number_with_delimiter(purchase.paid_amount.to_i) %></div>
                  </td>
                  <td>
                    <div class="fw-bold <%= purchase.outstanding_amount > 0 ? 'text-danger' : 'text-success' %>">
                      ₹<%= number_with_delimiter(purchase.outstanding_amount.to_i) %>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="badge <%= purchase.payment_status_badge_class %> px-3 py-2">
                      <i class="bi bi-wallet2 me-1"></i>
                      <%= purchase.payment_status.titleize %>
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="badge <%= purchase.status_badge_class %> px-3 py-2">
                      <i class="bi bi-circle-fill me-1" style="font-size: 0.6rem;"></i>
                      <%= purchase.status.titleize %>
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <%= link_to admin_vendor_purchase_path(purchase), class: "btn btn-outline-primary btn-sm", title: "View Details" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>

                      <!-- Generate Invoice Button -->
                      <button type="button" class="btn btn-outline-success btn-sm" title="Generate Invoice" onclick="generateVendorInvoice(<%= purchase.id %>)">
                        <i class="bi bi-receipt"></i>
                      </button>

                      <!-- WhatsApp Share Button -->
                      <button type="button" class="btn btn-outline-success btn-sm" title="Share on WhatsApp" onclick="shareVendorInvoiceOnWhatsApp(<%= purchase.id %>)">
                        <i class="bi bi-whatsapp"></i>
                      </button>

                      <% if purchase.can_be_edited? %>
                        <%= link_to edit_admin_vendor_purchase_path(purchase), class: "btn btn-outline-warning btn-sm", title: "Edit" do %>
                          <i class="bi bi-pencil"></i>
                        <% end %>
                      <% end %>

                      <% if purchase.status == 'pending' %>
                        <%= link_to complete_purchase_admin_vendor_purchase_path(purchase),
                            method: :patch,
                            confirm: "Mark this purchase as completed?",
                            class: "btn btn-success btn-sm",
                            title: "Complete Purchase" do %>
                          <i class="bi bi-check-circle"></i>
                        <% end %>
                      <% end %>

                      <% if purchase.can_be_cancelled? %>
                        <%= link_to admin_vendor_purchase_path(purchase),
                            method: :delete,
                            confirm: "Are you sure you want to delete this purchase?",
                            class: "btn btn-outline-danger btn-sm",
                            title: "Delete" do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">
            <% if @vendor_purchases.respond_to?(:total_count) %>
              Showing <%= @vendor_purchases.offset_value + 1 %> to <%= [@vendor_purchases.offset_value + @vendor_purchases.limit_value, @vendor_purchases.total_count].min %> of <%= @vendor_purchases.total_count %> purchases
            <% else %>
              Showing <%= @vendor_purchases.count %> purchases
            <% end %>
          </div>
          <%= paginate @vendor_purchases if defined?(Kaminari) && @vendor_purchases.respond_to?(:current_page) %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-cart-x display-1 text-muted"></i>
          <h4 class="mt-3">No Vendor Purchases Found</h4>
          <p class="text-muted">
            <% if params[:search].present? || params[:vendor_id].present? || params[:status].present? %>
              Try adjusting your search filters.
            <% else %>
              Start by creating your first vendor purchase order.
            <% end %>
          </p>
          <%= link_to "New Purchase", new_admin_vendor_purchase_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function generateVendorInvoice(purchaseId) {
  // Show loading state
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
  button.disabled = true;

  fetch(`/admin/vendor_purchases/${purchaseId}/generate_invoice`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      showNotification('Invoice generated successfully!', 'success');

      // Open the public invoice in a new tab
      if (data.invoice_url) {
        window.open(data.invoice_url, '_blank');
      }
    } else {
      showNotification('Error generating invoice: ' + (data.error || 'Unknown error'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error generating invoice. Please try again.', 'error');
  })
  .finally(() => {
    // Restore button state
    button.innerHTML = originalContent;
    button.disabled = false;
  });
}

function shareVendorInvoiceOnWhatsApp(purchaseId) {
  // First generate/get the invoice URL
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
  button.disabled = true;

  fetch(`/admin/vendor_purchases/${purchaseId}/generate_invoice`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.invoice_url) {
      // Create WhatsApp message
      const message = `Hi! Here is your invoice for purchase #${data.purchase_number}:\n${data.invoice_url}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;

      // Open WhatsApp
      window.open(whatsappUrl, '_blank');

      showNotification('WhatsApp opened with invoice link!', 'success');
    } else {
      showNotification('Error getting invoice link: ' + (data.error || 'Unknown error'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error sharing invoice. Please try again.', 'error');
  })
  .finally(() => {
    // Restore button state
    button.innerHTML = originalContent;
    button.disabled = false;
  });
}

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;

  // Add to page
  document.body.appendChild(notification);

  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 5000);
}
</script>
