<% content_for :title, "Batch Inventory" %>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Batch Inventory</h2>
    <p class="text-muted mb-0">FIFO-based stock management system - Product overview with detailed batch information</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to new_admin_vendor_purchase_path, class: "btn btn-primary" do %>
      <i class="bi bi-plus-lg me-1"></i>
      New Purchase
    <% end %>
    <%= link_to admin_vendor_purchases_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Purchases
    <% end %>
  </div>
</div>

<!-- Summary Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Total Batches</h6>
            <h5 class="mb-0"><%= @total_batches %></h5>
          </div>
          <div class="text-primary">
            <i class="bi bi-boxes fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Unique Products</h6>
            <h5 class="mb-0"><%= @total_products %></h5>
          </div>
          <div class="text-success">
            <i class="bi bi-bag-check fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Total Quantity</h6>
            <h5 class="mb-0"><%= number_with_delimiter(@total_quantity) %></h5>
          </div>
          <div class="text-warning">
            <i class="bi bi-stack fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Total Stock Value</h6>
            <h5 class="mb-0">₹<%= number_with_delimiter(@total_stock_value.to_i) %></h5>
          </div>
          <div class="text-info">
            <i class="bi bi-currency-rupee fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4 border-0 shadow-sm">
  <div class="card-body">
    <%= form_with url: batch_inventory_admin_vendor_purchases_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-4">
        <%= form.text_field :search, value: params[:search],
            placeholder: "Search products...",
            class: "form-control" %>
      </div>
      <div class="col-md-3">
        <%= form.select :vendor_id, options_from_collection_for_select(@vendors, :id, :name, params[:vendor_id]),
            { prompt: 'All Vendors' }, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <div class="form-check">
          <%= check_box_tag :in_stock, 'true', params[:in_stock] == 'true', class: "form-check-input" %>
          <%= label_tag :in_stock, "In Stock Only", class: "form-check-label" %>
        </div>
      </div>
      <div class="col-md-3">
        <div class="d-flex gap-2">
          <%= form.submit "Filter", class: "btn btn-outline-primary" %>
          <%= link_to "Reset", batch_inventory_admin_vendor_purchases_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Products with Batch Information -->
<% if @product_stats.any? %>
  <div class="row">
    <% @product_stats.each_with_index do |stat, index| %>
      <div class="col-12 mb-4">
        <div class="card border-0 shadow-sm">
          <!-- Product Header -->
          <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <% if stat[:product].main_image %>
                  <%= image_tag stat[:product].main_image, class: "rounded", style: "width: 50px; height: 50px; object-fit: cover;" %>
                <% else %>
                  <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-box text-white"></i>
                  </div>
                <% end %>
              </div>
              <div>
                <h5 class="mb-0"><%= stat[:product].name %></h5>
                <div class="text-muted small">
                  SKU: <%= stat[:product].sku %> | Category: <%= stat[:product].category&.name %>
                </div>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <button class="btn btn-outline-primary btn-sm me-2" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#product-details-<%= stat[:product].id %>"
                      aria-expanded="false">
                <i class="bi bi-chevron-down"></i> View Details
              </button>
            </div>
          </div>

          <!-- Product Summary Stats -->
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-primary bg-opacity-10 rounded">
                  <div class="h5 mb-0 text-primary"><%= stat[:batch_count] %></div>
                  <small class="text-muted">Batches</small>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                  <div class="h5 mb-0 text-success"><%= number_with_delimiter(stat[:total_quantity]) %></div>
                  <small class="text-muted">Total Qty</small>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-info bg-opacity-10 rounded">
                  <div class="h5 mb-0 text-info">₹<%= number_with_delimiter(stat[:total_value].to_i) %></div>
                  <small class="text-muted">Total Value</small>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                  <div class="h5 mb-0 text-warning">₹<%= sprintf("%.2f", stat[:avg_purchase_price]) %></div>
                  <small class="text-muted">Avg Price</small>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-secondary bg-opacity-10 rounded">
                  <div class="h5 mb-0 text-secondary"><%= stat[:vendor_count] %></div>
                  <small class="text-muted">Vendors</small>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="text-center p-2 bg-dark bg-opacity-10 rounded">
                  <div class="small mb-0">
                    <div class="text-dark"><%= stat[:oldest_batch_date]&.strftime("%d/%m/%y") %></div>
                    <div class="text-muted">to</div>
                    <div class="text-dark"><%= stat[:newest_batch_date]&.strftime("%d/%m/%y") %></div>
                  </small>
                  <small class="text-muted">Date Range</small>
                </div>
              </div>
            </div>

            <!-- Detailed Batch Information (Collapsible) -->
            <div class="collapse mt-4" id="product-details-<%= stat[:product].id %>">
              <div class="border-top pt-4">
                <h6 class="mb-3">Batch Details (FIFO Order)</h6>
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>Batch #</th>
                        <th>Date</th>
                        <th>Vendor</th>
                        <th>Qty Purchased</th>
                        <th>Qty Remaining</th>
                        <th>Purchase Price</th>
                        <th>Total Value</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% stat[:batches].each_with_index do |batch, batch_index| %>
                        <tr class="<%= batch.quantity_remaining <= 0 ? 'table-secondary bg-opacity-25' : '' %>">
                          <td>
                            <span class="badge <%= batch.quantity_remaining <= 0 ? 'bg-dark text-light' : 'bg-secondary' %>">
                              #<%= batch.id %>
                            </span>
                            <% if batch.quantity_remaining <= 0 %>
                              <small class="text-muted d-block">Exhausted</small>
                            <% end %>
                          </td>
                          <td>
                            <div class="small">
                              <div><%= batch.batch_date&.strftime("%d %b %Y") %></div>
                              <div class="text-muted"><%= time_ago_in_words(batch.created_at) %> ago</div>
                            </div>
                          </td>
                          <td>
                            <div class="d-flex align-items-center">
                              <span class="badge bg-info bg-opacity-20 text-info me-1">
                                <i class="bi bi-building"></i>
                              </span>
                              <%= batch.vendor&.name || 'Unknown' %>
                            </div>
                          </td>
                          <td>
                            <span class="fw-medium"><%= number_with_delimiter(batch.quantity_purchased) %></span>
                          </td>
                          <td>
                            <span class="fw-medium <%= batch.quantity_remaining <= 0 ? 'text-danger' : 'text-success' %>">
                              <%= number_with_delimiter(batch.quantity_remaining) %>
                            </span>
                          </td>
                          <td>
                            <span class="text-success">₹<%= sprintf("%.2f", batch.purchase_price) %></span>
                          </td>
                          <td>
                            <span class="fw-medium text-primary">
                              ₹<%= number_with_delimiter((batch.quantity_remaining * batch.purchase_price).to_i) %>
                            </span>
                          </td>
                          <td>
                            <% if batch.quantity_remaining <= 0 %>
                              <span class="badge bg-danger">Exhausted</span>
                            <% elsif batch.quantity_remaining <= batch.quantity_purchased * 0.2 %>
                              <span class="badge bg-warning">Low Stock</span>
                            <% else %>
                              <span class="badge bg-success">Available</span>
                            <% end %>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              <% if batch.vendor_purchase.present? %>
                                <%= link_to "Purchase", admin_vendor_purchase_path(batch.vendor_purchase),
                                    class: "btn btn-outline-primary btn-sm", title: "View Purchase Record" %>
                              <% end %>
                              <%= link_to "Vendor", admin_vendor_path(batch.vendor),
                                  class: "btn btn-outline-info btn-sm", title: "View Vendor" %>
                              <%= link_to "Product", admin_product_path(batch.product),
                                  class: "btn btn-outline-secondary btn-sm", title: "View Product" %>
                            </div>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>

                <!-- FIFO Order Information -->
                <div class="alert alert-info mt-3">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>FIFO (First In, First Out):</strong> Batches are listed in the order they will be consumed.
                  Older batches (top) will be used first when processing orders.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5">
      <i class="bi bi-inbox display-4 text-muted mb-3"></i>
      <h5 class="text-muted">No Batches Found</h5>
      <p class="text-muted mb-4">No stock batches match your current filters.</p>
      <%= link_to "Reset Filters", batch_inventory_admin_vendor_purchases_path, class: "btn btn-outline-primary" %>
    </div>
  </div>
<% end %>

<style>
  .table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .card-header {
    padding: 1rem 1.25rem;
  }

  .collapse .table-responsive {
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .btn-group .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  @media (max-width: 768px) {
    .btn-group {
      flex-direction: column;
      width: 100%;
    }

    .btn-group .btn {
      margin-bottom: 0.25rem;
    }
  }
</style>