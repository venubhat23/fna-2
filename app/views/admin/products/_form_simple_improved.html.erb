<style>
  /* Enhanced Product Form Styles */
  .product-form-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .section-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.25rem;
    margin: 0;
  }

  .section-header h5 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .required-field {
    color: #dc3545;
    margin-left: 2px;
  }

  .toggle-section {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 0.5rem 0;
    border: 1px solid #dee2e6;
  }

  .toggle-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 0.75rem;
  }

  .form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
  }

  .helper-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  .price-display {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border: 1px solid #667eea30;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }

  .quick-action-card {
    position: sticky;
    top: 1rem;
  }

  @media (max-width: 768px) {
    .quick-action-card {
      position: relative;
      top: 0;
    }
  }
</style>

<div class="product-form-container">
  <%= form_with model: [:admin, @product], local: true, multipart: true, class: "row g-4", id: "product-form" do |form| %>

    <!-- Error Display -->
    <% if @product.errors.any? %>
      <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show">
          <h6 class="alert-heading">Please fix the following errors:</h6>
          <ul class="mb-0">
            <% @product.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
    <% end %>

    <!-- Main Content -->
    <div class="col-lg-8">

      <!-- Basic Information -->
      <div class="section-card">
        <div class="section-header">
          <h5><i class="bi bi-info-circle"></i> Product Information</h5>
        </div>
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-12">
              <%= form.label :name, class: "form-label" %>
              <span class="required-field">*</span>
              <%= form.text_field :name, class: "form-control", placeholder: "Enter product name", required: true %>
            </div>

            <div class="col-md-6">
              <%= form.label :category_id, "Category", class: "form-label" %>
              <span class="required-field">*</span>
              <%= form.select :category_id,
                  options_for_select([['-- Select Category --', '']] + Category.for_select, @product.category_id),
                  {},
                  { class: "form-select", required: true } %>
            </div>

            <div class="col-md-6">
              <%= form.label :sku, "SKU", class: "form-label" %>
              <%= form.text_field :sku, class: "form-control", placeholder: "Auto-generated if empty" %>
            </div>

            <div class="col-md-6">
              <%= form.label :product_type, "Product Type", class: "form-label" %>
              <%= form.select :product_type,
                  options_for_select(Product::PRODUCT_TYPES, @product.product_type || 'Grocery'),
                  {},
                  { class: "form-select" } %>
            </div>

            <div class="col-md-6">
              <%= form.label :status, class: "form-label" %>
              <%= form.select :status,
                  options_for_select([
                    ['Active', 'active'],
                    ['Draft', 'draft'],
                    ['Inactive', 'inactive']
                  ], @product.status),
                  {},
                  { class: "form-select" } %>
            </div>

            <div class="col-12">
              <%= form.label :description, class: "form-label" %>
              <%= form.text_area :description, class: "form-control", rows: 4, placeholder: "Product description..." %>
            </div>

            <!-- Subscription Toggle -->
            <div class="col-12">
              <div class="toggle-section">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="mb-1"><i class="bi bi-arrow-repeat text-primary"></i> Enable Subscription</h6>
                    <small class="text-muted">Allow customers to subscribe for regular delivery</small>
                  </div>
                  <div class="form-check form-switch">
                    <%= form.check_box :is_subscription_enabled, class: "form-check-input", id: "subscription_toggle" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing & Discounts -->
      <div class="section-card">
        <div class="section-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <h5><i class="bi bi-currency-rupee"></i> Pricing & Discounts</h5>
        </div>
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-md-6">
              <%= form.label :buying_price, "Cost Price", class: "form-label" %>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <%= form.number_field :buying_price, class: "form-control", step: 0.01, min: 0, placeholder: "0.00", id: "buying_price" %>
              </div>
              <div class="helper-text">Your purchase/manufacturing cost</div>
            </div>

            <div class="col-md-6">
              <%= form.label :price, "Selling Price", class: "form-label" %>
              <span class="required-field">*</span>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <%= form.number_field :price, class: "form-control", step: 0.01, min: 0, placeholder: "0.00", required: true, id: "selling_price" %>
              </div>
              <div class="helper-text">Price before any discounts</div>
            </div>

            <!-- Price Preview -->
            <div class="col-12">
              <div class="price-display">
                <div class="row text-center">
                  <div class="col-md-4">
                    <small class="text-muted d-block">Cost Price</small>
                    <h6 class="mb-0" id="cost_display">₹0.00</h6>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted d-block">Profit Margin</small>
                    <h6 class="mb-0 text-success" id="margin_display">0%</h6>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted d-block">Selling Price</small>
                    <h6 class="mb-0" id="price_display">₹0.00</h6>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enable Discount -->
            <div class="col-12">
              <div class="toggle-section">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <div>
                    <h6 class="mb-1"><i class="bi bi-percent text-warning"></i> Enable Discount</h6>
                    <small class="text-muted">Offer special pricing to customers</small>
                  </div>
                  <div class="form-check form-switch">
                    <%= form.check_box :is_discounted, class: "form-check-input", id: "discount_toggle", checked: @product.is_discounted %>
                  </div>
                </div>

                <!-- Discount Configuration -->
                <div id="discount_config" style="<%= @product.is_discounted ? '' : 'display: none;' %>">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <%= form.label :discount_type, "Type", class: "form-label" %>
                      <%= form.select :discount_type,
                          options_for_select([
                            ['Percentage (%)', 'percentage'],
                            ['Fixed Amount (₹)', 'fixed']
                          ], @product.discount_type),
                          { prompt: 'Select discount type' },
                          { class: "form-select", id: "discount_type" } %>
                    </div>

                    <div class="col-md-6">
                      <%= form.label :discount_value, "Value", class: "form-label" %>
                      <div class="input-group">
                        <span class="input-group-text" id="discount_symbol">%</span>
                        <%= form.number_field :discount_value, class: "form-control", step: 0.01, min: 0, placeholder: "0", id: "discount_value" %>
                      </div>
                    </div>

                    <div class="col-12">
                      <%= form.label :discount_amount, "Calculated Discount", class: "form-label" %>
                      <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <%= form.number_field :discount_amount, class: "form-control", readonly: true, id: "discount_amount" %>
                      </div>
                      <div class="helper-text">Auto-calculated discount amount</div>
                    </div>

                    <!-- Final Price Display -->
                    <div class="col-12">
                      <div class="alert alert-info">
                        <div class="row text-center">
                          <div class="col-4">
                            <small class="d-block">Original</small>
                            <strong id="original_display">₹0.00</strong>
                          </div>
                          <div class="col-4">
                            <small class="d-block">Discount</small>
                            <strong class="text-danger" id="discount_display">-₹0.00</strong>
                          </div>
                          <div class="col-4">
                            <small class="d-block">Final Price</small>
                            <strong class="text-success" id="final_display">₹0.00</strong>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enable GST -->
            <div class="col-12">
              <div class="toggle-section">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <div>
                    <h6 class="mb-1"><i class="bi bi-receipt text-info"></i> Enable GST</h6>
                    <small class="text-muted">Configure tax settings</small>
                  </div>
                  <div class="form-check form-switch">
                    <%= form.check_box :gst_enabled, class: "form-check-input", id: "gst_toggle", checked: @product.gst_enabled %>
                  </div>
                </div>

                <!-- GST Configuration -->
                <div id="gst_config" style="<%= @product.gst_enabled ? '' : 'display: none;' %>">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <%= form.label :gst_percentage, "GST Rate", class: "form-label" %>
                      <%= form.select :gst_percentage,
                          options_for_select([
                            ['0%', 0],
                            ['5%', 5],
                            ['12%', 12],
                            ['18%', 18],
                            ['28%', 28]
                          ], @product.gst_percentage),
                          { prompt: 'Select GST rate' },
                          { class: "form-select", id: "gst_rate" } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory -->
      <div class="section-card">
        <div class="section-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
          <h5><i class="bi bi-box-seam"></i> Inventory</h5>
        </div>
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-md-4">
              <%= form.label :stock, "Stock", class: "form-label" %>
              <%= form.number_field :stock, class: "form-control", min: 0, placeholder: "0" %>
            </div>

            <div class="col-md-4">
              <%= form.label :weight, "Weight (kg)", class: "form-label" %>
              <%= form.number_field :weight, class: "form-control", step: 0.01, min: 0, placeholder: "0.00" %>
            </div>

            <div class="col-md-4">
              <%= form.label :dimensions, "Dimensions", class: "form-label" %>
              <%= form.text_field :dimensions, class: "form-control", placeholder: "L x W x H" %>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="quick-action-card">
        <div class="section-card">
          <div class="section-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h5><i class="bi bi-lightning-fill"></i> Actions</h5>
          </div>
          <div class="card-body p-4">
            <div class="d-grid gap-2">
              <%= form.submit "Save Product", class: "btn btn-primary btn-lg" %>
              <%= link_to "Cancel", admin_products_path, class: "btn btn-outline-secondary" %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden Fields -->
    <%= form.hidden_field :discount_amount %>

  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const buyingPrice = document.getElementById('buying_price');
  const sellingPrice = document.getElementById('selling_price');
  const discountToggle = document.getElementById('discount_toggle');
  const discountConfig = document.getElementById('discount_config');
  const discountType = document.getElementById('discount_type');
  const discountValue = document.getElementById('discount_value');
  const discountSymbol = document.getElementById('discount_symbol');
  const gstToggle = document.getElementById('gst_toggle');
  const gstConfig = document.getElementById('gst_config');

  // Update price displays
  function updateDisplays() {
    const buying = parseFloat(buyingPrice?.value) || 0;
    const selling = parseFloat(sellingPrice?.value) || 0;
    const type = discountType?.value;
    const value = parseFloat(discountValue?.value) || 0;

    // Update cost and selling price
    document.getElementById('cost_display').textContent = `₹${buying.toFixed(2)}`;
    document.getElementById('price_display').textContent = `₹${selling.toFixed(2)}`;

    // Calculate profit margin
    if (buying > 0 && selling > 0) {
      const profit = selling - buying;
      const margin = (profit / buying) * 100;
      document.getElementById('margin_display').textContent = `${margin.toFixed(1)}%`;
    }

    // Calculate discount
    let discountAmount = 0;
    let finalPrice = selling;

    if (discountToggle?.checked && type && value > 0) {
      if (type === 'percentage') {
        discountAmount = (selling * value) / 100;
      } else if (type === 'fixed') {
        discountAmount = value;
      }
      finalPrice = Math.max(0, selling - discountAmount);
    }

    // Update discount displays
    document.getElementById('original_display').textContent = `₹${selling.toFixed(2)}`;
    document.getElementById('discount_display').textContent = `-₹${discountAmount.toFixed(2)}`;
    document.getElementById('final_display').textContent = `₹${finalPrice.toFixed(2)}`;
    document.getElementById('discount_amount').value = discountAmount.toFixed(2);
  }

  // Event listeners
  buyingPrice?.addEventListener('input', updateDisplays);
  sellingPrice?.addEventListener('input', updateDisplays);
  discountValue?.addEventListener('input', updateDisplays);

  // Toggle discount section
  discountToggle?.addEventListener('change', function() {
    discountConfig.style.display = this.checked ? 'block' : 'none';
    updateDisplays();
  });

  // Change discount symbol
  discountType?.addEventListener('change', function() {
    if (discountSymbol) {
      discountSymbol.textContent = this.value === 'fixed' ? '₹' : '%';
    }
    updateDisplays();
  });

  // Toggle GST section
  gstToggle?.addEventListener('change', function() {
    gstConfig.style.display = this.checked ? 'block' : 'none';
  });

  // Initialize
  updateDisplays();
});
</script>