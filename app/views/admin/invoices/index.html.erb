<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Invoice Management</h2>
  </div>
  <div>
    <!-- Filter Dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-funnel me-2"></i>Filter Invoices
      </button>
      <ul class="dropdown-menu">
        <li><%= link_to "All Invoices", admin_invoices_path, class: "dropdown-item" %></li>
        <li><hr class="dropdown-divider"></li>
        <li><%= link_to "Pending", admin_invoices_path(status: 'pending'), class: "dropdown-item" %></li>
        <li><%= link_to "Paid", admin_invoices_path(status: 'paid'), class: "dropdown-item" %></li>
        <li><hr class="dropdown-divider"></li>
        <li><%= link_to "Affiliate Payouts", admin_invoices_path(payout_type: 'affiliate'), class: "dropdown-item" %></li>
        <li><%= link_to "Ambassador Payouts", admin_invoices_path(payout_type: 'distributor'), class: "dropdown-item" %></li>
        <li><%= link_to "Commission Payouts", admin_invoices_path(payout_type: 'commission'), class: "dropdown-item" %></li>
      </ul>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Invoices</h6>
            <h3 class="mb-0 text-primary"><%= number_with_delimiter(Invoice.count) %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-receipt text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Pending Invoices</h6>
            <h3 class="mb-0 text-warning"><%= number_with_delimiter(Invoice.pending.count) %></h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="bi bi-clock text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Paid Invoices</h6>
            <h3 class="mb-0 text-success"><%= number_with_delimiter(Invoice.paid.count) %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-check-circle text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Overdue Invoices</h6>
            <h3 class="mb-0 text-danger"><%= number_with_delimiter(Invoice.overdue.count) %></h3>
          </div>
          <div class="bg-danger bg-opacity-10 rounded p-3">
            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoices List -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">Invoice List</h5>
  </div>
  <div class="card-body p-0">
    <% if @invoices.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-0">Invoice #</th>
              <th class="border-0">Recipient</th>
              <th class="border-0">Type</th>
              <th class="border-0">Amount</th>
              <th class="border-0">Invoice Date</th>
              <th class="border-0">Due Date</th>
              <th class="border-0">Status</th>
              <th class="border-0">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @invoices.each do |invoice| %>
              <tr>
                <td>
                  <div class="fw-bold text-primary fs-6">
                    <%= invoice.invoice_number %>
                  </div>
                </td>
                <td class="py-3">
                  <div>
                    <div class="fw-semibold text-dark">
                      <%= invoice.payout_recipient %>
                    </div>
                    <small class="text-muted">
                      <%= invoice.payout_type.humanize %> Payment
                    </small>
                  </div>
                </td>
                <td class="py-3">
                  <div class="text-dark">
                    <% case invoice.payout_type %>
                    <% when 'affiliate' %>
                      Affiliate
                    <% when 'distributor' %>
                      Ambassador
                    <% when 'commission' %>
                      Commission
                    <% else %>
                      <%= invoice.payout_type.humanize %>
                    <% end %>
                  </div>
                </td>
                <td class="py-3">
                  <div class="d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 rounded-3 px-3 py-2">
                      <div class="fs-6 fw-bold text-success mb-0">
                        â‚¹<%= number_with_delimiter(invoice.formatted_amount) %>
                      </div>
                      <small class="text-success opacity-75">Amount</small>
                    </div>
                  </div>
                </td>
                <td class="py-3">
                  <div class="d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 rounded-2 px-3 py-2">
                      <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-calendar-event text-info me-2"></i>
                        <span class="fw-medium text-dark">
                          <%= invoice.invoice_date.strftime('%d %b %Y') %>
                        </span>
                      </div>
                      <small class="text-info">Invoice Date</small>
                    </div>
                  </div>
                </td>
                <td class="py-3">
                  <div class="d-flex align-items-center">
                    <div class="<%= invoice.overdue? ? 'bg-danger' : 'bg-warning' %> bg-opacity-10 rounded-2 px-3 py-2">
                      <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-calendar-check <%= invoice.overdue? ? 'text-danger' : 'text-warning' %> me-2"></i>
                        <span class="fw-medium text-dark">
                          <%= invoice.due_date.strftime('%d %b %Y') %>
                        </span>
                      </div>
                      <small class="<%= invoice.overdue? ? 'text-danger' : 'text-warning' %>">
                        <% if invoice.overdue? %>
                          <i class="bi bi-exclamation-triangle me-1"></i>
                          Overdue by <%= invoice.days_overdue %> days
                        <% else %>
                          Due Date
                        <% end %>
                      </small>
                    </div>
                  </div>
                </td>
                <td class="py-3">
                  <div class="text-dark">
                    <% case invoice.status %>
                    <% when 'pending' %>
                      Pending
                    <% when 'paid' %>
                      Paid
                    <% else %>
                      Cancelled
                    <% end %>
                  </div>
                </td>
                <td class="py-3">
                  <div class="d-flex gap-2 align-items-center">
                    <!-- View Details -->
                    <%= link_to admin_invoice_path(invoice),
                        class: "btn btn-outline-primary btn-sm rounded-pill px-3",
                        title: "View Details",
                        data: { bs_toggle: "tooltip" } do %>
                      <i class="bi bi-eye me-1"></i>View
                    <% end %>


                    <!-- Mark as Paid (if pending) -->
                    <% if invoice.status == 'pending' %>
                      <%= link_to mark_as_paid_admin_invoice_path(invoice),
                          method: :patch,
                          class: "btn btn-success btn-sm rounded-pill px-3",
                          confirm: "Mark this invoice as paid?",
                          title: "Mark as Paid",
                          data: { bs_toggle: "tooltip" } do %>
                        <i class="bi bi-check-circle me-1"></i>Mark Paid
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer bg-transparent border-0">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <small class="text-muted mb-2 mb-md-0">
            <% if @invoices.respond_to?(:total_count) %>
              Showing <%= @invoices.current_page == 1 ? 1 : ((@invoices.current_page - 1) * @invoices.limit_value + 1) %>
              to <%= [@invoices.current_page * @invoices.limit_value, @invoices.total_count].min %>
              of <%= number_with_delimiter(@invoices.total_count) %> invoices
            <% else %>
              Showing <%= @invoices.count %> invoices
            <% end %>
          </small>

          <% if @invoices.respond_to?(:total_pages) && @invoices.total_pages > 1 %>
            <div class="pagination-wrapper">
              <%= paginate @invoices %>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-receipt fs-1 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No invoices found</h5>
        <p class="text-muted mb-3">
          No invoices have been generated yet. Invoices are automatically created when payouts are processed.
        </p>
      </div>
    <% end %>
  </div>
</div>

<style>
  /* Custom styling for invoice index page */
  .table th {
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    padding: 1rem 0.75rem;
  }

  .table td {
    vertical-align: middle;
    border-color: #f1f5f9;
  }

  .table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }

  .avatar {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease;
  }

  .avatar:hover {
    transform: scale(1.05);
  }

  .badge {
    font-size: 12px;
    letter-spacing: 0.25px;
  }

  .rounded-pill {
    border-radius: 50px !important;
  }

  .btn-sm.rounded-pill {
    padding: 0.375rem 1rem;
    font-size: 13px;
    font-weight: 500;
  }

  .spinner-border-sm {
    animation: spinner-border 0.75s linear infinite;
  }

  /* Hover effects for action buttons */
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
  }

  /* Dropdown menu styling */
  .dropdown-menu {
    border: none;
    border-radius: 12px;
    padding: 0.5rem 0;
  }

  .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 13px;
    transition: all 0.2s ease;
  }

  .dropdown-item:hover {
    background-color: #f1f5f9;
    color: #334155;
  }

  /* Custom background colors */
  .bg-purple {
    --bs-purple: #8b5cf6;
    background-color: var(--bs-purple) !important;
  }

  .text-purple {
    color: #8b5cf6 !important;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .table-responsive {
      font-size: 14px;
    }

    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 12px;
    }
  }
</style>