<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Invoice Management</h2>
    <p class="text-muted mb-0">Manage customer invoices and billing</p>
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkInvoiceModal">
      <i class="bi bi-plus-lg me-1"></i>
      Generate Invoices
    </button>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <% if @invoices.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @invoices.each do |invoice| %>
              <tr>
                <td><%= invoice.invoice_number %></td>
                <td><%= invoice.customer.display_name %></td>
                <td>â‚¹<%= number_with_delimiter(invoice.total_amount) %></td>
                <td>
                  <span class="badge bg-<%= invoice.status == 'paid' ? 'success' : (invoice.status == 'draft' ? 'secondary' : 'warning') %>">
                    <%= invoice.status&.humanize || 'Draft' %>
                  </span>
                </td>
                <td><%= invoice.invoice_date&.strftime("%d %b %Y") %></td>
                <td>
                  <%= link_to "View", admin_invoice_path(invoice), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <h5 class="text-muted">No Invoices Found</h5>
        <p class="text-muted">Generate invoices for completed deliveries</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal-overlay" id="bulkInvoiceModal" style="display: none;">
  <div class="simple-modal">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title" id="bulkInvoiceModalLabel">
        <i class="bi bi-receipt"></i> Generate Bulk Invoices
      </h5>
      <button type="button" class="btn-close btn-close-white" onclick="closeBulkInvoiceModal()" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="bulkInvoiceLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading invoice form...</p>
      </div>
      <div id="bulkInvoiceContent" style="display: none;">
        <!-- Form content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Modal CSS -->
<style>
/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1050;
  overflow-y: auto;
  padding: 20px;
}

.simple-modal {
  background: white;
  border-radius: 15px;
  max-width: 90%;
  width: 900px;
  margin: 0 auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  position: relative;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

.simple-modal .modal-header {
  padding: 20px 30px;
  border-radius: 15px 15px 0 0;
  display: flex;
  justify-content: between;
  align-items: center;
}

.simple-modal .modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.simple-modal .btn-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
  margin-left: auto;
}

.simple-modal .btn-close:hover {
  opacity: 1;
}

.simple-modal .modal-body {
  padding: 30px;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

/* Close modal when clicking outside */
.modal-overlay:target {
  display: block;
}

/* Scrollbar styling for modal content */
.simple-modal .modal-body::-webkit-scrollbar {
  width: 8px;
}

.simple-modal .modal-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<script>
// Update the button to use onclick instead of Bootstrap modal
document.addEventListener('DOMContentLoaded', function() {
  const generateBtn = document.querySelector('[data-bs-target="#bulkInvoiceModal"]');
  if (generateBtn) {
    generateBtn.removeAttribute('data-bs-toggle');
    generateBtn.removeAttribute('data-bs-target');
    generateBtn.setAttribute('onclick', 'openBulkInvoiceModal()');
  }
});

// Open bulk invoice modal
function openBulkInvoiceModal() {
  console.log('Opening bulk invoice modal');

  // Load form content
  loadBulkInvoiceForm();

  // Show modal
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }
}

// Close bulk invoice modal
function closeBulkInvoiceModal() {
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore background scrolling
  }
}

// Load bulk invoice form
function loadBulkInvoiceForm() {
  // Show loading, hide content
  const modalLoading = document.getElementById('bulkInvoiceLoading');
  const modalContent = document.getElementById('bulkInvoiceContent');

  if (modalLoading) modalLoading.style.display = 'block';
  if (modalContent) modalContent.style.display = 'none';

  // Fetch form content
  fetch('<%= bulk_invoice_form_admin_invoices_path %>')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();
    })
    .then(html => {
      if (modalContent) {
        modalContent.innerHTML = html;
        modalContent.style.display = 'block';
      }
      if (modalLoading) {
        modalLoading.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error loading form:', error);
      if (modalContent) {
        modalContent.innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
        modalContent.style.display = 'block';
      }
      if (modalLoading) {
        modalLoading.style.display = 'none';
      }
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('bulkInvoiceModal');
  if (e.target === modal) {
    closeBulkInvoiceModal();
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeBulkInvoiceModal();
  }
});
</script>