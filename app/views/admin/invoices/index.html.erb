<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Invoice Management</h2>
    <p class="text-muted mb-0">Manage customer invoices and billing</p>
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkInvoiceModal">
      <i class="bi bi-plus-lg me-1"></i>
      Generate Invoices
    </button>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-receipt text-primary fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <div class="text-muted small">Total Invoices</div>
            <div class="fs-4 fw-bold text-dark"><%= number_with_delimiter(@stats[:total_invoices]) %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-success bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-currency-rupee text-success fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <div class="text-muted small">Total Amount</div>
            <div class="fs-4 fw-bold text-dark">₹<%= number_with_delimiter(@stats[:total_amount].to_i) %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-success bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <div class="text-muted small">Paid Amount</div>
            <div class="fs-4 fw-bold text-success">₹<%= number_with_delimiter(@stats[:paid_amount].to_i) %></div>
            <div class="small text-muted"><%= @stats[:paid_count] %> invoices</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-clock text-warning fs-4"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <div class="text-muted small">Pending Amount</div>
            <div class="fs-4 fw-bold text-warning">₹<%= number_with_delimiter(@stats[:pending_amount].to_i) %></div>
            <div class="small text-muted"><%= @stats[:pending_count] %> invoices</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filters -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <%= form_with url: admin_invoices_path, method: :get, local: true, class: "search-form" do |f| %>
      <div class="row g-3 align-items-end">
        <div class="col-lg-4 col-md-6">
          <%= f.text_field :search, value: params[:search], placeholder: "Search invoices, customers...",
                          class: "form-control", id: "searchInput" %>
        </div>
        <div class="col-lg-2 col-md-6">
          <%= f.select :status, options_for_select([
                ['All Status', 'all'],
                ['Paid', 'fully_paid'],
                ['Unpaid', 'unpaid'],
                ['Partially Paid', 'partially_paid']
              ], params[:status] || 'all'), {}, { class: "form-select" } %>
        </div>
        <div class="col-lg-2 col-md-6">
          <%= f.date_field :date_from, value: params[:date_from],
                          class: "form-control", placeholder: "From Date" %>
        </div>
        <div class="col-lg-2 col-md-6">
          <%= f.date_field :date_to, value: params[:date_to],
                          class: "form-control", placeholder: "To Date" %>
        </div>
        <div class="col-lg-2 col-md-12">
          <div class="d-flex gap-2">
            <%= f.submit "Search", class: "btn btn-primary" %>
            <%= link_to "Reset", admin_invoices_path, class: "btn btn-outline-secondary" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Invoices Table -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white border-0 py-3">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h6 class="mb-0 text-dark">Invoice List</h6>
        <small class="text-muted">
          <% if params[:search].present? || params[:status].present? || params[:date_from].present? || params[:date_to].present? %>
            Showing filtered results
          <% else %>
            Showing latest <%= @invoices.count %> invoices
          <% end %>
        </small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <small class="text-muted">
          Total: <%= number_with_delimiter(@stats[:total_invoices]) %> invoices
        </small>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @invoices.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0 fw-semibold">Invoice #</th>
              <th class="border-0 fw-semibold">Customer</th>
              <th class="border-0 fw-semibold">Amount</th>
              <th class="border-0 fw-semibold">Payment Status</th>
              <th class="border-0 fw-semibold">Date</th>
              <th class="border-0 fw-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @invoices.each do |invoice| %>
              <tr>
                <td class="fw-medium text-primary">
                  <%= link_to invoice.invoice_number, admin_invoice_path(invoice),
                             class: "text-decoration-none fw-medium" %>
                </td>
                <td>
                  <div class="d-flex flex-column">
                    <span class="fw-medium"><%= invoice.customer.display_name %></span>
                    <% if invoice.customer.email.present? %>
                      <small class="text-muted"><%= invoice.customer.email %></small>
                    <% end %>
                  </div>
                </td>
                <td class="fw-medium">₹<%= number_with_delimiter(invoice.total_amount.to_i) %></td>
                <td>
                  <% case invoice.payment_status %>
                  <% when 'fully_paid' %>
                    <span class="badge bg-success bg-opacity-10 text-success border border-success">
                      <i class="bi bi-check-circle me-1"></i>
                      Paid
                    </span>
                  <% when 'partially_paid' %>
                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">
                      <i class="bi bi-clock me-1"></i>
                      Partial
                    </span>
                  <% else %>
                    <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary">
                      <i class="bi bi-x-circle me-1"></i>
                      Unpaid
                    </span>
                  <% end %>
                </td>
                <td class="text-muted">
                  <div class="d-flex flex-column">
                    <span><%= invoice.invoice_date&.strftime("%d %b %Y") %></span>
                    <small class="text-muted"><%= time_ago_in_words(invoice.created_at) %> ago</small>
                  </div>
                </td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                           data-bs-toggle="dropdown">
                      Actions
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <%= link_to admin_invoice_path(invoice), class: "dropdown-item" do %>
                          <i class="bi bi-eye me-2"></i>View Invoice
                        <% end %>
                      </li>
                      <li>
                        <%= link_to edit_admin_invoice_path(invoice), class: "dropdown-item" do %>
                          <i class="bi bi-pencil-square me-2"></i>Edit Invoice
                        <% end %>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <% unless invoice.payment_status == 'fully_paid' %>
                        <li>
                          <%= link_to mark_as_paid_admin_invoice_path(invoice), method: :patch,
                                     class: "dropdown-item",
                                     data: { confirm: "Mark this invoice as paid?" } do %>
                            <i class="bi bi-check-circle me-2"></i>Mark as Paid
                          <% end %>
                        </li>
                      <% end %>
                      <% if respond_to?(:download_pdf_admin_invoice_path) %>
                        <li>
                          <%= link_to download_pdf_admin_invoice_path(invoice),
                                     class: "dropdown-item", target: "_blank" do %>
                            <i class="bi bi-download me-2"></i>Download PDF
                          <% end %>
                        </li>
                      <% end %>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to admin_invoice_path(invoice), method: :delete,
                                   class: "dropdown-item text-danger",
                                   data: { confirm: "Are you sure you want to delete this invoice? This action cannot be undone." } do %>
                          <i class="bi bi-trash me-2"></i>Delete Invoice
                        <% end %>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination Info -->
      <div class="card-footer bg-light border-0">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            Showing <%= @invoices.count %> of <%= number_with_delimiter(@stats[:total_invoices]) %> invoices
          </div>
          <div>
            <% if @invoices.count >= 50 %>
              <%= link_to "Load More", admin_invoices_path(params.merge(limit: 100)),
                         class: "btn btn-sm btn-outline-primary" %>
            <% end %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-receipt-cutoff display-1 text-muted"></i>
        </div>
        <h5 class="text-muted">No Invoices Found</h5>
        <p class="text-muted mb-3">
          <% if params[:search].present? || params[:status].present? %>
            No invoices match your search criteria.
          <% else %>
            Generate invoices for completed deliveries to get started.
          <% end %>
        </p>
        <% if params[:search].present? || params[:status].present? %>
          <%= link_to "Clear Filters", admin_invoices_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal-overlay" id="bulkInvoiceModal" style="display: none;">
  <div class="simple-modal">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title" id="bulkInvoiceModalLabel">
        <i class="bi bi-receipt"></i> Generate Bulk Invoices
      </h5>
      <button type="button" class="btn-close btn-close-white" onclick="closeBulkInvoiceModal()" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body pt-4">
      <div id="bulkInvoiceLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading invoice form...</p>
      </div>
      <div id="bulkInvoiceContent" style="display: none;">
        <form id="generateInvoiceForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="invoice_month" class="form-label">Month <span class="text-danger">*</span></label>
                <select class="form-select" id="invoice_month" name="month" required>
                  <option value="">Select Month</option>
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="invoice_year" class="form-label">Year <span class="text-danger">*</span></label>
                <select class="form-select" id="invoice_year" name="year" required>
                  <option value="">Select Year</option>
                  <% (2024..2030).each do |year| %>
                    <option value="<%= year %>" <%= 'selected' if year == Date.current.year %>><%= year %></option>
                  <% end %>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Customer Selection <span class="text-danger">*</span></label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="customer_selection" id="all_customers" value="all" checked>
              <label class="form-check-label" for="all_customers">
                All Customers
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="customer_selection" id="specific_customers" value="specific">
              <label class="form-check-label" for="specific_customers">
                Specific Customers
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="customer_selection" id="delivery_person_customers" value="delivery_person">
              <label class="form-check-label" for="delivery_person_customers">
                Customers by Delivery Person
              </label>
            </div>
          </div>

          <!-- Delivery Person Selection -->
          <div id="delivery_person_section" class="mb-4" style="display: none;">
            <label class="form-label">Select Delivery Person</label>
            <select class="form-select" id="delivery_person_select" name="delivery_person_id">
              <option value="">Choose Delivery Person...</option>
              <!-- Options will be populated by JavaScript -->
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Select a delivery person to generate invoices for their customers only.
            </div>
          </div>

          <div id="customer_dropdown_section" class="mb-4" style="display: none;">
            <label class="form-label">Select Customers</label>
            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllCustomers()">
                    <i class="bi bi-check-all me-1"></i>Select All
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCustomers()">
                    <i class="bi bi-x-circle me-1"></i>Deselect All
                  </button>
                </div>
                <div>
                  <input type="text" class="form-control form-control-sm" placeholder="Search customers..."
                         id="customerSearch" onkeyup="filterCustomers()" style="width: 200px;">
                </div>
              </div>
              <div id="customers_checkbox_list">
                <!-- Customer checkboxes will be loaded dynamically -->
                <div class="text-muted text-center py-3">
                  <i class="bi bi-person-lines-fill fs-3 d-block mb-2"></i>
                  Loading customers...
                </div>
              </div>
            </div>
            <div class="form-text mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Select customers using checkboxes. Use search to quickly find specific customers.
              <span id="selected_count" class="badge bg-primary ms-2">0 selected</span>
            </div>
            <!-- Hidden inputs for form submission -->
            <div id="selected_customer_inputs"></div>
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" onclick="closeBulkInvoiceModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="generateInvoiceBtn">
              <i class="bi bi-receipt me-1"></i>
              Generate Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal CSS -->
<style>
/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1050;
  overflow-y: auto;
  padding: 20px;
}

.simple-modal {
  background: white;
  border-radius: 15px;
  max-width: 90%;
  width: 900px;
  margin: 50px auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  position: relative;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
}

.simple-modal .modal-header {
  padding: 20px 30px;
  border-radius: 15px 15px 0 0;
  display: flex;
  justify-content: between;
  align-items: center;
}

.simple-modal .modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.simple-modal .btn-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
  margin-left: auto;
}

.simple-modal .btn-close:hover {
  opacity: 1;
}

.simple-modal .modal-body {
  padding: 30px;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

/* Close modal when clicking outside */
.modal-overlay:target {
  display: block;
}

/* Scrollbar styling for modal content */
.simple-modal .modal-body::-webkit-scrollbar {
  width: 8px;
}

.simple-modal .modal-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<script>
// Update the button to use onclick instead of Bootstrap modal
document.addEventListener('DOMContentLoaded', function() {
  const generateBtn = document.querySelector('[data-bs-target="#bulkInvoiceModal"]');
  if (generateBtn) {
    generateBtn.removeAttribute('data-bs-toggle');
    generateBtn.removeAttribute('data-bs-target');
    generateBtn.setAttribute('onclick', 'openBulkInvoiceModal()');
  }
});

// Open bulk invoice modal
function openBulkInvoiceModal() {
  console.log('Opening bulk invoice modal');

  // Load form content
  loadBulkInvoiceForm();

  // Show modal
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }
}

// Close bulk invoice modal
function closeBulkInvoiceModal() {
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore background scrolling
  }
}

// Load bulk invoice form
function loadBulkInvoiceForm() {
  // Show loading, hide content
  const modalLoading = document.getElementById('bulkInvoiceLoading');
  const modalContent = document.getElementById('bulkInvoiceContent');

  if (modalLoading) modalLoading.style.display = 'block';
  if (modalContent) modalContent.style.display = 'none';

  // Load customers and show form content directly
  loadCustomersAndShowForm();
}

function loadCustomersAndShowForm() {
  // Load both customers and delivery persons
  Promise.all([
    fetch('/admin/invoices/customers'),
    fetch('/admin/invoices/delivery_persons')
  ])
    .then(responses => {
      // Check if both requests were successful
      responses.forEach(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
      });
      return Promise.all(responses.map(response => response.json()));
    })
    .then(([customers, deliveryPersons]) => {
      // Populate customer checkboxes
      const customerCheckboxList = document.getElementById('customers_checkbox_list');
      if (customerCheckboxList) {
        customerCheckboxList.innerHTML = '';

        if (customers.length === 0) {
          customerCheckboxList.innerHTML = `
            <div class="text-muted text-center py-3">
              <i class="bi bi-person-x fs-3 d-block mb-2"></i>
              No customers found
            </div>
          `;
        } else {
          customers.forEach(customer => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check customer-checkbox-item';
            checkboxDiv.innerHTML = `
              <input class="form-check-input customer-checkbox" type="checkbox"
                     value="${customer.id}" id="customer_${customer.id}"
                     onchange="updateSelectedCustomers()">
              <label class="form-check-label" for="customer_${customer.id}">
                <strong>${customer.display_name}</strong>
                ${customer.email ? `<br><small class="text-muted">${customer.email}</small>` : ''}
                ${customer.mobile ? `<br><small class="text-muted">${customer.mobile}</small>` : ''}
              </label>
            `;
            customerCheckboxList.appendChild(checkboxDiv);
          });
        }
      }

      // Populate delivery persons dropdown
      const deliveryPersonSelect = document.getElementById('delivery_person_select');
      if (deliveryPersonSelect) {
        // Clear existing options except the first one
        deliveryPersonSelect.innerHTML = '<option value="">Choose Delivery Person...</option>';

        deliveryPersons.forEach(dp => {
          const option = document.createElement('option');
          option.value = dp.id;
          option.textContent = dp.display_name;
          deliveryPersonSelect.appendChild(option);
        });
      }

      // Store data globally for search functionality
      window.allCustomers = customers;
      window.allDeliveryPersons = deliveryPersons;

      // Show form content and hide loading
      const modalLoading = document.getElementById('bulkInvoiceLoading');
      const modalContent = document.getElementById('bulkInvoiceContent');

      if (modalContent) modalContent.style.display = 'block';
      if (modalLoading) modalLoading.style.display = 'none';

      // Initialize form event listeners
      initializeFormListeners();
    })
    .catch(error => {
      console.error('Error loading customers:', error);
      const modalContent = document.getElementById('bulkInvoiceContent');
      const modalLoading = document.getElementById('bulkInvoiceLoading');

      if (modalContent) {
        modalContent.innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
        modalContent.style.display = 'block';
      }
      if (modalLoading) modalLoading.style.display = 'none';
    });
}

function initializeFormListeners() {
  // Handle customer selection radio buttons
  const customerRadios = document.querySelectorAll('input[name="customer_selection"]');
  const customerDropdownSection = document.getElementById('customer_dropdown_section');
  const deliveryPersonSection = document.getElementById('delivery_person_section');

  customerRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (customerDropdownSection) {
        customerDropdownSection.style.display = this.value === 'specific' ? 'block' : 'none';
      }
      if (deliveryPersonSection) {
        deliveryPersonSection.style.display = this.value === 'delivery_person' ? 'block' : 'none';
      }

      // Clear delivery person selection when switching away from delivery person mode
      if (this.value !== 'delivery_person') {
        const deliveryPersonSelect = document.getElementById('delivery_person_select');
        if (deliveryPersonSelect) {
          deliveryPersonSelect.value = '';
        }
      }
    });
  });

  // Handle delivery person selection
  const deliveryPersonSelect = document.getElementById('delivery_person_select');
  if (deliveryPersonSelect) {
    deliveryPersonSelect.addEventListener('change', function() {
      const deliveryPersonId = this.value;
      const deliveryPersonCustomersRadio = document.getElementById('delivery_person_customers');

      if (deliveryPersonId && deliveryPersonCustomersRadio && deliveryPersonCustomersRadio.checked) {
        loadCustomersForDeliveryPerson(deliveryPersonId);
      }
    });
  }

  // Handle form submission
  const form = document.getElementById('generateInvoiceForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      generateInvoices();
    });
  }
}

// Customer checkbox functions
function selectAllCustomers() {
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  const visibleCheckboxes = Array.from(checkboxes).filter(checkbox =>
    checkbox.closest('.customer-checkbox-item').style.display !== 'none'
  );

  visibleCheckboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectedCustomers();
}

function deselectAllCustomers() {
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectedCustomers();
}

function filterCustomers() {
  const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
  const customerItems = document.querySelectorAll('.customer-checkbox-item');

  customerItems.forEach(item => {
    const label = item.querySelector('label');
    const text = label.textContent.toLowerCase();

    if (text.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });

  // Update count after filtering
  updateSelectedCustomers();
}

function updateSelectedCustomers() {
  const selectedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
  const selectedCount = selectedCheckboxes.length;

  // Update the count badge
  const countBadge = document.getElementById('selected_count');
  if (countBadge) {
    countBadge.textContent = `${selectedCount} selected`;
    countBadge.className = selectedCount > 0 ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
  }

  // Update hidden inputs for form submission
  const selectedInputsContainer = document.getElementById('selected_customer_inputs');
  if (selectedInputsContainer) {
    selectedInputsContainer.innerHTML = '';

    selectedCheckboxes.forEach(checkbox => {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'customer_ids[]';
      hiddenInput.value = checkbox.value;
      selectedInputsContainer.appendChild(hiddenInput);
    });
  }
}

function loadCustomersForDeliveryPerson(deliveryPersonId) {
  const customerCheckboxList = document.getElementById('customers_checkbox_list');

  if (!customerCheckboxList) return;

  // Show loading
  customerCheckboxList.innerHTML = `
    <div class="text-center py-3">
      <div class="spinner-border text-primary spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      Loading customers for selected delivery person...
    </div>
  `;

  // Fetch customers for this delivery person
  fetch(`/admin/invoices/customers_by_delivery_person?delivery_person_id=${deliveryPersonId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(customers => {
      customerCheckboxList.innerHTML = '';

      if (customers.length === 0) {
        customerCheckboxList.innerHTML = `
          <div class="text-muted text-center py-3">
            <i class="bi bi-person-x fs-3 d-block mb-2"></i>
            No customers found for this delivery person
          </div>
        `;
      } else {
        customers.forEach(customer => {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.className = 'form-check customer-checkbox-item';
          checkboxDiv.innerHTML = `
            <input class="form-check-input customer-checkbox" type="checkbox"
                   value="${customer.id}" id="customer_${customer.id}"
                   onchange="updateSelectedCustomers()">
            <label class="form-check-label" for="customer_${customer.id}">
              <strong>${customer.display_name}</strong>
              ${customer.email ? `<br><small class="text-muted">${customer.email}</small>` : ''}
              ${customer.mobile ? `<br><small class="text-muted">${customer.mobile}</small>` : ''}
            </label>
          `;
          customerCheckboxList.appendChild(checkboxDiv);
        });
      }

      // Show the customer dropdown section when customers are loaded
      const customerDropdownSection = document.getElementById('customer_dropdown_section');
      if (customerDropdownSection && customers.length > 0) {
        customerDropdownSection.style.display = 'block';
      }

      // Update the count
      updateSelectedCustomers();
    })
    .catch(error => {
      console.error('Error loading customers for delivery person:', error);
      customerCheckboxList.innerHTML = `
        <div class="text-danger text-center py-3">
          <i class="bi bi-exclamation-triangle fs-3 d-block mb-2"></i>
          Error loading customers. Please try again.
        </div>
      `;
    });
}

function generateInvoices() {
  const form = document.getElementById('generateInvoiceForm');
  const generateBtn = document.getElementById('generateInvoiceBtn');

  if (!form || !generateBtn) return;

  // Show loading state
  generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Generating...';
  generateBtn.disabled = true;

  // Collect form data
  const formData = new FormData(form);
  const data = {
    month: formData.get('month'),
    year: formData.get('year'),
    customer_selection: formData.get('customer_selection'),
    customer_ids: formData.getAll('customer_ids[]'),
    delivery_person_id: formData.get('delivery_person_id')
  };

  // Validate form
  if (!data.month || !data.year) {
    alert('Please select month and year');
    resetGenerateButton();
    return;
  }

  if (data.customer_selection === 'specific' && data.customer_ids.length === 0) {
    alert('Please select at least one customer');
    resetGenerateButton();
    return;
  }

  if (data.customer_selection === 'delivery_person') {
    if (!data.delivery_person_id) {
      alert('Please select a delivery person');
      resetGenerateButton();
      return;
    }
    if (data.customer_ids.length === 0) {
      alert('No customers found for the selected delivery person, or no customers selected');
      resetGenerateButton();
      return;
    }
  }

  // Send request
  fetch('/admin/invoices/generate', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert(`Successfully generated ${result.invoices_created} invoices!`);
      closeBulkInvoiceModal();
      location.reload(); // Refresh the page to show new invoices
    } else {
      alert('Error generating invoices: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error generating invoices. Please try again.');
  })
  .finally(() => {
    resetGenerateButton();
  });
}

function resetGenerateButton() {
  const generateBtn = document.getElementById('generateInvoiceBtn');
  if (generateBtn) {
    generateBtn.innerHTML = '<i class="bi bi-receipt me-1"></i>Generate Invoice';
    generateBtn.disabled = false;
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('bulkInvoiceModal');
  if (e.target === modal) {
    closeBulkInvoiceModal();
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeBulkInvoiceModal();
  }
});

// Enhanced search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchForm = document.querySelector('.search-form');
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;

  // Add loading state to form submission
  if (searchForm) {
    searchForm.addEventListener('submit', function() {
      this.classList.add('loading');
    });
  }

  // Auto-search functionality (optional - uncomment to enable)
  /*
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);

      searchTimeout = setTimeout(() => {
        if (this.value.length >= 3 || this.value.length === 0) {
          searchForm.classList.add('loading');
          searchForm.submit();
        }
      }, 500);
    });
  }
  */

  // Quick status filter
  const statusSelect = document.querySelector('select[name="status"]');
  if (statusSelect) {
    statusSelect.addEventListener('change', function() {
      if (this.value !== 'all') {
        searchForm.classList.add('loading');
        searchForm.submit();
      }
    });
  }

  // Highlight search terms in results
  function highlightSearchTerms() {
    const searchTerm = new URLSearchParams(window.location.search).get('search');
    if (searchTerm && searchTerm.length > 0) {
      const tableRows = document.querySelectorAll('tbody tr');

      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
          if (cell.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            cell.innerHTML = cell.innerHTML.replace(regex, '<mark class="bg-warning bg-opacity-25 text-dark">$1</mark>');
          }
        });
      });
    }
  }

  // Call highlight function
  highlightSearchTerms();

  // Add smooth scrolling to results after search
  if (window.location.search.includes('search=') || window.location.search.includes('status=')) {
    setTimeout(() => {
      const resultsTable = document.querySelector('.table-responsive');
      if (resultsTable) {
        resultsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }

  // Export functionality (if needed)
  function exportToCSV() {
    const table = document.querySelector('.table');
    if (!table) return;

    let csv = [];
    const rows = table.querySelectorAll('tr');

    for (let row of rows) {
      const cols = row.querySelectorAll('td, th');
      const csvRow = [];

      for (let col of cols) {
        // Skip action column
        if (!col.textContent.includes('Actions')) {
          csvRow.push('"' + col.textContent.trim().replace(/"/g, '""') + '"');
        }
      }

      if (csvRow.length > 0) {
        csv.push(csvRow.join(','));
      }
    }

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'invoices_' + new Date().toISOString().slice(0, 10) + '.csv';
    link.click();
    window.URL.revokeObjectURL(url);
  }

  // Add export button (optional)
  const headerActions = document.querySelector('.d-flex.gap-2');
  if (headerActions && document.querySelectorAll('tbody tr').length > 0) {
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn btn-outline-secondary';
    exportBtn.innerHTML = '<i class="bi bi-download me-1"></i>Export';
    exportBtn.onclick = exportToCSV;
    headerActions.appendChild(exportBtn);
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      if (searchInput) {
        searchInput.focus();
        searchInput.select();
      }
    }

    // Ctrl/Cmd + R to reset filters
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
      e.preventDefault();
      window.location.href = window.location.pathname;
    }
  });

  // Add keyboard shortcut hints to search input
  if (searchInput) {
    searchInput.setAttribute('title', 'Tip: Press Ctrl+K to quickly focus search');
  }
});
</script>

<style>
.customer-checkbox-item {
  padding: 8px 12px;
  margin-bottom: 6px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  background-color: white;
  transition: all 0.2s ease;
}

.customer-checkbox-item:hover {
  background-color: #f8f9fa;
  border-color: #007bff;
  box-shadow: 0 1px 3px rgba(0, 123, 255, 0.1);
}

.customer-checkbox-item .form-check-input:checked + .form-check-label {
  color: #007bff;
  font-weight: 500;
}

.customer-checkbox-item .form-check-input {
  margin-top: 0.2rem;
}

.customer-checkbox-item label {
  cursor: pointer;
  width: 100%;
  margin-bottom: 0;
}

.customer-checkbox-item label strong {
  display: block;
  font-size: 0.95rem;
}

.customer-checkbox-item label small {
  font-size: 0.8rem;
  line-height: 1.2;
}

#customerSearch {
  border: 1px solid #ced4da;
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#customerSearch:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.badge {
  font-size: 0.75rem;
  padding: 0.35em 0.65em;
}

/* Enhanced styling for invoice index */
.search-form .form-control:focus,
.search-form .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.table th {
  font-weight: 600;
  color: #495057;
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 0.5px;
  padding: 1rem 0.75rem;
}

.table td {
  padding: 1rem 0.75rem;
  vertical-align: middle;
}

.table tbody tr:hover {
  background-color: #f8f9fa;
  transform: scale(1.002);
  transition: all 0.2s ease;
}

/* Card enhancements */
.card {
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.08) !important;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Summary card icons */
.bg-opacity-10 {
  background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
}

/* Badge improvements */
.badge {
  font-weight: 500;
  padding: 0.5em 0.8em;
  border-radius: 0.375rem;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.875rem;
  }

  .card-body {
    padding: 1rem !important;
  }

  .row.g-3 > * {
    margin-bottom: 1rem;
  }
}

/* Loading animation */
.search-form.loading .btn {
  pointer-events: none;
}

.search-form.loading .btn::after {
  content: "";
  display: inline-block;
  width: 1rem;
  height: 1rem;
  margin-left: 0.5rem;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>