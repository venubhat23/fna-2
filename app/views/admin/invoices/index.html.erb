<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Invoice Management</h2>
    <p class="text-muted mb-0">Manage customer invoices and billing</p>
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkInvoiceModal">
      <i class="bi bi-plus-lg me-1"></i>
      Generate Invoices
    </button>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <% if @invoices.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @invoices.each do |invoice| %>
              <tr>
                <td><%= invoice.invoice_number %></td>
                <td><%= invoice.customer.display_name %></td>
                <td>â‚¹<%= number_with_delimiter(invoice.total_amount) %></td>
                <td>
                  <span class="badge bg-<%= invoice.status == 'paid' ? 'success' : (invoice.status == 'draft' ? 'secondary' : 'warning') %>">
                    <%= invoice.status&.humanize || 'Draft' %>
                  </span>
                </td>
                <td><%= invoice.invoice_date&.strftime("%d %b %Y") %></td>
                <td>
                  <%= link_to "View", admin_invoice_path(invoice), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <h5 class="text-muted">No Invoices Found</h5>
        <p class="text-muted">Generate invoices for completed deliveries</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal-overlay" id="bulkInvoiceModal" style="display: none;">
  <div class="simple-modal">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title" id="bulkInvoiceModalLabel">
        <i class="bi bi-receipt"></i> Generate Bulk Invoices
      </h5>
      <button type="button" class="btn-close btn-close-white" onclick="closeBulkInvoiceModal()" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="bulkInvoiceLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading invoice form...</p>
      </div>
      <div id="bulkInvoiceContent" style="display: none;">
        <form id="generateInvoiceForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="invoice_month" class="form-label">Month <span class="text-danger">*</span></label>
                <select class="form-select" id="invoice_month" name="month" required>
                  <option value="">Select Month</option>
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="invoice_year" class="form-label">Year <span class="text-danger">*</span></label>
                <select class="form-select" id="invoice_year" name="year" required>
                  <option value="">Select Year</option>
                  <% (2024..2030).each do |year| %>
                    <option value="<%= year %>" <%= 'selected' if year == Date.current.year %>><%= year %></option>
                  <% end %>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Customer Selection <span class="text-danger">*</span></label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="customer_selection" id="all_customers" value="all" checked>
              <label class="form-check-label" for="all_customers">
                All Customers
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="customer_selection" id="specific_customers" value="specific">
              <label class="form-check-label" for="specific_customers">
                Specific Customers
              </label>
            </div>
          </div>

          <div id="customer_dropdown_section" class="mb-4" style="display: none;">
            <label class="form-label">Select Customers</label>
            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllCustomers()">
                    <i class="bi bi-check-all me-1"></i>Select All
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCustomers()">
                    <i class="bi bi-x-circle me-1"></i>Deselect All
                  </button>
                </div>
                <div>
                  <input type="text" class="form-control form-control-sm" placeholder="Search customers..."
                         id="customerSearch" onkeyup="filterCustomers()" style="width: 200px;">
                </div>
              </div>
              <div id="customers_checkbox_list">
                <!-- Customer checkboxes will be loaded dynamically -->
                <div class="text-muted text-center py-3">
                  <i class="bi bi-person-lines-fill fs-3 d-block mb-2"></i>
                  Loading customers...
                </div>
              </div>
            </div>
            <div class="form-text mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Select customers using checkboxes. Use search to quickly find specific customers.
              <span id="selected_count" class="badge bg-primary ms-2">0 selected</span>
            </div>
            <!-- Hidden inputs for form submission -->
            <div id="selected_customer_inputs"></div>
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" onclick="closeBulkInvoiceModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="generateInvoiceBtn">
              <i class="bi bi-receipt me-1"></i>
              Generate Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal CSS -->
<style>
/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1050;
  overflow-y: auto;
  padding: 20px;
}

.simple-modal {
  background: white;
  border-radius: 15px;
  max-width: 90%;
  width: 900px;
  margin: 0 auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  position: relative;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

.simple-modal .modal-header {
  padding: 20px 30px;
  border-radius: 15px 15px 0 0;
  display: flex;
  justify-content: between;
  align-items: center;
}

.simple-modal .modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.simple-modal .btn-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
  margin-left: auto;
}

.simple-modal .btn-close:hover {
  opacity: 1;
}

.simple-modal .modal-body {
  padding: 30px;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

/* Close modal when clicking outside */
.modal-overlay:target {
  display: block;
}

/* Scrollbar styling for modal content */
.simple-modal .modal-body::-webkit-scrollbar {
  width: 8px;
}

.simple-modal .modal-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.simple-modal .modal-body::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<script>
// Update the button to use onclick instead of Bootstrap modal
document.addEventListener('DOMContentLoaded', function() {
  const generateBtn = document.querySelector('[data-bs-target="#bulkInvoiceModal"]');
  if (generateBtn) {
    generateBtn.removeAttribute('data-bs-toggle');
    generateBtn.removeAttribute('data-bs-target');
    generateBtn.setAttribute('onclick', 'openBulkInvoiceModal()');
  }
});

// Open bulk invoice modal
function openBulkInvoiceModal() {
  console.log('Opening bulk invoice modal');

  // Load form content
  loadBulkInvoiceForm();

  // Show modal
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }
}

// Close bulk invoice modal
function closeBulkInvoiceModal() {
  const modal = document.getElementById('bulkInvoiceModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore background scrolling
  }
}

// Load bulk invoice form
function loadBulkInvoiceForm() {
  // Show loading, hide content
  const modalLoading = document.getElementById('bulkInvoiceLoading');
  const modalContent = document.getElementById('bulkInvoiceContent');

  if (modalLoading) modalLoading.style.display = 'block';
  if (modalContent) modalContent.style.display = 'none';

  // Load customers and show form content directly
  loadCustomersAndShowForm();
}

function loadCustomersAndShowForm() {
  fetch('/admin/invoices/customers')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(customers => {
      // Populate customer checkboxes
      const customerCheckboxList = document.getElementById('customers_checkbox_list');
      if (customerCheckboxList) {
        customerCheckboxList.innerHTML = '';

        if (customers.length === 0) {
          customerCheckboxList.innerHTML = `
            <div class="text-muted text-center py-3">
              <i class="bi bi-person-x fs-3 d-block mb-2"></i>
              No customers found
            </div>
          `;
        } else {
          customers.forEach(customer => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check customer-checkbox-item';
            checkboxDiv.innerHTML = `
              <input class="form-check-input customer-checkbox" type="checkbox"
                     value="${customer.id}" id="customer_${customer.id}"
                     onchange="updateSelectedCustomers()">
              <label class="form-check-label" for="customer_${customer.id}">
                <strong>${customer.display_name}</strong>
                ${customer.email ? `<br><small class="text-muted">${customer.email}</small>` : ''}
                ${customer.mobile ? `<br><small class="text-muted">${customer.mobile}</small>` : ''}
              </label>
            `;
            customerCheckboxList.appendChild(checkboxDiv);
          });
        }
      }

      // Store customers data globally for search functionality
      window.allCustomers = customers;

      // Show form content and hide loading
      const modalLoading = document.getElementById('bulkInvoiceLoading');
      const modalContent = document.getElementById('bulkInvoiceContent');

      if (modalContent) modalContent.style.display = 'block';
      if (modalLoading) modalLoading.style.display = 'none';

      // Initialize form event listeners
      initializeFormListeners();
    })
    .catch(error => {
      console.error('Error loading customers:', error);
      const modalContent = document.getElementById('bulkInvoiceContent');
      const modalLoading = document.getElementById('bulkInvoiceLoading');

      if (modalContent) {
        modalContent.innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
        modalContent.style.display = 'block';
      }
      if (modalLoading) modalLoading.style.display = 'none';
    });
}

function initializeFormListeners() {
  // Handle customer selection radio buttons
  const customerRadios = document.querySelectorAll('input[name="customer_selection"]');
  const customerDropdownSection = document.getElementById('customer_dropdown_section');

  customerRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (customerDropdownSection) {
        customerDropdownSection.style.display = this.value === 'specific' ? 'block' : 'none';
      }
    });
  });

  // Handle form submission
  const form = document.getElementById('generateInvoiceForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      generateInvoices();
    });
  }
}

// Customer checkbox functions
function selectAllCustomers() {
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  const visibleCheckboxes = Array.from(checkboxes).filter(checkbox =>
    checkbox.closest('.customer-checkbox-item').style.display !== 'none'
  );

  visibleCheckboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectedCustomers();
}

function deselectAllCustomers() {
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectedCustomers();
}

function filterCustomers() {
  const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
  const customerItems = document.querySelectorAll('.customer-checkbox-item');

  customerItems.forEach(item => {
    const label = item.querySelector('label');
    const text = label.textContent.toLowerCase();

    if (text.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });

  // Update count after filtering
  updateSelectedCustomers();
}

function updateSelectedCustomers() {
  const selectedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
  const selectedCount = selectedCheckboxes.length;

  // Update the count badge
  const countBadge = document.getElementById('selected_count');
  if (countBadge) {
    countBadge.textContent = `${selectedCount} selected`;
    countBadge.className = selectedCount > 0 ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
  }

  // Update hidden inputs for form submission
  const selectedInputsContainer = document.getElementById('selected_customer_inputs');
  if (selectedInputsContainer) {
    selectedInputsContainer.innerHTML = '';

    selectedCheckboxes.forEach(checkbox => {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'customer_ids[]';
      hiddenInput.value = checkbox.value;
      selectedInputsContainer.appendChild(hiddenInput);
    });
  }
}

function generateInvoices() {
  const form = document.getElementById('generateInvoiceForm');
  const generateBtn = document.getElementById('generateInvoiceBtn');

  if (!form || !generateBtn) return;

  // Show loading state
  generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Generating...';
  generateBtn.disabled = true;

  // Collect form data
  const formData = new FormData(form);
  const data = {
    month: formData.get('month'),
    year: formData.get('year'),
    customer_selection: formData.get('customer_selection'),
    customer_ids: formData.getAll('customer_ids[]')
  };

  // Validate form
  if (!data.month || !data.year) {
    alert('Please select month and year');
    resetGenerateButton();
    return;
  }

  if (data.customer_selection === 'specific' && data.customer_ids.length === 0) {
    alert('Please select at least one customer');
    resetGenerateButton();
    return;
  }

  // Send request
  fetch('/admin/invoices/generate', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert(`Successfully generated ${result.invoices_created} invoices!`);
      closeBulkInvoiceModal();
      location.reload(); // Refresh the page to show new invoices
    } else {
      alert('Error generating invoices: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error generating invoices. Please try again.');
  })
  .finally(() => {
    resetGenerateButton();
  });
}

function resetGenerateButton() {
  const generateBtn = document.getElementById('generateInvoiceBtn');
  if (generateBtn) {
    generateBtn.innerHTML = '<i class="bi bi-receipt me-1"></i>Generate Invoice';
    generateBtn.disabled = false;
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('bulkInvoiceModal');
  if (e.target === modal) {
    closeBulkInvoiceModal();
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeBulkInvoiceModal();
  }
});
</script>

<style>
.customer-checkbox-item {
  padding: 8px 12px;
  margin-bottom: 6px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  background-color: white;
  transition: all 0.2s ease;
}

.customer-checkbox-item:hover {
  background-color: #f8f9fa;
  border-color: #007bff;
  box-shadow: 0 1px 3px rgba(0, 123, 255, 0.1);
}

.customer-checkbox-item .form-check-input:checked + .form-check-label {
  color: #007bff;
  font-weight: 500;
}

.customer-checkbox-item .form-check-input {
  margin-top: 0.2rem;
}

.customer-checkbox-item label {
  cursor: pointer;
  width: 100%;
  margin-bottom: 0;
}

.customer-checkbox-item label strong {
  display: block;
  font-size: 0.95rem;
}

.customer-checkbox-item label small {
  font-size: 0.8rem;
  line-height: 1.2;
}

#customerSearch {
  border: 1px solid #ced4da;
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#customerSearch:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.badge {
  font-size: 0.75rem;
  padding: 0.35em 0.65em;
}
</style>