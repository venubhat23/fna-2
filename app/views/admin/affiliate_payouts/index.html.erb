<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Affiliate Payouts</h2>
    <p class="text-muted mb-0">Manage affiliate commission payouts based on main agent commission payments (2% of net premium)</p>
  </div>
  <div>
    <button type="button" class="btn btn-primary me-2" onclick="openQuickPayoutModal()">
      <i class="bi bi-credit-card me-2"></i>Process Payout
    </button>
    <button type="button" class="btn btn-success" onclick="loadUnpaidAffiliatesModal()">
      <i class="bi bi-wallet2 me-2"></i>Bulk Payout Manager
    </button>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-info">
      <div class="card-body text-center">
        <h5 class="card-title text-info">Total Affiliates</h5>
        <h2 class="text-info"><%= @total_affiliates %></h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-success">
      <div class="card-body text-center">
        <h5 class="card-title text-success">Total Commission Earned</h5>
        <h2 class="text-success">₹<%= number_with_delimiter(@total_commission_earned.round(2)) %></h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-warning">
      <div class="card-body text-center">
        <h5 class="card-title text-warning">Pending Amount</h5>
        <h2 class="text-warning">₹<%= number_with_delimiter(@total_pending_amount.round(2)) %></h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-primary">
      <div class="card-body text-center">
        <h5 class="card-title text-primary">Paid Amount</h5>
        <h2 class="text-primary">₹<%= number_with_delimiter(@total_paid_amount.round(2)) %></h2>
      </div>
    </div>
  </div>
</div>

<!-- Affiliate Payouts Table -->
<div class="card">
  <div class="card-header">
    <h5 class="card-title mb-0">Affiliate Commission Summary</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-light">
          <tr>
            <th>Affiliate Name</th>
            <th>Lead IDs & Commission</th>
            <th>Total Amount (₹)</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @affiliate_payouts.any? %>
            <% @affiliate_payouts.each do |affiliate_data| %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-person text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-0"><%= affiliate_data[:affiliate].display_name %></h6>
                      <small class="text-muted"><%= affiliate_data[:affiliate].email %></small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <% affiliate_data[:leads].each do |lead_data| %>
                      <span class="badge <%= lead_data[:paid] ? 'bg-success' : 'bg-warning' %> text-dark">
                        <%= lead_data[:lead].lead_id %>: ₹<%= number_with_delimiter(lead_data[:commission].to_i) %>
                        <% if lead_data[:paid] %>
                          <i class="bi bi-check-circle ms-1"></i>
                        <% end %>
                      </span>
                    <% end %>
                  </div>
                  <small class="text-muted"><%= affiliate_data[:leads].count %> leads</small>
                </td>
                <td>
                  <span class="fw-bold text-dark">
                    ₹<%= number_with_delimiter(affiliate_data[:total_amount].to_i) %>
                  </span>
                  <br>
                  <small class="text-muted">
                    Paid: ₹<%= number_with_delimiter(affiliate_data[:paid_amount].to_i) %> |
                    Pending: ₹<%= number_with_delimiter(affiliate_data[:pending_amount].to_i) %>
                  </small>
                </td>
                <td>
                  <% if affiliate_data[:pending_amount] > 0 %>
                    <div class="d-flex align-items-center">
                      <span class="badge bg-warning me-2">
                        <i class="bi bi-clock me-1"></i>Pending Payment
                      </span>
                      <small class="text-muted">
                        ₹<%= number_with_delimiter(affiliate_data[:pending_amount].to_i) %> pending
                      </small>
                    </div>
                  <% else %>
                    <div class="d-flex align-items-center">
                      <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>All Paid
                      </span>
                      <small class="text-success ms-2">Complete</small>
                    </div>
                  <% end %>
                </td>
                <td>
                  <% unpaid_leads = affiliate_data[:leads].select { |l| !l[:paid] } %>
                  <% if unpaid_leads.any? %>
                    <div class="d-flex gap-2">
                      <button type="button"
                              class="btn btn-sm btn-success"
                              onclick="openMarkAllModal(<%= affiliate_data[:affiliate].id %>, '<%= affiliate_data[:affiliate].display_name.html_safe %>', <%= affiliate_data[:pending_amount].round(2) %>, <%= unpaid_leads.count %>, [<%= unpaid_leads.map { |l| "'#{l[:lead].lead_id}'" }.join(', ') %>])">
                        <i class="bi bi-check-circle me-1"></i>Mark All as Paid
                      </button>
                    </div>
                  <% else %>
                    <div class="d-flex align-items-center text-success">
                      <i class="bi bi-check-circle-fill me-2"></i>
                      <span class="fw-medium">All Paid</span>
                    </div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" class="text-center py-4">
                <div class="text-center py-5">
                  <div class="mb-3">
                    <i class="bi bi-people display-1 text-muted"></i>
                  </div>
                  <h5 class="mb-3">No Affiliate Payouts Found</h5>
                  <p class="text-muted mb-4">
                    Affiliate payouts will appear here once main agent commissions are marked as received for policies with affiliates.
                  </p>
                  <p class="text-muted">
                    <strong>How it works:</strong><br>
                    1. Main agent commission must be marked as "received" for policies<br>
                    2. Policies must have an associated lead ID and affiliate<br>
                    3. Affiliate commission is calculated as 2% of net premium<br>
                    4. Payouts are grouped by affiliate showing all their lead commissions
                  </p>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Help Information -->

<style>
.avatar-sm {
  width: 38px;
  height: 38px;
}

.badge {
  font-size: 0.75rem;
}

.gap-1 {
  gap: 0.25rem;
}

.lead-badge.selected {
  background-color: #0d6efd !important;
  color: white !important;
}

.affiliate-checkbox:checked + .avatar-sm {
  background-color: #198754 !important;
}

/* Enhanced Modal Styles - Same as Commission Tracking */
.modal-backdrop {
  display: none !important;
}

#bulkPayoutModal {
  z-index: 9999 !important;
  background: transparent !important;
}

#bulkPayoutModal .modal-dialog {
  max-width: 600px;
  margin: 6rem auto 2rem auto !important;
  z-index: 10000 !important;
  position: relative;
}

#bulkPayoutModal .modal-content {
  border: 2px solid #dee2e6;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 10001 !important;
  background: white !important;
  overflow: hidden;
}

#bulkPayoutModal .modal-header {
  border-bottom: 1px solid #e9ecef;
  background: linear-gradient(135deg, #198754, #20c997);
  color: white;
  padding: 1.5rem;
}

#bulkPayoutModal .modal-header h5 {
  font-weight: 600;
  margin: 0;
}

#bulkPayoutModal .modal-footer {
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
  padding: 1rem 1.5rem;
}

#bulkPayoutModal .modal-body {
  background: white !important;
  padding: 2rem 1.5rem;
  position: relative;
  z-index: 10002 !important;
}

#bulkPayoutModal .btn-close {
  filter: invert(1);
  opacity: 1;
}

#bulkPayoutModal .btn-close:hover {
  opacity: 0.8;
}

/* Ensure modal is properly displayed */
.modal.show {
  display: block !important;
  z-index: 9999 !important;
}

.modal-backdrop.show {
  display: none !important;
}

/* Simple responsive positioning */
@media (min-width: 576px) {
  #bulkPayoutModal .modal-dialog {
    margin: 6rem auto 2rem auto !important;
  }
}

@media (max-width: 575px) {
  #bulkPayoutModal .modal-dialog {
    margin: 3rem 1rem 2rem 1rem !important;
  }
}

/* Ensure modal appears above everything and is interactive */
body.modal-open {
  overflow: visible !important;
  padding-right: 0 !important;
}

/* Enhanced modal styling */
.modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  overflow-x: hidden !important;
  overflow-y: auto !important;
  background: transparent !important;
}

/* Quick Payout Modal & Mark All Paid Modal positioning */
#quickPayoutModal .modal-dialog,
#markAllPaidModal .modal-dialog {
  margin: 6rem auto 2rem auto !important;
}

@media (min-width: 576px) {
  #quickPayoutModal .modal-dialog,
  #markAllPaidModal .modal-dialog {
    margin: 6rem auto 2rem auto !important;
  }
}

@media (max-width: 575px) {
  #quickPayoutModal .modal-dialog,
  #markAllPaidModal .modal-dialog {
    margin: 3rem 1rem 2rem 1rem !important;
  }
}

/* Ensure form elements are interactive */
#bulkPayoutModal input,
#bulkPayoutModal textarea,
#bulkPayoutModal button {
  position: relative;
  z-index: 10010 !important;
  pointer-events: auto !important;
}

/* Enhanced button styling */
#bulkPayoutModal .btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

#bulkPayoutModal .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Selection summary styling */
#selectionSummary {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  border-left: 4px solid #198754;
}

#selectionSummary .text-muted {
  font-style: italic;
}

/* Action buttons container */
.d-grid.gap-2 {
  gap: 0.75rem !important;
}

/* Enhanced cards */
.card.border-0.shadow-sm {
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08) !important;
}

.card-header.bg-transparent {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
  border-bottom: 1px solid #dee2e6;
}
</style>

<!-- Bulk Actions Modal -->
<div class="modal" id="bulkPayoutModal" tabindex="-1" aria-labelledby="bulkPayoutModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkPayoutModalLabel">
          <i class="bi bi-wallet2 me-2"></i>Affiliate Payout Management
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Payment Details Form -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-receipt text-primary me-2"></i>Payment Details
                </h6>
                <div class="mb-3">
                  <label class="form-label">Transaction ID <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="bulkTransactionId" placeholder="Enter transaction ID" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Payment Date</label>
                  <input type="date" class="form-control" id="bulkPaymentDate" value="<%= Date.current.strftime('%Y-%m-%d') %>">
                </div>
                <div class="mb-0">
                  <label class="form-label">Notes</label>
                  <textarea class="form-control" id="bulkNotes" rows="3" placeholder="Payment notes (optional)"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-success bg-opacity-10">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-calculator text-success me-2"></i>Selection Summary
                </h6>
                <div id="modalSelectionSummary">
                  <p class="text-muted mb-0">Select items below to see summary</p>
                </div>
                <div class="mt-3">
                  <button type="button" class="btn btn-success w-100" id="bulkProcessPayment" disabled>
                    <i class="bi bi-credit-card me-2"></i>Process Payment
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Affiliates and Leads List -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                <i class="bi bi-people text-primary me-2"></i>Unpaid Affiliates & Leads
              </h6>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" onclick="selectAllModalItems()">
                  <i class="bi bi-check-square me-1"></i>Select All
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearAllModalSelections()">
                  <i class="bi bi-square me-1"></i>Clear All
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div id="affiliateLeadsList">
              <!-- Content will be loaded dynamically -->
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading unpaid affiliates and leads...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress indicator -->
        <div class="mt-3" id="processingIndicator" style="display: none;">
          <div class="alert alert-info">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                <span class="visually-hidden">Processing...</span>
              </div>
              <span class="text-success">Processing payments... Please wait.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x me-1"></i>Close
        </button>
        <small class="text-muted me-auto">
          <i class="bi bi-info-circle me-1"></i>
          Select affiliates/leads and enter transaction details to process payments
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Quick Payout Modal -->
<div class="modal fade" id="quickPayoutModal" tabindex="-1" aria-labelledby="quickPayoutModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickPayoutModalLabel">
          <i class="bi bi-credit-card me-2"></i>Quick Payout
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          This will process all pending affiliate payouts with a single transaction.
        </div>

        <%= form_with url: mark_as_paid_admin_affiliate_payouts_path, method: :post, local: true, id: "quickPayoutForm" do |form| %>
          <div class="mb-3">
            <label for="quick_transaction_id" class="form-label">Transaction ID <span class="text-danger">*</span></label>
            <%= form.text_field :transaction_id, id: "quick_transaction_id", class: "form-control", placeholder: "Enter transaction ID for batch payout", required: true %>
          </div>

          <div class="mb-3">
            <label for="quick_payment_date" class="form-label">Payment Date</label>
            <%= form.date_field :payment_date, id: "quick_payment_date", class: "form-control", value: Date.current %>
          </div>

          <div class="mb-3">
            <label for="quick_notes" class="form-label">Notes</label>
            <%= form.text_area :notes, id: "quick_notes", rows: 3, class: "form-control", placeholder: "Batch payout for all pending affiliates" %>
          </div>

          <%= form.hidden_field :payout_type, value: "quick_all_pending" %>

          <div class="d-grid">
            <%= form.submit "Process All Pending Payouts", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Mark All as Paid Modal -->
<div class="modal fade" id="markAllPaidModal" tabindex="-1" aria-labelledby="markAllPaidModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="markAllPaidModalLabel">Mark All as Paid</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: mark_as_paid_admin_affiliate_payouts_path, method: :post, local: true, id: "markAllPaidForm" do |form| %>
        <div class="modal-body">
          <div class="mb-3">
            <p class="fw-bold">Affiliate: <span id="modalAffiliateName"></span></p>
            <p class="text-muted">Amount: ₹<span id="modalAmount"></span> for <span id="modalLeadCount"></span> lead(s)</p>
          </div>

          <div class="mb-3">
            <label for="transaction_id" class="form-label">Transaction ID <span class="text-danger">*</span></label>
            <%= form.text_field :transaction_id, class: "form-control", placeholder: "Enter transaction ID", required: true %>
          </div>

          <div class="mb-3">
            <label for="notes" class="form-label">Notes</label>
            <%= form.text_area :notes, rows: 3, class: "form-control", placeholder: "Optional notes about this payment..." %>
          </div>

          <%= form.hidden_field :affiliate_id, id: "modalAffiliateId" %>
          <%= form.hidden_field :payout_type, value: "affiliate_all" %>
          <div id="modalLeadIds"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= form.submit "Mark as Paid", class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Removed old checkbox functionality - no longer needed
  // Table now shows clear paid/pending status without checkboxes
  console.log('Affiliate payouts page loaded');

  // Mark All as Paid Modal Function
  window.openMarkAllModal = function(affiliateId, affiliateName, amount, leadCount, leadIds) {
    // Set modal content
    document.getElementById('modalAffiliateName').textContent = affiliateName;
    document.getElementById('modalAmount').textContent = amount.toLocaleString();
    document.getElementById('modalLeadCount').textContent = leadCount;

    // Set form values
    document.getElementById('modalAffiliateId').value = affiliateId;

    // Clear and add lead IDs
    const leadIdsContainer = document.getElementById('modalLeadIds');
    leadIdsContainer.innerHTML = '';

    leadIds.forEach(leadId => {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'lead_ids[]';
      hiddenInput.value = leadId;
      leadIdsContainer.appendChild(hiddenInput);
    });

    // Clear previous form values
    document.getElementById('transaction_id').value = '';
    document.getElementById('notes').value = '';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('markAllPaidModal'));
    modal.show();
  };

  // Old bulk action handlers (keeping for backward compatibility but fixing syntax errors)
  const markAllSelectedBtn = document.getElementById('markAllSelectedPaid');
  const markSelectedAffiliatesBtn = document.getElementById('markSelectedAffiliatesPaid');
  const markSelectedLeadsBtn = document.getElementById('markSelectedLeadsPaid');

  if (markAllSelectedBtn) {
    markAllSelectedBtn.addEventListener('click', function() {
      const selectedAffiliates = document.querySelectorAll('.affiliate-checkbox:checked');
      const selectedLeads = document.querySelectorAll('.lead-checkbox:checked');

      if (selectedAffiliates.length === 0 && selectedLeads.length === 0) {
        alert('Please select at least one affiliate or lead.');
        return;
      }

      if (confirm('Are you sure you want to mark all selected items as paid?')) {
        submitBulkPayoutForm('bulk_selection', selectedAffiliates, selectedLeads);
      }
    });
  }

  if (markSelectedAffiliatesBtn) {
    markSelectedAffiliatesBtn.addEventListener('click', function() {
      const selectedAffiliates = document.querySelectorAll('.affiliate-checkbox:checked');

      if (selectedAffiliates.length === 0) {
        alert('Please select at least one affiliate.');
        return;
      }

      if (confirm(`Are you sure you want to mark ${selectedAffiliates.length} affiliate(s) as paid?`)) {
        // Process only the first affiliate to avoid multiple redirects
        const affiliate = selectedAffiliates[0];
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<%= mark_as_paid_admin_affiliate_payouts_path %>';

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'authenticity_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        const affiliateIdInput = document.createElement('input');
        affiliateIdInput.type = 'hidden';
        affiliateIdInput.name = 'affiliate_id';
        affiliateIdInput.value = affiliate.dataset.affiliateId;
        form.appendChild(affiliateIdInput);

        const payoutTypeInput = document.createElement('input');
        payoutTypeInput.type = 'hidden';
        payoutTypeInput.name = 'payout_type';
        payoutTypeInput.value = 'affiliate_all';
        form.appendChild(payoutTypeInput);

        document.body.appendChild(form);
        form.submit();
      }
    });
  }

  if (markSelectedLeadsBtn) {
    markSelectedLeadsBtn.addEventListener('click', function() {
      const selectedLeads = document.querySelectorAll('.lead-checkbox:checked');

      if (selectedLeads.length === 0) {
        alert('Please select at least one lead.');
        return;
      }

      if (confirm(`Are you sure you want to mark ${selectedLeads.length} lead(s) as paid?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<%= mark_as_paid_admin_affiliate_payouts_path %>';

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'authenticity_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        const payoutTypeInput = document.createElement('input');
        payoutTypeInput.type = 'hidden';
        payoutTypeInput.name = 'payout_type';
        payoutTypeInput.value = 'lead_multiple';
        form.appendChild(payoutTypeInput);

        selectedLeads.forEach(lead => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'lead_ids[]';
          input.value = lead.dataset.leadId;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
      }
    });
  }

  // Modal management functions (moved to global scope above for accessibility)

  window.refreshSelectionSummary = function() {
    updateSelectionSummary();
    showNotification('Selection summary refreshed!', 'info');
  };

  window.selectAllAffiliates = function() {
    document.querySelectorAll('.affiliate-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
    updateSelectionSummary();
    showNotification('All affiliates selected!', 'success');
  };

  window.selectAllPendingLeads = function() {
    document.querySelectorAll('.lead-badge[data-paid="false"]').forEach(badge => {
      const checkbox = badge.querySelector('.lead-checkbox');
      if (checkbox) {
        checkbox.checked = true;
        badge.classList.add('selected');
      }
    });
    updateSelectionSummary();
    showNotification('All pending leads selected!', 'success');
  };

  window.clearAllSelections = function() {
    document.querySelectorAll('.affiliate-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.querySelectorAll('.lead-badge.selected').forEach(badge => {
      badge.classList.remove('selected');
    });
    document.getElementById('selectAll').checked = false;
    updateSelectionSummary();
    showNotification('All selections cleared!', 'info');
  };

  function calculateTotalSelectedAmount() {
    const selectedAffiliates = document.querySelectorAll('.affiliate-checkbox:checked');
    const selectedLeads = document.querySelectorAll('.lead-checkbox:checked');
    let totalAmount = 0;

    selectedAffiliates.forEach(affiliate => {
      totalAmount += parseFloat(affiliate.dataset.pendingAmount || 0);
    });

    selectedLeads.forEach(lead => {
      totalAmount += parseFloat(lead.dataset.commission || 0);
    });

    return totalAmount;
  }

  function showProcessingIndicator() {
    document.getElementById('processingIndicator').style.display = 'block';
  }

  function hideProcessingIndicator() {
    document.getElementById('processingIndicator').style.display = 'none';
  }

  function showNotification(message, type = 'info') {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 3000);
  }

  function submitBulkPayoutForm(payoutType, selectedAffiliates, selectedLeads) {
    // Create and submit a bulk form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '<%= mark_as_paid_admin_affiliate_payouts_path %>';

    // Add CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    // Add payout type
    const payoutTypeInput = document.createElement('input');
    payoutTypeInput.type = 'hidden';
    payoutTypeInput.name = 'payout_type';
    payoutTypeInput.value = payoutType;
    form.appendChild(payoutTypeInput);

    // Add selected affiliates
    selectedAffiliates.forEach(affiliate => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'affiliate_ids[]';
      input.value = affiliate.dataset.affiliateId;
      form.appendChild(input);
    });

    // Add selected leads
    selectedLeads.forEach(lead => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'lead_ids[]';
      input.value = lead.dataset.leadId;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
  }

  // Clean up any existing modal backdrops on page load
  document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());

  // Quick Payout Modal Function
  window.openQuickPayoutModal = function() {
    const modal = new bootstrap.Modal(document.getElementById('quickPayoutModal'));
    modal.show();
  };

  // Define global functions outside of document ready to ensure they're accessible
  window.loadUnpaidAffiliatesModal = function() {
    console.log('Loading unpaid affiliates modal...');

    const modalElement = document.getElementById('bulkPayoutModal');
    if (!modalElement) {
      console.error('Modal element not found');
      return;
    }

    const modal = new bootstrap.Modal(modalElement, {
      backdrop: false,
      keyboard: true,
      focus: true
    });

    modal.show();

    // Load unpaid affiliates data
    fetch('<%= unpaid_data_admin_affiliate_payouts_path %>')
      .then(response => response.json())
      .then(data => {
        console.log('Received data:', data);
        if (data.success) {
          renderAffiliateLeadsList(data.data);
        } else {
          document.getElementById('affiliateLeadsList').innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-exclamation-circle text-warning fs-1"></i>
              <p class="mt-2 text-muted">Error loading data: ${data.message}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error loading unpaid affiliates:', error);
        document.getElementById('affiliateLeadsList').innerHTML = `
          <div class="text-center py-4">
            <i class="bi bi-exclamation-circle text-danger fs-1"></i>
            <p class="mt-2 text-muted">Failed to load data. Please try again.</p>
          </div>
        `;
      });
  };

  // Global helper functions for modal
  window.renderAffiliateLeadsList = function(affiliatesData) {
    if (affiliatesData.length === 0) {
      document.getElementById('affiliateLeadsList').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-check-circle-fill text-success fs-1"></i>
          <h5 class="mt-3 text-success">All Affiliate Payments Complete!</h5>
          <p class="text-muted">No pending affiliate payouts found.</p>
        </div>
      `;
      return;
    }

    let html = '<div class="list-group list-group-flush">';

    affiliatesData.forEach(affiliateData => {
      html += `
        <div class="list-group-item">
          <div class="d-flex align-items-center mb-3">
            <input type="checkbox" class="form-check-input me-3 affiliate-modal-checkbox"
                   id="affiliate_${affiliateData.affiliate.id}"
                   data-affiliate-id="${affiliateData.affiliate.id}"
                   onchange="toggleAffiliateLeads(this)">
            <div class="flex-grow-1">
              <h6 class="mb-1">${affiliateData.affiliate.name}</h6>
              <small class="text-muted">${affiliateData.affiliate.email}</small>
            </div>
            <div class="text-end">
              <span class="badge bg-warning text-dark">₹${affiliateData.total_pending.toLocaleString()}</span>
            </div>
          </div>

          <div class="ms-4">
            <div class="row">
      `;

      affiliateData.leads.forEach((lead, index) => {
        html += `
          <div class="col-md-6 mb-2">
            <div class="form-check">
              <input class="form-check-input lead-modal-checkbox"
                     type="checkbox"
                     id="lead_${lead.id}"
                     data-lead-id="${lead.id}"
                     data-policy-id="${lead.policy_id}"
                     data-commission="${lead.commission}"
                     data-affiliate-id="${affiliateData.affiliate.id}"
                     onchange="updateModalSummary()">
              <label class="form-check-label" for="lead_${lead.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Lead: ${lead.id}</strong><br>
                    <small class="text-muted">${lead.customer_name}</small><br>
                    <small class="text-muted">Policy: ${lead.policy_number}</small>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-success">₹${lead.commission.toLocaleString()}</span>
                  </div>
                </div>
              </label>
            </div>
          </div>
        `;
      });

      html += `
            </div>
          </div>
        </div>
      `;
    });

    html += '</div>';
    document.getElementById('affiliateLeadsList').innerHTML = html;
    updateModalSummary();
  };

  window.toggleAffiliateLeads = function(affiliateCheckbox) {
    const affiliateId = affiliateCheckbox.dataset.affiliateId;
    const isChecked = affiliateCheckbox.checked;

    // Toggle all leads for this affiliate
    document.querySelectorAll(`input[data-affiliate-id="${affiliateId}"].lead-modal-checkbox`).forEach(leadCheckbox => {
      leadCheckbox.checked = isChecked;
    });

    updateModalSummary();
  };

  window.selectAllModalItems = function() {
    document.querySelectorAll('.affiliate-modal-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
    document.querySelectorAll('.lead-modal-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
    updateModalSummary();
  };

  window.clearAllModalSelections = function() {
    document.querySelectorAll('.affiliate-modal-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.querySelectorAll('.lead-modal-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    updateModalSummary();
  };

  window.updateModalSummary = function() {
    const selectedLeads = document.querySelectorAll('.lead-modal-checkbox:checked');
    const selectedAffiliates = document.querySelectorAll('.affiliate-modal-checkbox:checked');

    let totalAmount = 0;
    let leadCount = 0;
    let affiliateCount = selectedAffiliates.length;

    selectedLeads.forEach(lead => {
      totalAmount += parseFloat(lead.dataset.commission || 0);
      leadCount++;
    });

    const summary = document.getElementById('modalSelectionSummary');
    const processButton = document.getElementById('bulkProcessPayment');

    if (leadCount === 0) {
      summary.innerHTML = '<p class="text-muted mb-0">Select items below to see summary</p>';
      if (processButton) processButton.disabled = true;
    } else {
      summary.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span><i class="bi bi-people me-1"></i>Affiliates:</span>
          <span class="badge bg-primary">${affiliateCount}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span><i class="bi bi-tags me-1"></i>Leads:</span>
          <span class="badge bg-info">${leadCount}</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center">
          <strong>Total Amount:</strong>
          <span class="badge bg-success fs-6">₹${totalAmount.toLocaleString()}</span>
        </div>
      `;
      if (processButton) processButton.disabled = false;
    }
  };

  // Payment Processing
  document.getElementById('bulkProcessPayment').addEventListener('click', function() {
    const transactionId = document.getElementById('bulkTransactionId').value;
    const paymentDate = document.getElementById('bulkPaymentDate').value;
    const notes = document.getElementById('bulkNotes').value;

    if (!transactionId.trim()) {
      showNotification('Please enter a transaction ID', 'warning');
      document.getElementById('bulkTransactionId').focus();
      return;
    }

    const selectedLeads = document.querySelectorAll('.lead-modal-checkbox:checked');
    if (selectedLeads.length === 0) {
      showNotification('Please select at least one lead to process payment', 'warning');
      return;
    }

    // Show confirmation
    const totalAmount = Array.from(selectedLeads).reduce((sum, lead) => {
      return sum + parseFloat(lead.dataset.commission || 0);
    }, 0);

    const confirmMessage = `Process payment for ${selectedLeads.length} leads?\n\nTotal Amount: ₹${totalAmount.toLocaleString()}\nTransaction ID: ${transactionId}`;

    if (confirm(confirmMessage)) {
      processBulkPayment(selectedLeads, transactionId, paymentDate, notes);
    }
  });

  function processBulkPayment(selectedLeads, transactionId, paymentDate, notes) {
    // Show processing indicator
    document.getElementById('processingIndicator').style.display = 'block';
    document.getElementById('bulkProcessPayment').disabled = true;
    document.getElementById('bulkProcessPayment').innerHTML = '<i class="bi bi-hourglass me-2"></i>Processing...';

    // Prepare form data
    const formData = new FormData();
    formData.append('authenticity_token', document.querySelector('meta[name="csrf-token"]').getAttribute('content'));
    formData.append('payout_type', 'bulk_modal_selection');
    formData.append('transaction_id', transactionId);
    formData.append('payment_date', paymentDate);
    formData.append('notes', notes);

    // Add selected leads
    selectedLeads.forEach(lead => {
      formData.append('lead_ids[]', lead.dataset.leadId);
    });

    // Submit payment
    fetch('<%= mark_as_paid_admin_affiliate_payouts_path %>', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => {
      if (response.redirected) {
        // Follow the redirect
        window.location.href = response.url;
      } else {
        return response.json();
      }
    })
    .then(data => {
      if (data && !data.success) {
        showNotification('Payment failed: ' + (data.message || 'Unknown error'), 'danger');
      } else {
        // Success - page should have redirected, but if not, show success and reload
        showNotification('Payment processed successfully!', 'success');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }
    })
    .catch(error => {
      console.error('Payment processing error:', error);
      showNotification('Payment failed. Please try again.', 'danger');
    })
    .finally(() => {
      // Reset button state
      document.getElementById('processingIndicator').style.display = 'none';
      document.getElementById('bulkProcessPayment').disabled = false;
      document.getElementById('bulkProcessPayment').innerHTML = '<i class="bi bi-credit-card me-2"></i>Process Payment';
    });
  }

  // Enhanced modal initialization
  const bulkModal = document.getElementById('bulkPayoutModal');
  if (bulkModal) {
    bulkModal.addEventListener('hidden.bs.modal', function() {
      // Reset form
      document.getElementById('bulkTransactionId').value = '';
      document.getElementById('bulkNotes').value = '';
      document.getElementById('modalSelectionSummary').innerHTML = '<p class="text-muted mb-0">Select items below to see summary</p>';
      document.getElementById('bulkProcessPayment').disabled = true;
      document.getElementById('processingIndicator').style.display = 'none';

      // Clean up any leftover backdrops and reset body
      setTimeout(() => {
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
      }, 100);
    });
  }
});
</script>