<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Create New Banner</h2>
    <p class="text-muted mb-0">Add a new promotional or informational banner to the platform</p>
  </div>
  <div>
    <%= link_to admin_banners_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Banners
    <% end %>
  </div>
</div>

<!-- Banner Form -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">Banner Information</h5>
  </div>
  <div class="card-body">
    <%= form_with model: [:admin, @banner], local: true, class: "row g-3" do |form| %>
      <!-- Display errors -->
      <% if @banner.errors.any? %>
        <div class="col-12">
          <div class="alert alert-danger">
            <h6 class="alert-heading">Please correct the following errors:</h6>
            <ul class="mb-0">
              <% @banner.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>

      <!-- Banner Title -->
      <div class="col-md-8">
        <%= form.label :title, class: "form-label" %>
        <%= form.text_field :title, class: "form-control", placeholder: "Enter banner title..." %>
        <div class="form-text">A descriptive title for the banner (max 255 characters)</div>
      </div>

      <!-- Display Order -->
      <div class="col-md-4">
        <%= form.label :display_order, class: "form-label" %>
        <%= form.number_field :display_order, class: "form-control", min: 0 %>
        <div class="form-text">Lower numbers display first</div>
      </div>

      <!-- Banner Description -->
      <div class="col-12">
        <%= form.label :description, class: "form-label" %>
        <%= form.text_area :description, rows: 3, class: "form-control", placeholder: "Enter banner description, tagline, or message..." %>
        <div class="form-text">Short description or message to display (max 500 characters)</div>
      </div>

      <!-- Banner Image -->
      <div class="col-md-6">
        <%= form.label :banner_image, "Banner Image (Local Upload)", class: "form-label" %>
        <%= form.file_field :banner_image, class: "form-control", accept: "image/*" %>
        <div class="form-text">
          Upload image (JPG, PNG, or WEBP). Images should be optimized for web to reduce load time.
        </div>
      </div>

      <!-- Cloudinary Image Upload -->
      <div class="col-md-6">
        <%= form.label :image_url, "Banner Image (Cloudinary)", class: "form-label" %>
        <%= form.hidden_field :image_url %>

        <div class="cloudinary-upload-section">
          <div class="upload-area border-dashed p-4 text-center rounded mb-3"
               style="border: 2px dashed #ddd; background: #f9f9f9; cursor: pointer;">
            <div class="upload-placeholder">
              <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
              <p class="mb-2">Click to select image or drag & drop</p>
              <p class="text-muted small mb-0">Supports JPG, PNG, WEBP (Max 10MB)</p>
            </div>
          </div>

          <input type="file" id="cloudinary-file-input" accept="image/*" style="display: none;">

          <div class="upload-guidelines">
            <div class="alert alert-info py-2">
              <small>
                <strong>Cloudinary Guidelines:</strong><br>
                • Recommended size: 1200×600 pixels<br>
                • Maximum file size: 10MB<br>
                • Automatically optimized for web delivery<br>
                • Global CDN for fast loading
              </small>
            </div>
          </div>

          <div class="image-preview" style="display: none;">
            <div class="position-relative">
              <img id="preview-image" src="" alt="Preview" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" id="remove-image">
                <i class="bi bi-x"></i>
              </button>
            </div>
            <div class="mt-2">
              <small class="text-success">
                <i class="bi bi-check-circle"></i>
                Image uploaded successfully to Cloudinary
              </small>
            </div>
          </div>

          <div class="upload-progress" style="display: none;">
            <div class="progress mb-2">
              <div class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted">Uploading to Cloudinary...</small>
          </div>

          <div class="upload-error" style="display: none;">
            <div class="alert alert-danger py-2">
              <small><span class="error-message"></span></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Redirect Link -->
      <div class="col-md-6">
        <%= form.label :redirect_link, class: "form-label" %>
        <%= form.url_field :redirect_link, class: "form-control", placeholder: "https://example.com/landing-page" %>
        <div class="form-text">Optional URL for more details or promotional landing page</div>
      </div>

      <!-- Display Start Date -->
      <div class="col-md-4">
        <%= form.label :display_start_date, class: "form-label" %>
        <%= form.date_field :display_start_date, class: "form-control" %>
        <div class="form-text">Date from which the banner should appear</div>
      </div>

      <!-- Display End Date -->
      <div class="col-md-4">
        <%= form.label :display_end_date, class: "form-label" %>
        <%= form.date_field :display_end_date, class: "form-control" %>
        <div class="form-text">Date after which the banner should stop displaying</div>
      </div>

      <!-- Display Location -->
      <div class="col-md-4">
        <%= form.label :display_location, class: "form-label" %>
        <%= form.select :display_location,
            options_for_select([
              ['Dashboard', 'dashboard'],
              ['Login Page', 'login'],
              ['Home Page', 'home'],
              ['Sidebar Ad', 'sidebar']
            ], @banner.display_location),
            { prompt: 'Select display location...' },
            { class: "form-select" } %>
        <div class="form-text">Where the banner should appear</div>
      </div>

      <!-- Status -->
      <div class="col-md-6">
        <div class="form-check form-switch">
          <%= form.check_box :status, class: "form-check-input" %>
          <%= form.label :status, "Active", class: "form-check-label" %>
        </div>
        <div class="form-text">Activate the banner immediately upon creation</div>
      </div>

      <!-- Form Actions -->
      <div class="col-12">
        <hr class="my-4">
        <div class="d-flex justify-content-end gap-2">
          <%= link_to "Cancel", admin_banners_path, class: "btn btn-outline-secondary" %>
          <%= form.submit "Create Banner", class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Best Practices Note -->
<div class="card border-0 shadow-sm mt-4">
  <div class="card-header bg-light border-0">
    <h6 class="mb-0 text-primary">
      <i class="bi bi-lightbulb me-2"></i>
      Best Practices & Notes
    </h6>
  </div>
  <div class="card-body">
    <ul class="mb-0">
      <li><strong>Image Optimization:</strong> Compress images to reduce file size and improve page load times</li>
      <li><strong>Responsive Design:</strong> Ensure banner images work well on both desktop and mobile devices</li>
      <li><strong>Clear Messaging:</strong> Keep banner text concise and action-oriented</li>
      <li><strong>Display Period:</strong> Set appropriate start and end dates to manage banner lifecycle</li>
      <li><strong>Display Order:</strong> Use lower numbers for higher priority banners that should appear first</li>
      <li><strong>Testing:</strong> Preview banners before activating to ensure proper display</li>
    </ul>
  </div>
</div>

<!-- Cloudinary Upload JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.querySelector('.upload-area');
  const fileInput = document.getElementById('cloudinary-file-input');
  const imagePreview = document.querySelector('.image-preview');
  const uploadProgress = document.querySelector('.upload-progress');
  const uploadError = document.querySelector('.upload-error');
  const uploadPlaceholder = document.querySelector('.upload-placeholder');
  const uploadGuidelines = document.querySelector('.upload-guidelines');
  const previewImage = document.getElementById('preview-image');
  const removeButton = document.getElementById('remove-image');
  const imageUrlField = document.getElementById('<%= dom_id(@banner, :image_url) %>');

  // Click to upload
  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });

  // File selection
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      handleFileUpload(file);
    }
  });

  // Drag and drop
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#0d6efd';
    uploadArea.style.backgroundColor = '#f0f8ff';
  });

  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ddd';
    uploadArea.style.backgroundColor = '#f9f9f9';
  });

  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ddd';
    uploadArea.style.backgroundColor = '#f9f9f9';

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFileUpload(files[0]);
    }
  });

  // Remove image
  removeButton.addEventListener('click', function() {
    resetUploadArea();
    imageUrlField.value = '';
  });

  function handleFileUpload(file) {
    // Validate file
    if (!file.type.startsWith('image/')) {
      showError('Please select a valid image file (JPG, PNG, WEBP)');
      return;
    }

    if (file.size > 10 * 1024 * 1024) { // 10MB
      showError('File size must be less than 10MB');
      return;
    }

    // Show progress
    showProgress();

    // Create FormData
    const formData = new FormData();
    formData.append('image', file);

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Upload to Cloudinary
    fetch('<%= upload_cloudinary_image_admin_banners_path %>', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': csrfToken,
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      hideProgress();

      if (data.success) {
        showPreview(data.url, data.public_id);
        imageUrlField.value = data.public_id;
      } else {
        showError(data.error || 'Upload failed');
      }
    })
    .catch(error => {
      hideProgress();
      showError('Network error. Please try again.');
      console.error('Upload error:', error);
    });
  }

  function showProgress() {
    hideError();
    uploadPlaceholder.style.display = 'none';
    uploadGuidelines.style.display = 'none';
    uploadProgress.style.display = 'block';

    // Animate progress bar
    const progressBar = uploadProgress.querySelector('.progress-bar');
    progressBar.style.width = '100%';
  }

  function hideProgress() {
    uploadProgress.style.display = 'none';
    const progressBar = uploadProgress.querySelector('.progress-bar');
    progressBar.style.width = '0%';
  }

  function showPreview(imageUrl, publicId) {
    uploadPlaceholder.style.display = 'none';
    uploadGuidelines.style.display = 'none';
    imagePreview.style.display = 'block';
    previewImage.src = imageUrl;
  }

  function showError(message) {
    hideProgress();
    const errorMessage = uploadError.querySelector('.error-message');
    errorMessage.textContent = message;
    uploadError.style.display = 'block';
  }

  function hideError() {
    uploadError.style.display = 'none';
  }

  function resetUploadArea() {
    imagePreview.style.display = 'none';
    uploadProgress.style.display = 'none';
    uploadError.style.display = 'none';
    uploadPlaceholder.style.display = 'block';
    uploadGuidelines.style.display = 'block';
    previewImage.src = '';
    fileInput.value = '';
  }
});
</script>