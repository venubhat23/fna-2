<% content_for :title, "Subscription Details" %>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-eye text-primary"></i>
      Subscription #<%= @subscription.id %>
    </h1>
    <div class="btn-group">
      <%= link_to admin_subscriptions_path, class: "btn btn-secondary" do %>
        <i class="bi bi-arrow-left"></i> Back
      <% end %>
      <%= link_to edit_admin_subscription_path(@subscription), class: "btn btn-warning" do %>
        <i class="bi bi-pencil"></i> Edit
      <% end %>
      <% if @subscription.status == 'active' %>
        <%= link_to pause_subscription_admin_subscription_path(@subscription),
            method: :patch,
            class: "btn btn-outline-warning",
            confirm: "Pause this subscription?" do %>
          <i class="bi bi-pause"></i> Pause
        <% end %>
      <% elsif @subscription.status == 'paused' %>
        <%= link_to resume_subscription_admin_subscription_path(@subscription),
            method: :patch,
            class: "btn btn-outline-success",
            confirm: "Resume this subscription?" do %>
          <i class="bi bi-play"></i> Resume
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- Subscription Overview -->
    <div class="col-xl-8 col-lg-7">
      <!-- Basic Details Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-info-circle"></i> Subscription Details
          </h6>
          <span class="badge bg-<%= @subscription.status == 'active' ? 'success' : 'warning' %> fs-6">
            <%= @subscription.status.humanize %>
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-primary mb-3"><i class="bi bi-person"></i> Customer Information</h6>
              <table class="table table-borderless">
                <tr>
                  <td><strong>Name:</strong></td>
                  <td><%= "#{@subscription.customer.first_name} #{@subscription.customer.last_name}".strip %></td>
                </tr>
                <tr>
                  <td><strong>Mobile:</strong></td>
                  <td><%= @subscription.customer.mobile %></td>
                </tr>
                <tr>
                  <td><strong>Address:</strong></td>
                  <td><%= @subscription.customer.address.present? ? @subscription.customer.address : 'Not provided' %></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="text-success mb-3"><i class="bi bi-box"></i> Product Information</h6>
              <table class="table table-borderless">
                <tr>
                  <td><strong>Product:</strong></td>
                  <td><%= @subscription.product.name %></td>
                </tr>
                <tr>
                  <td><strong>Quantity:</strong></td>
                  <td><%= @subscription.quantity %> <%= @subscription.unit %></td>
                </tr>
                <tr>
                  <td><strong>Price:</strong></td>
                  <td>₹<%= @subscription.product.price %> per <%= @subscription.unit %></td>
                </tr>
              </table>
            </div>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <h6 class="text-warning mb-3"><i class="bi bi-calendar"></i> Schedule Information</h6>
              <table class="table table-borderless">
                <tr>
                  <td><strong>Pattern:</strong></td>
                  <td>
                    <span class="badge bg-info fs-6"><%= @subscription.delivery_pattern.humanize %></span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Start Date:</strong></td>
                  <td><%= @subscription.start_date.strftime('%d %B %Y') %></td>
                </tr>
                <tr>
                  <td><strong>End Date:</strong></td>
                  <td><%= @subscription.end_date.strftime('%d %B %Y') %></td>
                </tr>
                <tr>
                  <td><strong>Duration:</strong></td>
                  <td><%= @subscription.total_days %> days</td>
                </tr>
                <tr>
                  <td><strong>Delivery Time:</strong></td>
                  <td><%= @subscription.delivery_time.humanize %></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="text-info mb-3"><i class="bi bi-graph-up"></i> Progress Summary</h6>
              <table class="table table-borderless">
                <tr>
                  <td><strong>Total Deliveries:</strong></td>
                  <td><%= @summary[:total_deliveries] %></td>
                </tr>
                <tr>
                  <td><strong>Completed:</strong></td>
                  <td><span class="badge bg-success"><%= @summary[:completed] %></span></td>
                </tr>
                <tr>
                  <td><strong>Pending:</strong></td>
                  <td><span class="badge bg-warning"><%= @summary[:pending] %></span></td>
                </tr>
                <tr>
                  <td><strong>Completion Rate:</strong></td>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-success" style="width: <%= @summary[:completion_rate] %>%">
                        <%= @summary[:completion_rate].round(1) %>%
                      </div>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Tasks -->
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-truck"></i> Delivery Tasks (<%= @delivery_tasks.count %>)
          </h6>
          <%= link_to generate_tasks_admin_subscription_path(@subscription),
              method: :post,
              class: "btn btn-sm btn-outline-primary",
              confirm: "This will regenerate all delivery tasks. Are you sure?" do %>
            <i class="bi bi-arrow-clockwise"></i> Regenerate Tasks
          <% end %>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Date</th>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Delivery Person</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @delivery_tasks.each do |task| %>
                  <tr class="<%= 'table-success' if task.status == 'delivered' %>
                           <%= 'table-warning' if task.status == 'pending' %>
                           <%= 'table-info' if task.status == 'assigned' %>">
                    <td>
                      <strong><%= task.delivery_date.strftime('%d %b %Y') %></strong><br>
                      <small class="text-muted"><%= task.delivery_date.strftime('%A') %></small>
                    </td>
                    <td>
                      <%= task.product.name %><br>
                      <small class="text-muted">₹<%= task.product.price %></small>
                    </td>
                    <td>
                      <span class="badge bg-primary fs-6">
                        <%= task.quantity %> <%= task.unit %>
                      </span>
                    </td>
                    <td>
                      <% if task.delivery_person %>
                        <strong><%= "#{task.delivery_person.first_name} #{task.delivery_person.last_name}" %></strong><br>
                        <small class="text-muted">Assigned: <%= task.assigned_at&.strftime('%d %b, %I:%M %p') %></small>
                      <% else %>
                        <span class="text-muted">Not assigned</span>
                      <% end %>
                    </td>
                    <td>
                      <% status_class = case task.status
                                        when 'pending' then 'bg-warning'
                                        when 'assigned' then 'bg-info'
                                        when 'delivered' then 'bg-success'
                                        when 'cancelled' then 'bg-danger'
                                        when 'missed' then 'bg-secondary'
                                        else 'bg-light'
                                        end %>
                      <span class="badge <%= status_class %> fs-6">
                        <%= task.status.humanize %>
                      </span>
                      <% if task.completed_at %>
                        <br><small class="text-muted">
                          <%= task.completed_at.strftime('%d %b, %I:%M %p') %>
                        </small>
                      <% end %>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <% if task.status == 'pending' %>
                          <button class="btn btn-outline-primary btn-sm" title="Assign">
                            <i class="bi bi-person-plus"></i>
                          </button>
                        <% elsif task.status == 'assigned' %>
                          <button class="btn btn-outline-success btn-sm" title="Mark Delivered">
                            <i class="bi bi-check"></i>
                          </button>
                        <% end %>
                        <button class="btn btn-outline-danger btn-sm" title="Cancel">
                          <i class="bi bi-x"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>

            <% if @delivery_tasks.empty? %>
              <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h5 class="text-muted mt-3">No delivery tasks found</h5>
                <p class="text-muted">Tasks will be generated based on the subscription pattern.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar with Quick Stats and Actions -->
    <div class="col-xl-4 col-lg-5">
      <!-- Quick Stats -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-graph-up"></i> Quick Stats
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-success mb-0"><%= @summary[:total_deliveries] %></h4>
                <small class="text-muted">Total Deliveries</small>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-primary mb-0"><%= @summary[:completed] %></h4>
                <small class="text-muted">Completed</small>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-3">
                <h4 class="text-warning mb-0"><%= @summary[:pending] %></h4>
                <small class="text-muted">Pending</small>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-3">
                <h4 class="text-info mb-0">₹<%= (@subscription.total_amount || 0).round %></h4>
                <small class="text-muted">Total Amount</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-lightning"></i> Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to edit_admin_subscription_path(@subscription), class: "btn btn-outline-warning" do %>
              <i class="bi bi-pencil"></i> Edit Subscription
            <% end %>

            <% if @subscription.status == 'active' %>
              <%= link_to pause_subscription_admin_subscription_path(@subscription),
                  method: :patch,
                  class: "btn btn-outline-warning",
                  confirm: "Pause this subscription?" do %>
                <i class="bi bi-pause"></i> Pause Subscription
              <% end %>
            <% else %>
              <%= link_to resume_subscription_admin_subscription_path(@subscription),
                  method: :patch,
                  class: "btn btn-outline-success",
                  confirm: "Resume this subscription?" do %>
                <i class="bi bi-play"></i> Resume Subscription
              <% end %>
            <% end %>

            <%= link_to generate_tasks_admin_subscription_path(@subscription),
                method: :post,
                class: "btn btn-outline-primary",
                confirm: "This will regenerate all delivery tasks. Are you sure?" do %>
              <i class="bi bi-arrow-clockwise"></i> Regenerate Tasks
            <% end %>

            <%= link_to toggle_status_admin_subscription_path(@subscription),
                method: :patch,
                class: "btn btn-outline-#{ @subscription.is_active? ? 'danger' : 'success' }",
                confirm: "#{@subscription.is_active? ? 'Deactivate' : 'Activate'} this subscription?" do %>
              <i class="bi bi-power"></i>
              <%= @subscription.is_active? ? 'Deactivate' : 'Activate' %>
            <% end %>

            <hr>

            <%= link_to admin_subscription_path(@subscription),
                method: :delete,
                class: "btn btn-outline-danger",
                confirm: "Are you sure? This will delete all delivery tasks as well." do %>
              <i class="bi bi-trash"></i> Delete Subscription
            <% end %>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-clock-history"></i> Timeline
          </h6>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-marker bg-success"></div>
              <div class="timeline-content">
                <h6 class="mb-1">Subscription Created</h6>
                <small class="text-muted"><%= @subscription.created_at.strftime('%d %B %Y at %I:%M %p') %></small>
              </div>
            </div>

            <% if @subscription.updated_at != @subscription.created_at %>
              <div class="timeline-item">
                <div class="timeline-marker bg-info"></div>
                <div class="timeline-content">
                  <h6 class="mb-1">Last Updated</h6>
                  <small class="text-muted"><%= @subscription.updated_at.strftime('%d %B %Y at %I:%M %p') %></small>
                </div>
              </div>
            <% end %>

            <% if @delivery_tasks.delivered.any? %>
              <div class="timeline-item">
                <div class="timeline-marker bg-primary"></div>
                <div class="timeline-content">
                  <h6 class="mb-1">Last Delivery</h6>
                  <small class="text-muted">
                    <%= @delivery_tasks.delivered.order(:completed_at).last.completed_at&.strftime('%d %B %Y at %I:%M %p') %>
                  </small>
                </div>
              </div>
            <% end %>

            <% next_delivery = @delivery_tasks.pending.order(:delivery_date).first %>
            <% if next_delivery %>
              <div class="timeline-item">
                <div class="timeline-marker bg-warning"></div>
                <div class="timeline-content">
                  <h6 class="mb-1">Next Delivery</h6>
                  <small class="text-muted"><%= next_delivery.delivery_date.strftime('%d %B %Y') %></small>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Customer Patterns -->
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-people"></i> Customer Patterns
            <small class="text-muted">(Today's Tasks)</small>
          </h6>
        </div>
        <div class="card-body">
          <% if @customer_patterns.any? %>
            <div class="customer-patterns-list" style="max-height: 400px; overflow-y: auto;">
              <% @customer_patterns.each do |pattern| %>
                <div class="customer-pattern-item border-bottom py-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="customer-info">
                      <h6 class="mb-1 text-dark">
                        <i class="bi bi-person-circle text-primary"></i>
                        <%= "#{pattern.first_name} #{pattern.last_name}".strip %>
                      </h6>
                      <small class="text-muted">
                        <i class="bi bi-bookmark"></i> <%= pattern.total_subscriptions %> subscription<%= 's' if pattern.total_subscriptions != 1 %>
                      </small>
                    </div>
                    <div class="task-info text-end">
                      <span class="badge bg-<%= pattern.daily_tasks_count > 0 ? 'success' : 'secondary' %> fs-6">
                        <%= pattern.daily_tasks_count %>
                      </span>
                      <br>
                      <small class="text-muted">today</small>
                    </div>
                  </div>
                  <div class="mt-2">
                    <div class="progress" style="height: 4px;">
                      <% completion_rate = pattern.daily_tasks_count > 0 ? 100 : 0 %>
                      <div class="progress-bar bg-<%= pattern.daily_tasks_count > 0 ? 'success' : 'light' %>"
                           style="width: <%= completion_rate %>%"></div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-people display-4 text-muted"></i>
              <h6 class="text-muted mt-3">No Customer Patterns</h6>
              <p class="text-muted small">Customer subscription patterns will appear here</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}

.timeline-item {
  position: relative;
  margin-bottom: 20px;
}

.timeline-marker {
  position: absolute;
  left: -22px;
  top: 3px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
}

.timeline-content {
  background: #f8f9fa;
  padding: 10px 15px;
  border-radius: 8px;
  border-left: 3px solid #dee2e6;
}

.timeline-content h6 {
  margin-bottom: 5px;
  font-weight: 600;
}
</style>