<% content_for :title, "Create New Subscription" %>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-plus-circle text-primary"></i>
      Create New Subscription
    </h1>
    <%= link_to admin_subscriptions_path, class: "btn btn-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Subscriptions
    <% end %>
  </div>

  <div class="card shadow">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="bi bi-form-check"></i> Subscription Details
      </h6>
    </div>
    <div class="card-body">
      <%= form_with model: @subscription, url: admin_subscriptions_path, local: true, html: { class: "needs-validation", novalidate: true } do |form| %>

        <!-- Error Messages -->
        <% if @subscription.errors.any? %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Please fix the following errors:</strong>
            <ul class="mb-0 mt-2">
              <% @subscription.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>

        <div class="row">
          <!-- Step 1: Customer Selection -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-person"></i> Step 1: Select Customer</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :customer_id, "Customer", class: "form-label fw-bold" %>
                  <%= form.select :customer_id,
                      options_for_select([['Select Customer...', '']] + @customers, @subscription.customer_id),
                      {},
                      {
                        class: "form-select select2-customer",
                        required: true,
                        "data-placeholder" => "Search and select customer..."
                      } %>
                  <div class="invalid-feedback">
                    Please select a customer.
                  </div>
                </div>

                <!-- Customer Info Display -->
                <div id="customer-info" class="d-none">
                  <div class="alert alert-info">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Customer Details</h6>
                    <div id="customer-details"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Products Selection -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-box"></i> Step 2: Select Products & Quantities</h6>
                <button type="button" class="btn btn-sm btn-light" id="addProductBtn">
                  <i class="bi bi-plus-circle me-1"></i>Add Product
                </button>
              </div>
              <div class="card-body">
                <!-- Products Container -->
                <div id="productsContainer">
                  <div class="product-item mb-3 p-3 border rounded" data-product-index="0">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="text-primary mb-0">
                        <i class="bi bi-box-seam me-1"></i>Product #1
                      </h6>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-product-btn d-none">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold">Product</label>
                      <select name="subscription[products][0][product_id]" class="form-select select2-product" required>
                        <option value="">Select Product...</option>
                        <% @products.each do |product| %>
                          <option value="<%= product[1] %>"><%= product[0] %></option>
                        <% end %>
                      </select>
                      <div class="invalid-feedback">Please select a product.</div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Quantity</label>
                        <input type="number" name="subscription[products][0][quantity]"
                               class="form-control" value="1" step="0.1" min="0.1" required>
                        <div class="invalid-feedback">Please enter a valid quantity.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Unit</label>
                        <select name="subscription[products][0][unit]" class="form-select">
                          <option value="liter">Liter</option>
                          <option value="ml">ML</option>
                          <option value="packet">Packet</option>
                          <option value="bottle">Bottle</option>
                        </select>
                      </div>
                    </div>

                    <!-- Product Info Display -->
                    <div class="product-info d-none mt-3">
                      <div class="alert alert-info alert-sm">
                        <div class="product-details"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Summary Display -->
                <div id="productsSummary" class="mt-3 p-3 bg-light rounded">
                  <h6 class="mb-2"><i class="bi bi-list-check me-1"></i>Products Summary</h6>
                  <div id="summaryContent">
                    <p class="mb-0 text-muted">Add products to see summary</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Step 3: Schedule Configuration -->
          <div class="col-md-12 mb-4">
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-calendar"></i> Step 3: Configure Delivery Schedule</h6>
              </div>
              <div class="card-body">
                <!-- Delivery Pattern Selection -->
                <div class="mb-4">
                  <%= form.label :delivery_pattern, "Delivery Pattern", class: "form-label fw-bold" %>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "daily",
                            checked: @subscription.delivery_pattern == 'daily' || @subscription.delivery_pattern.nil?,
                            class: "form-check-input",
                            id: "pattern_daily" %>
                        <%= form.label :delivery_pattern, "Daily",
                            class: "form-check-label",
                            for: "pattern_daily" %>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "alternate",
                            class: "form-check-input",
                            id: "pattern_alternate" %>
                        <%= form.label :delivery_pattern, "Alternate Days",
                            class: "form-check-label",
                            for: "pattern_alternate" %>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "specific_dates",
                            class: "form-check-input",
                            id: "pattern_specific" %>
                        <%= form.label :delivery_pattern, "Specific Dates",
                            class: "form-check-label",
                            for: "pattern_specific" %>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Date Range for Daily/Alternate -->
                <div id="date-range-section" class="row mb-4">
                  <div class="col-md-3">
                    <%= form.label :start_date, "Start Date", class: "form-label fw-bold" %>
                    <%= form.date_field :start_date,
                        value: @subscription.start_date || Date.tomorrow,
                        class: "form-control form-control-lg",
                        required: true %>
                    <div class="invalid-feedback">
                      Please select a start date.
                    </div>
                  </div>
                  <div class="col-md-3">
                    <%= form.label :end_date, "End Date", class: "form-label fw-bold" %>
                    <%= form.date_field :end_date,
                        value: @subscription.end_date || 1.month.from_now.to_date,
                        class: "form-control form-control-lg",
                        required: true %>
                    <div class="invalid-feedback">
                      Please select an end date.
                    </div>
                  </div>
                  <div class="col-md-3">
                    <%= form.label :delivery_time, "Delivery Time", class: "form-label fw-bold" %>
                    <%= form.select :delivery_time,
                        options_for_select([
                          ['Morning (6 AM - 10 AM)', 'morning'],
                          ['Evening (5 PM - 8 PM)', 'evening'],
                          ['Anytime', 'anytime']
                        ], @subscription.delivery_time || 'morning'),
                        {},
                        { class: "form-select form-select-lg" } %>
                  </div>
                  <div class="col-md-3">
                    <%= form.label :delivery_person_id, "Delivery Person", class: "form-label fw-bold" %>
                    <%= form.select :delivery_person_id,
                        options_for_select([['Select Delivery Person (Optional)', '']] + @delivery_people, @subscription.delivery_person_id),
                        {},
                        {
                          class: "form-select form-select-lg select2-delivery-person",
                          "data-placeholder" => "Select delivery person..."
                        } %>
                    <small class="form-text text-muted">Leave blank for auto-assignment</small>
                  </div>
                </div>

                <!-- Specific Dates Section -->
                <div id="specific-dates-section" class="d-none mb-4">
                  <h6 class="fw-bold mb-3">Select Specific Dates:</h6>

                  <div class="row">
                    <div class="col-md-8">
                      <!-- Interactive Calendar -->
                      <div class="card">
                        <div class="card-header bg-light">
                          <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="prevMonth">
                              <i class="bi bi-chevron-left"></i>
                            </button>
                            <h6 class="mb-0" id="currentMonth">Loading...</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="nextMonth">
                              <i class="bi bi-chevron-right"></i>
                            </button>
                          </div>
                        </div>
                        <div class="card-body p-2">
                          <div id="datePickerCalendar" class="date-picker-calendar">
                            <!-- Calendar will be generated here -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <!-- Selected Dates Display -->
                      <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                          <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Selected Dates</h6>
                        </div>
                        <div class="card-body">
                          <div id="selectedDatesList" class="selected-dates-list">
                            <p class="text-muted text-center">Click calendar dates to select</p>
                          </div>
                          <div class="mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" id="clearAllDates">
                              <i class="bi bi-trash"></i> Clear All Dates
                            </button>
                          </div>
                          <div class="mt-2">
                            <small class="text-muted">
                              <strong>Selected:</strong> <span id="selectedCount">0</span> dates
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Hidden field for form submission -->
                  <%= form.hidden_field :specific_dates, id: "specificDatesField" %>
                </div>

                <!-- Schedule Preview -->
                <div class="alert alert-primary" id="schedule-preview">
                  <h6><i class="bi bi-calendar-check"></i> Schedule Preview</h6>
                  <div id="preview-content">
                    <p class="mb-0">Select dates and pattern to see delivery schedule preview</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Step 4: Additional Settings -->
          <div class="col-md-12 mb-4">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Step 4: Additional Settings</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <%= form.label :status, "Status", class: "form-label fw-bold" %>
                    <%= form.select :status,
                        options_for_select([
                          ['Active', 'active'],
                          ['Paused', 'paused']
                        ], @subscription.status || 'active'),
                        {},
                        { class: "form-select" } %>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch mt-4">
                      <%= form.check_box :is_active,
                          checked: @subscription.is_active.nil? ? true : @subscription.is_active,
                          class: "form-check-input",
                          id: "subscription_is_active" %>
                      <%= form.label :is_active, "Active Subscription",
                          class: "form-check-label fw-bold",
                          for: "subscription_is_active" %>
                      <small class="d-block text-muted">Inactive subscriptions won't generate delivery tasks</small>
                    </div>
                  </div>
                </div>

                <!-- Cost Estimation -->
                <div class="mt-4">
                  <div class="alert alert-success" id="cost-estimation">
                    <h6><i class="bi bi-calculator"></i> Cost Estimation</h6>
                    <div id="cost-details">
                      <p class="mb-0">Select product and dates to see cost estimation</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center">
                <%= form.submit "Create Subscription & Generate Daily Tasks",
                    class: "btn btn-primary btn-lg me-3",
                    id: "submit-btn" %>
                <%= link_to "Cancel", admin_subscriptions_path,
                    class: "btn btn-secondary btn-lg" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Enhanced CSS Styles for Calendar -->
<style>
.calendar-table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-day-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid #dee2e6;
  padding: 12px 4px;
  text-align: center;
  font-weight: 600;
  font-size: 0.875rem;
  color: #495057;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.calendar-cell {
  border: 1px solid #e9ecef;
  padding: 0;
  height: 45px;
  width: 14.28%;
  position: relative;
  transition: all 0.2s ease;
}

.calendar-cell.empty {
  background-color: #fafafa;
  border-color: #f1f3f4;
}

.date-cell-content {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  width: 100%;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 4px;
  margin: 2px;
}

.calendar-cell.clickable-date:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.calendar-cell.clickable-date:hover .date-cell-content {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  color: #1565c0;
  font-weight: 600;
}

.calendar-cell.selected-date .date-cell-content {
  background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
  color: white;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(25, 118, 210, 0.4);
}

.calendar-cell.today .date-cell-content {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  color: #e65100;
  font-weight: 600;
  border: 2px solid #ff9800;
}

.calendar-cell.past-date .date-cell-content {
  background-color: #f8f9fa;
  color: #adb5bd;
  cursor: not-allowed;
  opacity: 0.6;
}

.calendar-cell.selected-date.today .date-cell-content {
  background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
  color: white;
  border: 2px solid #ff9800;
  box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.3);
}

.selected-dates-grid {
  max-height: 280px;
  overflow-y: auto;
  padding-right: 8px;
}

.selected-dates-grid::-webkit-scrollbar {
  width: 4px;
}

.selected-dates-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.selected-dates-grid::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.selected-dates-grid::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.selected-date-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  margin-bottom: 6px;
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border: 1px solid #e1f5fe;
  border-radius: 8px;
  font-size: 0.85rem;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.selected-date-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-color: #81c784;
}

.selected-date-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 3px;
  background: linear-gradient(to bottom, #1976d2, #42a5f5);
}

.date-text {
  font-weight: 600;
  color: #37474f;
  display: flex;
  align-items: center;
  gap: 6px;
}

.remove-date {
  padding: 4px 8px;
  font-size: 0.75rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.remove-date:hover {
  background-color: #f44336 !important;
  border-color: #f44336 !important;
  color: white !important;
  transform: scale(1.1);
}

.date-picker-calendar {
  padding: 0;
  border-radius: 8px;
  overflow: hidden;
}

/* Animation for month transitions */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.calendar-table {
  animation: fadeIn 0.3s ease-out;
}

/* Card enhancements for specific dates section */
#specific-dates-section .card {
  border: none;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  border-radius: 12px;
  overflow: hidden;
}

#specific-dates-section .card-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid #e1e8ed;
  padding: 12px 16px;
}

#specific-dates-section .card-body {
  padding: 16px;
}

/* Responsive design */
@media (max-width: 768px) {
  .calendar-cell {
    height: 35px;
  }

  .date-cell-content {
    font-size: 0.8rem;
  }

  .calendar-day-header {
    padding: 8px 2px;
    font-size: 0.75rem;
  }

  .selected-date-item {
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  .selected-dates-grid {
    max-height: 200px;
  }
}

/* Multiple Products Styling */
.product-item {
  transition: all 0.3s ease;
  border: 2px solid #e9ecef !important;
}

.product-item:hover {
  border-color: #007bff !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.product-item.border-primary {
  border-color: #007bff !important;
  background: rgba(13, 110, 253, 0.02);
}

.remove-product-btn {
  opacity: 0.7;
  transition: all 0.2s ease;
}

.remove-product-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

#productsSummary {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid #dee2e6;
  border-radius: 8px;
}

#addProductBtn {
  transition: all 0.2s ease;
}

#addProductBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.alert-sm {
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}

.product-info {
  animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- JavaScript for Dynamic Form Behavior -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  let productCounter = 0;

  // Initialize Select2
  if (typeof $ !== 'undefined' && $.fn.select2) {
    $('.select2-customer').select2({
      theme: 'bootstrap-5',
      placeholder: 'Search and select customer...',
      allowClear: true
    });

    $('.select2-delivery-person').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select delivery person...',
      allowClear: true
    });

    initializeProductSelects();
  }

  // Initialize product selects
  function initializeProductSelects() {
    $('.select2-product').each(function() {
      if (!$(this).hasClass('select2-hidden-accessible')) {
        $(this).select2({
          theme: 'bootstrap-5',
          placeholder: 'Select product...',
          allowClear: true
        });
      }
    });
  }

  // Add Product Button
  document.getElementById('addProductBtn').addEventListener('click', function() {
    addNewProduct();
  });

  // Add new product entry
  function addNewProduct() {
    productCounter++;
    const productsContainer = document.getElementById('productsContainer');

    const productOptions = '<% @products.each do |product| %><option value="<%= product[1] %>"><%= product[0] %></option><% end %>';

    const newProductHTML = `
      <div class="product-item mb-3 p-3 border rounded" data-product-index="${productCounter}">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h6 class="text-primary mb-0">
            <i class="bi bi-box-seam me-1"></i>Product #${productCounter + 1}
          </h6>
          <button type="button" class="btn btn-sm btn-outline-danger remove-product-btn">
            <i class="bi bi-trash"></i>
          </button>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Product</label>
          <select name="subscription[products][${productCounter}][product_id]" class="form-select select2-product" required>
            <option value="">Select Product...</option>
            ${productOptions}
          </select>
          <div class="invalid-feedback">Please select a product.</div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <label class="form-label fw-bold">Quantity</label>
            <input type="number" name="subscription[products][${productCounter}][quantity]"
                   class="form-control" value="1" step="0.1" min="0.1" required>
            <div class="invalid-feedback">Please enter a valid quantity.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Unit</label>
            <select name="subscription[products][${productCounter}][unit]" class="form-select">
              <option value="liter">Liter</option>
              <option value="ml">ML</option>
              <option value="packet">Packet</option>
              <option value="bottle">Bottle</option>
            </select>
          </div>
        </div>

        <!-- Product Info Display -->
        <div class="product-info d-none mt-3">
          <div class="alert alert-info alert-sm">
            <div class="product-details"></div>
          </div>
        </div>
      </div>
    `;

    productsContainer.insertAdjacentHTML('beforeend', newProductHTML);

    // Show remove buttons for all products if we have more than 1
    updateRemoveButtons();

    // Initialize Select2 for new select
    initializeProductSelects();

    // Update product numbers
    updateProductNumbers();

    // Update summary
    updateProductsSummary();
  }

  // Remove product functionality
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-product-btn')) {
      e.preventDefault();
      const productItem = e.target.closest('.product-item');
      productItem.remove();
      updateRemoveButtons();
      updateProductNumbers();
      updateProductsSummary();
    }
  });

  // Update remove button visibility
  function updateRemoveButtons() {
    const productItems = document.querySelectorAll('.product-item');
    const removeButtons = document.querySelectorAll('.remove-product-btn');

    if (productItems.length > 1) {
      removeButtons.forEach(btn => btn.classList.remove('d-none'));
    } else {
      removeButtons.forEach(btn => btn.classList.add('d-none'));
    }
  }

  // Update product numbers
  function updateProductNumbers() {
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
      const header = item.querySelector('h6');
      header.innerHTML = `<i class="bi bi-box-seam me-1"></i>Product #${index + 1}`;

      // Update form field names to maintain sequential indexing
      const selects = item.querySelectorAll('select, input');
      selects.forEach(field => {
        const name = field.getAttribute('name');
        if (name) {
          const newName = name.replace(/\[\d+\]/, `[${index}]`);
          field.setAttribute('name', newName);
        }
      });

      item.setAttribute('data-product-index', index);
    });
  }

  // Update products summary
  function updateProductsSummary() {
    const productItems = document.querySelectorAll('.product-item');
    const summaryContent = document.getElementById('summaryContent');

    if (productItems.length === 0) {
      summaryContent.innerHTML = '<p class="mb-0 text-muted">Add products to see summary</p>';
      return;
    }

    let summaryHTML = '<div class="row g-2">';
    let hasValidProducts = false;

    productItems.forEach((item, index) => {
      const productSelect = item.querySelector('select[name*="product_id"]');
      const quantityInput = item.querySelector('input[name*="quantity"]');
      const unitSelect = item.querySelector('select[name*="unit"]');

      if (productSelect.value) {
        hasValidProducts = true;
        const productText = productSelect.options[productSelect.selectedIndex].text;
        const quantity = quantityInput.value || '1';
        const unit = unitSelect.options[unitSelect.selectedIndex].text;

        summaryHTML += `
          <div class="col-md-6 col-lg-4">
            <div class="p-2 bg-white rounded border">
              <small class="fw-bold text-primary d-block">${productText}</small>
              <small class="text-muted">${quantity} ${unit} per delivery</small>
            </div>
          </div>
        `;
      }
    });

    summaryHTML += '</div>';

    if (hasValidProducts) {
      summaryContent.innerHTML = summaryHTML;
    } else {
      summaryContent.innerHTML = '<p class="mb-0 text-muted">Select products to see summary</p>';
    }
  }

  // Listen for product/quantity changes
  document.addEventListener('change', function(e) {
    if (e.target.matches('select[name*="product_id"], input[name*="quantity"], select[name*="unit"]')) {
      updateProductsSummary();
      updateCostEstimation();
    }
  });

  // Calendar functionality
  let currentDate = new Date();
  let selectedDates = [];
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();

  // Initialize calendar
  generateCalendar(currentMonth, currentYear);

  // Initialize display based on selected pattern
  const initialPattern = document.querySelector('input[name="milk_subscription[delivery_pattern]"]:checked')?.value;
  const dateRangeSectionInit = document.getElementById('date-range-section');
  const specificDatesSectionInit = document.getElementById('specific-dates-section');

  if (initialPattern === 'specific_dates') {
    specificDatesSectionInit.classList.remove('d-none');
    dateRangeSectionInit.classList.add('d-none');
  } else {
    specificDatesSectionInit.classList.add('d-none');
    dateRangeSectionInit.classList.remove('d-none');
  }

  // Calendar navigation
  document.getElementById('prevMonth').addEventListener('click', function() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    generateCalendar(currentMonth, currentYear);
  });

  document.getElementById('nextMonth').addEventListener('click', function() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    generateCalendar(currentMonth, currentYear);
  });

  // Clear all selected dates
  document.getElementById('clearAllDates').addEventListener('click', function() {
    selectedDates = [];
    updateSelectedDatesDisplay();
    updateSpecificDatesField();
    generateCalendar(currentMonth, currentYear);
    updateSchedulePreview();
  });

  // Handle delivery pattern changes
  const patternInputs = document.querySelectorAll('input[name="milk_subscription[delivery_pattern]"]');
  const dateRangeSection = document.getElementById('date-range-section');
  const specificDatesSection = document.getElementById('specific-dates-section');

  patternInputs.forEach(input => {
    input.addEventListener('change', function() {
      if (this.value === 'specific_dates') {
        dateRangeSection.classList.add('d-none');
        specificDatesSection.classList.remove('d-none');
        generateCalendar(currentMonth, currentYear); // Refresh calendar when shown
      } else {
        dateRangeSection.classList.remove('d-none');
        specificDatesSection.classList.add('d-none');
      }
      updateSchedulePreview();
    });
  });

  // Update preview when dates change
  const startDate = document.getElementById('milk_subscription_start_date');
  const endDate = document.getElementById('milk_subscription_end_date');
  const quantity = document.getElementById('milk_subscription_quantity');

  [startDate, endDate, quantity].forEach(element => {
    if (element) {
      element.addEventListener('change', updateSchedulePreview);
    }
  });

  // Customer selection handler
  const customerSelect = document.getElementById('milk_subscription_customer_id');
  if (customerSelect) {
    customerSelect.addEventListener('change', function() {
      // You can add AJAX call here to fetch customer details
      if (this.value) {
        document.getElementById('customer-info').classList.remove('d-none');
        document.getElementById('customer-details').innerHTML =
          '<strong>Customer Selected:</strong> ' + this.options[this.selectedIndex].text;
      } else {
        document.getElementById('customer-info').classList.add('d-none');
      }
    });
  }

  // Delivery person selection handler
  const deliveryPersonSelect = document.getElementById('milk_subscription_delivery_person_id');
  if (deliveryPersonSelect) {
    deliveryPersonSelect.addEventListener('change', function() {
      updateSchedulePreview(); // Update preview to show delivery person assignment
    });
  }

  // Product selection handler
  const productSelect = document.getElementById('milk_subscription_product_id');
  if (productSelect) {
    productSelect.addEventListener('change', function() {
      if (this.value) {
        document.getElementById('product-info').classList.remove('d-none');
        document.getElementById('product-details').innerHTML =
          '<strong>Product Selected:</strong> ' + this.options[this.selectedIndex].text;
      } else {
        document.getElementById('product-info').classList.add('d-none');
      }
      updateCostEstimation();
    });
  }

  // Calendar Functions
  function generateCalendar(month, year) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    // Update month display
    document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    // Set today to start of day for accurate comparison
    today.setHours(0, 0, 0, 0);

    let calendarHTML = '<table class="calendar-table w-100">';
    calendarHTML += '<thead><tr>';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
      calendarHTML += '<th class="calendar-day-header">' + day + '</th>';
    });
    calendarHTML += '</tr></thead><tbody>';

    let date = 1;
    for (let i = 0; i < 6; i++) { // Maximum 6 weeks in a month
      calendarHTML += '<tr>';
      for (let j = 0; j < 7; j++) {
        if (i === 0 && j < firstDay) {
          calendarHTML += '<td class="calendar-cell empty"></td>';
        } else if (date > daysInMonth) {
          calendarHTML += '<td class="calendar-cell empty"></td>';
        } else {
          const currentDate = new Date(year, month, date);
          currentDate.setHours(0, 0, 0, 0); // Set to start of day
          const dateString = formatDate(currentDate);
          const isPast = currentDate < today;
          const isSelected = selectedDates.includes(dateString);
          const isToday = currentDate.getTime() === today.getTime();

          let cellClass = 'calendar-cell';
          if (!isPast) cellClass += ' clickable-date';
          if (isPast) cellClass += ' past-date';
          if (isSelected) cellClass += ' selected-date';
          if (isToday) cellClass += ' today';

          const dataAttr = !isPast ? `data-date="${dateString}"` : '';
          calendarHTML += `<td class="${cellClass}" ${dataAttr}>`;
          calendarHTML += '<div class="date-cell-content">' + date + '</div>';
          calendarHTML += '</td>';
          date++;
        }
      }
      calendarHTML += '</tr>';

      if (date > daysInMonth) break;
    }

    calendarHTML += '</tbody></table>';

    const calendarContainer = document.getElementById('datePickerCalendar');
    if (calendarContainer) {
      calendarContainer.innerHTML = calendarHTML;
    }

    // Add click events to clickable date cells only
    document.querySelectorAll('.clickable-date').forEach(cell => {
      cell.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const dateStr = this.getAttribute('data-date');
        if (!dateStr) return;

        console.log('Date clicked:', dateStr);

        const index = selectedDates.indexOf(dateStr);
        if (index > -1) {
          // Remove date
          console.log('Removing date:', dateStr);
          selectedDates.splice(index, 1);
          this.classList.remove('selected-date');
        } else {
          // Add date
          console.log('Adding date:', dateStr);
          selectedDates.push(dateStr);
          selectedDates.sort();
          this.classList.add('selected-date');
        }

        updateSelectedDatesDisplay();
        updateSpecificDatesField();
        updateSchedulePreview();
      });
    });
  }

  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function isSameDay(date1, date2) {
    return date1.getTime() === date2.getTime();
  }

  function parseDate(dateStr) {
    // Parse YYYY-MM-DD format properly
    const [year, month, day] = dateStr.split('-').map(num => parseInt(num, 10));
    const date = new Date(year, month - 1, day); // month is 0-indexed
    date.setHours(0, 0, 0, 0);
    return date;
  }

  function updateSelectedDatesDisplay() {
    const container = document.getElementById('selectedDatesList');
    const countElement = document.getElementById('selectedCount');

    if (selectedDates.length === 0) {
      container.innerHTML = '<p class="text-muted text-center mb-0"><i class="bi bi-calendar-x me-1"></i>Click calendar dates to select</p>';
      countElement.textContent = '0';
      return;
    }

    countElement.textContent = selectedDates.length;

    let html = '<div class="selected-dates-grid">';
    selectedDates.forEach((dateStr, index) => {
      const date = parseDate(dateStr);
      const formattedDate = date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      html += '<div class="selected-date-item">';
      html += `<span class="date-text"><i class="bi bi-calendar-event me-1"></i>${formattedDate}</span>`;
      html += `<button type="button" class="btn btn-sm btn-outline-danger remove-date" data-date="${dateStr}" title="Remove date">`;
      html += '<i class="bi bi-x-lg"></i>';
      html += '</button>';
      html += '</div>';
    });
    html += '</div>';

    container.innerHTML = html;

    // Add remove date functionality
    document.querySelectorAll('.remove-date').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const dateStr = this.getAttribute('data-date');
        const index = selectedDates.indexOf(dateStr);
        if (index > -1) {
          selectedDates.splice(index, 1);
          updateSelectedDatesDisplay();
          updateSpecificDatesField();
          generateCalendar(currentMonth, currentYear);
          updateSchedulePreview();
        }
      });
    });
  }

  function updateSpecificDatesField() {
    document.getElementById('specificDatesField').value = JSON.stringify(selectedDates);
  }

  // Helper function to format numbers properly
  function formatNumber(num, decimals = 2) {
    return parseFloat(num.toFixed(decimals));
  }

  // Functions
  function updateSchedulePreview() {
    const pattern = document.querySelector('input[name="milk_subscription[delivery_pattern]"]:checked')?.value;
    const start = startDate?.value;
    const end = endDate?.value;
    const qty = quantity?.value || 1;
    const deliveryPersonSelect = document.getElementById('milk_subscription_delivery_person_id');
    const deliveryPersonText = deliveryPersonSelect?.value ?
      deliveryPersonSelect.options[deliveryPersonSelect.selectedIndex].text : 'Auto-assigned';

    if (!start || !end || !pattern) return;

    let deliveryCount = 0;
    let previewText = '';

    const startDateObj = new Date(start);
    const endDateObj = new Date(end);
    const totalDays = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;

    switch(pattern) {
      case 'daily':
        deliveryCount = totalDays;
        previewText = `Daily delivery from ${start} to ${end} (${deliveryCount} deliveries)`;
        break;
      case 'alternate':
        deliveryCount = Math.ceil(totalDays / 2);
        previewText = `Alternate day delivery from ${start} to ${end} (${deliveryCount} deliveries)`;
        break;
      case 'specific_dates':
        deliveryCount = selectedDates.length;
        if (deliveryCount > 0) {
          previewText = `Specific dates delivery (${deliveryCount} deliveries)`;
        } else {
          previewText = 'No specific dates selected yet';
        }
        break;
    }

    const totalQty = formatNumber(deliveryCount * qty);
    document.getElementById('preview-content').innerHTML = `
      <p class="mb-1"><strong>${previewText}</strong></p>
      <p class="mb-1">Total quantity: ${totalQty} units</p>
      <p class="mb-0"><i class="bi bi-person-badge me-1"></i><strong>Delivery Person:</strong> ${deliveryPersonText}</p>
    `;

    updateCostEstimation(deliveryCount);
  }

  function updateCostEstimation(deliveryCount = null) {
    if (!deliveryCount) {
      // Calculate based on current preview
      const pattern = document.querySelector('input[name="milk_subscription[delivery_pattern]"]:checked')?.value;
      const start = startDate?.value;
      const end = endDate?.value;

      if (start && end) {
        const startDateObj = new Date(start);
        const endDateObj = new Date(end);
        const totalDays = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;

        switch(pattern) {
          case 'daily': deliveryCount = totalDays; break;
          case 'alternate': deliveryCount = Math.ceil(totalDays / 2); break;
          case 'specific_dates':
            deliveryCount = selectedDates.length;
            break;
        }
      }
    }

    if (deliveryCount > 0) {
      const productItems = document.querySelectorAll('.product-item');
      let totalEstimate = 0;
      let hasValidProducts = false;
      let costDetailsHTML = '<div class="row">';

      productItems.forEach((item, index) => {
        const productSelect = item.querySelector('select[name*="product_id"]');
        const quantityInput = item.querySelector('input[name*="quantity"]');

        if (productSelect.value && quantityInput.value) {
          hasValidProducts = true;
          const productText = productSelect.options[productSelect.selectedIndex].text;
          const quantity = parseFloat(quantityInput.value) || 1;
          const pricePerUnit = 30; // This should come from backend
          const totalQuantity = formatNumber(deliveryCount * quantity);
          const productTotal = formatNumber(totalQuantity * pricePerUnit);
          totalEstimate += parseFloat(productTotal);

          costDetailsHTML += `
            <div class="col-md-6 mb-2">
              <div class="p-2 bg-light rounded">
                <strong class="text-primary d-block">${productText}</strong>
                <small>Qty: ${totalQuantity} units × ₹${formatNumber(pricePerUnit)} = ₹${productTotal}</small>
              </div>
            </div>
          `;
        }
      });

      if (hasValidProducts) {
        costDetailsHTML += `
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <div class="p-3 bg-primary bg-opacity-10 rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <span><strong>Total Deliveries:</strong> ${deliveryCount}</span>
                  <span><strong>Total Amount:</strong> ₹${formatNumber(totalEstimate)}</span>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('cost-details').innerHTML = costDetailsHTML;
      } else {
        document.getElementById('cost-details').innerHTML = '<p class="mb-0">Select products to see cost estimation</p>';
      }
    } else {
      document.getElementById('cost-details').innerHTML = '<p class="mb-0">Select dates to see cost estimation</p>';
    }
  }

  // Form validation
  const form = document.querySelector('.needs-validation');
  if (form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  }

  // Initialize preview
  updateSchedulePreview();
});
</script>