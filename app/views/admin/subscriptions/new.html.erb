<% content_for :title, "Create New Subscription" %>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-plus-circle text-primary"></i>
      Create New Subscription
    </h1>
    <%= link_to admin_subscriptions_path, class: "btn btn-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Subscriptions
    <% end %>
  </div>

  <div class="card shadow">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="bi bi-form-check"></i> Subscription Details
      </h6>
    </div>
    <div class="card-body">
      <%= form_with model: @subscription, url: admin_subscriptions_path, local: true, html: { class: "needs-validation", novalidate: true } do |form| %>

        <!-- Error Messages -->
        <% if @subscription.errors.any? %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Please fix the following errors:</strong>
            <ul class="mb-0 mt-2">
              <% @subscription.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>

        <div class="row">
          <!-- Step 1: Customer Selection -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-person"></i> Step 1: Select Customer</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :customer_id, "Customer", class: "form-label fw-bold" %>
                  <%= form.select :customer_id,
                      options_for_select([['Select Customer...', '']] + @customers, @subscription.customer_id),
                      {},
                      {
                        class: "form-select select2-customer",
                        required: true,
                        "data-placeholder" => "Search and select customer..."
                      } %>
                  <div class="invalid-feedback">
                    Please select a customer.
                  </div>
                </div>

                <!-- Customer Info Display -->
                <div id="customer-info" class="d-none">
                  <div class="alert alert-info">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Customer Details</h6>
                    <div id="customer-details"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Product Selection -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-box"></i> Step 2: Select Product & Quantity</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :product_id, "Product", class: "form-label fw-bold" %>
                  <%= form.select :product_id,
                      options_for_select([['Select Product...', '']] + @products, @subscription.product_id),
                      {},
                      {
                        class: "form-select select2-product",
                        required: true
                      } %>
                  <div class="invalid-feedback">
                    Please select a product.
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-8">
                    <%= form.label :quantity, "Quantity", class: "form-label fw-bold" %>
                    <%= form.number_field :quantity,
                        value: @subscription.quantity || 1,
                        step: 0.1,
                        min: 0.1,
                        class: "form-control form-control-lg",
                        required: true %>
                    <div class="invalid-feedback">
                      Please enter a valid quantity.
                    </div>
                  </div>
                  <div class="col-md-4">
                    <%= form.label :unit, "Unit", class: "form-label fw-bold" %>
                    <%= form.select :unit,
                        options_for_select([
                          ['Liter', 'liter'],
                          ['ML', 'ml'],
                          ['Packet', 'packet'],
                          ['Bottle', 'bottle']
                        ], @subscription.unit || 'liter'),
                        {},
                        { class: "form-select" } %>
                  </div>
                </div>

                <!-- Product Info Display -->
                <div id="product-info" class="d-none mt-3">
                  <div class="alert alert-success">
                    <div id="product-details"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Step 3: Schedule Configuration -->
          <div class="col-md-12 mb-4">
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-calendar"></i> Step 3: Configure Delivery Schedule</h6>
              </div>
              <div class="card-body">
                <!-- Delivery Pattern Selection -->
                <div class="mb-4">
                  <%= form.label :delivery_pattern, "Delivery Pattern", class: "form-label fw-bold" %>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "daily",
                            checked: @subscription.delivery_pattern == 'daily' || @subscription.delivery_pattern.nil?,
                            class: "form-check-input",
                            id: "pattern_daily" %>
                        <%= form.label :delivery_pattern, "Daily",
                            class: "form-check-label",
                            for: "pattern_daily" %>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "alternate",
                            class: "form-check-input",
                            id: "pattern_alternate" %>
                        <%= form.label :delivery_pattern, "Alternate Days",
                            class: "form-check-label",
                            for: "pattern_alternate" %>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-check-inline">
                        <%= form.radio_button :delivery_pattern, "specific_dates",
                            class: "form-check-input",
                            id: "pattern_specific" %>
                        <%= form.label :delivery_pattern, "Specific Dates",
                            class: "form-check-label",
                            for: "pattern_specific" %>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Date Range for Daily/Alternate -->
                <div id="date-range-section" class="row mb-4">
                  <div class="col-md-4">
                    <%= form.label :start_date, "Start Date", class: "form-label fw-bold" %>
                    <%= form.date_field :start_date,
                        value: @subscription.start_date || Date.tomorrow,
                        class: "form-control form-control-lg",
                        required: true %>
                    <div class="invalid-feedback">
                      Please select a start date.
                    </div>
                  </div>
                  <div class="col-md-4">
                    <%= form.label :end_date, "End Date", class: "form-label fw-bold" %>
                    <%= form.date_field :end_date,
                        value: @subscription.end_date || 1.month.from_now.to_date,
                        class: "form-control form-control-lg",
                        required: true %>
                    <div class="invalid-feedback">
                      Please select an end date.
                    </div>
                  </div>
                  <div class="col-md-4">
                    <%= form.label :delivery_time, "Delivery Time", class: "form-label fw-bold" %>
                    <%= form.select :delivery_time,
                        options_for_select([
                          ['Morning (6 AM - 10 AM)', 'morning'],
                          ['Evening (5 PM - 8 PM)', 'evening'],
                          ['Anytime', 'anytime']
                        ], @subscription.delivery_time || 'morning'),
                        {},
                        { class: "form-select form-select-lg" } %>
                  </div>
                </div>

                <!-- Specific Dates Section -->
                <div id="specific-dates-section" class="d-none mb-4">
                  <h6 class="fw-bold mb-3">Select Specific Dates:</h6>

                  <div class="row">
                    <div class="col-md-8">
                      <!-- Interactive Calendar -->
                      <div class="card">
                        <div class="card-header bg-light">
                          <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="prevMonth">
                              <i class="bi bi-chevron-left"></i>
                            </button>
                            <h6 class="mb-0" id="currentMonth">Loading...</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="nextMonth">
                              <i class="bi bi-chevron-right"></i>
                            </button>
                          </div>
                        </div>
                        <div class="card-body p-2">
                          <div id="datePickerCalendar" class="date-picker-calendar">
                            <!-- Calendar will be generated here -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <!-- Selected Dates Display -->
                      <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                          <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Selected Dates</h6>
                        </div>
                        <div class="card-body">
                          <div id="selectedDatesList" class="selected-dates-list">
                            <p class="text-muted text-center">Click calendar dates to select</p>
                          </div>
                          <div class="mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" id="clearAllDates">
                              <i class="bi bi-trash"></i> Clear All Dates
                            </button>
                          </div>
                          <div class="mt-2">
                            <small class="text-muted">
                              <strong>Selected:</strong> <span id="selectedCount">0</span> dates
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Hidden field for form submission -->
                  <%= form.hidden_field :specific_dates, id: "specificDatesField" %>
                </div>

                <!-- Schedule Preview -->
                <div class="alert alert-primary" id="schedule-preview">
                  <h6><i class="bi bi-calendar-check"></i> Schedule Preview</h6>
                  <div id="preview-content">
                    <p class="mb-0">Select dates and pattern to see delivery schedule preview</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Step 4: Additional Settings -->
          <div class="col-md-12 mb-4">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Step 4: Additional Settings</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <%= form.label :status, "Status", class: "form-label fw-bold" %>
                    <%= form.select :status,
                        options_for_select([
                          ['Active', 'active'],
                          ['Paused', 'paused']
                        ], @subscription.status || 'active'),
                        {},
                        { class: "form-select" } %>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch mt-4">
                      <%= form.check_box :is_active,
                          checked: @subscription.is_active.nil? ? true : @subscription.is_active,
                          class: "form-check-input",
                          id: "subscription_is_active" %>
                      <%= form.label :is_active, "Active Subscription",
                          class: "form-check-label fw-bold",
                          for: "subscription_is_active" %>
                      <small class="d-block text-muted">Inactive subscriptions won't generate delivery tasks</small>
                    </div>
                  </div>
                </div>

                <!-- Cost Estimation -->
                <div class="mt-4">
                  <div class="alert alert-success" id="cost-estimation">
                    <h6><i class="bi bi-calculator"></i> Cost Estimation</h6>
                    <div id="cost-details">
                      <p class="mb-0">Select product and dates to see cost estimation</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center">
                <%= form.submit "Create Subscription & Generate Tasks",
                    class: "btn btn-primary btn-lg me-3",
                    id: "submit-btn" %>
                <%= link_to "Cancel", admin_subscriptions_path,
                    class: "btn btn-secondary btn-lg" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- CSS Styles for Calendar -->
<style>
.calendar-table {
  width: 100%;
  border-collapse: collapse;
}

.calendar-day-header {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  padding: 8px 4px;
  text-align: center;
  font-weight: bold;
  font-size: 0.875rem;
}

.calendar-cell {
  border: 1px solid #dee2e6;
  padding: 0;
  height: 40px;
  width: 14.28%;
  position: relative;
}

.calendar-cell.empty {
  background-color: #f8f9fa;
}

.date-cell-content {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  width: 100%;
  cursor: pointer;
  font-size: 0.875rem;
  transition: all 0.2s ease;
}

.calendar-cell.clickable-date:hover .date-cell-content {
  background-color: #e3f2fd;
  color: #1976d2;
}

.calendar-cell.selected-date .date-cell-content {
  background-color: #1976d2;
  color: white;
  font-weight: bold;
}

.calendar-cell.today .date-cell-content {
  background-color: #fff3e0;
  color: #f57c00;
  font-weight: bold;
}

.calendar-cell.past-date .date-cell-content {
  background-color: #f5f5f5;
  color: #9e9e9e;
  cursor: not-allowed;
}

.calendar-cell.selected-date.today .date-cell-content {
  background-color: #1976d2;
  color: white;
}

.selected-dates-grid {
  max-height: 200px;
  overflow-y: auto;
}

.selected-date-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 8px;
  margin-bottom: 4px;
  background-color: #e3f2fd;
  border-radius: 4px;
  font-size: 0.875rem;
}

.date-text {
  font-weight: 500;
}

.remove-date {
  padding: 2px 6px;
  font-size: 0.75rem;
}

.date-picker-calendar {
  padding: 0;
}
</style>

<!-- JavaScript for Dynamic Form Behavior -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Select2
  if (typeof $ !== 'undefined' && $.fn.select2) {
    $('.select2-customer').select2({
      theme: 'bootstrap-5',
      placeholder: 'Search and select customer...',
      allowClear: true
    });

    $('.select2-product').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select product...',
      allowClear: true
    });
  }

  // Calendar functionality
  let currentDate = new Date();
  let selectedDates = [];
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();

  // Initialize calendar
  generateCalendar(currentMonth, currentYear);

  // Make sure specific dates section is hidden initially
  document.getElementById('specific-dates-section').style.display = 'none';

  // Calendar navigation
  document.getElementById('prevMonth').addEventListener('click', function() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    generateCalendar(currentMonth, currentYear);
  });

  document.getElementById('nextMonth').addEventListener('click', function() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    generateCalendar(currentMonth, currentYear);
  });

  // Clear all selected dates
  document.getElementById('clearAllDates').addEventListener('click', function() {
    selectedDates = [];
    updateSelectedDatesDisplay();
    updateSpecificDatesField();
    generateCalendar(currentMonth, currentYear);
    updateSchedulePreview();
  });

  // Handle delivery pattern changes
  const patternInputs = document.querySelectorAll('input[name="milk_subscription[delivery_pattern]"]');
  const dateRangeSection = document.getElementById('date-range-section');
  const specificDatesSection = document.getElementById('specific-dates-section');

  patternInputs.forEach(input => {
    input.addEventListener('change', function() {
      if (this.value === 'specific_dates') {
        dateRangeSection.style.display = 'none';
        specificDatesSection.style.display = 'block';
        generateCalendar(currentMonth, currentYear); // Refresh calendar when shown
      } else {
        dateRangeSection.style.display = 'block';
        specificDatesSection.style.display = 'none';
      }
      updateSchedulePreview();
    });
  });

  // Update preview when dates change
  const startDate = document.getElementById('milk_subscription_start_date');
  const endDate = document.getElementById('milk_subscription_end_date');
  const quantity = document.getElementById('milk_subscription_quantity');

  [startDate, endDate, quantity].forEach(element => {
    if (element) {
      element.addEventListener('change', updateSchedulePreview);
    }
  });

  // Customer selection handler
  const customerSelect = document.getElementById('milk_subscription_customer_id');
  if (customerSelect) {
    customerSelect.addEventListener('change', function() {
      // You can add AJAX call here to fetch customer details
      if (this.value) {
        document.getElementById('customer-info').classList.remove('d-none');
        document.getElementById('customer-details').innerHTML =
          '<strong>Customer Selected:</strong> ' + this.options[this.selectedIndex].text;
      } else {
        document.getElementById('customer-info').classList.add('d-none');
      }
    });
  }

  // Product selection handler
  const productSelect = document.getElementById('milk_subscription_product_id');
  if (productSelect) {
    productSelect.addEventListener('change', function() {
      if (this.value) {
        document.getElementById('product-info').classList.remove('d-none');
        document.getElementById('product-details').innerHTML =
          '<strong>Product Selected:</strong> ' + this.options[this.selectedIndex].text;
      } else {
        document.getElementById('product-info').classList.add('d-none');
      }
      updateCostEstimation();
    });
  }

  // Calendar Functions
  function generateCalendar(month, year) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    // Update month display
    document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();

    let calendarHTML = '<table class="calendar-table w-100">';
    calendarHTML += '<thead><tr>';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
      calendarHTML += '<th class="calendar-day-header">' + day + '</th>';
    });
    calendarHTML += '</tr></thead><tbody>';

    let date = 1;
    for (let i = 0; i < 6; i++) { // Maximum 6 weeks in a month
      calendarHTML += '<tr>';
      for (let j = 0; j < 7; j++) {
        if (i === 0 && j < firstDay) {
          calendarHTML += '<td class="calendar-cell empty"></td>';
        } else if (date > daysInMonth) {
          calendarHTML += '<td class="calendar-cell empty"></td>';
        } else {
          const currentDate = new Date(year, month, date);
          const dateString = formatDate(currentDate);
          const isPast = currentDate < today && !isSameDay(currentDate, today);
          const isSelected = selectedDates.includes(dateString);
          const isToday = isSameDay(currentDate, today);

          let cellClass = 'calendar-cell clickable-date';
          if (isPast) cellClass += ' past-date';
          if (isSelected) cellClass += ' selected-date';
          if (isToday) cellClass += ' today';

          calendarHTML += '<td class="' + cellClass + '" data-date="' + dateString + '">';
          calendarHTML += '<div class="date-cell-content">' + date + '</div>';
          calendarHTML += '</td>';
          date++;
        }
      }
      calendarHTML += '</tr>';

      if (date > daysInMonth) break;
    }

    calendarHTML += '</tbody></table>';
    document.getElementById('datePickerCalendar').innerHTML = calendarHTML;

    // Add click events to date cells
    document.querySelectorAll('.clickable-date').forEach(cell => {
      cell.addEventListener('click', function(e) {
        e.preventDefault();
        const dateStr = this.getAttribute('data-date');
        console.log('Date clicked:', dateStr);

        if (this.classList.contains('past-date')) {
          console.log('Past date clicked, ignoring');
          return; // Don't allow past dates
        }

        if (selectedDates.includes(dateStr)) {
          // Remove date
          console.log('Removing date:', dateStr);
          selectedDates = selectedDates.filter(d => d !== dateStr);
          this.classList.remove('selected-date');
        } else {
          // Add date
          console.log('Adding date:', dateStr);
          selectedDates.push(dateStr);
          selectedDates.sort();
          this.classList.add('selected-date');
        }

        updateSelectedDatesDisplay();
        updateSpecificDatesField();
        updateSchedulePreview();
      });
    });
  }

  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
  }

  function isSameDay(date1, date2) {
    return date1.toDateString() === date2.toDateString();
  }

  function updateSelectedDatesDisplay() {
    const container = document.getElementById('selectedDatesList');
    const countElement = document.getElementById('selectedCount');

    if (selectedDates.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">Click calendar dates to select</p>';
      countElement.textContent = '0';
      return;
    }

    countElement.textContent = selectedDates.length;

    let html = '<div class="selected-dates-grid">';
    selectedDates.forEach((dateStr, index) => {
      const date = new Date(dateStr);
      const formattedDate = date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      });

      html += '<div class="selected-date-item">';
      html += '<span class="date-text">' + formattedDate + '</span>';
      html += '<button type="button" class="btn btn-sm btn-outline-danger remove-date" data-date="' + dateStr + '">';
      html += '<i class="bi bi-x"></i>';
      html += '</button>';
      html += '</div>';
    });
    html += '</div>';

    container.innerHTML = html;

    // Add remove date functionality
    document.querySelectorAll('.remove-date').forEach(btn => {
      btn.addEventListener('click', function() {
        const dateStr = this.getAttribute('data-date');
        selectedDates = selectedDates.filter(d => d !== dateStr);
        updateSelectedDatesDisplay();
        updateSpecificDatesField();
        generateCalendar(currentMonth, currentYear);
        updateSchedulePreview();
      });
    });
  }

  function updateSpecificDatesField() {
    document.getElementById('specificDatesField').value = JSON.stringify(selectedDates);
  }

  // Helper function to format numbers properly
  function formatNumber(num, decimals = 2) {
    return parseFloat(num.toFixed(decimals));
  }

  // Functions
  function updateSchedulePreview() {
    const pattern = document.querySelector('input[name="milk_subscription[delivery_pattern]"]:checked')?.value;
    const start = startDate?.value;
    const end = endDate?.value;
    const qty = quantity?.value || 1;

    if (!start || !end || !pattern) return;

    let deliveryCount = 0;
    let previewText = '';

    const startDateObj = new Date(start);
    const endDateObj = new Date(end);
    const totalDays = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;

    switch(pattern) {
      case 'daily':
        deliveryCount = totalDays;
        previewText = `Daily delivery from ${start} to ${end} (${deliveryCount} deliveries)`;
        break;
      case 'alternate':
        deliveryCount = Math.ceil(totalDays / 2);
        previewText = `Alternate day delivery from ${start} to ${end} (${deliveryCount} deliveries)`;
        break;
      case 'specific_dates':
        deliveryCount = selectedDates.length;
        if (deliveryCount > 0) {
          previewText = `Specific dates delivery (${deliveryCount} deliveries)`;
        } else {
          previewText = 'No specific dates selected yet';
        }
        break;
    }

    const totalQty = formatNumber(deliveryCount * qty);
    document.getElementById('preview-content').innerHTML = `
      <p class="mb-1"><strong>${previewText}</strong></p>
      <p class="mb-0">Total quantity: ${totalQty} units</p>
    `;

    updateCostEstimation(deliveryCount);
  }

  function updateCostEstimation(deliveryCount = null) {
    const productSelect = document.getElementById('milk_subscription_product_id');
    const qty = quantity?.value || 1;

    if (!deliveryCount) {
      // Calculate based on current preview
      const pattern = document.querySelector('input[name="milk_subscription[delivery_pattern]"]:checked')?.value;
      const start = startDate?.value;
      const end = endDate?.value;

      if (start && end) {
        const startDateObj = new Date(start);
        const endDateObj = new Date(end);
        const totalDays = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;

        switch(pattern) {
          case 'daily': deliveryCount = totalDays; break;
          case 'alternate': deliveryCount = Math.ceil(totalDays / 2); break;
          case 'specific_dates':
            deliveryCount = selectedDates.length;
            break;
        }
      }
    }

    if (productSelect && productSelect.value && deliveryCount > 0) {
      // You can make an AJAX call here to get actual product price
      // For now, using placeholder values
      const pricePerUnit = 30; // This should come from backend
      const totalQuantity = formatNumber(deliveryCount * parseFloat(qty));
      const totalAmount = formatNumber(totalQuantity * pricePerUnit);

      document.getElementById('cost-details').innerHTML = `
        <div class="row">
          <div class="col-md-3">
            <strong>Deliveries:</strong> ${deliveryCount}
          </div>
          <div class="col-md-3">
            <strong>Total Quantity:</strong> ${totalQuantity} units
          </div>
          <div class="col-md-3">
            <strong>Rate:</strong> ₹${formatNumber(pricePerUnit)}/unit
          </div>
          <div class="col-md-3">
            <strong>Total Amount:</strong> ₹${totalAmount}
          </div>
        </div>
      `;
    }
  }

  // Form validation
  const form = document.querySelector('.needs-validation');
  if (form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  }

  // Initialize preview
  updateSchedulePreview();
});
</script>