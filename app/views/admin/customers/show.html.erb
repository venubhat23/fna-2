<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1"><%= @customer.display_name %></h2>
    <p class="text-muted mb-0">
      <span class="badge bg-primary me-2">
        Customer
      </span>
      Customer ID: #<%= @customer.id %>
    </p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to edit_admin_customer_path(@customer), class: "btn btn-warning" do %>
      <i class="bi bi-pencil me-1"></i>
      Edit Customer
    <% end %>
    <%= link_to admin_customers_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Customers
    <% end %>
  </div>
</div>

<div class="row">
  <!-- Main Customer Information -->
  <div class="col-lg-8">
    <!-- Basic Information -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Basic Information</h5>
        <% customer_status = @customer.respond_to?(:status) ? @customer.status : true %>
        <span class="badge bg-<%= customer_status ? 'success' : 'danger' %>">
          <%= customer_status ? 'Active' : 'Inactive' %>
        </span>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <% # All customers are treated as individual customers %>
            <div class="col-md-6">
              <strong class="text-muted d-block">First Name</strong>
              <%= @customer.first_name || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Last Name</strong>
              <%= @customer.last_name || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Middle Name</strong>
              <%= @customer.middle_name || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">WhatsApp Number</strong>
              <% if @customer.whatsapp_number.present? %>
                <a href="https://wa.me/<%= @customer.whatsapp_number.gsub(/\D/, '') %>"><%= @customer.whatsapp_number %></a>
              <% else %>
                -
              <% end %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Date of Birth</strong>
              <%= @customer.birth_date&.strftime("%B %d, %Y") || '-' %>
              <% if @customer.birth_date.present? %>
                <small class="text-muted d-block">Age: <%= ((Date.current - @customer.birth_date.to_date) / 365.25).floor %> years</small>
              <% end %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Gender</strong>
              <%= @customer.gender&.capitalize || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Marital Status</strong>
              <%= @customer.marital_status&.capitalize || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">PAN Number</strong>
              <%= @customer.pan_no || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">GST Number</strong>
              <%= @customer.gst_no || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Nationality</strong>
              <%= @customer.nationality || '-' %>
            </div>

          <div class="col-md-6">
            <strong class="text-muted d-block">Email</strong>
            <% if @customer.email.present? %>
              <a href="mailto:<%= @customer.email %>"><%= @customer.email %></a>
            <% else %>
              -
            <% end %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Mobile</strong>
            <% if @customer.mobile.present? %>
              <a href="tel:<%= @customer.mobile %>"><%= @customer.mobile %></a>
            <% else %>
              -
            <% end %>
          </div>

          <% # All customers are treated as individual customers %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Created At</strong>
              <%= @customer.created_at&.strftime("%B %d, %Y at %I:%M %p") || '-' %>
            </div>
            <div class="col-md-6">
              <strong class="text-muted d-block">Last Updated</strong>
              <%= @customer.updated_at&.strftime("%B %d, %Y at %I:%M %p") || '-' %>
            </div>
        </div>
      </div>
    </div>

    <!-- Login Credentials -->
    <% user = User.find_by(email: @customer.email) %>
    <% if user %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">
          <i class="bi bi-key me-2 text-primary"></i>
          Login Credentials
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Username (Email)</strong>
            <div class="d-flex align-items-center">
              <span class="me-2"><%= user.email %></span>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= user.email %>')">
                <i class="bi bi-copy"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Password</strong>
            <div class="d-flex align-items-center">
              <span class="me-2 font-monospace">
                <% if @customer.auto_generated_password.present? %>
                  <%= @customer.auto_generated_password %>
                <% else %>
                  <span class="text-muted">Set by customer</span>
                <% end %>
              </span>
              <% if @customer.auto_generated_password.present? %>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= @customer.auto_generated_password %>')">
                  <i class="bi bi-copy"></i>
                </button>
              <% end %>
            </div>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">User Type</strong>
            <span class="badge bg-info"><%= user.user_type.titleize %></span>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Account Status</strong>
            <span class="badge bg-<%= user.status? ? 'success' : 'danger' %>">
              <%= user.status? ? 'Active' : 'Inactive' %>
            </span>
          </div>
          <div class="col-12">
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Login URL:</strong>
              <a href="<%= request.base_url %>/mobile/login" target="_blank" class="alert-link">
                <%= request.base_url %>/mobile/login
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Professional Information -->
    <% if @customer.company_name.present? || @customer.occupation.present? || @customer.annual_income.present? %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Professional Information</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Company Name</strong>
            <%= @customer.company_name || '-' %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Occupation</strong>
            <%= @customer.occupation || '-' %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Annual Income</strong>
            <% if @customer.annual_income.present? %>
              ₹ <%= number_with_delimiter(@customer.annual_income) %>
            <% else %>
              -
            <% end %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Preferred Language</strong>
            <%= @customer.preferred_language&.capitalize || '-' %>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Emergency Contact Information -->
    <% if @customer.emergency_contact_name.present? || @customer.emergency_contact_number.present? || @customer.blood_group.present? %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Emergency Information</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Emergency Contact Name</strong>
            <%= @customer.emergency_contact_name || '-' %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Emergency Contact Number</strong>
            <% if @customer.emergency_contact_number.present? %>
              <a href="tel:<%= @customer.emergency_contact_number %>"><%= @customer.emergency_contact_number %></a>
            <% else %>
              -
            <% end %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Blood Group</strong>
            <span class="badge bg-danger"><%= @customer.blood_group || 'Not Specified' %></span>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Address Information -->
    <% if @customer.address.present? || @customer.latitude.present? || @customer.longitude.present? %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Address & Location</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <% if @customer.address.present? %>
          <div class="col-12">
            <strong class="text-muted d-block">Address</strong>
            <%= @customer.address %>
          </div>
          <% end %>

          <% if @customer.latitude.present? || @customer.longitude.present? %>
              <div class="col-md-6">
                <strong class="text-muted d-block">Latitude</strong>
                <%= @customer.latitude || '-' %>
              </div>
              <div class="col-md-6">
                <strong class="text-muted d-block">Longitude</strong>
                <%= @customer.longitude || '-' %>
              </div>
              <div class="col-md-6">
                <strong class="text-muted d-block">Location Accuracy</strong>
                <%= @customer.location_accuracy || '-' %>
              </div>
              <div class="col-md-6">
                <strong class="text-muted d-block">Location Obtained At</strong>
                <%= @customer.location_obtained_at&.strftime("%B %d, %Y at %I:%M %p") || '-' %>
              </div>
            <% else %>
              <div class="col-md-12">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  No location information available for this customer.
                </div>
              </div>
            <% end %>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Images -->
    <% if @customer.personal_image.attached? || @customer.house_image.attached? %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Images</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <% if @customer.personal_image.attached? %>
            <div class="col-md-6">
              <strong class="text-muted d-block mb-2">Personal Image</strong>
              <div class="card">
                <%= image_tag @customer.personal_image, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
                <div class="card-body p-2">
                  <%= link_to @customer.personal_image, class: "btn btn-sm btn-outline-primary", target: "_blank" do %>
                    <i class="bi bi-eye me-1"></i>View Full Size
                  <% end %>
                </div>
              </div>
            </div>
            <% end %>
            <% if @customer.house_image.attached? %>
            <div class="col-md-6">
              <strong class="text-muted d-block mb-2">House Image</strong>
              <div class="card">
                <%= image_tag @customer.house_image, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
                <div class="card-body p-2">
                  <%= link_to @customer.house_image, class: "btn btn-sm btn-outline-primary", target: "_blank" do %>
                    <i class="bi bi-eye me-1"></i>View Full Size
                  <% end %>
                </div>
              </div>
            </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Additional Notes -->
    <% if @customer.notes.present? %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">
          <i class="bi bi-journal-text me-2 text-info"></i>
          Additional Notes
        </h5>
      </div>
      <div class="card-body">
        <div class="p-3 bg-light rounded">
          <%= simple_format(@customer.notes) %>
        </div>
      </div>
    </div>
    <% end %>

    <!-- E-commerce Activity -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">
          <i class="bi bi-cart me-2 text-primary"></i>
          E-commerce Activity
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="text-center">
              <h4 class="text-primary mb-1"><%= @customer.bookings.count %></h4>
              <small class="text-muted">Total Bookings</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center">
              <h4 class="text-success mb-1"><%= @customer.orders.count %></h4>
              <small class="text-muted">Total Orders</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center">
              <h4 class="text-info mb-1"><%= @customer.booking_schedules.count %></h4>
              <small class="text-muted">Subscriptions</small>
            </div>
          </div>
        </div>

        <% if @customer.bookings.any? %>
          <hr>
          <h6 class="mb-3">Recent Bookings</h6>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Booking #</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Total</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @customer.bookings.order(created_at: :desc).limit(5).each do |booking| %>
                  <tr>
                    <td><%= booking.booking_number || "##{booking.id}" %></td>
                    <td><%= booking.created_at.strftime("%b %d, %Y") %></td>
                    <td>
                      <span class="badge bg-<%= booking.status == 'completed' ? 'success' : 'warning' %>">
                        <%= booking.status&.titleize || 'Pending' %>
                      </span>
                    </td>
                    <td>₹<%= number_with_delimiter(booking.total_amount.to_i) if booking.total_amount %></td>
                    <td>
                      <%= link_to "View", admin_booking_path(booking), class: "btn btn-sm btn-outline-primary" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <%= link_to "View All Bookings", admin_bookings_path(customer_id: @customer.id), class: "btn btn-outline-primary" %>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <i class="bi bi-cart-x fs-1 d-block mb-3"></i>
            <h6>No Bookings Yet</h6>
            <p class="mb-0">This customer hasn't made any bookings yet.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Quick Stats -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Quick Stats</h6>
      </div>
      <div class="card-body">
        <div class="row g-2 text-center">
          <div class="col-12">
            <small class="text-muted d-block">Customer Since</small>
            <strong><%= @customer.created_at.strftime("%B %Y") %></strong>
          </div>
          <hr>
          <div class="col-6">
            <small class="text-muted d-block">Total Bookings</small>
            <h5 class="text-primary mb-0"><%= @customer.bookings.count %></h5>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Total Orders</small>
            <h5 class="text-success mb-0"><%= @customer.orders.count %></h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Timeline -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Customer Timeline</h6>
      </div>
      <div class="card-body">
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker bg-success"></div>
            <div class="timeline-content">
              <small class="text-muted">Customer Created</small>
              <div><%= @customer.created_at.strftime("%B %d, %Y at %I:%M %p") %></div>
            </div>
          </div>
          <% if @customer.updated_at != @customer.created_at %>
            <div class="timeline-item">
              <div class="timeline-marker bg-info"></div>
              <div class="timeline-content">
                <small class="text-muted">Last Updated</small>
                <div><%= @customer.updated_at.strftime("%B %d, %Y at %I:%M %p") %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>


  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 20px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}

.timeline-item {
  position: relative;
  margin-bottom: 1rem;
}

.timeline-marker {
  position: absolute;
  left: -15px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
}

.timeline-content {
  padding-left: 10px;
}
</style>

<script>
function copyToClipboard(text) {
  if (navigator.clipboard && window.isSecureContext) {
    // Use modern clipboard API
    navigator.clipboard.writeText(text).then(() => {
      showCopySuccess();
    }).catch(err => {
      console.error('Failed to copy: ', err);
      fallbackCopyTextToClipboard(text);
    });
  } else {
    // Fallback for older browsers
    fallbackCopyTextToClipboard(text);
  }
}

function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopySuccess();
    } else {
      console.error('Fallback: Copying text command was unsuccessful');
    }
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }

  document.body.removeChild(textArea);
}

function showCopySuccess() {
  // Create a temporary success message
  const message = document.createElement('div');
  message.className = 'alert alert-success position-fixed top-0 end-0 m-3';
  message.style.zIndex = '9999';
  message.innerHTML = '<i class="bi bi-check-circle me-2"></i>Copied to clipboard!';
  document.body.appendChild(message);

  // Remove the message after 2 seconds
  setTimeout(() => {
    if (document.body.contains(message)) {
      document.body.removeChild(message);
    }
  }, 2000);
}
</script>