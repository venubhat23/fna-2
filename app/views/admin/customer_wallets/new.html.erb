<% content_for :title, "Create Customer Wallet" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Create Customer Wallet</h2>
    <p class="text-muted mb-0">Set up a new digital wallet for a customer</p>
  </div>
  <div>
    <%= link_to admin_customer_wallets_path, class: "btn btn-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>Back to Wallets
    <% end %>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-header bg-white">
    <h6 class="mb-0">Wallet Details</h6>
  </div>
  <div class="card-body">
    <%= form_with model: [:admin, @customer_wallet], local: true, class: "needs-validation", novalidate: true do |form| %>

      <!-- Error Messages -->
      <% if @customer_wallet.errors.any? %>
        <div class="alert alert-danger">
          <h6>Please fix the following errors:</h6>
          <ul class="mb-0">
            <% @customer_wallet.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <%= form.label :customer_id, "Customer", class: "form-label fw-bold" %>
            <%= form.select :customer_id,
                options_for_select([['Select Customer...', '']] + @customers.map { |c| ["#{c.first_name} #{c.last_name} - #{c.mobile}", c.id] }, @customer_wallet.customer_id),
                {},
                {
                  class: "form-select select2",
                  required: true,
                  "data-placeholder" => "Search and select customer..."
                } %>
            <div class="invalid-feedback">
              Please select a customer.
            </div>
            <small class="text-muted">Only customers without existing wallets are shown</small>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-3">
            <%= form.label :balance, "Initial Balance", class: "form-label fw-bold" %>
            <div class="input-group">
              <span class="input-group-text">₹</span>
              <%= form.number_field :balance,
                  value: @customer_wallet.balance || 0,
                  step: 0.01,
                  min: 0,
                  class: "form-control",
                  required: true %>
            </div>
            <div class="invalid-feedback">
              Please enter a valid balance amount.
            </div>
            <small class="text-muted">Minimum balance is ₹0.00</small>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <div class="form-check form-switch">
              <%= form.check_box :status,
                  checked: @customer_wallet.status.nil? ? true : @customer_wallet.status,
                  class: "form-check-input",
                  id: "wallet_status" %>
              <%= form.label :status, "Active Wallet",
                  class: "form-check-label fw-bold",
                  for: "wallet_status" %>
              <small class="d-block text-muted">Inactive wallets cannot be used for transactions</small>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-3">
            <%= form.label :notes, "Notes (Optional)", class: "form-label fw-bold" %>
            <%= form.text_area :notes,
                rows: 3,
                placeholder: "Any additional notes about this wallet...",
                class: "form-control" %>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <%= link_to "Cancel", admin_customer_wallets_path, class: "btn btn-secondary" %>
        <%= form.submit "Create Wallet", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Initialize Select2 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof $ !== 'undefined' && $.fn.select2) {
    $('.select2').select2({
      theme: 'bootstrap-5',
      placeholder: 'Search and select customer...',
      allowClear: true
    });
  }

  // Form validation
  const form = document.querySelector('.needs-validation');
  if (form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  }
});
</script>