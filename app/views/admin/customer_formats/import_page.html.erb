<% content_for :title, "Import from Master Subscription" %>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-download text-success"></i>
        Import from Master Subscription
      </h1>
      <p class="text-muted">Create monthly subscriptions from existing customer formats</p>
    </div>
    <div>
      <%= link_to admin_customer_formats_path, class: "btn btn-secondary" do %>
        <i class="bi bi-arrow-left"></i> Back to Customer Formats
      <% end %>
    </div>
  </div>

  <!-- Import Form Card -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Import Configuration</h5>
        </div>
        <div class="card-body">
          <%= form_with url: import_from_master_admin_customer_formats_path, method: :post, local: false, html: { id: "importForm", class: "needs-validation" }, novalidate: true do |form| %>

            <!-- Month and Year Selection -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="form-group">
                  <%= form.label :month, "Select Month", class: "form-label fw-bold" %>
                  <%= form.select :month,
                      options_for_select([
                        ['January', 1], ['February', 2], ['March', 3], ['April', 4],
                        ['May', 5], ['June', 6], ['July', 7], ['August', 8],
                        ['September', 9], ['October', 10], ['November', 11], ['December', 12]
                      ], Date.current.month),
                      { prompt: "Choose Month" },
                      { class: "form-select form-select-lg", required: true } %>
                  <div class="form-text">Select the month for which to create subscriptions</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <%= form.label :year, "Select Year", class: "form-label fw-bold" %>
                  <%= form.select :year,
                      options_for_select((Date.current.year..(Date.current.year + 2)).map { |y| [y, y] }, Date.current.year),
                      { prompt: "Choose Year" },
                      { class: "form-select form-select-lg", required: true } %>
                  <div class="form-text">Select the year for the subscription period</div>
                </div>
              </div>
            </div>

            <!-- Import Process Information -->
            <div class="alert alert-info">
              <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Import Process Information</h6>
              <div class="row">
                <div class="col-md-6">
                  <strong>What will be created:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Monthly subscriptions for selected period</li>
                    <li>Daily tasks based on delivery patterns</li>
                    <li>Customer-specific delivery schedules</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <strong>Important Notes:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Only active customer formats will be processed</li>
                    <li>Process runs in background (~10 minutes)</li>
                    <li>Duplicates are automatically prevented</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
              <button type="submit" class="btn btn-success btn-lg px-5" id="importBtn">
                <i class="bi bi-gear me-2"></i>
                <span id="importBtnText">Start Import Process</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" id="importSpinner" role="status"></span>
              </button>
            </div>

          <% end %>
        </div>
      </div>
    </div>

    <!-- Statistics Sidebar -->
    <div class="col-lg-4">
      <!-- Current Stats Card -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Current Statistics</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <i class="bi bi-file-text text-primary display-6"></i>
              <h4 class="text-primary mt-2"><%= @stats[:active] %></h4>
              <small class="text-muted">Active Formats</small>
            </div>
            <div class="col-6 mb-3">
              <i class="bi bi-people text-success display-6"></i>
              <h4 class="text-success mt-2"><%= Customer.joins(:customer_formats).where(customer_formats: { status: 'active' }).distinct.count rescue 0 %></h4>
              <small class="text-muted">Customers</small>
            </div>
            <div class="col-6">
              <i class="bi bi-box text-warning display-6"></i>
              <h4 class="text-warning mt-2"><%= Product.joins(:customer_formats).where(customer_formats: { status: 'active' }).distinct.count rescue 0 %></h4>
              <small class="text-muted">Products</small>
            </div>
            <div class="col-6">
              <i class="bi bi-diagram-3 text-info display-6"></i>
              <h4 class="text-info mt-2"><%= @stats[:pattern_counts].keys.count rescue 0 %></h4>
              <small class="text-muted">Patterns</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Formats Preview -->
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0"><i class="bi bi-list me-2"></i>Recent Active Formats</h6>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
          <% if @active_formats.any? %>
            <% @active_formats.each do |format| %>
              <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                <div class="flex-shrink-0">
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-person"></i>
                  </div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-0"><%= "#{format.customer.first_name} #{format.customer.last_name}" %></h6>
                  <small class="text-muted"><%= format.product.name %> - <%= format.quantity %> <%= format.pattern.humanize %></small>
                </div>
                <div class="flex-shrink-0">
                  <span class="badge bg-success">Active</span>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-inbox display-4"></i>
              <p class="mt-2">No active formats found</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section (Hidden initially) -->
  <div id="importResults" class="d-none">
    <div class="card shadow mt-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Import Results</h5>
      </div>
      <div class="card-body" id="importResultsContent">
        <!-- Results will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const importForm = document.getElementById('importForm');
  const importBtn = document.getElementById('importBtn');
  const importBtnText = document.getElementById('importBtnText');
  const importSpinner = document.getElementById('importSpinner');
  const importResults = document.getElementById('importResults');
  const importResultsContent = document.getElementById('importResultsContent');

  if (importForm) {
    importForm.addEventListener('submit', function(e) {
      e.preventDefault();
      processImport();
    });
  }

  function processImport() {
    console.log('üöÄ Starting import process...');

    // Show loading state
    importBtn.disabled = true;
    importBtnText.textContent = 'Processing...';
    importSpinner.classList.remove('d-none');

    // Prepare form data
    const formData = new FormData(importForm);
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // Submit request
    fetch(importForm.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': csrfToken
      }
    })
    .then(response => {
      console.log('üì° Response received:', response.status);
      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('‚úÖ Import response:', data);

      // Show results
      importResults.classList.remove('d-none');

      if (data.success) {
        importResultsContent.innerHTML = `
          <div class="alert alert-success">
            <h5 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Import Successful!</h5>
            <p class="mb-0">${data.message}</p>
          </div>
          <div class="text-center mt-3">
            <a href="${window.location.pathname.replace('/import_page', '')}" class="btn btn-primary">
              <i class="bi bi-arrow-left me-2"></i>Back to Customer Formats
            </a>
          </div>
        `;

        // Show success alert
        showAlert('success', data.message);

        // Auto-redirect after 5 seconds
        setTimeout(() => {
          window.location.href = window.location.pathname.replace('/import_page', '');
        }, 5000);
      } else {
        throw new Error(data.message || 'Import failed');
      }
    })
    .catch(error => {
      console.error('‚ùå Import error:', error);

      importResults.classList.remove('d-none');
      importResultsContent.innerHTML = `
        <div class="alert alert-danger">
          <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Import Failed</h5>
          <p class="mb-0">${error.message}</p>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-2"></i>Try Again
            </button>
          </div>
        </div>
      `;

      showAlert('danger', error.message);
    })
    .finally(() => {
      // Reset button state
      importBtn.disabled = false;
      importBtnText.textContent = 'Start Import Process';
      importSpinner.classList.add('d-none');
    });
  }

  function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
    const strongText = type === 'success' ? 'Success!' : 'Error!';

    // Remove any existing alerts
    document.querySelectorAll('.alert.position-fixed').forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
      <i class="${iconClass} me-2"></i>
      <strong>${strongText}</strong> ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remove alert after 8 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 8000);
  }
});
</script>