<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Order Management</h2>
    <p class="text-muted mb-0">Track and manage customer orders from booking to delivery</p>
  </div>
  <div>
    <%= link_to new_admin_booking_path, class: "btn btn-primary" do %>
      <i class="bi bi-plus-lg me-1"></i>
      Create New Booking
    <% end %>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Total Orders</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:all] || 0 : 0 %></h4>
          </div>
          <div class="text-primary">
            <i class="bi bi-bag fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Pending</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:ordered_and_delivery_pending] || 0 : 0 %></h4>
          </div>
          <div class="text-warning">
            <i class="bi bi-clock fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Processing</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:processing] || 0 : 0 %></h4>
          </div>
          <div class="text-info">
            <i class="bi bi-gear fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Shipped</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:shipped] || 0 : 0 %></h4>
          </div>
          <div class="text-primary">
            <i class="bi bi-truck fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Delivered</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:delivered] || 0 : 0 %></h4>
          </div>
          <div class="text-success">
            <i class="bi bi-check-circle fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Cancelled</h6>
            <h4 class="mb-0"><%= @status_counts.present? ? @status_counts[:cancelled] || 0 : 0 %></h4>
          </div>
          <div class="text-danger">
            <i class="bi bi-x-circle fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Orders Table -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Order List</h5>
      <div class="d-flex gap-2">
        <div class="position-relative">
          <input type="text" class="form-control" placeholder="Search orders..." id="searchInput">
          <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @orders.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0 fw-semibold">Order Details</th>
              <th class="border-0 fw-semibold">Customer</th>
              <th class="border-0 fw-semibold">Items</th>
              <th class="border-0 fw-semibold">Amount</th>
              <th class="border-0 fw-semibold">Status</th>
              <th class="border-0 fw-semibold">Payment</th>
              <th class="border-0 fw-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @orders.each do |order| %>
              <tr>
                <td class="align-middle">
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary-subtle rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-bag text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-0"><%= order.order_number %></h6>
                      <small class="text-muted"><%= order.order_date&.strftime("%d %b %Y") || order.created_at&.strftime("%d %b %Y") %></small>
                    </div>
                  </div>
                </td>
                <td class="align-middle">
                  <div>
                    <h6 class="mb-0"><%= order.customer_name || order.customer&.display_name %></h6>
                    <% if order.customer_email || order.customer&.email %>
                      <small class="text-muted">
                        <i class="bi bi-envelope me-1"></i>
                        <%= order.customer_email || order.customer&.email %>
                      </small>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <% if order.respond_to?(:order_items) && order.order_items.present? %>
                    <span class="badge bg-info-subtle text-info">
                      <%= pluralize(order.order_items.sum(:quantity), 'item') %>
                    </span>
                  <% else %>
                    <span class="badge bg-secondary-subtle text-secondary">N/A</span>
                  <% end %>
                </td>
                <td class="align-middle">
                  <div class="fw-medium text-success">
                    ₹<%= number_with_delimiter(order.total_amount || 0) %>
                  </div>
                  <% if order.respond_to?(:discount_amount) && order.discount_amount.to_f > 0 %>
                    <small class="text-muted">-₹<%= number_with_delimiter(order.discount_amount) %> discount</small>
                  <% end %>
                </td>
                <td class="align-middle">
                  <span class="badge bg-<%= order.status_color %>">
                    <i class="bi <%= order.status_icon %> me-1"></i>
                    <%= order.status&.humanize || 'Unknown' %>
                  </span>
                </td>
                <td class="align-middle">
                  <% payment_class = case order.payment_status
                                    when 'paid' then 'bg-success-subtle text-success'
                                    when 'unpaid' then 'bg-danger-subtle text-danger'
                                    when 'partially_paid' then 'bg-warning-subtle text-warning'
                                    when 'refunded' then 'bg-info-subtle text-info'
                                    else 'bg-secondary-subtle text-secondary'
                                    end %>
                  <span class="badge <%= payment_class %>">
                    <%= order.payment_status&.humanize || 'Unknown' %>
                  </span>
                </td>
                <td class="align-middle">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <%= link_to admin_order_path(order), class: "dropdown-item" do %>
                          <i class="bi bi-eye me-2"></i>
                          View Details
                        <% end %>
                      </li>
                      <li>
                        <%= link_to edit_admin_order_path(order), class: "dropdown-item" do %>
                          <i class="bi bi-pencil me-2"></i>
                          Edit Order
                        <% end %>
                      </li>

                      <!-- Stage Transition Actions -->
                      <% if order.status != 'cancelled' && order.status != 'delivered' %>
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">
                          <i class="bi bi-arrow-right me-1"></i>Move to Stage
                        </li>

                        <% if order.ordered_and_delivery_pending? || order.confirmed? %>
                          <li>
                            <button class="dropdown-item" onclick="openStageModal('processing', '<%= order.id %>', '<%= order.order_number %>')">
                              <i class="bi bi-gear me-2 text-info"></i>
                              Mark as Processing
                            </button>
                          </li>
                        <% end %>

                        <% if order.processing? %>
                          <li>
                            <button class="dropdown-item" onclick="openStageModal('packed', '<%= order.id %>', '<%= order.order_number %>')">
                              <i class="bi bi-box me-2 text-warning"></i>
                              Mark as Packed
                            </button>
                          </li>
                        <% end %>

                        <% if order.packed? %>
                          <li>
                            <button class="dropdown-item" onclick="openStageModal('shipped', '<%= order.id %>', '<%= order.order_number %>')">
                              <i class="bi bi-truck me-2 text-primary"></i>
                              Mark as Shipped
                            </button>
                          </li>
                        <% end %>

                        <% if order.shipped? || order.out_for_delivery? %>
                          <li>
                            <button class="dropdown-item" onclick="openStageModal('delivered', '<%= order.id %>', '<%= order.order_number %>')">
                              <i class="bi bi-check-circle me-2 text-success"></i>
                              Mark as Delivered
                            </button>
                          </li>
                        <% end %>

                        <% if order.can_cancel? %>
                          <li>
                            <button class="dropdown-item text-danger" onclick="openStageModal('cancelled', '<%= order.id %>', '<%= order.order_number %>')">
                              <i class="bi bi-x-circle me-2"></i>
                              Cancel Order
                            </button>
                          </li>
                        <% end %>
                      <% end %>

                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to admin_order_path(order), method: :delete,
                            class: "dropdown-item text-danger",
                            confirm: "Are you sure you want to delete this order?",
                            data: {
                              confirm: "Are you sure you want to delete order #{order.order_number}? This action cannot be undone."
                            } do %>
                          <i class="bi bi-trash me-2"></i>
                          Delete Order
                        <% end %>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if respond_to?(:paginate) && @orders.respond_to?(:total_pages) %>
        <div class="card-footer bg-transparent border-0">
          <%= paginate @orders %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-bag-x fs-1 text-muted"></i>
        </div>
        <h5 class="text-muted mb-3">No Orders Found</h5>
        <p class="text-muted mb-4">Orders will appear here once customers start making purchases.</p>
        <%= link_to "Create Booking", new_admin_booking_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Search functionality
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('tbody tr');

  searchInput?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();

    tableRows.forEach(row => {
      const orderNumber = row.cells[0]?.textContent.toLowerCase() || '';
      const customerName = row.cells[1]?.textContent.toLowerCase() || '';
      const statusInfo = row.cells[4]?.textContent.toLowerCase() || '';
      const paymentInfo = row.cells[5]?.textContent.toLowerCase() || '';

      if (orderNumber.includes(searchTerm) ||
          customerName.includes(searchTerm) ||
          statusInfo.includes(searchTerm) ||
          paymentInfo.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
});
</script>

<!-- Stage Conversion Modals -->

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" aria-labelledby="processingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info-subtle">
        <h5 class="modal-title" id="processingModalLabel">
          <i class="bi bi-gear me-2"></i>Move Order to Processing
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="processingForm" method="post" action="">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :status, 'processing' %>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            This order will be moved to processing stage. The warehouse team will be notified to prepare the order.
          </div>
          <div class="mb-3">
            <label for="processing_notes" class="form-label">Processing Notes (Optional)</label>
            <textarea class="form-control" id="processing_notes" name="processing_notes" rows="3" placeholder="Add any special processing instructions..."></textarea>
          </div>
          <div class="mb-3">
            <label for="estimated_processing_time" class="form-label">Estimated Processing Time</label>
            <select class="form-select" id="estimated_processing_time" name="estimated_processing_time">
              <option value="1">1-2 hours</option>
              <option value="4">4-6 hours</option>
              <option value="24" selected>1 day</option>
              <option value="48">2 days</option>
              <option value="72">3 days</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-info">
            <i class="bi bi-gear me-1"></i>Start Processing
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Packed Modal -->
<div class="modal fade" id="packedModal" tabindex="-1" aria-labelledby="packedModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title" id="packedModalLabel">
          <i class="bi bi-box me-2"></i>Mark Order as Packed
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="packedForm" method="post" action="">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :status, 'packed' %>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Order has been packed and is ready for shipment. Please verify all items are included.
          </div>
          <div class="mb-3">
            <label for="packed_by" class="form-label">Packed By</label>
            <input type="text" class="form-control" id="packed_by" name="packed_by" placeholder="Enter packer name">
          </div>
          <div class="mb-3">
            <label for="package_weight" class="form-label">Package Weight (kg)</label>
            <input type="number" class="form-control" id="package_weight" name="package_weight" step="0.1" placeholder="Enter package weight">
          </div>
          <div class="mb-3">
            <label for="package_dimensions" class="form-label">Package Dimensions (L x W x H cm)</label>
            <input type="text" class="form-control" id="package_dimensions" name="package_dimensions" placeholder="e.g., 30 x 20 x 15">
          </div>
          <div class="mb-3">
            <label for="packing_notes" class="form-label">Packing Notes</label>
            <textarea class="form-control" id="packing_notes" name="packing_notes" rows="3" placeholder="Any special packing details..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-box me-1"></i>Mark as Packed
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Shipped Modal -->
<div class="modal fade" id="shippedModal" tabindex="-1" aria-labelledby="shippedModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary-subtle">
        <h5 class="modal-title" id="shippedModalLabel">
          <i class="bi bi-truck me-2"></i>Ship Order
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="shippedForm" method="post" action="">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :status, 'shipped' %>
        <div class="modal-body">
          <div class="alert alert-primary">
            <i class="bi bi-truck me-2"></i>
            Order will be marked as shipped. A tracking number will be generated automatically if not provided.
          </div>
          <div class="mb-3">
            <label for="shipping_carrier" class="form-label">Shipping Carrier <span class="text-danger">*</span></label>
            <select class="form-select" id="shipping_carrier" name="shipping_carrier" required>
              <option value="">Select Carrier</option>
              <option value="fedex">FedEx</option>
              <option value="ups">UPS</option>
              <option value="dhl">DHL</option>
              <option value="bluedart">BlueDart</option>
              <option value="dtdc">DTDC</option>
              <option value="ecom">Ecom Express</option>
              <option value="delhivery">Delhivery</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="tracking_number" class="form-label">Tracking Number</label>
            <input type="text" class="form-control" id="tracking_number" name="tracking_number" placeholder="Enter tracking number (auto-generated if empty)">
          </div>
          <div class="mb-3">
            <label for="estimated_delivery" class="form-label">Estimated Delivery Date</label>
            <input type="date" class="form-control" id="estimated_delivery" name="estimated_delivery" value="<%= (Date.current + 3.days).strftime('%Y-%m-%d') %>">
          </div>
          <div class="mb-3">
            <label for="shipping_cost" class="form-label">Shipping Cost (₹)</label>
            <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" placeholder="Enter shipping cost">
          </div>
          <div class="mb-3">
            <label for="shipping_notes" class="form-label">Shipping Notes</label>
            <textarea class="form-control" id="shipping_notes" name="shipping_notes" rows="3" placeholder="Add any shipping instructions..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-truck me-1"></i>Ship Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delivered Modal -->
<div class="modal fade" id="deliveredModal" tabindex="-1" aria-labelledby="deliveredModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success-subtle">
        <h5 class="modal-title" id="deliveredModalLabel">
          <i class="bi bi-check-circle me-2"></i>Mark Order as Delivered
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="deliveredForm" method="post" action="">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :status, 'delivered' %>
        <div class="modal-body">
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            Order has been successfully delivered to the customer. This action marks the order as complete.
          </div>
          <div class="mb-3">
            <label for="delivered_to" class="form-label">Delivered To</label>
            <input type="text" class="form-control" id="delivered_to" name="delivered_to" placeholder="Name of person who received the order">
          </div>
          <div class="mb-3">
            <label for="delivery_date" class="form-label">Delivery Date & Time</label>
            <input type="datetime-local" class="form-control" id="delivery_date" name="delivery_date" value="<%= Time.current.strftime('%Y-%m-%dT%H:%M') %>">
          </div>
          <div class="mb-3">
            <label for="delivery_location" class="form-label">Delivery Location</label>
            <select class="form-select" id="delivery_location" name="delivery_location">
              <option value="home">Home</option>
              <option value="office">Office</option>
              <option value="neighbour">Neighbour</option>
              <option value="security">Security/Reception</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="delivery_proof" class="form-label">Delivery Proof</label>
            <input type="file" class="form-control" id="delivery_proof" name="delivery_proof" accept="image/*">
            <div class="form-text">Upload photo proof of delivery (optional)</div>
          </div>
          <div class="mb-3">
            <label for="delivery_notes" class="form-label">Delivery Notes</label>
            <textarea class="form-control" id="delivery_notes" name="delivery_notes" rows="3" placeholder="Any delivery details or customer feedback..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>Mark as Delivered
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancelled Modal -->
<div class="modal fade" id="cancelledModal" tabindex="-1" aria-labelledby="cancelledModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger-subtle">
        <h5 class="modal-title" id="cancelledModalLabel">
          <i class="bi bi-x-circle me-2"></i>Cancel Order
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="cancelledForm" method="post" action="">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :status, 'cancelled' %>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action will cancel the order. Please ensure you have customer consent before proceeding.
          </div>
          <div class="mb-3">
            <label for="cancellation_reason" class="form-label">Cancellation Reason <span class="text-danger">*</span></label>
            <select class="form-select" id="cancellation_reason" name="cancellation_reason" required>
              <option value="">Select Reason</option>
              <option value="customer_request">Customer Request</option>
              <option value="out_of_stock">Out of Stock</option>
              <option value="payment_failed">Payment Failed</option>
              <option value="address_issue">Address Issue</option>
              <option value="duplicate_order">Duplicate Order</option>
              <option value="fraud_suspected">Fraud Suspected</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="refund_method" class="form-label">Refund Method</label>
            <select class="form-select" id="refund_method" name="refund_method">
              <option value="">No Refund Required</option>
              <option value="original_payment">Original Payment Method</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="store_credit">Store Credit</option>
              <option value="cash">Cash</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="refund_amount" class="form-label">Refund Amount (₹)</label>
            <input type="number" class="form-control" id="refund_amount" name="refund_amount" step="0.01" placeholder="Enter refund amount">
          </div>
          <div class="mb-3">
            <label for="cancellation_notes" class="form-label">Cancellation Notes <span class="text-danger">*</span></label>
            <textarea class="form-control" id="cancellation_notes" name="cancellation_notes" rows="3" placeholder="Provide detailed reason for cancellation..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Order</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-1"></i>Cancel Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Stage Modal Functions
let currentOrderId = null;

function openStageModal(stage, orderId, orderNumber) {
  currentOrderId = orderId;

  // Update modal title and form action
  const modal = document.getElementById(stage + 'Modal');
  const form = document.getElementById(stage + 'Form');

  if (modal && form) {
    // Set the form action to the update_status endpoint
    form.action = `/admin/orders/${orderId}/update_status`;

    // Update modal title with order number
    const titleElement = modal.querySelector('.modal-title');
    const titleText = titleElement.innerHTML;
    titleElement.innerHTML = titleText.split(' - Order')[0] + ` - Order ${orderNumber}`;

    // Show the modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
  }
}

// Form submission handlers
document.addEventListener('DOMContentLoaded', function() {
  const forms = ['processingForm', 'packedForm', 'shippedForm', 'deliveredForm', 'cancelledForm'];

  forms.forEach(formId => {
    const form = document.getElementById(formId);
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        // Disable button and show loading
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="bi bi-spinner-border spinner-border-sm me-1"></i>Processing...';

        // Submit via fetch
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            location.reload();
          } else {
            alert(data.message || 'Error updating order status');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating order status');
        })
        .finally(() => {
          // Re-enable button
          submitButton.disabled = false;
          submitButton.innerHTML = originalText;
        });
      });
    }
  });
});
</script>