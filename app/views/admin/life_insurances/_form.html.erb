<%= form_with model: [:admin, @life_insurance], local: true, class: "needs-validation", novalidate: true do |form| %>

  <!-- Client & Agent Details Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-person me-2 text-primary"></i>
        Client & Agent Details
      </h5>
    </div>
    <div class="card-body">
      <% if @life_insurance.errors.any? %>
        <div class="alert alert-danger alert-dismissible fade show">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Please correct the following errors:</strong>
          <ul class="mb-0 mt-2">
            <% @life_insurance.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% end %>

      <div class="row">
        <div class="col-md-4 mb-3">
          <%= form.label :customer_id, "Client Name*", class: "form-label" %>
          <%= form.select :customer_id,
              options_for_select(@customers.map { |c| [c.display_name, c.id] }, @life_insurance.customer_id),
              { prompt: 'Search and select client...' },
              { class: "form-control #{'is-invalid' if @life_insurance.errors[:customer_id].any?}", required: true, id: "customer_select", data: { placeholder: "Type to search clients..." } } %>
          <% if @life_insurance.errors[:customer_id].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:customer_id].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :policy_holder, "Policy Holder", class: "form-label" %>
          <%= form.select :policy_holder,
              options_for_select([['Self', 'Self']], @life_insurance.policy_holder),
              { prompt: 'Select Policy Holder' },
              { class: "form-control", id: "policy_holder_select" } %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :sub_agent_id, "Affiliate", class: "form-label" %>
          <%= form.select :sub_agent_id,
              options_for_select(@sub_agents.map { |a| [a.display_name, a.id] }, @life_insurance.sub_agent_id),
              { prompt: 'Search and select affiliate...' },
              { class: "form-control", id: "affiliate_select", data: { placeholder: "Type to search affiliates..." } } %>
        </div>
      </div>

      <div class="row">
        <!-- Investor selection removed - commission is collectively distributed -->

        <div class="col-md-6 mb-3">
          <%= form.label :insured_name, "Insured Name", class: "form-label" %>
          <%= form.text_field :insured_name,
              class: "form-control",
              placeholder: "Enter insured name" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Policy Details Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-file-text me-2 text-primary"></i>
        Policy Details
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- 1st: Broker Code dropdown with Direct/Broking options -->
        <div class="col-md-4 mb-3">
          <%= form.label :broker_code_type, "Broker Code", class: "form-label" %>
          <%= form.select :broker_code_type,
              options_for_select([
                ['Direct', 'direct'],
                ['Broking', 'broking']
              ], @life_insurance.broker_code_type),
              { prompt: 'Select Broker Code' },
              { class: "form-control", id: "life_insurance_broker_code_type" } %>
        </div>

        <!-- 2nd: Agency Code (shows Agents when Direct selected, Brokers when Broking selected) -->
        <div class="col-md-4 mb-3">
          <%= form.label :agency_code_id, "Agency Code", class: "form-label" %>
          <span class="dynamic-label" id="agency_code_label_text"></span>
          <%= form.select :agency_code_id,
              options_for_select(@agency_codes.map { |a| ["#{a.agent_name} - #{a.code}", a.id] }, @life_insurance.agency_code_id),
              { prompt: 'Select Agency Code' },
              { class: "form-control", id: "life_insurance_agency_code_id" } %>
        </div>

        <!-- Hidden field for broker_id when needed -->
        <%= form.hidden_field :broker_id, id: "broker_id_hidden" %>

        <!-- 3rd: Insurance Company Name (Dynamic based on Agent/Broker selection) -->
        <div class="col-md-4 mb-3">
          <%= form.label :insurance_company_name, "Insurance Company Name*", class: "form-label" %>
          <%= form.select :insurance_company_name,
              options_for_select(@insurance_companies.map { |c| [c, c] }, @life_insurance.insurance_company_name),
              { prompt: 'Search and select company...' },
              { class: "form-control #{'is-invalid' if @life_insurance.errors[:insurance_company_name].any?}", required: true, id: "life_insurance_insurance_company_name", data: { placeholder: "Type to search companies..." } } %>
          <% if @life_insurance.errors[:insurance_company_name].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:insurance_company_name].first %></div>
          <% end %>
        </div>
      </div>

      <div class="row">

        <div class="col-md-4 mb-3">
          <%= form.label :policy_type, "Policy Type*", class: "form-label" %>
          <%= form.select :policy_type,
              options_for_select(@policy_types.map { |t| [t, t] }, @life_insurance.policy_type),
              { prompt: 'Select type' },
              { class: "form-control #{'is-invalid' if @life_insurance.errors[:policy_type].any?}", required: true } %>
          <% if @life_insurance.errors[:policy_type].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:policy_type].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :payment_mode, "Payment Mode*", class: "form-label" %>
          <%= form.select :payment_mode,
              options_for_select(@payment_modes.map { |m| [m, m] }, @life_insurance.payment_mode),
              { prompt: 'Select Payment Mode' },
              { class: "form-control #{'is-invalid' if @life_insurance.errors[:payment_mode].any?}", required: true } %>
          <% if @life_insurance.errors[:payment_mode].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:payment_mode].first %></div>
          <% end %>
        </div>


        <div class="col-md-4 mb-3">
          <%= form.label :policy_number, "Policy Number*", class: "form-label" %>
          <%= form.text_field :policy_number,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:policy_number].any?}",
              placeholder: "Enter unique policy number", required: true %>
          <% if @life_insurance.errors[:policy_number].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:policy_number].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :policy_booking_date, "Policy Booking Date", class: "form-label" %>
          <%= form.date_field :policy_booking_date,
              class: "form-control",
              value: @life_insurance.policy_booking_date || Date.current %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :policy_start_date, "Policy Start Date*", class: "form-label" %>
          <%= form.date_field :policy_start_date,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:policy_start_date].any?}",
              required: true, id: "start_date" %>
          <% if @life_insurance.errors[:policy_start_date].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:policy_start_date].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :policy_end_date, "Policy End Date*", class: "form-label" %>
          <%= form.date_field :policy_end_date,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:policy_end_date].any?}",
              required: true, id: "end_date" %>
          <% if @life_insurance.errors[:policy_end_date].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:policy_end_date].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :risk_start_date, "Risk Start Date", class: "form-label" %>
          <%= form.date_field :risk_start_date,
              class: "form-control" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :policy_term, "Policy Term (Y)*", class: "form-label" %>
          <%= form.select :policy_term,
              options_for_select([
                ['1 Year', 1],
                ['2 Years', 2],
                ['3 Years', 3],
                ['5 Years', 5],
                ['10 Years', 10],
                ['15 Years', 15],
                ['20 Years', 20],
                ['25 Years', 25],
                ['30 Years', 30]
              ], @life_insurance.policy_term),
              { prompt: 'Select Policy Term' },
              { class: "form-select #{'is-invalid' if @life_insurance.errors[:policy_term].any?}", required: true, id: "policy_term_select" } %>
          <% if @life_insurance.errors[:policy_term].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:policy_term].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :premium_payment_term, "Premium Payment Term*", class: "form-label" %>
          <%= form.number_field :premium_payment_term,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:premium_payment_term].any?}",
              placeholder: "Years", required: true, min: 1, step: 1, id: "premium_payment_term" %>
          <% if @life_insurance.errors[:premium_payment_term].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:premium_payment_term].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :plan_name, "Plan Name", class: "form-label" %>
          <%= form.text_field :plan_name,
              class: "form-control",
              placeholder: "Enter plan name" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :sum_insured, "Sum Insured", class: "form-label" %>
          <%= form.select :sum_insured,
              options_for_select([
                ['₹5 Lakhs', 500000],
                ['₹10 Lakhs', 1000000],
                ['₹15 Lakhs', 1500000],
                ['₹20 Lakhs', 2000000],
                ['₹25 Lakhs', 2500000],
                ['₹50 Lakhs', 5000000],
                ['₹75 Lakhs', 7500000],
                ['₹1 Crore', 10000000],
                ['₹1.5 Crore', 15000000],
                ['₹2 Crore', 20000000],
                ['₹5 Crore', 50000000]
              ], @life_insurance.sum_insured),
              { prompt: 'Select Sum Insured' },
              { class: "form-control #{'is-invalid' if @life_insurance.errors[:sum_insured].any?}", required: true } %>
          <% if @life_insurance.errors[:sum_insured].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:sum_insured].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :net_premium, "Net Premium*", class: "form-label" %>
          <%= form.number_field :net_premium,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:net_premium].any?}",
              placeholder: "0", step: 0.01, required: true, id: "net_premium" %>
          <% if @life_insurance.errors[:net_premium].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:net_premium].first %></div>
          <% end %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :first_year_gst_percentage, "1st Year GST %*", class: "form-label" %>
          <%= form.number_field :first_year_gst_percentage,
              class: "form-control",
              value: @life_insurance.first_year_gst_percentage || 18,
              step: 0.01, id: "first_year_gst" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :second_year_gst_percentage, "2nd Year GST %", class: "form-label" %>
          <%= form.number_field :second_year_gst_percentage,
              class: "form-control",
              value: @life_insurance.second_year_gst_percentage || 0,
              step: 0.01 %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :third_year_gst_percentage, "3rd Year GST %", class: "form-label" %>
          <%= form.number_field :third_year_gst_percentage,
              class: "form-control",
              value: @life_insurance.third_year_gst_percentage || 0,
              step: 0.01 %>
        </div>

        <div class="col-md-4 mb-3">
          <%= form.label :total_premium, "Total Premium*", class: "form-label" %>
          <%= form.number_field :total_premium,
              class: "form-control #{'is-invalid' if @life_insurance.errors[:total_premium].any?}",
              placeholder: "0", step: 0.01, required: true, readonly: true, id: "total_premium" %>
          <% if @life_insurance.errors[:total_premium].any? %>
            <div class="invalid-feedback"><%= @life_insurance.errors[:total_premium].first %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>


  <!-- Nominee Details Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-people me-2 text-primary"></i>
        Nominee Details
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= form.label :nominee_name, "Name", class: "form-label" %>
          <%= form.text_field :nominee_name,
              class: "form-control",
              placeholder: "Nominee Name" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :nominee_relationship, "Relationship", class: "form-label" %>
          <%= form.select :nominee_relationship,
              options_for_select(@relationships.map { |r| [r, r] }, @life_insurance.nominee_relationship),
              { prompt: 'Nominee Relationship' },
              { class: "form-control" } %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :nominee_age, "Age", class: "form-label" %>
          <%= form.number_field :nominee_age,
              class: "form-control",
              placeholder: "Nominee Age" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Bank Details Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-bank me-2 text-primary"></i>
        Bank Details
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= form.label :bank_name, "Bank Name", class: "form-label" %>
          <%= form.text_field :bank_name,
              class: "form-control",
              placeholder: "Bank Name" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :account_type, "Account Type", class: "form-label" %>
          <%= form.select :account_type,
              options_for_select(@account_types.map { |t| [t, t] }, @life_insurance.account_type),
              { prompt: 'Account Type' },
              { class: "form-control" } %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :account_number, "Account Number", class: "form-label" %>
          <%= form.text_field :account_number,
              class: "form-control",
              placeholder: "Account Number" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :ifsc_code, "IFSC CODE", class: "form-label" %>
          <%= form.text_field :ifsc_code,
              class: "form-control",
              placeholder: "IFSC CODE" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :account_holder_name, "Account Holder Name", class: "form-label" %>
          <%= form.text_field :account_holder_name,
              class: "form-control",
              placeholder: "Holder Name" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Details Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-info-circle me-2 text-primary"></i>
        Other Details
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :reference_by_name, "Reference By Name", class: "form-label" %>
          <%= form.text_field :reference_by_name,
              class: "form-control",
              placeholder: "Enter reference name" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :broker_name, "Broker Name", class: "form-label" %>
          <%= form.text_field :broker_name,
              class: "form-control",
              placeholder: "Broker Name" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :bonus, "Bonus", class: "form-label" %>
          <%= form.number_field :bonus,
              class: "form-control",
              value: @life_insurance.bonus || 0,
              step: 0.01 %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :fund, "Fund", class: "form-label" %>
          <%= form.number_field :fund,
              class: "form-control",
              value: @life_insurance.fund || 0,
              step: 0.01 %>
        </div>
        <div class="col-12 mb-3">
          <%= form.label :extra_note, "Extra Note", class: "form-label" %>
          <%= form.text_area :extra_note,
              class: "form-control",
              rows: 4,
              placeholder: "Enter additional notes or comments..." %>
        </div>
      </div>
    </div>
  </div>

  <!-- Commission Detail Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-percent me-2 text-primary"></i>
        Commission Detail
      </h5>
    </div>
    <div class="card-body">
      <h6>Main Agent Commission</h6>
      <div class="row">
        <div class="col-md-2 mb-3">
          <label class="form-label">1st year (%)</label>
          <%= form.number_field :main_agent_commission_percentage,
              class: "form-control",
              value: @life_insurance.main_agent_commission_percentage || 0,
              step: 0.01, id: "commission_percentage" %>
        </div>
        <div class="col-md-5 mb-3">
          <%= form.label :commission_amount, "Commission Amount", class: "form-label" %>
          <%= form.number_field :commission_amount,
              class: "form-control",
              value: @life_insurance.commission_amount || 0,
              step: 0.01, readonly: true, id: "commission_amount" %>
        </div>
        <div class="col-md-5 mb-3">
          <%= form.label :tds_percentage, "TDS %", class: "form-label" %>
          <%= form.number_field :tds_percentage,
              class: "form-control",
              value: @life_insurance.tds_percentage || 0,
              step: 0.01, id: "tds_percentage" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :tds_amount, "TDS Amount", class: "form-label" %>
          <%= form.number_field :tds_amount,
              class: "form-control",
              value: @life_insurance.tds_amount || 0,
              step: 0.01, readonly: true, id: "tds_amount" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :after_tds_value, "After TDS Value", class: "form-label" %>
          <%= form.number_field :after_tds_value,
              class: "form-control",
              value: @life_insurance.after_tds_value || 0,
              step: 0.01, readonly: true, id: "after_tds_value" %>
        </div>
      </div>

      <!-- Affiliate Commission -->
      <hr class="my-4">
      <h6>Affiliate Commission</h6>
      <div class="row">
        <div class="col-md-2 mb-3">
          <label class="form-label">1st year (%)</label>
          <%= form.number_field :sub_agent_commission_percentage,
              class: "form-control sub-agent-commission-percentage",
              value: @life_insurance.sub_agent_commission_percentage || 2.0,
              step: 0.01 %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">Commission Amount</label>
          <%= form.number_field :sub_agent_commission_amount,
              class: "form-control sub-agent-commission-amount",
              value: @life_insurance.sub_agent_commission_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">TDS %</label>
          <%= form.number_field :sub_agent_tds_percentage,
              class: "form-control sub-agent-tds-percentage",
              value: @life_insurance.sub_agent_tds_percentage || 0,
              step: 0.01 %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">TDS Amount</label>
          <%= form.number_field :sub_agent_tds_amount,
              class: "form-control sub-agent-tds-amount",
              value: @life_insurance.sub_agent_tds_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">After TDS Value</label>
          <%= form.number_field :sub_agent_after_tds_value,
              class: "form-control sub-agent-after-tds-value",
              value: @life_insurance.sub_agent_after_tds_value || 0,
              step: 0.01, readonly: true %>
        </div>
      </div>

      <!-- Ambassador Commission -->
      <hr class="my-4">
      <h6>Ambassador Commission</h6>
      <div class="row">
        <div class="col-md-2 mb-3">
          <label class="form-label">1st year (%)</label>
          <%= form.number_field :ambassador_commission_percentage,
              class: "form-control ambassador-commission-percentage",
              value: @life_insurance.ambassador_commission_percentage || 2.0,
              step: 0.01 %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">Commission Amount</label>
          <%= form.number_field :ambassador_commission_amount,
              class: "form-control ambassador-commission-amount",
              value: @life_insurance.ambassador_commission_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">TDS %</label>
          <%= form.number_field :ambassador_tds_percentage,
              class: "form-control ambassador-tds-percentage",
              value: @life_insurance.ambassador_tds_percentage || 0,
              step: 0.01 %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">TDS Amount</label>
          <%= form.number_field :ambassador_tds_amount,
              class: "form-control ambassador-tds-amount",
              value: @life_insurance.ambassador_tds_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">After TDS Value</label>
          <%= form.number_field :ambassador_after_tds_value,
              class: "form-control ambassador-after-tds-value",
              value: @life_insurance.ambassador_after_tds_value || 0,
              step: 0.01, readonly: true %>
        </div>
      </div>

      <!-- Investor Portion -->
      <hr class="my-4">
      <h6>Investor Portion</h6>
      <div class="row">
        <div class="col-md-2 mb-3">
          <label class="form-label">1st year (%)</label>
          <%= form.number_field :investor_commission_percentage,
              class: "form-control investor-commission-percentage",
              value: @life_insurance.investor_commission_percentage || 2.0,
              step: 0.01 %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">Amount</label>
          <%= form.number_field :investor_commission_amount,
              class: "form-control investor-commission-amount",
              value: @life_insurance.investor_commission_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label">TDS %</label>
          <%= form.number_field :investor_tds_percentage,
              class: "form-control investor-tds-percentage",
              value: @life_insurance.investor_tds_percentage || 0,
              step: 0.01 %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">TDS Amount</label>
          <%= form.number_field :investor_tds_amount,
              class: "form-control investor-tds-amount",
              value: @life_insurance.investor_tds_amount || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">After TDS Value</label>
          <%= form.number_field :investor_after_tds_value,
              class: "form-control investor-after-tds-value",
              value: @life_insurance.investor_after_tds_value || 0,
              step: 0.01, readonly: true %>
        </div>
      </div>

      <!-- Company Expenses & Profit Calculation -->
      <hr class="my-4">
      <h6>Company Expenses & Profit Calculation</h6>
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Company Expenses (%)</label>
          <%= form.number_field :company_expenses_percentage,
              class: "form-control company-expenses-percentage",
              value: @life_insurance.company_expenses_percentage || 2.0,
              step: 0.01, min: 0, max: 100 %>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Total Distribution (%)</label>
          <%= form.number_field :total_distribution_percentage,
              class: "form-control total-distribution-percentage",
              value: @life_insurance.total_distribution_percentage || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Profit (%)</label>
          <%= form.number_field :profit_percentage,
              class: "form-control profit-percentage",
              value: @life_insurance.profit_percentage || 0,
              step: 0.01, readonly: true %>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Profit Amount (₹)</label>
          <%= form.number_field :profit_amount,
              class: "form-control profit-amount",
              value: @life_insurance.profit_amount || 0,
              step: 0.01, readonly: true %>
        </div>
      </div>

      <div class="alert alert-info mt-3">
        <h6 class="mb-2">Commission Calculation Summary:</h6>
        <ul class="mb-0">
          <li><strong>Main Agent Commission:</strong> <span id="main-income-display">0%</span> of Net Premium</li>
          <li><strong>Total Distribution:</strong> <span id="distribution-display">6.0%</span> (Affiliate + Ambassador + Investor)</li>
          <li><strong>Company Expenses:</strong> <span id="expenses-display">2.0%</span> of Net Premium</li>
          <li><strong>Profit:</strong> Main Agent Commission - Total Distribution - Company Expenses</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Policy Upload Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-cloud-upload me-2 text-primary"></i>
        Policy Upload
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :policy_documents, "Upload Policy", class: "form-label" %>
          <%= form.file_field :policy_documents,
              class: "form-control",
              multiple: true %>
          <div class="form-text">Click to upload or drag and drop</div>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :documents, "Upload Documents", class: "form-label" %>
          <%= form.file_field :documents,
              class: "form-control",
              multiple: true %>
          <div class="form-text">Upload additional documents</div>
        </div>
      </div>

      <!-- Existing Documents (Edit Mode) -->
      <% if @life_insurance.persisted? && @life_insurance.uploaded_documents.any? %>
        <div class="border-top pt-4 mt-4">
          <h6 class="mb-3">Current Documents</h6>
          <div class="row">
            <% @life_insurance.uploaded_documents.each do |document| %>
              <div class="col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="flex-shrink-0">
                        <i class="bi bi-<%= document.file_icon %> text-primary fs-4"></i>
                      </div>
                      <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1"><%= document.title %></h6>
                        <small class="text-muted">
                          <%= document.human_document_type %> •
                          <%= document.human_file_type %>
                          <% if document.file_size %>
                            • <%= number_to_human_size(document.file_size) %>
                          <% end %>
                        </small>
                        <% if document.description.present? %>
                          <p class="text-muted mt-1 mb-0 small"><%= document.description %></p>
                        <% end %>
                      </div>
                      <div class="flex-shrink-0">
                        <div class="btn-group">
                          <%= link_to admin_document_path(document), class: "btn btn-sm btn-outline-info", target: "_blank", title: "View" do %>
                            <i class="bi bi-eye"></i>
                          <% end %>
                          <%= link_to download_admin_document_path(document), class: "btn btn-sm btn-outline-primary", target: "_blank", title: "Download" do %>
                            <i class="bi bi-download"></i>
                          <% end %>
                          <%= link_to admin_document_path(document), method: :delete,
                              class: "btn btn-sm btn-outline-danger",
                              title: "Delete",
                              confirm: "Are you sure you want to delete this document?",
                              data: { turbo_method: :delete } do %>
                            <i class="bi bi-trash"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- New Document System -->
      <div class="border-top pt-4 mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">
            <% if @life_insurance.persisted? %>
              Add More Documents
            <% else %>
              Document Management System
            <% end %>
          </h6>
          <button type="button" class="btn btn-sm btn-primary" id="add_policy_document">
            <i class="bi bi-plus-lg me-1"></i>
            Add Document
          </button>
        </div>

        <div id="policy_documents_container">
          <!-- New document system will be added here -->
        </div>

        <p class="text-muted mb-0 mt-2">
          <small>Use this system to add organized documents with titles and types</small>
        </p>
      </div>
    </div>
  </div>

  <!-- Autopay Installment Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-calendar-event me-2 text-primary"></i>
        Autopay Installment
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :installment_autopay_start_date, "Installment Autopay Start Date", class: "form-label" %>
          <%= form.date_field :installment_autopay_start_date,
              class: "form-control",
              value: @life_insurance.installment_autopay_start_date || Date.current %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :installment_autopay_end_date, "Installment Autopay End Date", class: "form-label" %>
          <%= form.date_field :installment_autopay_end_date,
              class: "form-control",
              value: @life_insurance.installment_autopay_end_date || Date.current %>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <div>
          <%= link_to admin_life_insurances_path, class: "btn btn-outline-secondary" do %>
            <i class="bi bi-x-lg me-2"></i>
            Back to List
          <% end %>
        </div>
        <div>
          <%= form.submit "Save Policy", class: "btn btn-primary btn-lg" %>
        </div>
      </div>
    </div>
  </div>

<% end %>

<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS for searchable dropdown -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Custom styling for enhanced Select2 dropdown -->
<style>
  .select2-container--bootstrap-5 .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .select2-container--bootstrap-5 .select2-selection--single:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .select2-container--bootstrap-5 .select2-selection__rendered {
    color: #495057;
    padding-left: 12px;
    padding-right: 20px;
    line-height: 36px;
  }

  .select2-container--bootstrap-5 .select2-results__option {
    padding: 8px 12px;
  }

  .select2-container--bootstrap-5 .select2-results__option--highlighted {
    background-color: #0d6efd;
    color: white;
  }

  .select2-dropdown {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }

  .select2-results__options {
    max-height: 400px !important;
    min-height: 200px;
  }

  .select2-dropdown-large .select2-results__options {
    max-height: 600px !important;
    min-height: 400px !important;
    overflow-y: auto;
  }

  .select2-dropdown-large {
    min-width: 100% !important;
  }

  .select2-dropdown-large .select2-results__option {
    padding: 8px 12px !important;
    min-height: 45px;
    display: flex;
    align-items: center;
  }

  .select2-search__field {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    padding: 6px 12px;
  }

  .client-option {
    display: flex;
    align-items: center;
    padding: 8px 0;
    min-height: 45px;
  }

  .client-option-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(45deg, #0d6efd, #6f42c1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 10px;
    font-size: 13px;
    flex-shrink: 0;
  }

  .client-option-details {
    flex: 1;
  }

  .client-option-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 2px;
  }

  .client-option-id {
    font-size: 11px;
    color: #6c757d;
  }

  /* Affiliate option styling */
  .affiliate-option {
    display: flex;
    align-items: center;
    padding: 8px 0;
    min-height: 45px;
  }

  .affiliate-option-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 10px;
    font-size: 13px;
    flex-shrink: 0;
  }

  .affiliate-option-details {
    flex: 1;
  }

  .affiliate-option-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 2px;
  }

  .affiliate-option-id {
    font-size: 11px;
    color: #6c757d;
  }

  /* Company option styling */
  .company-option {
    display: flex;
    align-items: center;
    padding: 8px 0;
    min-height: 45px;
  }

  .company-option-avatar {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(45deg, #dc3545, #fd7e14);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 10px;
    font-size: 12px;
    flex-shrink: 0;
  }

  .company-option-details {
    flex: 1;
  }

  .company-option-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 2px;
  }

  .company-option-type {
    font-size: 11px;
    color: #6c757d;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Select2 for searchable dropdown
  $('#customer_select').select2({
    theme: 'bootstrap-5',
    placeholder: 'Search and select client...',
    allowClear: true,
    width: '100%',
    dropdownParent: $('body'),
    dropdownCssClass: 'select2-dropdown-large',
    minimumResultsForSearch: 0,
    closeOnSelect: true,
    templateResult: function(option) {
      if (!option.id || option.element.value === '') {
        return option.text;
      }

      // Generate avatar with initials
      var initials = option.text.split(' ').map(function(name) {
        return name.charAt(0).toUpperCase();
      }).join('').substring(0, 2);

      // Custom template for dropdown options with avatar
      var $option = $(
        '<div class="client-option">' +
          '<div class="client-option-avatar">' + initials + '</div>' +
          '<div class="client-option-details">' +
            '<div class="client-option-name">' + option.text + '</div>' +
            '<div class="client-option-id">Client ID: #' + option.id + '</div>' +
          '</div>' +
        '</div>'
      );
      return $option;
    },
    templateSelection: function(option) {
      return option.text || 'Search and select client...';
    },
    escapeMarkup: function(markup) {
      return markup;
    }
  });

  // Initialize Select2 for Affiliate dropdown with AJAX search
  $('#affiliate_select').select2({
    theme: 'bootstrap-5',
    placeholder: 'Search and select affiliate...',
    allowClear: true,
    width: '100%',
    dropdownParent: $('body'),
    dropdownCssClass: 'select2-dropdown-large',
    minimumInputLength: 0, // Allow opening without typing
    ajax: {
      url: '/api/v1/public/search_sub_agents',
      dataType: 'json',
      delay: 250,
      data: function (params) {
        // Get the selected customer ID to filter affiliates
        var selectedCustomerId = $('#customer_select').val();

        return {
          q: params.term || '', // Send empty query to get default results
          customer_id: selectedCustomerId, // Pass customer ID for filtering
          limit: params.term ? 20 : 10 // Show fewer results when no search term
        };
      },
      processResults: function (data) {
        console.log('Search affiliates response:', data);
        return {
          results: data.results || []
        };
      },
      error: function(xhr, status, error) {
        console.error('Search affiliates AJAX error:', status, error);
        return {
          results: [{id: '', text: 'Error loading affiliates - please try again'}]
        };
      },
      cache: false // Disable cache so customer changes refresh the affiliate list
    },
    templateResult: function(option) {
      if (option.loading) return option.text;
      if (!option.id || option.id === '') {
        return option.text;
      }

      // Generate avatar with initials
      var initials = option.text.split(' ').map(function(name) {
        return name.charAt(0).toUpperCase();
      }).join('').substring(0, 2);

      // Custom template for affiliate options with green avatar
      var $option = $(
        '<div class="affiliate-option">' +
          '<div class="affiliate-option-avatar">' + initials + '</div>' +
          '<div class="affiliate-option-details">' +
            '<div class="affiliate-option-name">' + option.text + '</div>' +
            '<div class="affiliate-option-id">Affiliate ID: #' + option.id + '</div>' +
          '</div>' +
        '</div>'
      );
      return $option;
    },
    templateSelection: function(option) {
      return option.text || 'Search and select affiliate...';
    },
    escapeMarkup: function(markup) {
      return markup;
    }
  });

  // Initialize Select2 for Insurance Company dropdown
  $('#life_insurance_insurance_company_name').select2({
    theme: 'bootstrap-5',
    placeholder: 'Search and select company...',
    allowClear: true,
    width: '100%',
    dropdownParent: $('body'),
    dropdownCssClass: 'select2-dropdown-large',
    minimumResultsForSearch: 0,
    closeOnSelect: true,
    templateResult: function(option) {
      if (!option.id || option.element.value === '') {
        return option.text;
      }

      // Generate company initials
      var initials = option.text.split(' ').map(function(word) {
        return word.charAt(0).toUpperCase();
      }).join('').substring(0, 3);

      // Custom template for company options with square orange avatar
      var $option = $(
        '<div class="company-option">' +
          '<div class="company-option-avatar">' + initials + '</div>' +
          '<div class="company-option-details">' +
            '<div class="company-option-name">' + option.text + '</div>' +
            '<div class="company-option-type">Insurance Company</div>' +
          '</div>' +
        '</div>'
      );
      return $option;
    },
    templateSelection: function(option) {
      return option.text || 'Search and select company...';
    },
    escapeMarkup: function(markup) {
      return markup;
    }
  });

  // Auto-calculate total premium
  function calculateTotalPremium() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const firstYearGst = parseFloat(document.getElementById('first_year_gst').value) || 0;

    const gstAmount = netPremium * (firstYearGst / 100);
    const totalPremium = netPremium + gstAmount;

    document.getElementById('total_premium').value = totalPremium.toFixed(2);
  }

  // Auto-calculate commission amounts
  function calculateCommission() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const commissionPercentage = parseFloat(document.getElementById('commission_percentage').value) || 0;
    const tdsPercentage = parseFloat(document.getElementById('tds_percentage').value) || 0;

    const commissionAmount = netPremium * (commissionPercentage / 100);
    const tdsAmount = commissionAmount * (tdsPercentage / 100);
    const afterTdsValue = commissionAmount - tdsAmount;

    document.getElementById('commission_amount').value = commissionAmount.toFixed(2);
    document.getElementById('tds_amount').value = tdsAmount.toFixed(2);
    document.getElementById('after_tds_value').value = afterTdsValue.toFixed(2);
  }

  // Auto-calculate sub-agent commission
  function calculateSubAgentCommission() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const commissionPercentage = parseFloat(document.querySelector('.sub-agent-commission-percentage').value) || 2.0;
    const tdsPercentage = parseFloat(document.querySelector('.sub-agent-tds-percentage').value) || 0;

    const commissionAmount = netPremium * (commissionPercentage / 100);
    const tdsAmount = commissionAmount * (tdsPercentage / 100);
    const afterTdsValue = commissionAmount - tdsAmount;

    document.querySelector('.sub-agent-commission-amount').value = commissionAmount.toFixed(2);
    document.querySelector('.sub-agent-tds-amount').value = tdsAmount.toFixed(2);
    document.querySelector('.sub-agent-after-tds-value').value = afterTdsValue.toFixed(2);
  }


  // Auto-calculate ambassador commission
  function calculateAmbassadorCommission() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const commissionPercentage = parseFloat(document.querySelector('.ambassador-commission-percentage').value) || 2.0;
    const tdsPercentage = parseFloat(document.querySelector('.ambassador-tds-percentage').value) || 0;

    const commissionAmount = netPremium * (commissionPercentage / 100);
    const tdsAmount = commissionAmount * (tdsPercentage / 100);
    const afterTdsValue = commissionAmount - tdsAmount;

    document.querySelector('.ambassador-commission-amount').value = commissionAmount.toFixed(2);
    document.querySelector('.ambassador-tds-amount').value = tdsAmount.toFixed(2);
    document.querySelector('.ambassador-after-tds-value').value = afterTdsValue.toFixed(2);
  }

  // Auto-calculate investor commission
  function calculateInvestorCommission() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const commissionPercentage = parseFloat(document.querySelector('.investor-commission-percentage').value) || 2.0;
    const tdsPercentage = parseFloat(document.querySelector('.investor-tds-percentage').value) || 0;

    const commissionAmount = netPremium * (commissionPercentage / 100);
    const tdsAmount = commissionAmount * (tdsPercentage / 100);
    const afterTdsValue = commissionAmount - tdsAmount;

    document.querySelector('.investor-commission-amount').value = commissionAmount.toFixed(2);
    document.querySelector('.investor-tds-amount').value = tdsAmount.toFixed(2);
    document.querySelector('.investor-after-tds-value').value = afterTdsValue.toFixed(2);
  }

  // Calculate company expenses and profit
  function calculateProfitAndExpenses() {
    const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
    const mainAgentCommissionPercentage = parseFloat(document.getElementById('commission_percentage').value) || 0;

    // Get commission percentages
    const subAgentPercentage = parseFloat(document.querySelector('.sub-agent-commission-percentage').value) || 2.0;
    const ambassadorPercentage = parseFloat(document.querySelector('.ambassador-commission-percentage').value) || 2.0;
    const investorPercentage = parseFloat(document.querySelector('.investor-commission-percentage').value) || 2.0;
    const companyExpensesPercentage = parseFloat(document.querySelector('.company-expenses-percentage').value) || 2.0;

    // Calculate total distribution
    const totalDistributionPercentage = subAgentPercentage + ambassadorPercentage + investorPercentage;

    // Calculate profit: Main Agent Commission - Affiliate Commission - Ambassador Commission - Investor Portion - Company Expenses
    const profitPercentage = mainAgentCommissionPercentage - totalDistributionPercentage - companyExpensesPercentage;
    const profitAmount = netPremium * (profitPercentage / 100);

    // Update fields
    document.querySelector('.total-distribution-percentage').value = totalDistributionPercentage.toFixed(2);
    document.querySelector('.profit-percentage').value = profitPercentage.toFixed(2);
    document.querySelector('.profit-amount').value = profitAmount.toFixed(2);

    // Update display in summary
    document.getElementById('expenses-display').textContent = companyExpensesPercentage.toFixed(1) + '%';
    updateCommissionSummary();
  }

  // Update the commission calculation summary dynamically
  function updateCommissionSummary() {
    const mainAgentCommissionPercentage = parseFloat(document.getElementById('commission_percentage').value) || 0;
    const totalDistributionPercentage = parseFloat(document.querySelector('.total-distribution-percentage').value) || 0;
    const companyExpensesPercentage = parseFloat(document.querySelector('.company-expenses-percentage').value) || 0;

    document.getElementById('main-income-display').textContent = mainAgentCommissionPercentage.toFixed(1) + '%';
    document.getElementById('distribution-display').textContent = totalDistributionPercentage.toFixed(1) + '%';
    document.getElementById('expenses-display').textContent = companyExpensesPercentage.toFixed(1) + '%';
  }

  // Calculate all commissions when net premium changes
  function calculateAllCommissions() {
    calculateCommission();
    calculateSubAgentCommission();
    calculateAmbassadorCommission();
    calculateInvestorCommission();
    calculateProfitAndExpenses();
  }

  // Auto-calculate end date based on start date and policy term
  function calculateEndDate() {
    const startDate = document.getElementById('start_date').value;
    const policyTerm = document.getElementById('policy_term_select').value;

    if (startDate) {
      const start = new Date(startDate);
      const end = new Date(start);

      // Use policy term if available, otherwise default to 1 year
      const termYears = policyTerm ? parseInt(policyTerm) : 1;

      // Calculate end date based on policy term (in years)
      end.setFullYear(end.getFullYear() + termYears);

      // Set end date to one day before the renewal date
      end.setDate(end.getDate() - 1);

      document.getElementById('end_date').value = end.toISOString().split('T')[0];
    }
  }

  // Load policy holder options when customer changes
  function loadPolicyHolderOptions() {
    const customerId = document.getElementById('customer_select').value;
    const policyHolderSelect = document.getElementById('policy_holder_select');

    if (customerId) {
      fetch(`/admin/insurance/life/policy_holder_options?customer_id=${customerId}`)
        .then(response => response.json())
        .then(data => {
          policyHolderSelect.innerHTML = '';
          data.options.forEach(option => {
            const optionElement = new Option(option.label, option.value);
            policyHolderSelect.add(optionElement);
          });
        });
    }
  }

  // Load brokers when insurance company changes
  function loadBrokersByCompany() {
    const companyName = document.getElementById('life_insurance_insurance_company_name').value;
    const brokerSelect = document.getElementById('broker_select');
    const agencyCodeSelect = document.getElementById('life_insurance_agency_code_id');

    // Clear dependent dropdowns
    brokerSelect.innerHTML = '<option value="">Select Broker Code</option>';
    agencyCodeSelect.innerHTML = '<option value="">Select Agency Code</option>';

    if (companyName) {
      fetch(`/admin/insurance/life/brokers_by_company?company_name=${encodeURIComponent(companyName)}`)
        .then(response => response.json())
        .then(data => {
          data.brokers.forEach(broker => {
            const option = new Option(broker.name, broker.id);
            brokerSelect.add(option);
          });
        })
        .catch(error => console.error('Error loading brokers:', error));
    }
  }

  // Handle broker code type change (Direct/Broking) - LEGACY FUNCTION - NO LONGER USED
  function handleBrokerCodeTypeChange() {
    // This function is kept for compatibility but functionality moved to new system below
    console.log('Legacy handleBrokerCodeTypeChange called');
  }

  // Load all agency codes for Direct selection
  function loadAllAgencyCodes() {
    const agencyCodeSelect = document.getElementById('life_insurance_agency_code_id');
    agencyCodeSelect.innerHTML = '<option value="">Select Agency Code</option>';

    fetch('/admin/insurance/life/all_agency_codes', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.agency_codes && data.agency_codes.length > 0) {
          data.agency_codes.forEach(agencyCode => {
            const option = new Option(agencyCode.name, agencyCode.id);
            agencyCodeSelect.add(option);
          });
        }
      })
      .catch(error => {
        console.error('Error loading agency codes:', error);
      });
  }

  // Load all brokers for Broking selection
  function loadAllBrokers() {
    const brokerSelect = document.getElementById('broker_select');
    brokerSelect.innerHTML = '<option value="">Select Broker</option>';

    fetch('/admin/insurance/life/all_brokers', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.brokers && data.brokers.length > 0) {
          data.brokers.forEach(broker => {
            const option = new Option(broker.name, broker.id);
            brokerSelect.add(option);
          });
        }
      })
      .catch(error => {
        console.error('Error loading brokers:', error);
      });
  }

  // Load agency codes when broker changes (legacy function - keeping for compatibility)
  function loadAgencyCodesByBroker() {
    const brokerId = document.getElementById('broker_select').value;
    const agencyCodeSelect = document.getElementById('life_insurance_agency_code_id');

    console.log('loadAgencyCodesByBroker called with brokerId:', brokerId);

    // Clear agency code dropdown
    agencyCodeSelect.innerHTML = '<option value="">Select Agency Code</option>';

    if (brokerId) {
      console.log('Fetching agency codes for broker:', brokerId);

      fetch(`/admin/insurance/life/agency_codes_by_broker?broker_id=${brokerId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Received data:', data);
          if (data.agency_codes && data.agency_codes.length > 0) {
            data.agency_codes.forEach(agencyCode => {
              const option = new Option(agencyCode.name, agencyCode.id);
              agencyCodeSelect.add(option);
              console.log('Added option:', agencyCode.name);
            });
          } else {
            console.log('No agency codes found for this broker');
            const noOption = new Option('No agency codes available', '');
            noOption.disabled = true;
            agencyCodeSelect.add(noOption);
          }
        })
        .catch(error => {
          console.error('Error loading agency codes:', error);
          const errorOption = new Option('Error loading agency codes', '');
          errorOption.disabled = true;
          agencyCodeSelect.add(errorOption);
        });
    } else {
      console.log('No broker selected');
    }
  }


  // Event listeners
  document.getElementById('net_premium').addEventListener('input', function() {
    calculateTotalPremium();
    calculateAllCommissions();
  });
  document.getElementById('first_year_gst').addEventListener('input', calculateTotalPremium);
  document.getElementById('commission_percentage').addEventListener('input', function() {
    calculateCommission();
    calculateProfitAndExpenses();
  });
  document.getElementById('tds_percentage').addEventListener('input', calculateCommission);
  document.getElementById('start_date').addEventListener('change', calculateEndDate);
  document.getElementById('policy_term_select').addEventListener('change', calculateEndDate);
  // Use Select2 event listener instead of native event
  $('#customer_select').on('select2:select', function(e) {
    loadPolicyHolderOptions();

    // Clear and refresh affiliate dropdown when customer changes
    $('#affiliate_select').val(null).trigger('change');

    // Show a message to indicate that affiliates are being filtered
    var selectedCustomerId = this.value;
    if (selectedCustomerId) {
      console.log('Customer selected, filtering affiliates for customer ID:', selectedCustomerId);
    }
  });

  // Handle customer clearing
  $('#customer_select').on('select2:clear', function(e) {
    // Clear affiliate dropdown when customer is cleared
    $('#affiliate_select').val(null).trigger('change');
    console.log('Customer cleared, showing all affiliates');
  });

  // Cascading dropdown event listeners - Use Select2 events
  $('#life_insurance_insurance_company_name').on('select2:select', function(e) {
    loadBrokersByCompany();
  });
  // Removed broker_select event listener - element doesn't exist in form

  // Broker code type change listener - REMOVED (element doesn't exist)
  // Legacy code removed to prevent null reference errors

  // Sub-agent commission event listeners
  document.querySelector('.sub-agent-commission-percentage').addEventListener('input', function() {
    calculateSubAgentCommission();
    calculateProfitAndExpenses();
  });
  document.querySelector('.sub-agent-tds-percentage').addEventListener('input', calculateSubAgentCommission);

  // Ambassador commission event listeners
  document.querySelector('.ambassador-commission-percentage').addEventListener('input', function() {
    calculateAmbassadorCommission();
    calculateProfitAndExpenses();
  });
  document.querySelector('.ambassador-tds-percentage').addEventListener('input', calculateAmbassadorCommission);

  // Investor commission event listeners
  document.querySelector('.investor-commission-percentage').addEventListener('input', function() {
    calculateInvestorCommission();
    calculateProfitAndExpenses();
  });
  document.querySelector('.investor-tds-percentage').addEventListener('input', calculateInvestorCommission);

  // Company expenses event listener
  document.querySelector('.company-expenses-percentage').addEventListener('input', calculateProfitAndExpenses);

  // Event listeners for automatic end date calculation (removed duplicate start_date listener)

  // Initialize calculations and summary on page load
  calculateAllCommissions();
  updateCommissionSummary();
  calculateEndDate(); // Also calculate end date on page load if start date exists

  // ==== BROKER CODE & AGENCY CODE DYNAMIC DROPDOWNS ====

  // Get dropdown elements
  const brokerCodeTypeSelect = document.getElementById('life_insurance_broker_code_type');
  const agencyCodeSelect = document.getElementById('life_insurance_agency_code_id');
  const insuranceCompanySelect = document.getElementById('life_insurance_insurance_company_name');
  const brokerIdHidden = document.getElementById('broker_id_hidden');
  const agencyCodeLabelText = document.getElementById('agency_code_label_text');

  // Debug: Check if elements are found
  console.log('Elements found:');
  console.log('brokerCodeTypeSelect:', brokerCodeTypeSelect);
  console.log('agencyCodeSelect:', agencyCodeSelect);
  console.log('insuranceCompanySelect:', insuranceCompanySelect);

  let currentSelectedAgentName = null;
  let currentSelectedBrokerId = null;

  // Get CSRF token for requests
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

  // Function to load all agents when "Direct" is selected
  function loadAllAgentsForDirect() {
    console.log('=== loadAllAgentsForDirect called ===');
    console.log('agencyCodeSelect element:', agencyCodeSelect);
    console.log('insuranceCompanySelect element:', insuranceCompanySelect);

    // Check if elements exist before proceeding
    if (!agencyCodeSelect || !insuranceCompanySelect) {
      console.error('Required select elements not found');
      return;
    }

    // Clear existing options and show loading
    agencyCodeSelect.innerHTML = '<option value="">Loading agents...</option>';
    insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';

    // Update label
    if (agencyCodeLabelText) {
      agencyCodeLabelText.textContent = ' (All Agents)';
    }

    console.log('Loading agents for Direct from all_agents API...');

    // Fetch agents from the dedicated all_agents API endpoint
    const headers = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json'
    };

    if (csrfToken) {
      headers['X-CSRF-Token'] = csrfToken;
    }

    fetch('/admin/agency_codes/all_agents.json?insurance_type=Life', {
      headers: headers,
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Agency Codes API response status:', response.status);
      if (response.status === 401 || response.status === 403) {
        throw new Error('Authentication required - please refresh the page');
      }
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('All Agents API response data:', data);

      if (data && data.success && data.agents && data.agents.length > 0) {
        console.log('Loading', data.agents.length, 'agents');

        // Add agents to dropdown
        data.agents.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent.id;
          option.setAttribute('data-agent-name', agent.agent_name);
          option.textContent = agent.display_name;
          agencyCodeSelect.appendChild(option);
        });
        console.log('Loaded', data.agents.length, 'agents for Life insurance');
      } else {
        console.warn('No Life insurance agents found');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No agents available for Life insurance';
        option.disabled = true;
        agencyCodeSelect.appendChild(option);
      }
    })
    .catch(error => {
      console.error('Error fetching agency codes:', error);
      // Show error in dropdown
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Error loading agents';
      option.disabled = true;
      agencyCodeSelect.appendChild(option);
    });
  }

  // Function to load all brokers when "Broking" is selected
  function loadAllBrokersForBroking() {
    // Check if elements exist before proceeding
    if (!agencyCodeSelect || !insuranceCompanySelect) {
      console.error('Required select elements not found');
      return;
    }

    // Clear existing options and show loading
    agencyCodeSelect.innerHTML = '<option value="">Loading brokers...</option>';
    insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';

    // Update label
    if (agencyCodeLabelText) {
      agencyCodeLabelText.textContent = ' (All Brokers)';
    }

    console.log('Loading brokers for Broking from /admin/brokers...');

    // Use the direct brokers endpoint for faster loading
    const brokersHeaders = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json'
    };

    if (csrfToken) {
      brokersHeaders['X-CSRF-Token'] = csrfToken;
    }

    fetch('/admin/brokers.json', {
      headers: brokersHeaders,
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Brokers API response status:', response.status);
      if (response.status === 401 || response.status === 403) {
        throw new Error('Authentication required - please refresh the page');
      }
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Brokers API response data:', data);

      // Clear loading message
      agencyCodeSelect.innerHTML = '<option value="">Select Broker</option>';

      // Handle different response formats
      let brokers = data;
      if (data && data.brokers) {
        brokers = data.brokers;
      }

      if (brokers && Array.isArray(brokers) && brokers.length > 0) {
        console.log('Loading', brokers.length, 'brokers');
        brokers.forEach(broker => {
          const option = document.createElement('option');
          option.value = `broker_${broker.id}`;
          option.setAttribute('data-broker-id', broker.id);
          option.textContent = broker.name;
          agencyCodeSelect.appendChild(option);
        });
        console.log('Loaded', brokers.length, 'brokers successfully');
      } else {
        console.warn('No brokers found');
        // Show message in dropdown if no brokers found
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No brokers available';
        option.disabled = true;
        agencyCodeSelect.appendChild(option);
      }
    })
    .catch(error => {
      console.error('Error fetching brokers:', error);
      // Show error in dropdown
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Error loading brokers';
      option.disabled = true;
      agencyCodeSelect.appendChild(option);
    });
  }

  // Function to load companies for selected agent (Direct mode)
  function loadCompaniesForAgent(agentName) {
    if (!insuranceCompanySelect) {
      console.error('Insurance company select element not found');
      return;
    }

    // Show loading message
    insuranceCompanySelect.innerHTML = '<option value="">Loading companies...</option>';

    if (!agentName) {
      insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
      return;
    }

    console.log('Loading companies for agent:', agentName);

    // Fetch companies from API with timeout
    const companiesHeaders = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    };

    if (csrfToken) {
      companiesHeaders['X-CSRF-Token'] = csrfToken;
    }

    const fetchPromise = fetch(`/admin/agency_codes/companies_for_agent.json?agent_name=${encodeURIComponent(agentName)}&insurance_type=Life`, {
      headers: companiesHeaders,
      credentials: 'same-origin'
    });

    // Add timeout for faster feedback
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Request timeout')), 8000)
    );

    Promise.race([fetchPromise, timeoutPromise])
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Companies for agent response:', data);

      // Clear loading message
      insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';

      if (data.success && data.companies && data.companies.length > 0) {
        data.companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company.company_name;
          option.textContent = company.company_name;
          insuranceCompanySelect.appendChild(option);
        });
        console.log(`Loaded ${data.companies.length} companies for agent`);
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No companies available for this agent';
        option.disabled = true;
        insuranceCompanySelect.appendChild(option);
        console.log('No companies found for this agent');
      }
    })
    .catch(error => {
      console.error('Error fetching companies for agent:', error);
      insuranceCompanySelect.innerHTML = '<option value="">Error loading companies</option>';

      // Show error message for a few seconds then reset
      setTimeout(() => {
        insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
      }, 3000);
    });
  }

  // Function to load companies for selected broker (Broking mode)
  function loadCompaniesForBroker(brokerId) {
    if (!insuranceCompanySelect) {
      console.error('Insurance company select element not found');
      return;
    }

    // Show loading message
    insuranceCompanySelect.innerHTML = '<option value="">Loading companies...</option>';

    if (!brokerId) {
      insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
      return;
    }

    console.log('Loading companies for broker ID:', brokerId);

    // Fetch companies from API with timeout
    const brokerCompaniesHeaders = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    };

    if (csrfToken) {
      brokerCompaniesHeaders['X-CSRF-Token'] = csrfToken;
    }

    const fetchPromise = fetch(`/admin/agency_codes/companies_for_broker.json?broker_id=${brokerId}`, {
      headers: brokerCompaniesHeaders,
      credentials: 'same-origin'
    });

    // Add timeout for faster feedback
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Request timeout')), 10000)
    );

    Promise.race([fetchPromise, timeoutPromise])
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Companies for broker response:', data);

      // Clear loading message
      insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';

      if (data.success && data.companies && data.companies.length > 0) {
        data.companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company.company_name || company;
          option.textContent = company.company_name || company;
          insuranceCompanySelect.appendChild(option);
        });
        console.log(`Loaded ${data.companies.length} companies for broker`);
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No companies available for this broker';
        option.disabled = true;
        insuranceCompanySelect.appendChild(option);
        console.log('⚠️ No companies found for this broker');
      }
    })
    .catch(error => {
      console.error('Error fetching companies for broker:', error);
      insuranceCompanySelect.innerHTML = '<option value="">Error loading companies</option>';

      // Show error message for a few seconds then reset
      setTimeout(() => {
        insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
      }, 3000);
    });
  }

  // Function to load all companies for Broking mode (regardless of broker selection)
  function loadAllCompaniesForBroking() {
    if (!insuranceCompanySelect) {
      console.error('Insurance company select element not found');
      return;
    }

    // Show loading message
    insuranceCompanySelect.innerHTML = '<option value="">Loading all companies...</option>';

    console.log('Loading all companies for Broking mode...');

    // Fetch all Life insurance companies from the database
    const companiesHeaders = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    };

    if (csrfToken) {
      companiesHeaders['X-CSRF-Token'] = csrfToken;
    }

    const fetchPromise = fetch('/admin/agency_codes/all_companies.json', {
      headers: companiesHeaders,
      credentials: 'same-origin'
    });

    // Add timeout for faster feedback
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Request timeout')), 8000)
    );

    Promise.race([fetchPromise, timeoutPromise])
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('All companies response:', data);

      // Clear loading message
      insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';

      if (data.success && data.companies && data.companies.length > 0) {
        data.companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company;
          option.textContent = company;
          insuranceCompanySelect.appendChild(option);
        });
        console.log(`Loaded ${data.companies.length} insurance companies for Broking mode`);
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No companies available';
        option.disabled = true;
        insuranceCompanySelect.appendChild(option);
        console.log('No companies found');
      }
    })
    .catch(error => {
      console.error('Error fetching all companies:', error);
      insuranceCompanySelect.innerHTML = '<option value="">Error loading companies</option>';

      // Show error message for a few seconds then reset
      setTimeout(() => {
        insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
      }, 3000);
    });
  }

  // Event listener for broker code type change
  if (brokerCodeTypeSelect) {
    brokerCodeTypeSelect.addEventListener('change', function() {
      const selectedType = this.value;
      console.log('Broker code type changed to:', selectedType);

      if (selectedType === 'direct') {
        // Load all agents when Direct is selected
        loadAllAgentsForDirect();
        // Clear broker ID
        if (brokerIdHidden) brokerIdHidden.value = '';
      } else if (selectedType === 'broking') {
        // Load all brokers when Broking is selected
        loadAllBrokersForBroking();
        // Load ALL companies immediately for Broking mode (regardless of broker selection)
        loadAllCompaniesForBroking();
        // Clear agency code ID since we're using broker selection
        if (agencyCodeSelect) agencyCodeSelect.value = '';
      } else {
        // No broker code type selected, clear all dropdowns
        if (agencyCodeSelect) agencyCodeSelect.innerHTML = '<option value="">Select Agency Code</option>';
        if (insuranceCompanySelect) insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
        if (agencyCodeLabelText) {
          agencyCodeLabelText.textContent = '';
        }
        if (brokerIdHidden) brokerIdHidden.value = '';
      }
    });
  } else {
    console.warn('Broker code type select element not found');
  }

  // Event listener for agency code selection change
  if (agencyCodeSelect) {
    agencyCodeSelect.addEventListener('change', function() {
      const selectedValue = this.value;
      const selectedOption = this.options[this.selectedIndex];

      if (!selectedValue) {
        // Clear company dropdown if nothing selected
        if (insuranceCompanySelect) {
          insuranceCompanySelect.innerHTML = '<option value="">Select Company</option>';
        }
        return;
      }

      const brokerCodeType = brokerCodeTypeSelect ? brokerCodeTypeSelect.value : null;

      if (brokerCodeType === 'direct') {
        // Get agent name from data attribute
        const agentName = selectedOption.getAttribute('data-agent-name');
        if (agentName) {
          currentSelectedAgentName = agentName;
          loadCompaniesForAgent(agentName);
        }
        // Clear broker ID for direct
        if (brokerIdHidden) brokerIdHidden.value = '';
      } else if (brokerCodeType === 'broking') {
        // Get broker ID from data attribute
        const brokerId = selectedOption.getAttribute('data-broker-id');
        if (brokerId) {
          currentSelectedBrokerId = brokerId;
          // In Broking mode, ALL companies are already loaded regardless of broker selection
          // So we don't need to call loadCompaniesForBroker(brokerId)
          // Set broker ID in hidden field
          if (brokerIdHidden) brokerIdHidden.value = brokerId;
        }
        // Keep the selected value visible in the dropdown
        // Don't clear this.value so user can see their selection
      }
    });
  }

  // Initialize functionality on page load
  if (brokerCodeTypeSelect && agencyCodeSelect && insuranceCompanySelect) {
    const currentBrokerCodeType = brokerCodeTypeSelect.value;

    if (currentBrokerCodeType === 'direct') {
      loadAllAgentsForDirect();
    } else if (currentBrokerCodeType === 'broking') {
      loadAllBrokersForBroking();
      // Also load ALL companies for Broking mode
      loadAllCompaniesForBroking();
    }
  } else {
    console.warn('Some dropdown elements not found during initialization');
  }

  // Document Management System
  let policyDocumentIndex = 0;
  const addPolicyDocumentBtn = document.getElementById('add_policy_document');
  const policyDocumentsContainer = document.getElementById('policy_documents_container');

  addPolicyDocumentBtn?.addEventListener('click', function() {
    const documentHtml = `
      <div class="document-entry p-3 mb-3 border rounded position-relative" data-index="${policyDocumentIndex}" style="background: #f8f9fa;">
        <button type="button" class="btn btn-sm btn-outline-danger position-absolute" style="top: 10px; right: 10px;" onclick="this.closest('.document-entry').remove()">
          <i class="bi bi-trash"></i>
        </button>
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Document Title <span class="text-danger">*</span></label>
            <input type="text" name="life_insurance[uploaded_documents_attributes][${policyDocumentIndex}][title]" class="form-control" placeholder="Enter document title" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Document Type <span class="text-danger">*</span></label>
            <select name="life_insurance[uploaded_documents_attributes][${policyDocumentIndex}][document_type]" class="form-select" required>
              <option value="">Select Document Type</option>
              <option value="aadhar">Aadhar</option>
              <option value="pan_card">PAN Card</option>
              <option value="driving_license">Driving License</option>
              <option value="passport">Passport</option>
              <option value="voter_id">Voter ID</option>
              <option value="birth_certificate">Birth Certificate</option>
              <option value="income_certificate">Income Certificate</option>
              <option value="salary_slip">Salary Slip</option>
              <option value="bank_statement">Bank Statement</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Document File <span class="text-danger">*</span></label>
            <input type="file" name="life_insurance[uploaded_documents_attributes][${policyDocumentIndex}][file]" class="form-control" accept="application/pdf,image/jpeg,image/jpg,image/png,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <label class="form-label">Description (Optional)</label>
            <textarea name="life_insurance[uploaded_documents_attributes][${policyDocumentIndex}][description]" class="form-control" rows="2" placeholder="Optional description"></textarea>
          </div>
        </div>
        <input type="hidden" name="life_insurance[uploaded_documents_attributes][${policyDocumentIndex}][uploaded_by]" value="Admin User">
      </div>
    `;
    policyDocumentsContainer.insertAdjacentHTML('beforeend', documentHtml);
    policyDocumentIndex++;
  });

});
</script>