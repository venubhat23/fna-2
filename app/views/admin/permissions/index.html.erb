<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Permissions Management</h2>
    <p class="text-muted mb-0">Configure system permissions and module access controls</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to admin_roles_path, class: "btn btn-outline-primary" do %>
      <i class="bi bi-person-badge me-1"></i>
      Manage Roles
    <% end %>
    <%= link_to new_admin_permission_path, class: "btn btn-success" do %>
      <i class="bi bi-plus-lg me-1"></i>
      Add Permission
    <% end %>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Permissions</h6>
            <h3 class="mb-0 text-primary"><%= number_with_delimiter(@total_permissions) %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-shield-check text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Modules Covered</h6>
            <h3 class="mb-0 text-success"><%= number_with_delimiter(@modules_count) %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-grid-3x3-gap text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Assigned Permissions</h6>
            <h3 class="mb-0 text-info"><%= number_with_delimiter(@assigned_permissions) %></h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="bi bi-check2-all text-info fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Unassigned Permissions</h6>
            <h3 class="mb-0 text-warning"><%= number_with_delimiter(@unassigned_permissions) %></h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Permissions by Module -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Permissions by Module</h5>
      <div class="d-flex gap-2">
        <% if @total_permissions == 0 %>
          <%= button_to generate_defaults_admin_permissions_path, method: :post, class: "btn btn-outline-success btn-sm" do %>
            <i class="bi bi-gear me-1"></i>
            Generate Default Permissions
          <% end %>
        <% end %>
        <%= link_to bulk_assign_admin_permissions_path, class: "btn btn-outline-info btn-sm" do %>
          <i class="bi bi-list-check me-1"></i>
          Bulk Assign
        <% end %>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @grouped_permissions.any? %>
      <% @modules.each do |module_info| %>
        <% module_name = module_info[:name] %>
        <% permissions = @grouped_permissions[module_name] || [] %>

        <div class="border-bottom">
          <div class="p-4">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">
                  <i class="bi bi-grid-3x3-gap me-2 text-primary"></i>
                  <%= module_info[:display] %>
                </h6>
                <p class="text-muted mb-2 small"><%= module_info[:description] %></p>
                <div class="d-flex gap-1 flex-wrap">
                  <% permissions.each do |permission| %>
                    <span class="badge bg-<%=
                      case permission.action_type
                      when 'create' then 'success'
                      when 'read' then 'info'
                      when 'update' then 'warning'
                      when 'delete' then 'danger'
                      when 'export' then 'secondary'
                      when 'import' then 'primary'
                      when 'manage' then 'dark'
                      else 'light'
                      end
                    %>">
                      <%= permission.action_type.humanize %>
                    </span>
                  <% end %>
                  <% if permissions.empty? %>
                    <span class="text-muted small">No permissions defined</span>
                  <% end %>
                </div>
              </div>
              <div class="text-end">
                <small class="text-muted"><%= permissions.count %> permissions</small>
                <div class="mt-1">
                  <%= link_to module_admin_permissions_path(module_name), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-gear"></i>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-shield-x fs-1 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No permissions found</h5>
        <p class="text-muted mb-3">
          Get started by generating default permissions for all system modules.
        </p>
        <%= button_to generate_defaults_admin_permissions_path, method: :post, class: "btn btn-success" do %>
          <i class="bi bi-gear me-1"></i>
          Generate Default Permissions
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% if @grouped_permissions.any? %>
  <!-- Action Legend -->
  <div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-transparent border-0">
      <h6 class="mb-0">
        <i class="bi bi-info-circle me-2 text-info"></i>
        Permission Types
      </h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-success me-2">Create</span>
            <small class="text-muted">Add new records to the system</small>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-info me-2">Read</span>
            <small class="text-muted">View and access existing data</small>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-warning me-2">Update</span>
            <small class="text-muted">Edit and modify existing records</small>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-danger me-2">Delete</span>
            <small class="text-muted">Remove records permanently</small>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-secondary me-2">Export</span>
            <small class="text-muted">Export data to external formats</small>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-primary me-2">Import</span>
            <small class="text-muted">Import data from external sources</small>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-dark me-2">Manage</span>
            <small class="text-muted">Full administrative control</small>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>