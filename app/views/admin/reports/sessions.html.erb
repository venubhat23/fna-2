<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">User Sessions Report</h2>
    <p class="text-muted mb-0">Track user login activity and session analytics</p>
  </div>
  <div class="d-flex gap-2">
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-download me-1"></i>
        Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>Export as CSV</a></li>
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Export as Excel</a></li>
      </ul>
    </div>
    <button class="btn btn-info" onclick="refreshSessions()">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Refresh Data
    </button>
  </div>
</div>

<!-- Date Range Filter -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <%= form_with url: admin_reports_sessions_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-3">
        <%= form.label :date_range, "Time Period", class: "form-label fw-semibold" %>
        <%= form.select :date_range,
            options_for_select([
              ['Today', 'today'],
              ['Last 7 Days', '7_days'],
              ['Last 30 Days', '30_days'],
              ['Last 3 Months', '3_months']
            ], @date_range || 'today'),
            {},
            { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.submit "Apply Filter", class: "btn btn-outline-primary w-100" %>
      </div>
      <div class="col-md-7 text-end">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Showing session data for
          <%= case @date_range
              when 'today' then 'today'
              when '7_days' then 'last 7 days'
              when '30_days' then 'last 30 days'
              when '3_months' then 'last 3 months'
              else 'today'
              end %>
        </small>
      </div>
    <% end %>
  </div>
</div>

<!-- Session Statistics -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Sessions</h6>
            <h3 class="mb-0 text-primary"><%= number_with_delimiter(@total_sessions || 0) %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-person-circle text-primary fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-success">
            <i class="bi bi-arrow-up"></i>
            User login activity
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Active Users</h6>
            <h3 class="mb-0 text-success"><%= number_with_delimiter(@active_users || 0) %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-people text-success fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-clock"></i>
            Currently online
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Avg Session Time</h6>
            <h3 class="mb-0 text-info"><%= @avg_session_time || "24m" %></h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="bi bi-stopwatch text-info fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-graph-up"></i>
            Per session duration
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Failed Logins</h6>
            <h3 class="mb-0 text-warning"><%= @failed_logins || 0 %></h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="bi bi-shield-exclamation text-warning fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-exclamation-triangle"></i>
            Security alerts
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Session Activity Chart -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">
      <i class="bi bi-graph-up me-2 text-primary"></i>
      Session Activity Timeline
    </h5>
  </div>
  <div class="card-body">
    <div class="text-center py-4">
      <div class="placeholder-glow">
        <div class="placeholder col-12 bg-primary bg-opacity-10" style="height: 250px; border-radius: 8px;"></div>
      </div>
      <div class="mt-3">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Session activity chart will be displayed here
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Recent Sessions -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">Recent Session Activity</h5>
  </div>
  <div class="card-body p-0">
    <% if @recent_sessions&.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-0">User</th>
              <th class="border-0">User Type</th>
              <th class="border-0">Login Time</th>
              <th class="border-0">Last Activity</th>
              <th class="border-0">Duration</th>
              <th class="border-0">IP Address</th>
              <th class="border-0">Status</th>
              <th class="border-0">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_sessions.each do |session| %>
              <tr>
                <td>
                  <div>
                    <h6 class="mb-1"><%= session[:user_name] || 'Unknown User' %></h6>
                    <small class="text-muted"><%= session[:email] || 'No email' %></small>
                  </div>
                </td>
                <td>
                  <span class="badge bg-<%=
                    case session[:user_type]
                    when 'admin' then 'danger'
                    when 'agent' then 'primary'
                    when 'customer' then 'success'
                    else 'secondary'
                    end
                  %>">
                    <%= session[:user_type]&.humanize || 'User' %>
                  </span>
                </td>
                <td>
                  <div>
                    <div class="fw-semibold"><%= session[:login_time]&.strftime("%d %b %Y") || Date.current.strftime("%d %b %Y") %></div>
                    <small class="text-muted"><%= session[:login_time]&.strftime("%I:%M %p") || Time.current.strftime("%I:%M %p") %></small>
                  </div>
                </td>
                <td>
                  <div>
                    <small class="text-muted"><%= session[:last_activity] || "Just now" %></small>
                  </div>
                </td>
                <td>
                  <div>
                    <span class="fw-semibold"><%= session[:duration] || "24m" %></span>
                  </div>
                </td>
                <td>
                  <div>
                    <code class="bg-light px-2 py-1 rounded"><%= session[:ip_address] || "127.0.0.1" %></code>
                  </div>
                </td>
                <td>
                  <span class="badge bg-<%= session[:status] == 'active' ? 'success' : 'secondary' %>">
                    <%= session[:status]&.humanize || 'Active' %>
                  </span>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </button>
                    <% if session[:status] == 'active' %>
                      <button class="btn btn-sm btn-outline-danger" title="End Session" onclick="endSession('<%= session[:id] %>')">
                        <i class="bi bi-power"></i>
                      </button>
                    <% end %>
                    <button class="btn btn-sm btn-outline-info" title="View History" onclick="viewHistory('<%= session[:user_id] %>')">
                      <i class="bi bi-clock-history"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-person-slash fs-1 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No session data found</h5>
        <p class="text-muted mb-3">
          No user sessions recorded for the selected time period.
        </p>
        <button class="btn btn-primary" onclick="refreshSessions()">
          <i class="bi bi-arrow-clockwise me-1"></i>
          Refresh Data
        </button>
      </div>
    <% end %>
  </div>
</div>

<style>
  .placeholder {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>

<script>
function refreshSessions() {
  if (confirm('Refresh session data? This will reload the current page.')) {
    location.reload();
  }
}

function endSession(sessionId) {
  if (confirm('Are you sure you want to end this user session?')) {
    alert(`Feature coming soon! This will end session ID: ${sessionId}`);
  }
}

function viewHistory(userId) {
  if (confirm('View complete session history for this user?')) {
    alert(`Feature coming soon! This will show session history for user ID: ${userId}`);
  }
}
</script>