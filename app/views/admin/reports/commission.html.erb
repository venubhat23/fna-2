<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Commission Reports</h2>
    <p class="text-muted mb-0">Track and analyze agent commissions and earnings</p>
  </div>
  <div class="d-flex gap-2">
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-download me-1"></i>
        Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>Export as CSV</a></li>
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Export as Excel</a></li>
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-pdf me-2"></i>Export as PDF</a></li>
      </ul>
    </div>
    <button class="btn btn-success" onclick="processCommissions()">
      <i class="bi bi-calculator me-1"></i>
      Process Payouts
    </button>
  </div>
</div>

<!-- Date Range Filter -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <%= form_with url: admin_reports_commission_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-3">
        <%= form.label :date_range, "Time Period", class: "form-label fw-semibold" %>
        <%= form.select :date_range,
            options_for_select([
              ['Last 7 Days', '7_days'],
              ['Last 30 Days', '30_days'],
              ['Last 3 Months', '3_months'],
              ['Last 6 Months', '6_months'],
              ['Last Year', '1_year']
            ], @date_range),
            {},
            { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.submit "Apply Filter", class: "btn btn-outline-primary w-100" %>
      </div>
      <div class="col-md-7 text-end">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Showing commission data for
          <%= case @date_range
              when '7_days' then 'last 7 days'
              when '30_days' then 'last 30 days'
              when '3_months' then 'last 3 months'
              when '6_months' then 'last 6 months'
              when '1_year' then 'last year'
              else 'last 30 days'
              end %>
        </small>
      </div>
    <% end %>
  </div>
</div>

<!-- Commission Statistics -->
<div class="row mb-4">
  <div class="col-xl-4 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Commission</h6>
            <h3 class="mb-0 text-success">₹<%= number_with_delimiter(@total_commission.to_i) %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-currency-rupee text-success fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-success">
            <i class="bi bi-arrow-up"></i>
            Based on policy premiums
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-4 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Active Agents</h6>
            <h3 class="mb-0 text-primary"><%= number_with_delimiter(@commission_by_agent.keys.count) %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-people text-primary fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-person-badge"></i>
            Earning agents this period
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-4 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Avg Commission</h6>
            <h3 class="mb-0 text-info">
              ₹<%= @commission_by_agent.any? ? number_with_delimiter((@total_commission / @commission_by_agent.keys.count).to_i) : '0' %>
            </h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="bi bi-graph-up text-info fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-calculator"></i>
            Per active agent
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Commission by Agent -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">
      <i class="bi bi-person-badge me-2 text-primary"></i>
      Commission Breakdown by Agent
    </h5>
  </div>
  <div class="card-body p-0">
    <% if @commission_by_agent.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-0">Rank</th>
              <th class="border-0">Agent</th>
              <th class="border-0">Commission Earned</th>
              <th class="border-0">Percentage Share</th>
              <th class="border-0">Performance</th>
              <th class="border-0">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @commission_by_agent.sort_by { |k, v| -v }.each_with_index do |(agent_key, commission), index| %>
              <% agent_name = agent_key.is_a?(Array) ? agent_key.join(' ') : agent_key %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <% if index < 3 %>
                      <span class="badge bg-<%=
                        case index
                        when 0 then 'warning'  # Gold
                        when 1 then 'secondary'  # Silver
                        when 2 then 'warning bg-opacity-50'  # Bronze
                        end
                      %> me-2">
                        <%= index + 1 %>
                      </span>
                    <% else %>
                      <span class="text-muted me-3">#<%= index + 1 %></span>
                    <% end %>
                  </div>
                </td>
                <td>
                  <div>
                    <h6 class="mb-1"><%= agent_name %></h6>
                    <small class="text-muted">Agent ID: #A<%= sprintf('%03d', index + 1) %></small>
                  </div>
                </td>
                <td>
                  <div>
                    <div class="fw-semibold text-success">₹<%= number_with_delimiter(commission.to_i) %></div>
                    <small class="text-muted">Commission</small>
                  </div>
                </td>
                <td>
                  <% percentage = (@total_commission > 0 ? (commission / @total_commission * 100) : 0) %>
                  <div>
                    <div class="fw-semibold"><%= sprintf('%.1f', percentage) %>%</div>
                    <div class="progress" style="height: 4px;">
                      <div class="progress-bar bg-<%=
                        case
                        when percentage >= 20 then 'success'
                        when percentage >= 10 then 'info'
                        when percentage >= 5 then 'warning'
                        else 'secondary'
                        end
                      %>" role="progressbar" style="width: <%= [percentage, 100].min %>%"></div>
                    </div>
                  </div>
                </td>
                <td>
                  <div>
                    <span class="badge bg-<%=
                      case
                      when commission >= (@total_commission * 0.15) then 'success'
                      when commission >= (@total_commission * 0.05) then 'warning'
                      else 'secondary'
                      end
                    %>">
                      <%=
                        case
                        when commission >= (@total_commission * 0.15) then 'Top Performer'
                        when commission >= (@total_commission * 0.05) then 'Good'
                        else 'Average'
                        end
                      %>
                    </span>
                    <div><small class="text-muted">Performance level</small></div>
                  </div>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" title="Process Payment">
                      <i class="bi bi-credit-card"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" title="Send Report">
                      <i class="bi bi-envelope"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-graph-down fs-1 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No commission data found</h5>
        <p class="text-muted mb-3">
          No commissions have been generated for the selected time period.
        </p>
        <div class="d-flex gap-2 justify-content-center">
          <%= link_to "View All Policies", admin_health_insurances_path, class: "btn btn-outline-primary" %>
          <button class="btn btn-primary" onclick="changeDateRange()">
            <i class="bi bi-calendar me-1"></i>
            Try Different Period
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Commission Trends (Placeholder for future chart) -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">
      <i class="bi bi-graph-up me-2 text-info"></i>
      Commission Trends
    </h5>
  </div>
  <div class="card-body">
    <div class="text-center py-4">
      <div class="placeholder-glow">
        <div class="placeholder col-12 bg-primary bg-opacity-10" style="height: 200px; border-radius: 8px;"></div>
      </div>
      <div class="mt-3">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Commission trend chart will be displayed here
        </small>
      </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mt-4 text-center">
      <div class="col-md-3">
        <div class="border-end">
          <h6 class="text-success mb-1">↗ Growing</h6>
          <small class="text-muted">Commission Trend</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="border-end">
          <h6 class="text-primary mb-1">10%</h6>
          <small class="text-muted">Avg Rate</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="border-end">
          <h6 class="text-info mb-1">Monthly</h6>
          <small class="text-muted">Payout Cycle</small>
        </div>
      </div>
      <div class="col-md-3">
        <h6 class="text-warning mb-1">Active</h6>
        <small class="text-muted">System Status</small>
      </div>
    </div>
  </div>
</div>

<style>
  .placeholder {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .progress {
    background-color: #e9ecef;
  }
</style>

<script>
  function processCommissions() {
    if (confirm('Are you sure you want to process commission payouts for all agents?')) {
      // Implementation for commission processing
      alert('Feature coming soon! This will process commission payments to all eligible agents.');
    }
  }

  function changeDateRange() {
    // Focus on the date range dropdown
    document.getElementById('date_range').focus();
  }

  // Auto-refresh data every 30 seconds (optional)
  // setInterval(function() {
  //   if (document.hidden === false) {
  //     location.reload();
  //   }
  // }, 30000);
</script>