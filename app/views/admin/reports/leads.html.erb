<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Leads Reports</h2>
    <p class="text-muted mb-0">Track lead generation, conversion rates, and sales performance</p>
  </div>
  <div class="d-flex gap-2">
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-download me-1"></i>
        Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>Export as CSV</a></li>
        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Export as Excel</a></li>
      </ul>
    </div>
    <%= link_to admin_leads_path, class: "btn btn-primary" do %>
      <i class="bi bi-eye me-1"></i>
      View All Leads
    <% end %>
  </div>
</div>

<!-- Date Range Filter -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <%= form_with url: admin_reports_leads_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-3">
        <%= form.label :date_range, "Time Period", class: "form-label fw-semibold" %>
        <%= form.select :date_range,
            options_for_select([
              ['Last 7 Days', '7_days'],
              ['Last 30 Days', '30_days'],
              ['Last 3 Months', '3_months'],
              ['Last 6 Months', '6_months'],
              ['Last Year', '1_year']
            ], @date_range),
            {},
            { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.submit "Apply Filter", class: "btn btn-outline-primary w-100" %>
      </div>
      <div class="col-md-7 text-end">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Showing leads data for
          <%= case @date_range
              when '7_days' then 'last 7 days'
              when '30_days' then 'last 30 days'
              when '3_months' then 'last 3 months'
              when '6_months' then 'last 6 months'
              when '1_year' then 'last year'
              else 'last 30 days'
              end %>
        </small>
      </div>
    <% end %>
  </div>
</div>

<!-- Lead Statistics -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Leads</h6>
            <h3 class="mb-0 text-primary"><%= number_with_delimiter(@leads_data[:total_leads]) %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-person-plus text-primary fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-success">
            <i class="bi bi-arrow-up"></i>
            New leads generated
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Conversion Rate</h6>
            <h3 class="mb-0 text-success"><%= sprintf('%.1f', @leads_data[:conversion_rate]) %>%</h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-graph-up text-success fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-target"></i>
            Lead to customer ratio
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Active Pipeline</h6>
            <h3 class="mb-0 text-info">
              <%= @leads_by_stage.except('converted', 'closed', 'rejected').values.sum %>
            </h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="bi bi-funnel text-info fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-clock"></i>
            In progress leads
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Converted</h6>
            <h3 class="mb-0 text-warning">
              <%= @leads_by_stage['converted'] || 0 %>
            </h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="bi bi-check-circle text-warning fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-trophy"></i>
            Successful conversions
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lead Pipeline Stages -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">
      <i class="bi bi-diagram-3 me-2 text-primary"></i>
      Lead Pipeline by Stage
    </h5>
  </div>
  <div class="card-body">
    <% if @leads_by_stage.any? %>
      <div class="row">
        <% @leads_by_stage.each do |stage, count| %>
          <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="text-center p-3 border rounded">
              <div class="mb-2">
                <i class="bi bi-<%=
                  case stage
                  when 'new' then 'plus-circle text-primary'
                  when 'contacted' then 'telephone text-info'
                  when 'qualified' then 'check-circle text-success'
                  when 'proposal' then 'file-earmark-text text-warning'
                  when 'negotiation' then 'chat-dots text-secondary'
                  when 'converted' then 'trophy text-success'
                  when 'closed' then 'x-circle text-danger'
                  else 'circle text-muted'
                  end
                %> fs-2"></i>
              </div>
              <h6 class="fw-semibold mb-1"><%= stage.humanize %></h6>
              <h4 class="text-<%=
                case stage
                when 'new' then 'primary'
                when 'contacted' then 'info'
                when 'qualified' then 'success'
                when 'proposal' then 'warning'
                when 'negotiation' then 'secondary'
                when 'converted' then 'success'
                when 'closed' then 'danger'
                else 'muted'
                end
              %> mb-0"><%= count %></h4>
              <small class="text-muted">leads</small>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-4">
        <i class="bi bi-diagram-3 fs-1 text-muted"></i>
        <h6 class="text-muted mt-2">No pipeline data available</h6>
        <small class="text-muted">Lead stages will appear here once data is available</small>
      </div>
    <% end %>
  </div>
</div>

<!-- Lead Performance Metrics -->
<div class="row">
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">
          <i class="bi bi-graph-up me-2 text-info"></i>
          Lead Performance Trends
        </h5>
      </div>
      <div class="card-body">
        <div class="text-center py-4">
          <div class="placeholder-glow">
            <div class="placeholder col-12 bg-info bg-opacity-10" style="height: 250px; border-radius: 8px;"></div>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Lead performance chart will be displayed here
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Top Performance Metrics</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">Lead Quality Score</small>
            <small class="fw-semibold text-success">85%</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" style="width: 85%"></div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">Response Time</small>
            <small class="fw-semibold text-info">2.3h avg</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-info" style="width: 75%"></div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">Follow-up Rate</small>
            <small class="fw-semibold text-warning">92%</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-warning" style="width: 92%"></div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">Closure Rate</small>
            <small class="fw-semibold text-danger">68%</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-danger" style="width: 68%"></div>
          </div>
        </div>

        <hr>

        <div class="text-center">
          <h6 class="text-muted mb-1">Overall Performance</h6>
          <h4 class="text-success mb-0">Good</h4>
          <small class="text-muted">Above average conversion rate</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .placeholder {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .progress {
    background-color: #e9ecef;
  }
</style>