<%# Floating Toggle Buttons %>
<div class="position-fixed" style="top: 90px; right: 20px; z-index: 1050;">
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-primary btn-sm shadow-lg" id="productsViewBtn" onclick="showProductsView()" title="Products" style="display: none;">
      <i class="bi bi-grid"></i>
    </button>
    <button type="button" class="btn btn-outline-primary btn-sm shadow-lg" id="checkoutViewBtn" onclick="showCheckoutView()" title="Checkout">
      <i class="bi bi-cart-check"></i>
    </button>
  </div>
</div>

<%# Large Toggle Buttons %>
<div class="mb-3">
  <div class="btn-group-lg d-flex gap-3" role="group">
    <button type="button" class="btn btn-primary px-3 py-2 rounded-3 shadow-sm" id="productsViewBtnLarge" onclick="showProductsView()" style="display: none;">
      <i class="bi bi-grid me-2"></i>
      <span class="fw-medium">Products</span>
    </button>
    <button type="button" class="btn btn-outline-primary px-3 py-2 rounded-3 shadow-sm" id="checkoutViewBtnLarge" onclick="showCheckoutView()">
      <i class="bi bi-cart-check me-2"></i>
      <span class="fw-medium">Checkout</span>
    </button>
  </div>
</div>

<%# Search and Filters %>
<div class="card border-0 shadow-sm mb-3" id="searchSection">
  <div class="card-body py-2">
    <div class="row g-2 align-items-center">
      <div class="col-md-5">
        <input type="text" class="form-control form-control-sm" placeholder="Search products by name, SKU, or category..." id="productSearch">
      </div>
      <div class="col-md-3">
        <select class="form-select form-select-sm" id="categoryFilter">
          <option value="">All Categories</option>
          <% Category.where(status: true).each do |category| %>
            <option value="<%= category.id %>"><%= category.name %></option>
          <% end %>
        </select>
      </div>
      <div class="col-md-4">
        <div class="d-flex gap-2 align-items-center">
          <small class="text-muted">Filter:</small>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm active" id="allProductsBtn" onclick="filterProducts('all')">All</button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="inStockBtn" onclick="filterProducts('instock')">In Stock</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Products View %>
<div id="productsView">
  <div class="card border-0 shadow-sm">
    <div class="card-body pt-3">
      <% if @products&.any? %>
        <div class="row g-3" id="productGrid">
          <% @products.each do |product| %>
            <% current_stock = product.cached_total_batch_stock %>
            <div class="col-md-4 col-lg-3 product-grid-item" data-product-id="<%= product.id %>" data-category="<%= product.category_id %>" data-stock="<%= current_stock %>">
              <div class="card h-100 border-0 shadow-sm hover-lift">
                <%# Product Image %>
                <div class="position-relative">
                  <% if product.images.attached? && product.images.any? %>
                    <%= image_tag product.images.first, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
                  <% else %>
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                      <i class="bi bi-box-seam fs-1 text-muted"></i>
                    </div>
                  <% end %>

                  <%# Enhanced Stock Badge %>
                  <% if product.out_of_stock? %>
                    <span class="position-absolute top-0 end-0 badge bg-danger m-2">
                      <i class="bi bi-x-circle me-1"></i>Out of Stock
                    </span>
                  <% elsif product.low_stock? %>
                    <span class="position-absolute top-0 end-0 badge bg-warning text-dark m-2">
                      <i class="bi bi-exclamation-triangle me-1"></i>Low Stock (<%= current_stock.to_i %> left)
                    </span>
                  <% else %>
                    <span class="position-absolute top-0 end-0 badge bg-success m-2">
                      <i class="bi bi-check-circle me-1"></i><%= current_stock.to_i %> in stock
                    </span>
                  <% end %>

                  <%# Discount Badge %>
                  <% if product.respond_to?(:discount_price) && product.discount_price.present? && product.discount_price != product.price %>
                    <% discount_percent = ((product.price - product.discount_price) * 100 / product.price).round %>
                    <span class="position-absolute top-0 start-0 badge bg-success m-2"><%= discount_percent %>% OFF</span>
                  <% end %>
                </div>

                <%# Product Details %>
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <small class="text-muted"><%= product.category&.name || 'No Category' %></small>
                    <div class="d-flex align-items-center gap-1">
                      <small class="text-muted">SKU: <%= product.sku %></small>
                      <%= link_to edit_admin_product_path(product),
                          class: "btn btn-sm btn-outline-secondary ms-1",
                          title: "Edit Product Details",
                          target: "_blank" do %>
                        <i class="bi bi-pencil-square"></i>
                      <% end %>
                    </div>
                  </div>

                  <h6 class="card-title mb-2" style="min-height: 48px;"><%= product.name %></h6>

                  <%# Price %>
                  <div class="mb-3">
                    <%
                      base_price = product.respond_to?(:discount_price) && product.discount_price.present? && product.discount_price != product.price ? product.discount_price : product.price
                      gst_rate = product.gst_enabled ? (product.gst_percentage || 0) : 0
                      gst_amount = base_price * gst_rate / 100
                      final_price = base_price + gst_amount
                    %>

                    <% if product.respond_to?(:discount_price) && product.discount_price.present? && product.discount_price != product.price %>
                      <div class="d-flex align-items-center gap-2">
                        <span class="h6 text-success mb-0">₹<%= number_with_delimiter(final_price.round(2)) %></span>
                        <small class="text-muted text-decoration-line-through">₹<%= number_with_delimiter(product.price) %></small>
                      </div>
                    <% else %>
                      <span class="h6 text-primary mb-0">₹<%= number_with_delimiter(final_price.round(2)) %></span>
                    <% end %>

                    <% if product.gst_enabled && gst_rate > 0 %>
                      <small class="text-muted d-block">
                        Base: ₹<%= number_with_delimiter(base_price.round(2)) %> + GST <%= gst_rate %>%
                      </small>
                    <% end %>
                  </div>


                  <%# Quantity and Add to Cart %>
                  <div class="mt-3">
                    <% if current_stock > 0 %>
                      <!-- Quantity Selector -->
                      <div class="mb-3">
                        <label class="form-label fw-bold small">
                          Quantity
                          <span class="badge bg-info-subtle text-info ms-1">
                            Max: <%= current_stock.to_i %>
                          </span>
                        </label>
                        <div class="input-group">
                          <button class="btn btn-outline-primary" type="button" onclick="decreaseQuantity(<%= product.id %>)" style="width: 45px; height: 45px; border-radius: 8px 0 0 8px;">
                            <i class="bi bi-dash fw-bold"></i>
                          </button>
                          <input type="number" id="qty-<%= product.id %>" value="1" min="1" max="<%= current_stock %>" class="form-control text-center fw-bold" style="height: 45px; font-size: 1.1rem;" onchange="validateQuantity(<%= product.id %>, <%= current_stock %>)">
                          <button class="btn btn-outline-primary" type="button" onclick="increaseQuantity(<%= product.id %>)" style="width: 45px; height: 45px; border-radius: 0 8px 8px 0;">
                            <i class="bi bi-plus fw-bold"></i>
                          </button>
                        </div>

                        <%# Simple Stock Warning - Only for Low Stock %>
                        <% if product.low_stock? %>
                          <small class="text-warning d-block mt-1">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Low Stock!</strong> Only <%= current_stock.to_i %> left
                          </small>
                        <% end %>
                      </div>

                      <!-- Add to Cart Button -->
                      <%
                        cart_base_price = product.respond_to?(:discount_price) && product.discount_price.present? ? product.discount_price : product.price
                        cart_gst_rate = product.gst_enabled ? (product.gst_percentage || 0) : 0
                        cart_gst_amount = cart_base_price * cart_gst_rate / 100
                        cart_final_price = cart_base_price + cart_gst_amount
                      %>
                      <button class="btn btn-primary w-100"
                              onclick="addToCart(<%= product.id %>, '<%= j(product.name) %>', <%= cart_final_price %>, <%= current_stock %>, <%= cart_base_price %>, <%= cart_gst_rate %>)"
                              data-base-price="<%= cart_base_price %>"
                              data-gst-rate="<%= cart_gst_rate %>"
                              data-final-price="<%= cart_final_price %>"
                              <%= 'disabled' if product.out_of_stock? %>>
                        <% if product.out_of_stock? %>
                          <i class="bi bi-x-circle me-2"></i>Out of Stock
                        <% else %>
                          <i class="bi bi-cart-plus me-2"></i>Add to Cart
                        <% end %>
                      </button>
                    <% else %>
                      <div class="text-center">
                        <button class="btn btn-danger w-100" disabled>
                          <i class="bi bi-x-circle me-2"></i>SOLD OUT
                        </button>
                        <small class="text-muted mt-1 d-block">Product is currently out of stock</small>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-box-seam fs-1 text-muted mb-3"></i>
          <h5 class="text-muted">No Products Available</h5>
          <p class="text-muted">Add products to start creating bookings.</p>
          <a href="<%= new_admin_product_path %>" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Add Product
          </a>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# Checkout View %>
<div id="checkoutView" style="display: none;">
  <div class="row">
    <%# Checkout Form %>
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Booking Details</h5>
        </div>
        <div class="card-body">
          <%= form_with model: [:admin, @booking], local: true, html: { id: 'bookingForm' } do |f| %>
            <% if @booking.errors.any? %>
              <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle me-2"></i>Please fix the following errors:</h6>
                <ul class="mb-0">
                  <% @booking.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <%# Customer Information %>
            <div class="mb-4">
              <h6 class="mb-3"><i class="bi bi-person me-2"></i>Customer Information</h6>

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">
                    <i class="bi bi-person-search me-1"></i>Search & Select Customer
                  </label>
                  <div class="position-relative">
                    <!-- Hidden input for form submission -->
                    <%= f.hidden_field :customer_id, id: 'selected_customer_id' %>

                    <!-- Search input with icon wrapper -->
                    <div class="customer-search-wrapper">
                      <i class="bi bi-search customer-search-icon"></i>
                      <input type="text"
                             class="form-control customer-search-input"
                             id="customerSearchInput"
                             placeholder="Search by name, phone, or email..."
                             autocomplete="off">
                    </div>

                    <!-- Search results dropdown -->
                    <div class="customer-search-dropdown" id="customerSearchDropdown">
                      <div class="customer-search-results" id="customerSearchResults">
                        <!-- Results will be populated here -->
                      </div>
                      <div class="customer-search-footer">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="showAllCustomers()">
                          <i class="bi bi-people me-1"></i>Show All Customers
                        </button>
                      </div>
                    </div>

                    <!-- Selected customer display -->
                    <div class="selected-customer-display" id="selectedCustomerDisplay" style="display: none;">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="customer-info">
                          <div class="customer-name fw-medium"></div>
                          <div class="customer-details text-muted small"></div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelectedCustomer()">
                          <i class="bi bi-x"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Store (Optional)</label>
                  <%= f.select :store_id,
                      options_for_select([['Select Store (Optional)', '']] + Store.active.map { |s| [s.display_name, s.id] }),
                      {},
                      { class: 'form-select', id: 'store_select', onchange: 'handleStoreSelection(this)' } %>
                  <div class="form-text">
                    <small><i class="bi bi-shop me-1"></i>Tag this sale to a store (auto-sets status to completed)</small>
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">
                    <i class="bi bi-flag me-1"></i>Status/Stage <span class="text-danger">*</span>
                  </label>
                  <%= f.select :status,
                      options_for_select([['Select Status', '']] + Booking.statuses.map { |key, value| [key.humanize, key] }, 'completed'),
                      {},
                      { class: 'form-select', required: true, id: 'booking_status' } %>
                  <div class="form-text">
                    <small><i class="bi bi-info-circle me-1"></i>Current booking status for tracking</small>
                  </div>

                  <!-- Status Preview -->
                  <div id="statusPreview" class="mt-2" style="display: none;">
                    <span class="badge" id="statusBadge">
                      <i id="statusIcon" class="me-1"></i>
                      <span id="statusName">Selected Status</span>
                    </span>
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                  <%= f.text_field :customer_name, class: 'form-control', placeholder: 'Enter customer name', required: true %>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
                  <%= f.text_field :customer_phone, class: 'form-control', placeholder: 'Enter mobile number', required: true %>
                </div>

                <div class="col-12">
                  <label class="form-label">Email Address</label>
                  <%= f.email_field :customer_email, class: 'form-control', placeholder: 'Enter email address' %>
                </div>

                <div class="col-12">
                  <label class="form-label">Delivery Address <span class="text-danger">*</span></label>
                  <%= f.text_area :delivery_address, class: 'form-control', rows: 3, placeholder: 'Enter complete delivery address', required: true %>
                </div>
              </div>
            </div>

            <%# Payment Information %>
            <div class="mb-4">
              <h6 class="mb-3"><i class="bi bi-credit-card me-2"></i>Payment Method</h6>

              <div class="row g-3">
                <div class="col-md-3">
                  <div class="form-check">
                    <%= f.radio_button :payment_method, 'cash', checked: true, class: 'form-check-input', id: 'payment_cash', onchange: 'selectPaymentMethod("cash")' %>
                    <label class="form-check-label" for="payment_cash">
                      <i class="bi bi-cash-stack me-1"></i>Cash Payment
                    </label>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="form-check">
                    <%= f.radio_button :payment_method, 'card', class: 'form-check-input', id: 'payment_card', onchange: 'selectPaymentMethod("card")' %>
                    <label class="form-check-label" for="payment_card">
                      <i class="bi bi-credit-card me-1"></i>Card Payment
                    </label>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="form-check">
                    <%= f.radio_button :payment_method, 'upi', class: 'form-check-input', id: 'payment_upi', onchange: 'selectPaymentMethod("upi")' %>
                    <label class="form-check-label" for="payment_upi">
                      <i class="bi bi-phone me-1"></i>UPI Payment
                    </label>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="form-check">
                    <%= f.radio_button :payment_method, 'online', class: 'form-check-input', id: 'payment_online', onchange: 'selectPaymentMethod("online")' %>
                    <label class="form-check-label" for="payment_online">
                      <i class="bi bi-globe me-1"></i>Online Payment
                    </label>
                  </div>
                </div>
              </div>

              <%# Cash Payment Details %>
              <div id="cashSection" class="mt-3">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Cash Received</label>
                    <%= f.number_field :cash_received, class: 'form-control', placeholder: '0.00', step: '0.01', onkeyup: 'calculateChange()' %>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Change to Return</label>
                    <%= f.number_field :change_amount, class: 'form-control', readonly: true, placeholder: '0.00' %>
                  </div>
                </div>
              </div>
            </div>

            <%# Payment Status %>
            <div class="mb-4">
              <h6 class="mb-3"><i class="bi bi-check-circle me-2"></i>Payment Status</h6>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check form-switch">
                    <%= f.check_box :payment_status,
                        { class: "form-check-input", id: "paymentStatusToggle" },
                        "paid", "unpaid" %>
                    <%= f.label :payment_status, "Mark as Paid", class: "form-check-label", for: "paymentStatusToggle" %>
                  </div>
                  <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Toggle this switch if payment has been received
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="alert alert-light border d-flex align-items-center mb-0" id="paymentStatusAlert">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    <span id="paymentStatusText">Payment not received</span>
                  </div>
                </div>
              </div>
            </div>

            <%# Additional Notes %>
            <div class="mb-4">
              <h6 class="mb-3"><i class="bi bi-chat-square-text me-2"></i>Additional Notes</h6>
              <%= f.text_area :notes, class: 'form-control', rows: 3, placeholder: 'Add any special instructions or notes for this booking...' %>
            </div>

            <%# Hidden Fields for Cart Items %>
            <div id="checkoutItemsFields"></div>

            <%# Hidden field for discount amount %>
            <%= f.hidden_field :discount_amount, value: 0, id: 'hiddenDiscountAmount' %>

            <%# Action Buttons %>
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" onclick="showProductsView()">
                <i class="bi bi-arrow-left me-1"></i>Back to Products
              </button>

              <button type="submit" name="create_order" value="1" class="btn btn-success" id="completeBookingBtn">
                <span class="btn-text">
                  <i class="bi bi-check-circle me-1"></i>Complete Booking
                </span>
                <span class="btn-loading d-none">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Processing booking...
                </span>
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Order Summary %>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header border-0 py-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 3px solid #667eea;">
          <h4 class="mb-0 text-black fw-bold"><i class="bi bi-receipt me-2 fs-4 text-primary"></i>ORDER SUMMARY</h4>
        </div>
        <div class="card-body">
          <div id="checkoutOrderSummary">
            <p class="text-muted text-center">No items in cart</p>
          </div>

          <div id="orderTotals" style="display: none;" class="border-top pt-3 mt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal</span>
              <span>₹<span id="checkoutSubtotal">0</span></span>
            </div>
            <div class="d-flex justify-content-between mb-2" id="gstRow">
              <span>GST</span>
              <span>₹<span id="checkoutTax">0</span></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Discount</span>
              <span>
                ₹<input type="number" id="checkoutDiscount" value="0" min="0" max="999999" step="0.01" class="form-control form-control-sm d-inline-block w-auto" style="width: 80px;" onchange="updateCheckoutTotals()" oninput="updateCheckoutTotals()">
              </span>
            </div>
            <div class="d-flex justify-content-between border-top pt-2 mb-0">
              <span class="fw-bold">Total Amount</span>
              <span class="fw-bold text-success fs-5">₹<span id="checkoutTotal">0</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Floating Cart - Enhanced and Larger %>
<div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1000;">
  <div class="card border-0 shadow-lg" id="floatingCart" style="min-width: 500px; max-width: 550px; display: none;">
    <div class="card-header py-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 3px solid #667eea;">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0 d-flex align-items-center fw-bold text-black">
          <i class="bi bi-cart3 me-2 fs-2 text-primary"></i>
          <span style="font-size: 1.75rem; letter-spacing: 1px; color: black; font-weight: 900;">SHOPPING CART</span>
        </h3>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary text-white px-3 py-2" style="font-size: 0.9rem; border: 2px solid #667eea;">
            <span id="cartCount">0</span> items
          </span>
          <button type="button" class="btn btn-sm btn-link text-dark p-0" onclick="minimizeCart()" title="Minimize">
            <i class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body p-3" style="max-height: 420px; overflow-y: auto;">
      <div id="cartItems">
        <p class="text-muted text-center mb-0">Your cart is empty</p>
      </div>
    </div>
    <div class="card-footer bg-light p-3">
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">Subtotal</span>
          <span class="fw-semibold">₹<span id="cartSubtotal">0</span></span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted" data-gst-label>Tax (GST)</span>
          <span class="fw-semibold">₹<span id="cartTax">0</span></span>
        </div>
        <div class="border-top pt-2">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold fs-5">Total</span>
            <span class="fw-bold fs-4 text-success">₹<span id="cartTotal">0</span></span>
          </div>
        </div>
      </div>
      <button class="btn btn-success btn-lg w-100" onclick="showCheckoutView()">
        <i class="bi bi-arrow-right-circle me-2"></i>Proceed to Checkout
      </button>
    </div>
  </div>

  <%# Minimized Cart Button - Enhanced %>
  <button class="btn btn-primary btn-lg rounded-circle shadow-lg" id="minimizedCart" style="display: none; width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid white;" onclick="maximizeCart()" title="Open Shopping Cart">
    <i class="bi bi-cart3 fs-2"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger fs-6" id="minimizedCartCount" style="padding: 5px 10px;">0</span>
  </button>
</div>

<%# JavaScript %>
<script>
// Shopping Cart System
let cart = {};
let currentView = 'products';

// Initialize cart
function initializeCart() {
  updateCartDisplay();
}

// Add item to cart
function addToCart(productId, productName, finalPrice, stock, basePrice, gstRate) {
  const quantity = parseInt(document.getElementById(`qty-${productId}`).value) || 1;

  if (quantity > stock) {
    alert(`Only ${stock} items available in stock!`);
    return;
  }

  if (cart[productId]) {
    if (cart[productId].quantity + quantity > stock) {
      alert(`Cannot add more items. Maximum stock: ${stock}`);
      return;
    }
    cart[productId].quantity += quantity;
  } else {
    cart[productId] = {
      name: productName,
      price: finalPrice,  // Final price including GST
      basePrice: basePrice || finalPrice,  // Base price without GST
      gstRate: gstRate || 0,  // GST percentage
      quantity: quantity,
      stock: stock
    };
  }

  // Reset quantity input
  document.getElementById(`qty-${productId}`).value = 1;

  updateCartDisplay();

  // Add pulse animation to cart
  const floatingCart = document.getElementById('floatingCart');
  const minimizedCart = document.getElementById('minimizedCart');
  if (floatingCart && floatingCart.style.display !== 'none') {
    floatingCart.classList.add('cart-pulse');
    setTimeout(() => floatingCart.classList.remove('cart-pulse'), 500);
  }
  if (minimizedCart && minimizedCart.style.display !== 'none') {
    minimizedCart.classList.add('cart-pulse');
    setTimeout(() => minimizedCart.classList.remove('cart-pulse'), 500);
  }

}

// Update cart display
function updateCartDisplay() {
  const cartCount = Object.keys(cart).length;
  const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
  const floatingCart = document.getElementById('floatingCart');
  const minimizedCart = document.getElementById('minimizedCart');
  const cartCountEl = document.getElementById('cartCount');
  const minimizedCartCountEl = document.getElementById('minimizedCartCount');
  const cartItemsEl = document.getElementById('cartItems');
  const cartSubtotalEl = document.getElementById('cartSubtotal');
  const cartTaxEl = document.getElementById('cartTax');
  const cartTotalEl = document.getElementById('cartTotal');

  cartCountEl.textContent = totalItems;
  minimizedCartCountEl.textContent = totalItems;

  if (cartCount === 0) {
    floatingCart.style.display = 'none';
    minimizedCart.style.display = 'none';
    cartItemsEl.innerHTML = '<div class="text-center py-4"><i class="bi bi-cart-x fs-1 text-muted d-block mb-2"></i><p class="text-muted mb-0">Your cart is empty</p><small class="text-muted">Add products to get started</small></div>';
    cartSubtotalEl.textContent = '0';
    cartTaxEl.textContent = '0';
    cartTotalEl.textContent = '0';
    return;
  }

  // Show cart if it was hidden
  if (floatingCart.style.display === 'none' && minimizedCart.style.display === 'none') {
    floatingCart.style.display = 'block';
  }

  let itemsHtml = '';
  let subtotal = 0;

  // Sort items by name for consistent display
  const sortedItems = Object.entries(cart).sort((a, b) => a[1].name.localeCompare(b[1].name));

  for (const [productId, item] of sortedItems) {
    const itemBasePrice = item.basePrice || item.price;
    const itemGSTRate = item.gstRate || 0;
    let itemTotal;

    if (itemGSTRate > 0) {
      // Product has GST - calculate base price subtotal separately
      const itemSubtotal = itemBasePrice * item.quantity;
      subtotal += itemSubtotal;
      itemTotal = item.price * item.quantity; // Full price for display
    } else {
      // Product has no GST
      itemTotal = item.price * item.quantity;
      subtotal += itemTotal;
    }

    itemsHtml += `
      <div class="cart-item-card mb-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="flex-grow-1">
            <div class="fw-semibold text-dark" style="font-size: 0.95rem;">${item.name}</div>
            <div class="d-flex align-items-center gap-2 mt-1">
              <span class="badge bg-light text-dark">₹${item.price} each</span>
              ${item.quantity >= item.stock - 2 ? `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Only ${item.stock} in stock</span>` : ''}
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger p-1" onclick="removeFromCart(${productId})" title="Remove item">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="input-group input-group-sm" style="width: 140px;">
            <button class="btn btn-outline-secondary px-3" type="button" onclick="decreaseCartQuantity(${productId})" ${item.quantity <= 1 ? 'disabled' : ''}>
              <i class="bi bi-dash"></i>
            </button>
            <input type="text" class="form-control text-center fw-bold" value="${item.quantity}" readonly style="background: white;">
            <button class="btn btn-outline-secondary px-3" type="button" onclick="increaseCartQuantity(${productId})" ${item.quantity >= item.stock ? 'disabled' : ''}>
              <i class="bi bi-plus"></i>
            </button>
          </div>
          <div class="text-end">
            <div class="fw-bold fs-5 text-primary">₹${itemTotal.toFixed(2)}</div>
            <small class="text-muted">${item.quantity} × ₹${item.price}</small>
          </div>
        </div>
      </div>
    `;
  }

  // Calculate GST based on individual products
  let totalGST = 0;
  for (const [productId, item] of Object.entries(cart)) {
    const itemGSTRate = item.gstRate || 0;
    if (itemGSTRate > 0) {
      const itemBasePrice = item.basePrice || item.price;
      const itemSubtotal = itemBasePrice * item.quantity;
      totalGST += itemSubtotal * itemGSTRate / 100;
    }
  }

  const total = subtotal + totalGST;

  cartItemsEl.innerHTML = itemsHtml;
  cartSubtotalEl.textContent = subtotal.toFixed(2);
  cartTaxEl.textContent = totalGST.toFixed(2);
  cartTotalEl.textContent = total.toFixed(2);

  // Update GST label in cart
  const cartGSTLabel = document.querySelector('#floatingCart .text-muted[data-gst-label]');
  if (cartGSTLabel) {
    if (totalGST > 0) {
      cartGSTLabel.textContent = 'GST';
    } else {
      cartGSTLabel.textContent = 'Tax (No GST)';
    }
  }
}

// Minimize cart to icon
function minimizeCart() {
  const floatingCart = document.getElementById('floatingCart');
  const minimizedCart = document.getElementById('minimizedCart');

  floatingCart.style.display = 'none';
  minimizedCart.style.display = 'block';

  // Add bounce animation
  minimizedCart.classList.add('animate-bounce');
  setTimeout(() => {
    minimizedCart.classList.remove('animate-bounce');
  }, 500);
}

// Maximize cart from icon
function maximizeCart() {
  const floatingCart = document.getElementById('floatingCart');
  const minimizedCart = document.getElementById('minimizedCart');

  minimizedCart.style.display = 'none';
  floatingCart.style.display = 'block';

  // Add slide-in animation
  floatingCart.classList.add('animate-slide-in');
  setTimeout(() => {
    floatingCart.classList.remove('animate-slide-in');
  }, 300);
}

// Remove item from cart
function removeFromCart(productId) {
  const item = cart[productId];
  if (item) {
    showNotification(`${item.name} removed from cart`, 'info');
  }
  delete cart[productId];
  updateCartDisplay();
  updateCheckoutDisplay();
}

// Increase cart item quantity
function increaseCartQuantity(productId) {
  if (cart[productId]) {
    if (cart[productId].quantity < cart[productId].stock) {
      cart[productId].quantity += 1;
      updateCartDisplay();
      updateCheckoutDisplay();
      showNotification(`Quantity increased for ${cart[productId].name}`, 'success');
    } else {
      showNotification(`Maximum stock reached for ${cart[productId].name}`, 'warning');
    }
  }
}

// Decrease cart item quantity
function decreaseCartQuantity(productId) {
  if (cart[productId]) {
    if (cart[productId].quantity > 1) {
      cart[productId].quantity -= 1;
      updateCartDisplay();
      updateCheckoutDisplay();
      showNotification(`Quantity decreased for ${cart[productId].name}`, 'success');
    } else {
      // If quantity would be 0, remove the item
      removeFromCart(productId);
    }
  }
}

// Show Products View
function showProductsView() {
  currentView = 'products';
  document.getElementById('productsView').style.display = 'block';
  document.getElementById('checkoutView').style.display = 'none';

  // Show search and filters section when in products view
  document.getElementById('searchSection').style.display = 'block';

  // Update buttons safely
  const productsBtn = document.getElementById('productsViewBtn');
  const checkoutBtn = document.getElementById('checkoutViewBtn');
  const productsBtnLarge = document.getElementById('productsViewBtnLarge');
  const checkoutBtnLarge = document.getElementById('checkoutViewBtnLarge');

  if (productsBtn) {
    productsBtn.style.display = 'none';
    productsBtn.className = 'btn btn-primary btn-sm shadow-lg';
  }
  if (checkoutBtn) {
    checkoutBtn.style.display = 'block';
    checkoutBtn.className = 'btn btn-outline-primary btn-sm shadow-lg';
  }
  if (productsBtnLarge) {
    productsBtnLarge.style.display = 'none';
    productsBtnLarge.className = 'btn btn-primary px-3 py-2 rounded-3 shadow-sm';
  }
  if (checkoutBtnLarge) {
    checkoutBtnLarge.style.display = 'block';
    checkoutBtnLarge.className = 'btn btn-outline-primary px-3 py-2 rounded-3 shadow-sm';
  }
}

// Show Checkout View
function showCheckoutView() {
  if (Object.keys(cart).length === 0) {
    alert('Please add items to cart before checkout');
    return;
  }

  currentView = 'checkout';
  document.getElementById('productsView').style.display = 'none';
  document.getElementById('checkoutView').style.display = 'block';

  // Hide search and filters section when in checkout view
  document.getElementById('searchSection').style.display = 'none';

  // Update buttons safely
  const productsBtn = document.getElementById('productsViewBtn');
  const checkoutBtn = document.getElementById('checkoutViewBtn');
  const productsBtnLarge = document.getElementById('productsViewBtnLarge');
  const checkoutBtnLarge = document.getElementById('checkoutViewBtnLarge');

  if (productsBtn) {
    productsBtn.style.display = 'block';
    productsBtn.className = 'btn btn-outline-primary btn-sm shadow-lg';
  }
  if (checkoutBtn) {
    checkoutBtn.style.display = 'none';
    checkoutBtn.className = 'btn btn-primary btn-sm shadow-lg';
  }
  if (productsBtnLarge) {
    productsBtnLarge.style.display = 'block';
    productsBtnLarge.className = 'btn btn-outline-primary px-3 py-2 rounded-3 shadow-sm';
  }
  if (checkoutBtnLarge) {
    checkoutBtnLarge.style.display = 'none';
    checkoutBtnLarge.className = 'btn btn-primary px-3 py-2 rounded-3 shadow-sm';
  }

  updateCheckoutDisplay();
}

// Update checkout display
function updateCheckoutDisplay() {
  const orderSummaryEl = document.getElementById('checkoutOrderSummary');
  const orderTotalsEl = document.getElementById('orderTotals');
  const fieldsContainer = document.getElementById('checkoutItemsFields');

  const itemCount = Object.keys(cart).length;

  if (itemCount === 0) {
    orderSummaryEl.innerHTML = '<p class="text-muted text-center">No items in cart</p>';
    orderTotalsEl.style.display = 'none';
    fieldsContainer.innerHTML = '';
    return;
  }

  orderTotalsEl.style.display = 'block';

  let summaryHtml = '';
  let fieldsHtml = '';
  let subtotal = 0;
  let fieldIndex = 0;

  for (const [productId, item] of Object.entries(cart)) {
    const itemBasePrice = item.basePrice || item.price;
    const itemGSTRate = item.gstRate || 0;
    let itemTotal;
    let itemGSTAmount = 0;

    if (itemGSTRate > 0) {
      // Product has GST enabled
      const itemSubtotal = itemBasePrice * item.quantity;
      itemGSTAmount = itemSubtotal * itemGSTRate / 100;
      itemTotal = itemSubtotal + itemGSTAmount;
      subtotal += itemSubtotal;
    } else {
      // Product has no GST
      itemTotal = item.price * item.quantity;
      subtotal += itemTotal;
    }

    summaryHtml += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-medium">${item.name}</div>
          <small class="text-muted">₹${item.price.toFixed(2)} × ${item.quantity}</small>
          ${itemGSTRate > 0 ? `<br><small class="text-success">GST ${itemGSTRate}%: ₹${itemGSTAmount.toFixed(2)}</small>` : ''}
        </div>
        <span class="fw-medium">₹${itemTotal.toFixed(2)}</span>
      </div>
    `;

    fieldsHtml += `
      <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][product_id]" value="${productId}">
      <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][quantity]" value="${item.quantity}">
      <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][price]" value="${item.price}">
    `;
    fieldIndex++;
  }

  orderSummaryEl.innerHTML = summaryHtml;
  fieldsContainer.innerHTML = fieldsHtml;

  updateCheckoutTotals();
}

// Ensure cart items are in form before submission
function ensureCartItemsInForm() {
  const fieldsContainer = document.getElementById('checkoutItemsFields');

  // If fields container is empty but cart has items, regenerate the fields
  if (fieldsContainer && Object.keys(cart).length > 0) {
    let fieldsHtml = '';
    let fieldIndex = 0;

    for (const [productId, item] of Object.entries(cart)) {
      fieldsHtml += `
        <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][product_id]" value="${productId}">
        <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][quantity]" value="${item.quantity}">
        <input type="hidden" name="booking[booking_items_attributes][${fieldIndex}][price]" value="${item.price}">
      `;
      fieldIndex++;
    }

    fieldsContainer.innerHTML = fieldsHtml;

    // Log for debugging
    console.log('Cart items added to form:', cart);
    console.log('Form fields generated:', fieldsHtml);
  }
}

// Update checkout totals
function updateCheckoutTotals() {
  let subtotal = 0;
  let totalGST = 0;

  // Calculate subtotal and GST based on each product's GST configuration
  for (const [productId, item] of Object.entries(cart)) {
    const itemBasePrice = item.basePrice || item.price;
    const itemGSTRate = item.gstRate || 0;

    if (itemGSTRate > 0) {
      // Product has GST enabled
      const itemSubtotal = itemBasePrice * item.quantity;
      const itemGST = itemSubtotal * itemGSTRate / 100;
      subtotal += itemSubtotal;
      totalGST += itemGST;
    } else {
      // Product has no GST
      subtotal += item.price * item.quantity;
    }
  }

  let discount = parseFloat(document.getElementById('checkoutDiscount')?.value || 0);

  // Validate discount doesn't exceed subtotal + GST
  const maxDiscount = subtotal + totalGST;
  if (discount > maxDiscount) {
    discount = maxDiscount;
    document.getElementById('checkoutDiscount').value = discount;
  }

  // Update the hidden field with the discount value
  const hiddenDiscountField = document.getElementById('hiddenDiscountAmount');
  if (hiddenDiscountField) {
    hiddenDiscountField.value = discount;
    console.log('Updated hidden discount field to:', discount);
  }

  const total = subtotal + totalGST - discount; // Final total after discount

  // Update display
  document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);

  // Show/highlight discount row when discount is applied
  const discountInput = document.getElementById('checkoutDiscount');
  if (discount > 0) {
    discountInput.style.borderColor = '#198754';
    discountInput.style.backgroundColor = '#f8fff9';
  } else {
    discountInput.style.borderColor = '';
    discountInput.style.backgroundColor = '';
  }

  // Only show GST if there is any GST amount
  const gstRow = document.getElementById('gstRow');
  if (gstRow) {
    if (totalGST > 0) {
      gstRow.style.display = 'flex';
      document.getElementById('checkoutTax').textContent = totalGST.toFixed(2);
    } else {
      gstRow.style.display = 'none';
    }
  } else {
    document.getElementById('checkoutTax').textContent = totalGST.toFixed(2);
  }

  document.getElementById('checkoutTotal').textContent = total.toFixed(2);

  // Update change calculation when total changes
  calculateChange();
}

// Payment method selection
function selectPaymentMethod(method) {
  const cashSection = document.getElementById('cashSection');
  if (method === 'cash') {
    cashSection.style.display = 'block';
  } else {
    cashSection.style.display = 'none';
  }
}

// Calculate change for cash payment
function calculateChange() {
  const total = parseFloat(document.getElementById('checkoutTotal').textContent) || 0;
  const received = parseFloat(document.getElementById('booking_cash_received').value) || 0;
  const change = Math.max(0, received - total);
  document.getElementById('booking_change_amount').value = change.toFixed(2);
}

// Customer Search System
let customers = <%= raw @customers.map { |c| {
  id: c.id,
  name: c.respond_to?(:display_name) ? c.display_name : "#{c.first_name} #{c.last_name}".strip,
  first_name: c.first_name,
  last_name: c.last_name,
  mobile: c.mobile,
  email: c.email,
  address: c.respond_to?(:address) ? c.address : ''
}}.to_json %>;

let searchTimeout;
let currentSearchQuery = '';
let selectedCustomerIndex = -1;

// Initialize customer search
function initializeCustomerSearch() {
  const searchInput = document.getElementById('customerSearchInput');
  const dropdown = document.getElementById('customerSearchDropdown');

  if (!searchInput || !dropdown) return;

  // Show dropdown on focus
  searchInput.addEventListener('focus', function() {
    if (this.value.length >= 1 || customers.length <= 20) {
      showCustomerDropdown();
      if (this.value.length >= 1) {
        performCustomerSearch(this.value);
      } else {
        showAllCustomers();
      }
    }
  });

  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.position-relative')) {
      hideCustomerDropdown();
    }
  });

  // Search as user types
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    currentSearchQuery = query;
    selectedCustomerIndex = -1;

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (query.length >= 1) {
        showCustomerDropdown();
        performCustomerSearch(query);
      } else if (query.length === 0) {
        if (customers.length <= 20) {
          showAllCustomers();
        } else {
          hideCustomerDropdown();
        }
      }
    }, 300);
  });

  // Handle keyboard navigation
  searchInput.addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('.customer-search-item');

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedCustomerIndex = Math.min(selectedCustomerIndex + 1, items.length - 1);
      updateHighlightedItem(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedCustomerIndex = Math.max(selectedCustomerIndex - 1, -1);
      updateHighlightedItem(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedCustomerIndex >= 0 && items[selectedCustomerIndex]) {
        items[selectedCustomerIndex].click();
      }
    } else if (e.key === 'Escape') {
      hideCustomerDropdown();
      this.blur();
    }
  });
}

function performCustomerSearch(query) {
  const results = document.getElementById('customerSearchResults');
  if (!results) return;

  // Show loading
  results.innerHTML = '<div class="customer-search-loading"><div class="customer-search-spinner"></div>Searching customers...</div>';

  // Simulate network delay for better UX
  setTimeout(() => {
    const filteredCustomers = customers.filter(customer =>
      customer.name.toLowerCase().includes(query.toLowerCase()) ||
      customer.mobile.includes(query) ||
      (customer.email && customer.email.toLowerCase().includes(query.toLowerCase()))
    ).slice(0, 10); // Limit to 10 results

    displayCustomerResults(filteredCustomers, query);
  }, 200);
}

function displayCustomerResults(customerList, searchQuery = '') {
  const results = document.getElementById('customerSearchResults');
  if (!results) return;

  if (customerList.length === 0) {
    results.innerHTML = '<div class="customer-search-empty"><i class="bi bi-person-x fs-4 mb-2 d-block text-muted"></i><div class="fw-medium">No customers found</div><small class="text-muted">Try searching with a different name, phone, or email</small></div>';
    return;
  }

  let html = '';
  customerList.forEach((customer, index) => {
    const highlightedName = highlightSearchTerm(customer.name, searchQuery);
    const highlightedMobile = highlightSearchTerm(customer.mobile, searchQuery);
    const highlightedEmail = customer.email ? highlightSearchTerm(customer.email, searchQuery) : '';

    html += '<div class="customer-search-item" onclick="selectCustomer(' + customer.id + ', \'' + escapeHtml(customer.name) + '\', \'' + customer.mobile + '\', \'' + escapeHtml(customer.email) + '\', \'' + escapeHtml(customer.address) + '\')" data-index="' + index + '">';
    html += '<div class="customer-result-card">';
    html += '<div class="customer-result-name">' + highlightedName + '</div>';
    html += '<div class="customer-result-details">';
    html += '<span class="customer-detail-item"><i class="bi bi-phone"></i>' + highlightedMobile + '</span>';
    if (customer.email) {
      html += '<span class="customer-detail-item"><i class="bi bi-envelope"></i>' + highlightedEmail + '</span>';
    }
    html += '<span class="customer-detail-badge">ID: ' + customer.id + '</span>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
  });

  results.innerHTML = html;
}

function highlightSearchTerm(text, searchTerm) {
  if (!searchTerm || !text) return text;
  const regex = new RegExp('(' + escapeRegex(searchTerm) + ')', 'gi');
  return text.replace(regex, '<mark style="background-color: #fff3cd; padding: 1px 2px; border-radius: 3px;">$1</mark>');
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/'/g, "\\\\'").replace(/"/g, '&quot;');
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&');
}

function updateHighlightedItem(items) {
  items.forEach((item, index) => {
    item.classList.toggle('active', index === selectedCustomerIndex);
  });

  if (selectedCustomerIndex >= 0 && items[selectedCustomerIndex]) {
    items[selectedCustomerIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

function selectCustomer(customerId, customerName, customerMobile, customerEmail, customerAddress) {
  document.getElementById('selected_customer_id').value = customerId;
  document.getElementById('customerSearchInput').style.display = 'none';

  const selectedDisplay = document.getElementById('selectedCustomerDisplay');
  selectedDisplay.style.display = 'block';
  selectedDisplay.querySelector('.customer-name').textContent = customerName;
  selectedDisplay.querySelector('.customer-details').innerHTML = '<div class="d-flex align-items-center gap-2 flex-wrap"><span class="badge bg-primary-subtle text-primary"><i class="bi bi-telephone me-1"></i>' + customerMobile + '</span>' + (customerEmail ? '<span class="badge bg-success-subtle text-success"><i class="bi bi-envelope me-1"></i>' + customerEmail + '</span>' : '') + '</div>';

  document.getElementById('booking_customer_name').value = customerName;
  document.getElementById('booking_customer_phone').value = customerMobile;
  document.getElementById('booking_customer_email').value = customerEmail || '';
  if (customerAddress) {
    document.getElementById('booking_delivery_address').value = customerAddress;
  }

  hideCustomerDropdown();
  showNotification('Selected customer: ' + customerName, 'success');
}

function clearSelectedCustomer() {
  document.getElementById('selected_customer_id').value = '';
  document.getElementById('customerSearchInput').style.display = 'block';
  document.getElementById('customerSearchInput').value = '';
  document.getElementById('selectedCustomerDisplay').style.display = 'none';

  document.getElementById('booking_customer_name').value = '';
  document.getElementById('booking_customer_phone').value = '';
  document.getElementById('booking_customer_email').value = '';
  document.getElementById('booking_delivery_address').value = '';

  document.getElementById('customerSearchInput').focus();
}

function showAllCustomers() {
  displayCustomerResults(customers.slice(0, 10));
}

function showCustomerDropdown() {
  const dropdown = document.getElementById('customerSearchDropdown');
  if (dropdown) {
    dropdown.classList.add('show');
  }
}

function hideCustomerDropdown() {
  const dropdown = document.getElementById('customerSearchDropdown');
  if (dropdown) {
    dropdown.classList.remove('show');
  }
  selectedCustomerIndex = -1;
}

// Quantity controls
function increaseQuantity(productId) {
  const input = document.getElementById(`qty-${productId}`);
  const max = parseInt(input.max);
  const current = parseInt(input.value) || 1;
  if (current < max) {
    input.value = current + 1;
  }
}

function decreaseQuantity(productId) {
  const input = document.getElementById(`qty-${productId}`);
  const current = parseInt(input.value) || 1;
  if (current > 1) {
    input.value = current - 1;
  }
}

// Validate quantity doesn't exceed available stock
function validateQuantity(productId, maxStock) {
  const input = document.getElementById(`qty-${productId}`);
  const value = parseInt(input.value) || 1;

  if (value > maxStock) {
    input.value = maxStock;
    showNotification(`Maximum ${maxStock} items available for this product`, 'warning');
  } else if (value < 1) {
    input.value = 1;
  }
}

// Notification system
function showNotification(message, type = 'success') {
  const colors = {
    success: 'alert-success',
    warning: 'alert-warning',
    danger: 'alert-danger',
    info: 'alert-info'
  };

  const icons = {
    success: 'bi-check-circle-fill',
    warning: 'bi-exclamation-triangle-fill',
    danger: 'bi-x-circle-fill',
    info: 'bi-info-circle-fill'
  };

  const notification = document.createElement('div');
  notification.className = `alert ${colors[type]} alert-dismissible fade show position-fixed bottom-0 start-50 translate-middle-x mb-3`;
  notification.style.cssText = 'z-index: 9999; min-width: 350px; max-width: 500px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);';
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${icons[type]} me-2 fs-5"></i>
      <div class="flex-grow-1">${message}</div>
      <button type="button" class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  document.body.appendChild(notification);

  // Slide in animation
  setTimeout(() => {
    notification.style.transform = 'translateX(-50%) translateY(-10px)';
  }, 10);

  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(-50%) translateY(20px)';
    setTimeout(() => notification.remove(), 300);
  }, 4000);
}

// Search functionality
function setupSearch() {
  const searchInput = document.getElementById('productSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      document.querySelectorAll('.product-grid-item').forEach(card => {
        const name = card.querySelector('h6')?.textContent?.toLowerCase() || '';
        const categoryElement = card.querySelector('small');
        const category = categoryElement?.textContent?.toLowerCase() || '';

        // Get the SKU from the second small element (SKU: xxx format)
        const skuElement = card.querySelectorAll('small')[1];
        const sku = skuElement?.textContent?.toLowerCase() || '';

        if (name.includes(searchTerm) ||
            category.includes(searchTerm) ||
            sku.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  }
}

// Filter functionality
function filterProducts(type) {
  const products = document.querySelectorAll('.product-grid-item');
  const allBtn = document.getElementById('allProductsBtn');
  const inStockBtn = document.getElementById('inStockBtn');

  // Update button states
  allBtn.classList.remove('active');
  inStockBtn.classList.remove('active');

  if (type === 'all') {
    allBtn.classList.add('active');
    products.forEach(product => {
      product.style.display = 'block';
    });
  } else if (type === 'instock') {
    inStockBtn.classList.add('active');
    products.forEach(product => {
      const stock = parseInt(product.dataset.stock) || 0;
      product.style.display = stock > 0 ? 'block' : 'none';
    });
  }
}

// Apply category filter
function applyCategoryFilter() {
  const categoryFilter = document.getElementById('categoryFilter').value;
  const products = document.querySelectorAll('.product-grid-item');

  products.forEach(product => {
    if (!categoryFilter || product.dataset.category === categoryFilter) {
      product.style.display = 'block';
    } else {
      product.style.display = 'none';
    }
  });
}

// Handle store selection - automatically set status to completed if store is selected
function handleStoreSelection(select) {
  const statusSelect = document.getElementById('booking_status');

  if (select.value && select.value !== '') {
    // Store is selected - set status to completed
    if (statusSelect) {
      statusSelect.value = 'completed';
      updateStatusPreview();

      // Show notification
      showNotification('Status automatically set to "Completed" as store is selected', 'info');

      // Add visual feedback
      statusSelect.style.backgroundColor = '#d4edda';
      setTimeout(() => {
        statusSelect.style.backgroundColor = '';
      }, 2000);
    }
  } else {
    // Store is deselected - optionally reset status to draft
    if (statusSelect && statusSelect.value === 'completed') {
      statusSelect.value = 'draft';
      updateStatusPreview();
      showNotification('Status reset to "Draft" as store was deselected', 'warning');
    }
  }
}

// Status management
function updateStatusPreview() {
  const statusSelect = document.getElementById('booking_status');
  const statusPreview = document.getElementById('statusPreview');
  const statusBadge = document.getElementById('statusBadge');
  const statusIcon = document.getElementById('statusIcon');
  const statusName = document.getElementById('statusName');

  if (!statusSelect || !statusPreview) return;

  const selectedValue = statusSelect.value;
  const selectedText = statusSelect.options[statusSelect.selectedIndex].text;

  if (selectedValue === '') {
    statusPreview.style.display = 'none';
    return;
  }

  // Status configurations from booking model
  const statusConfigs = {
    'draft': { color: 'bg-secondary', icon: 'bi-pencil' },
    'ordered_and_delivery_pending': { color: 'bg-secondary', icon: 'bi-clock' },
    'confirmed': { color: 'bg-info', icon: 'bi-check-circle' },
    'processing': { color: 'bg-warning', icon: 'bi-gear' },
    'packed': { color: 'bg-warning', icon: 'bi-box' },
    'shipped': { color: 'bg-primary', icon: 'bi-truck' },
    'out_for_delivery': { color: 'bg-primary', icon: 'bi-geo-alt' },
    'delivered': { color: 'bg-success', icon: 'bi-house-check' },
    'completed': { color: 'bg-success', icon: 'bi-check-all' },
    'cancelled': { color: 'bg-danger', icon: 'bi-x-circle' },
    'returned': { color: 'bg-danger', icon: 'bi-arrow-return-left' }
  };

  const config = statusConfigs[selectedValue] || { color: 'bg-secondary', icon: 'bi-question-circle' };

  statusBadge.className = `badge ${config.color}`;
  statusIcon.className = `${config.icon} me-1`;
  statusName.textContent = selectedText;
  statusPreview.style.display = 'block';
}

// Booking loader functionality
function showBookingLoader() {
  const submitBtn = document.getElementById('completeBookingBtn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnLoading = submitBtn.querySelector('.btn-loading');

  if (submitBtn && btnText && btnLoading) {
    // Hide normal text and show loading
    btnText.classList.add('d-none');
    btnLoading.classList.remove('d-none');

    // Disable the button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-loading-state');

    // Disable the back button during processing
    const backBtn = document.querySelector('button[onclick="showProductsView()"]');
    if (backBtn) {
      backBtn.disabled = true;
      backBtn.classList.add('opacity-50');
    }

    // Show overlay message
    showProcessingOverlay();
  }
}

function showProcessingOverlay() {
  // Create an overlay to prevent user interaction
  const overlay = document.createElement('div');
  overlay.id = 'bookingProcessingOverlay';
  overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
  overlay.style.cssText = `
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 9999;
  `;

  overlay.innerHTML = `
    <div class="text-center text-white">
      <div class="spinner-border spinner-border-lg mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 class="mb-2">Processing Your Booking</h5>
      <p class="mb-0 opacity-75">Please wait while we save your booking details...</p>
      <div class="mt-3">
        <small class="opacity-50">⚠️ Please do not close this window or navigate away</small>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
}

// Initialize payment status functionality
function initializePaymentStatus() {
  const paymentStatusToggle = document.getElementById('paymentStatusToggle');
  const paymentStatusAlert = document.getElementById('paymentStatusAlert');

  if (!paymentStatusToggle || !paymentStatusAlert) {
    console.error('Payment status elements not found');
    return;
  }

  // Update payment status display
  function updatePaymentStatusDisplay() {
    if (paymentStatusToggle.checked) {
      // Paid status
      paymentStatusAlert.className = 'alert alert-success border-success bg-success bg-opacity-10 d-flex align-items-center mb-0';
      paymentStatusAlert.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i><span>Payment received ✓</span>';
    } else {
      // Unpaid status
      paymentStatusAlert.className = 'alert alert-light border d-flex align-items-center mb-0';
      paymentStatusAlert.innerHTML = '<i class="bi bi-exclamation-triangle text-warning me-2"></i><span>Payment not received</span>';
    }
  }

  // Listen for changes
  paymentStatusToggle.addEventListener('change', updatePaymentStatusDisplay);

  // Initial display update
  updatePaymentStatusDisplay();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeCart();
  setupSearch();
  initializeCustomerSearch();

  // Set default payment method
  selectPaymentMethod('cash');

  // Update checkout totals when discount changes
  const discountInput = document.getElementById('checkoutDiscount');
  if (discountInput) {
    discountInput.addEventListener('change', updateCheckoutTotals);
  }

  // Add category filter listener
  const categoryFilter = document.getElementById('categoryFilter');
  if (categoryFilter) {
    categoryFilter.addEventListener('change', applyCategoryFilter);
  }

  // Initialize payment status functionality
  initializePaymentStatus();

  // Add status change listener
  const statusSelect = document.getElementById('booking_status');
  if (statusSelect) {
    statusSelect.addEventListener('change', updateStatusPreview);
  }

  // Prevent form submission with empty cart
  const bookingForm = document.getElementById('bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', function(e) {
      if (Object.keys(cart).length === 0) {
        e.preventDefault();
        alert('Please add items to cart before submitting');
        return false;
      }

      // Clean discount input and update hidden field before submission
      const discountInput = document.getElementById('checkoutDiscount');
      const hiddenDiscountField = document.getElementById('hiddenDiscountAmount');

      if (discountInput && hiddenDiscountField) {
        // Clean the discount value - remove any whitespace/newlines
        let discountValue = discountInput.value || 0;
        const cleanedValue = discountValue.toString().replace(/\s+/g, '').trim();
        const numericValue = parseFloat(cleanedValue) || 0;

        discountInput.value = cleanedValue;
        hiddenDiscountField.value = numericValue;
        console.log('Final discount value before submission:', numericValue);
      }

      // Check if status is selected
      const statusSelect = document.getElementById('booking_status');
      if (statusSelect && statusSelect.value === '') {
        e.preventDefault();
        alert('Please select a status for this booking');
        statusSelect.focus();
        return false;
      }

      // IMPORTANT: Ensure cart items are added to form before submission
      ensureCartItemsInForm();

      // Show loading state
      showBookingLoader();
    });
  }
});
</script>

<style>
/* Hover effects */
.hover-lift {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-lift:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Product grid responsive */
@media (max-width: 768px) {
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }

  .position-fixed {
    position: relative !important;
  }
}

/* Customer Search Dropdown Styles */
.customer-search-wrapper {
  position: relative;
}

.customer-search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #94a3b8;
  font-size: 0.95rem;
  z-index: 2;
  transition: color 0.3s ease;
}

.customer-search-input {
  position: relative;
  z-index: 1;
  border-radius: 8px;
  padding-left: 38px !important;
  background: #f8f9fa;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.customer-search-input:focus {
  border-color: #0d6efd;
  background: white;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

.customer-search-input:focus ~ .customer-search-icon,
.customer-search-wrapper:has(.customer-search-input:focus) .customer-search-icon {
  color: #0d6efd;
}

.customer-search-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e0e6ed;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.12);
  z-index: 1000;
  max-height: 420px;
  overflow: hidden;
  display: none;
}

.customer-search-dropdown.show {
  display: block;
  animation: slideDown 0.25s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.customer-search-results {
  max-height: 340px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 #f1f5f9;
}

.customer-search-results::-webkit-scrollbar {
  width: 6px;
}

.customer-search-results::-webkit-scrollbar-track {
  background: #f1f5f9;
}

.customer-search-results::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.customer-search-results::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Clean Customer Search Item Styles */
.customer-search-item {
  border-bottom: 1px solid #f1f5f9;
  cursor: pointer;
  transition: all 0.2s ease;
}

.customer-search-item:hover {
  background: linear-gradient(to right, #f8fbff 0%, #f1f8ff 100%);
}

.customer-search-item:last-child {
  border-bottom: none;
}

.customer-search-item.active {
  background: linear-gradient(to right, #e7f3ff 0%, #deedff 100%);
  border-left: 3px solid #0d6efd;
}

/* Modern Two-Line Card Layout */
.customer-result-card {
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.customer-result-name {
  font-weight: 600;
  color: #1e293b;
  font-size: 0.95rem;
  line-height: 1.4;
  letter-spacing: -0.01em;
}

.customer-result-details {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.customer-detail-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 400;
}

.customer-detail-item i {
  font-size: 0.75rem;
  color: #94a3b8;
  opacity: 0.8;
}

.customer-detail-badge {
  margin-left: auto;
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  color: #64748b;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 500;
  letter-spacing: 0.5px;
}

/* Hover Effects */
.customer-search-item:hover .customer-result-name {
  color: #0d6efd;
}

.customer-search-item:hover .customer-detail-item i {
  color: #0d6efd;
  opacity: 1;
}

.customer-search-item:hover .customer-detail-badge {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
}

/* Active/Selected State */
.customer-search-item.active .customer-result-name {
  color: #0d6efd;
}

.customer-search-item.active .customer-detail-badge {
  background: #0d6efd;
  color: white;
}

/* Responsive design for customer search */
@media (max-width: 768px) {
  .customer-result-card {
    padding: 12px 14px;
  }

  .customer-result-name {
    font-size: 0.9rem;
  }

  .customer-result-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .customer-detail-item {
    font-size: 0.8rem;
  }

  .customer-detail-badge {
    margin-left: 0;
    align-self: flex-start;
  }
}

.customer-search-footer {
  padding: 10px 12px;
  border-top: 1px solid #f1f5f9;
  background: linear-gradient(to bottom, #fafbfc 0%, #f8f9fa 100%);
}

.customer-search-footer .btn {
  border-radius: 8px;
  font-size: 0.85rem;
  padding: 6px 12px;
  border: 1px solid #e2e8f0;
  background: white;
  transition: all 0.2s ease;
}

.customer-search-footer .btn:hover {
  background: #0d6efd;
  border-color: #0d6efd;
  color: white;
}

.selected-customer-display {
  padding: 12px 14px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0284c7;
  border-radius: 10px;
  margin-top: 8px;
  box-shadow: 0 2px 8px rgba(2, 132, 199, 0.1);
}

.selected-customer-display .customer-info {
  flex-grow: 1;
}

.selected-customer-display .customer-name {
  font-weight: 600;
  color: #0c4a6e;
  font-size: 0.95rem;
  margin-bottom: 4px;
}

.selected-customer-display .btn-outline-danger {
  border-radius: 6px;
  padding: 4px 8px;
  border: 1px solid #fecaca;
  background: white;
  transition: all 0.2s ease;
}

.selected-customer-display .btn-outline-danger:hover {
  background: #ef4444;
  border-color: #ef4444;
  color: white;
}

.customer-search-empty {
  padding: 32px 16px;
  text-align: center;
  color: #64748b;
  background: linear-gradient(to bottom, #fafbfc 0%, white 100%);
}

.customer-search-empty i {
  color: #cbd5e1;
}

.customer-search-empty .fw-medium {
  color: #475569;
  font-size: 0.95rem;
  margin-bottom: 4px;
}

.customer-search-empty small {
  font-size: 0.85rem;
  color: #94a3b8;
}

.customer-search-loading {
  padding: 24px 16px;
  text-align: center;
  color: #64748b;
  font-size: 0.9rem;
}

.customer-search-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #0d6efd;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Booking Loading Button Styles */
.btn-loading-state {
  position: relative;
  pointer-events: none;
}

.btn-loading-state:hover {
  background-color: #198754 !important;
  border-color: #198754 !important;
}

.btn-loading .spinner-border-sm {
  width: 1rem;
  height: 1rem;
}

#bookingProcessingOverlay {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.spinner-border-lg {
  width: 3rem;
  height: 3rem;
}

/* Enhanced Floating Cart Styles */
#floatingCart {
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25) !important;
  transition: all 0.3s ease;
  border: 2px solid #667eea;
}

#floatingCart .card-header {
  border-radius: 14px 14px 0 0;
  padding: 1rem 1.25rem;
}

#floatingCart .card-header h3 {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 900;
  color: #000000 !important;
}

#floatingCart .card-header h3 span {
  color: #000000 !important;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

#floatingCart:hover {
  box-shadow: 0 15px 50px rgba(0,0,0,0.2) !important;
}

/* Pulse animation for cart */
@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

.cart-pulse {
  animation: pulse 0.5s ease-in-out;
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px 16px 0 0 !important;
}

.cart-item-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 14px;
  transition: all 0.2s ease;
  border: 1px solid #e9ecef;
}

.cart-item-card:hover {
  background: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}

.cart-item-card .input-group {
  border-radius: 8px;
  overflow: hidden;
}

.cart-item-card .input-group .btn {
  border: 1px solid #dee2e6;
  background: white;
  transition: all 0.2s ease;
}

.cart-item-card .input-group .btn:hover:not(:disabled) {
  background: #0d6efd;
  color: white;
  border-color: #0d6efd;
}

.cart-item-card .input-group .form-control {
  border-left: 1px solid #dee2e6;
  border-right: 1px solid #dee2e6;
  font-size: 0.95rem;
}

/* Minimized Cart Button */
#minimizedCart {
  position: relative;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  transition: all 0.3s ease;
}

#minimizedCart:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
}

#minimizedCart .badge {
  font-size: 0.65rem;
  padding: 2px 6px;
  min-width: 20px;
}

/* Cart Animations */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

.animate-bounce {
  animation: bounce 0.5s ease;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.animate-slide-in {
  animation: slideInRight 0.3s ease-out;
}

/* Cart scrollbar */
#floatingCart .card-body {
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 #f1f5f9;
}

#floatingCart .card-body::-webkit-scrollbar {
  width: 6px;
}

#floatingCart .card-body::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

#floatingCart .card-body::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

#floatingCart .card-body::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Empty cart styling */
#cartItems .bi-cart-x {
  color: #cbd5e1;
}

/* Footer styling */
#floatingCart .card-footer {
  border-radius: 0 0 16px 16px !important;
  border-top: 2px solid #e9ecef;
}

/* Success button enhancement */
#floatingCart .btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border: none;
  border-radius: 10px;
  font-weight: 600;
  padding: 12px;
  transition: all 0.3s ease;
}

#floatingCart .btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
}
</style>