<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Booking Management</h2>
    <p class="text-muted mb-0">Manage all customer bookings and orders</p>
  </div>
  <div class="d-flex gap-2 align-items-center">
    <!-- Real-time Status -->
    <div class="d-flex align-items-center gap-2">
      <div class="real-time-indicator">
        <span class="status-dot" id="realtimeStatus"></span>
        <small class="text-muted" id="lastUpdated">Last updated: <span id="updateTime">--:--:--</span></small>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
        <label class="form-check-label text-muted" for="autoRefreshToggle">
          Auto-refresh
        </label>
      </div>
    </div>
    <%= link_to new_admin_booking_path, class: "btn btn-primary" do %>
      <i class="bi bi-plus-lg me-1"></i>
      Create New Booking
    <% end %>
  </div>
</div>

<!-- Stage Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Draft</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.draft.count %></h5>
          </div>
          <div class="text-secondary">
            <i class="bi bi-pencil fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Pending</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.ordered_and_delivery_pending.count %></h5>
          </div>
          <div class="text-warning">
            <i class="bi bi-clock fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Processing</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:confirmed, :processing, :packed]).count %></h5>
          </div>
          <div class="text-info">
            <i class="bi bi-gear fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Shipped</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:shipped, :out_for_delivery]).count %></h5>
          </div>
          <div class="text-primary">
            <i class="bi bi-truck fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Completed</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: :completed).count %></h5>
          </div>
          <div class="text-success">
            <i class="bi bi-check-circle fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Issues</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:cancelled, :returned]).count %></h5>
          </div>
          <div class="text-danger">
            <i class="bi bi-exclamation-triangle fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bookings Table -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Booking List</h5>
      <div class="d-flex gap-2">
        <!-- Stage Filter -->
        <%= form_with url: admin_bookings_path, method: :get, local: true, class: "d-flex gap-2 align-items-center" do |form| %>
          <%= form.select :status,
              options_for_select([
                ['All Stages', ''],
                ['Draft', 'draft'],
                ['Pending Delivery', 'ordered_and_delivery_pending'],
                ['Confirmed', 'confirmed'],
                ['Processing', 'processing'],
                ['Packed', 'packed'],
                ['Shipped', 'shipped'],
                ['Out for Delivery', 'out_for_delivery'],
                ['Delivered', 'delivered'],
                ['Completed', 'completed'],
                ['Cancelled', 'cancelled'],
                ['Returned', 'returned']
              ], params[:status]),
              {},
              {
                class: "form-select",
                style: "width: 180px;",
                onchange: "this.form.submit();"
              } %>

          <!-- Search Input -->
          <div class="position-relative">
            <%= form.text_field :search,
                value: params[:search],
                class: "form-control",
                placeholder: "Search bookings...",
                id: "searchInput",
                style: "width: 250px;" %>
            <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
          </div>

          <!-- Search Button (hidden, form submits automatically) -->
          <%= form.submit "Search", class: "btn btn-outline-primary d-none" %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @bookings.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0 fw-semibold">Booking Details</th>
              <th class="border-0 fw-semibold">Customer</th>
              <th class="border-0 fw-semibold">Store</th>
              <th class="border-0 fw-semibold">Items & Amount</th>
              <th class="border-0 fw-semibold">Payment</th>
              <th class="border-0 fw-semibold text-dark">Current Stage</th>
              <th class="border-0 fw-semibold">Progress</th>
              <th class="border-0 fw-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @bookings.each do |booking| %>
              <tr>
                <td class="align-middle">
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary-subtle rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-cart text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-0">#<%= booking.booking_number %></h6>
                      <small class="text-muted"><%= booking.created_at.strftime("%d %b %Y") if booking.created_at %></small>
                    </div>
                  </div>
                </td>
                <td class="align-middle">
                  <div>
                    <h6 class="mb-0"><%= booking.customer&.display_name || booking.customer_name %></h6>
                    <% if booking.customer&.mobile || booking.customer_phone %>
                      <small class="text-muted">
                        <i class="bi bi-telephone me-1"></i>
                        <%= booking.customer&.mobile || booking.customer_phone %>
                      </small>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <% if booking.store.present? %>
                    <span class="badge bg-info">
                      <i class="bi bi-shop me-1"></i>
                      <%= booking.store.name %>
                    </span>
                  <% else %>
                    <small class="text-muted">-</small>
                  <% end %>
                </td>
                <td class="align-middle">
                  <div>
                    <span class="badge bg-info-subtle text-info">
                      <%= pluralize(booking.booking_items.size, 'item') %>
                    </span>
                    <div class="fw-medium text-success mt-1">
                      â‚¹<%= number_with_delimiter(booking.total_amount || 0) %>
                    </div>
                  </div>
                </td>
                <td class="align-middle">
                  <% payment_class = case booking.payment_status
                                    when 'paid' then 'bg-success-subtle text-success'
                                    when 'unpaid' then 'bg-danger-subtle text-danger'
                                    when 'partially_paid' then 'bg-warning-subtle text-warning'
                                    else 'bg-secondary-subtle text-secondary'
                                    end %>
                  <span class="badge <%= payment_class %>">
                    <%= booking.payment_status&.humanize || 'Unknown' %>
                  </span>
                  <% if booking.payment_method.present? %>
                    <div class="small text-muted mt-1">
                      <i class="bi bi-credit-card me-1"></i>
                      <%= booking.payment_method.humanize %>
                    </div>
                  <% end %>
                </td>
                <td class="align-middle">
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-<%= booking.status_color %> px-3 py-2" title="<%= booking.status&.humanize || 'Unknown' %>">
                      <i class="bi <%= booking.status_icon %> me-1"></i>
                      <% status_text = booking.status&.humanize || 'Unknown' %>
                      <%= status_text.length > 15 ? status_text[0..14] + '...' : status_text %>
                    </span>

                    <% if booking.next_possible_statuses.any? %>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Quick Stage Update">
                          <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li class="dropdown-header">Quick Stage Update</li>
                          <% booking.next_possible_statuses.each do |status| %>
                            <li>
                              <%= link_to update_status_admin_booking_path(booking, status: status),
                                  method: :patch, class: "dropdown-item",
                                  confirm: status == 'cancelled' ? 'Are you sure you want to cancel this order?' : nil do %>
                                <i class="bi bi-arrow-right me-2"></i>
                                <%= status.humanize %>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <div class="progress-container">
                    <%
                      stages = ['draft', 'ordered_and_delivery_pending', 'confirmed', 'processing', 'packed', 'shipped', 'out_for_delivery', 'delivered', 'completed']
                      current_stage_index = stages.index(booking.status) || 0
                      total_stages = stages.length
                      progress_percentage = ((current_stage_index + 1).to_f / total_stages * 100).round(0)

                      # Special handling for cancelled/returned
                      if ['cancelled', 'returned'].include?(booking.status)
                        progress_percentage = 0
                        progress_color = 'bg-danger'
                      else
                        progress_color = case progress_percentage
                                        when 0..20 then 'bg-secondary'
                                        when 21..40 then 'bg-warning'
                                        when 41..60 then 'bg-info'
                                        when 61..80 then 'bg-primary'
                                        else 'bg-success'
                                        end
                      end
                    %>

                    <div class="progress mb-1" style="height: 8px;">
                      <div class="progress-bar <%= progress_color %>"
                           role="progressbar"
                           style="width: <%= progress_percentage %>%"
                           aria-valuenow="<%= progress_percentage %>"
                           aria-valuemin="0"
                           aria-valuemax="100">
                      </div>
                    </div>

                    <div class="d-flex justify-content-between">
                      <small class="text-muted">
                        Stage <%= current_stage_index + 1 %>/9
                      </small>
                      <small class="text-muted">
                        <%= progress_percentage %>%
                      </small>
                    </div>

                    <!-- Next Steps -->
                    <% if booking.next_possible_statuses.any? %>
                      <div class="mt-1">
                        <small class="text-primary">
                          <i class="bi bi-arrow-right me-1"></i>
                          Next: <%= booking.next_possible_statuses.first.humanize %>
                        </small>
                      </div>
                    <% elsif booking.status == 'completed' %>
                      <div class="mt-1">
                        <small class="text-success">
                          <i class="bi bi-check-all me-1"></i>
                          Order Complete
                        </small>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <div class="d-flex gap-2 align-items-center">
                    <!-- Stage Management Icon -->
                    <%= link_to manage_stage_admin_booking_path(booking),
                        class: "btn btn-sm btn-outline-primary stage-management-btn",
                        title: "Manage Order Stages" do %>
                      <i class="bi bi-arrows-move"></i>
                    <% end %>

                    <!-- Secondary Actions Dropdown -->
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li class="dropdown-header">
                          <i class="bi bi-tools me-1"></i>Booking Actions
                        </li>
                        <li>
                          <%= link_to edit_admin_booking_path(booking), class: "dropdown-item" do %>
                            <i class="bi bi-pencil me-2"></i>
                            Edit Booking
                          <% end %>
                        </li>

                        <!-- Invoice Actions -->
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">
                          <i class="bi bi-receipt me-1"></i>Invoice Actions
                        </li>

                        <% if booking.invoice_generated? %>
                          <li>
                            <%= link_to invoice_admin_booking_path(booking), class: "dropdown-item", target: "_blank" do %>
                              <i class="bi bi-file-earmark-pdf me-2 text-primary"></i>
                              View Invoice
                            <% end %>
                          </li>
                        <% else %>
                          <li>
                            <%= link_to generate_invoice_admin_booking_path(booking), class: "dropdown-item", method: :patch do %>
                              <i class="bi bi-receipt me-2 text-success"></i>
                              Generate Invoice
                            <% end %>
                          </li>
                        <% end %>

                        <%# Order Conversion - Disabled until order association is properly set up %>
                        <%# TODO: Re-enable when booking_id column is added to orders table and association is uncommented %>
                        <%# <% if booking.order.present? %>
                        <%#   <li> %>
                        <%#     <%= link_to admin_order_path(booking.order), class: "dropdown-item" do %>
                        <%#       <i class="bi bi-box me-2 text-info"></i> %>
                        <%#       View Order %>
                        <%#     <% end %>
                        <%#   </li> %>
                        <%# <% elsif booking.payment_status_paid? %>
                        <%#   <li> %>
                        <%#     <%= link_to convert_to_order_admin_booking_path(booking), class: "dropdown-item", method: :patch do %>
                        <%#       <i class="bi bi-arrow-right me-2 text-warning"></i> %>
                        <%#       Convert to Order %>
                        <%#     <% end %>
                        <%#   </li> %>
                        <%# <% end %>

                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <%= link_to admin_booking_path(booking), method: :delete,
                              class: "dropdown-item text-danger",
                              confirm: "Are you sure you want to delete this booking?",
                              data: {
                                confirm: "Are you sure you want to delete booking ##{booking.booking_number}? This action cannot be undone."
                              } do %>
                            <i class="bi bi-trash me-2"></i>
                            Delete Booking
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if respond_to?(:paginate) && @bookings.respond_to?(:total_pages) %>
        <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">
              Showing <%= @bookings.offset_value + 1 %> - <%= [@bookings.offset_value + @bookings.length, @bookings.total_count].min %> of <%= @bookings.total_count %> bookings
              <span class="ms-2 badge bg-primary-subtle text-primary">
                <i class="bi bi-gear me-1"></i>
                <%= @per_page %> per page (from system settings)
              </span>
            </small>
          </div>
          <div>
            <%= paginate @bookings %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-cart-x fs-1 text-muted"></i>
        </div>
        <h5 class="text-muted mb-3">No Bookings Found</h5>
        <p class="text-muted mb-4">Start creating bookings for your customers to manage orders and sales.</p>
        <%= link_to "Create Booking", new_admin_booking_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Stage Management Modal -->
<div class="modal fade" id="stageManagementModal" tabindex="-1" aria-labelledby="stageManagementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-primary text-white">
        <div class="d-flex align-items-center">
          <i class="bi bi-arrows-move me-2 fs-4"></i>
          <div>
            <h5 class="modal-title mb-0" id="stageManagementModalLabel">Stage Management</h5>
            <small class="opacity-75" id="bookingNumberDisplay">Order #</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4" id="stageManagementContent">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mb-0">Loading stage information...</p>
        </div>

        <!-- Stage Content -->
        <div id="stageContent" style="display: none;">
          <!-- Current Stage Display -->
          <div class="current-stage-card mb-4">
            <div class="card border-primary">
              <div class="card-body text-center">
                <div class="stage-icon-large mb-3">
                  <i id="currentStageIcon" class="bi bi-clock-history display-4 text-primary"></i>
                </div>
                <h4 class="mb-2" id="currentStageName">Current Stage</h4>
                <p class="text-muted mb-0" id="currentStageDescription">Stage description will appear here</p>
              </div>
            </div>
          </div>

          <!-- Stage Progression Timeline -->
          <div class="stage-timeline mb-4">
            <h6 class="text-muted mb-3">
              <i class="bi bi-list-ol me-2"></i>Order Progress Timeline
            </h6>
            <div class="timeline-container" id="stageTimeline">
              <!-- Timeline will be populated dynamically -->
            </div>
          </div>

          <!-- Available Stage Transitions -->
          <div class="available-transitions">
            <h6 class="text-muted mb-3">
              <i class="bi bi-arrow-right-circle me-2"></i>Available Actions
            </h6>
            <div class="row g-3" id="stageTransitions">
              <!-- Stage transition buttons will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal removed - using manage_stage page instead -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Real-time data functionality
  let realtimeInterval = null;
  const autoRefreshToggle = document.getElementById('autoRefreshToggle');
  const realtimeStatus = document.getElementById('realtimeStatus');
  const updateTime = document.getElementById('updateTime');

  // Update real-time status indicator
  function updateRealtimeStatus(isActive, isLoading = false) {
    if (isLoading) {
      realtimeStatus.className = 'status-dot status-loading';
    } else if (isActive) {
      realtimeStatus.className = 'status-dot status-active';
    } else {
      realtimeStatus.className = 'status-dot status-inactive';
    }
  }

  // Fetch and update real-time data
  function fetchRealtimeData() {
    updateRealtimeStatus(autoRefreshToggle.checked, true);

    fetch('<%= realtime_data_admin_bookings_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update statistics cards
        updateStatisticsCards(data.stats);

        // Update last updated time
        updateTime.textContent = data.stats.last_updated;

        // Show success notification occasionally
        if (Math.random() < 0.1) { // 10% chance
          showNotification('Data refreshed successfully', 'success', 2000);
        }
      } else {
        console.error('Real-time update failed:', data.error);
        showNotification('Failed to refresh data', 'error', 3000);
      }

      updateRealtimeStatus(autoRefreshToggle.checked, false);
    })
    .catch(error => {
      console.error('Real-time update error:', error);
      updateRealtimeStatus(autoRefreshToggle.checked, false);
      showNotification('Connection error while refreshing data', 'error', 3000);
    });
  }

  // Update statistics cards with new data
  function updateStatisticsCards(stats) {
    const statsMapping = {
      'draft': stats.draft,
      'pending': stats.pending,
      'processing': stats.processing,
      'shipped': stats.shipped,
      'delivered': stats.delivered,
      'issues': stats.issues
    };

    // Update each card with animation
    Object.keys(statsMapping).forEach(key => {
      const cardElements = document.querySelectorAll(`.col-md-2 .card-body`);
      cardElements.forEach(cardBody => {
        const titleElement = cardBody.querySelector('h6');
        const countElement = cardBody.querySelector('h5');

        if (titleElement && countElement) {
          const cardType = titleElement.textContent.toLowerCase();
          const mappedKey = {
            'draft': 'draft',
            'pending': 'pending',
            'processing': 'processing',
            'shipped': 'shipped',
            'delivered': 'delivered',
            'issues': 'issues'
          }[cardType];

          if (mappedKey && statsMapping[mappedKey] !== undefined) {
            const newValue = statsMapping[mappedKey];
            const currentValue = parseInt(countElement.textContent) || 0;

            if (newValue !== currentValue) {
              // Add animation class
              countElement.style.transition = 'all 0.3s ease';
              countElement.style.transform = 'scale(1.1)';
              countElement.style.color = '#007bff';

              // Update value
              setTimeout(() => {
                countElement.textContent = newValue;

                // Reset animation
                setTimeout(() => {
                  countElement.style.transform = 'scale(1)';
                  countElement.style.color = '';
                }, 200);
              }, 100);
            }
          }
        }
      });
    });
  }

  // Show notification
  function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        <span>${message}</span>
      </div>
    `;

    // Position it
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    notification.style.transition = 'all 0.3s ease';

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 10);

    // Animate out and remove
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';

      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, duration);
  }

  // Auto-refresh toggle functionality
  autoRefreshToggle?.addEventListener('change', function() {
    if (this.checked) {
      // Start real-time updates every 30 seconds
      realtimeInterval = setInterval(fetchRealtimeData, 30000);
      updateRealtimeStatus(true);
      fetchRealtimeData(); // Fetch immediately
      showNotification('Real-time updates enabled', 'success', 2000);
    } else {
      // Stop real-time updates
      if (realtimeInterval) {
        clearInterval(realtimeInterval);
        realtimeInterval = null;
      }
      updateRealtimeStatus(false);
      showNotification('Real-time updates disabled', 'info', 2000);
    }
  });

  // Initialize real-time updates if toggle is checked
  if (autoRefreshToggle?.checked) {
    realtimeInterval = setInterval(fetchRealtimeData, 30000);
    updateRealtimeStatus(true);

    // Initial fetch after a short delay
    setTimeout(fetchRealtimeData, 2000);
  }

  // Search functionality
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('tbody tr');

  searchInput?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();

    tableRows.forEach(row => {
      const bookingNumber = row.cells[0]?.textContent.toLowerCase() || '';
      const customerName = row.cells[1]?.textContent.toLowerCase() || '';
      const paymentInfo = row.cells[3]?.textContent.toLowerCase() || '';
      const statusInfo = row.cells[4]?.textContent.toLowerCase() || '';
      const progressInfo = row.cells[5]?.textContent.toLowerCase() || '';

      if (bookingNumber.includes(searchTerm) ||
          customerName.includes(searchTerm) ||
          paymentInfo.includes(searchTerm) ||
          statusInfo.includes(searchTerm) ||
          progressInfo.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Cleanup interval when page is unloaded
  window.addEventListener('beforeunload', function() {
    if (realtimeInterval) {
      clearInterval(realtimeInterval);
    }
  });

  // Stage Management Functions
  // Stage management moved to separate page - manage_stage action
  // Old modal-based stage management functions removed

  function populateStageInformation(bookingId, currentStatus) {
    // Hide loading state
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('stageContent').style.display = 'block';

    // Stage configuration
    const stageConfig = {
      'draft': {
        name: 'Draft',
        icon: 'bi-pencil',
        color: 'text-secondary',
        description: 'Order is being prepared and not yet confirmed',
        nextStages: ['ordered_and_delivery_pending', 'cancelled']
      },
      'ordered_and_delivery_pending': {
        name: 'Pending Delivery',
        icon: 'bi-clock-history',
        color: 'text-warning',
        description: 'Order received and waiting to be processed',
        nextStages: ['confirmed', 'cancelled']
      },
      'confirmed': {
        name: 'Confirmed',
        icon: 'bi-check-circle',
        color: 'text-success',
        description: 'Order confirmed and ready for processing',
        nextStages: ['processing', 'cancelled']
      },
      'processing': {
        name: 'Processing',
        icon: 'bi-gear',
        color: 'text-info',
        description: 'Order is being prepared and processed',
        nextStages: ['packed', 'cancelled']
      },
      'packed': {
        name: 'Packed',
        icon: 'bi-box',
        color: 'text-primary',
        description: 'Items are packed and ready for shipment',
        nextStages: ['shipped', 'cancelled']
      },
      'shipped': {
        name: 'Shipped',
        icon: 'bi-truck',
        color: 'text-primary',
        description: 'Order has been shipped and is in transit',
        nextStages: ['out_for_delivery', 'returned']
      },
      'out_for_delivery': {
        name: 'Out for Delivery',
        icon: 'bi-geo-alt',
        color: 'text-warning',
        description: 'Order is out for delivery and will arrive soon',
        nextStages: ['delivered', 'returned']
      },
      'delivered': {
        name: 'Delivered',
        icon: 'bi-house-check',
        color: 'text-success',
        description: 'Order has been successfully delivered',
        nextStages: ['completed', 'returned']
      },
      'completed': {
        name: 'Completed',
        icon: 'bi-check-all',
        color: 'text-success',
        description: 'Order transaction is complete',
        nextStages: []
      },
      'cancelled': {
        name: 'Cancelled',
        icon: 'bi-x-circle',
        color: 'text-danger',
        description: 'Order has been cancelled',
        nextStages: []
      },
      'returned': {
        name: 'Returned',
        icon: 'bi-arrow-return-left',
        color: 'text-warning',
        description: 'Order has been returned',
        nextStages: ['completed']
      }
    };

    const currentStageInfo = stageConfig[currentStatus];

    // Update current stage display
    document.getElementById('currentStageIcon').className = `bi ${currentStageInfo.icon} display-4 ${currentStageInfo.color}`;
    document.getElementById('currentStageName').textContent = currentStageInfo.name;
    document.getElementById('currentStageDescription').textContent = currentStageInfo.description;

    // Populate timeline
    populateTimeline(currentStatus, stageConfig);

    // Populate available transitions
    populateTransitions(bookingId, currentStageInfo.nextStages, stageConfig);
  }

  function populateTimeline(currentStatus, stageConfig) {
    const allStages = ['draft', 'ordered_and_delivery_pending', 'confirmed', 'processing', 'packed', 'shipped', 'out_for_delivery', 'delivered', 'completed'];
    const currentIndex = allStages.indexOf(currentStatus);

    let timelineHTML = '<div class="timeline">';

    allStages.forEach((stage, index) => {
      const stageInfo = stageConfig[stage];
      const isCompleted = index <= currentIndex;
      const isCurrent = index === currentIndex;

      timelineHTML += `
        <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
          <div class="timeline-marker">
            <i class="bi ${stageInfo.icon} ${isCompleted ? stageInfo.color : 'text-muted'}"></i>
          </div>
          <div class="timeline-content">
            <h6 class="mb-1 ${isCompleted ? stageInfo.color : 'text-muted'}">${stageInfo.name}</h6>
            <small class="text-muted">${stageInfo.description}</small>
          </div>
        </div>
      `;
    });

    timelineHTML += '</div>';
    document.getElementById('stageTimeline').innerHTML = timelineHTML;
  }

  function populateTransitions(bookingId, nextStages, stageConfig) {
    const transitionsContainer = document.getElementById('stageTransitions');

    if (nextStages.length === 0) {
      transitionsContainer.innerHTML = `
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            No further stage transitions available for this order.
          </div>
        </div>
      `;
      return;
    }

    let transitionsHTML = '';

    nextStages.forEach(stage => {
      const stageInfo = stageConfig[stage];
      transitionsHTML += `
        <div class="col-md-6">
          <button type="button"
                  class="btn btn-outline-primary w-100 stage-transition-btn"
                  data-booking-id="${bookingId}"
                  data-target-stage="${stage}"
                  onclick="openStageTransitionForm(${bookingId}, '${stage}')">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <i class="bi ${stageInfo.icon} me-2 ${stageInfo.color}"></i>
                <div class="text-start">
                  <div class="fw-semibold">${stageInfo.name}</div>
                  <small class="text-muted">${stageInfo.description}</small>
                </div>
              </div>
              <i class="bi bi-arrow-right text-muted"></i>
            </div>
          </button>
        </div>
      `;
    });

    transitionsContainer.innerHTML = transitionsHTML;
  }

  window.openStageTransitionForm = function(bookingId, targetStage) {
    // Close stage management modal
    bootstrap.Modal.getInstance(document.getElementById('stageManagementModal')).hide();

    // Open transition form modal
    const transitionModal = new bootstrap.Modal(document.getElementById('stageTransitionModal'));

    // Set target stage
    document.getElementById('targetStage').value = targetStage;

    // Set form action
    const form = document.getElementById('stageTransitionForm');
    form.action = `/admin/bookings/${bookingId}/stage_transition`;

    // Update modal title and description
    const stageNames = {
      'confirmed': 'Confirm Order',
      'processing': 'Start Processing',
      'packed': 'Mark as Packed',
      'shipped': 'Mark as Shipped',
      'out_for_delivery': 'Out for Delivery',
      'delivered': 'Mark as Delivered',
      'completed': 'Complete Order',
      'cancelled': 'Cancel Order',
      'returned': 'Process Return'
    };

    document.getElementById('stageTransitionModalLabel').textContent = stageNames[targetStage] || 'Stage Transition';
    document.getElementById('transitionDescription').textContent = `Moving order to ${targetStage.replace(/_/g, ' ')} stage`;

    // Populate form fields based on target stage
    populateTransitionForm(targetStage);

    transitionModal.show();
  };

  function populateTransitionForm(targetStage) {
    const formFields = document.getElementById('transitionFormFields');
    let fieldsHTML = '';

    switch(targetStage) {
      case 'confirmed':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Confirmation Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter any confirmation notes or special instructions..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Estimated Processing Time</label>
            <select class="form-select" name="estimated_processing_time">
              <option value="1-2 hours">1-2 hours</option>
              <option value="2-4 hours">2-4 hours</option>
              <option value="4-8 hours">4-8 hours</option>
              <option value="1 day">1 day</option>
              <option value="2-3 days">2-3 days</option>
            </select>
          </div>
        `;
        break;

      case 'processing':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Processing Team</label>
            <select class="form-select" name="processing_team" required>
              <option value="">Select processing team</option>
              <option value="Team A">Team A - Kitchen</option>
              <option value="Team B">Team B - Packaging</option>
              <option value="Team C">Team C - Quality Check</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Expected Completion Time</label>
            <input type="datetime-local" class="form-control" name="expected_completion_time" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Processing Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter processing details and any special requirements..."></textarea>
          </div>
        `;
        break;

      case 'packed':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Package Weight (kg)</label>
            <input type="number" class="form-control" name="package_weight" step="0.1" placeholder="Enter package weight">
          </div>
          <div class="mb-3">
            <label class="form-label">Package Dimensions</label>
            <input type="text" class="form-control" name="package_dimensions" placeholder="Length x Width x Height (cm)">
          </div>
          <div class="mb-3">
            <label class="form-label">Quality Check Status</label>
            <select class="form-select" name="quality_status" required>
              <option value="passed">Quality Check Passed</option>
              <option value="passed_with_notes">Passed with Notes</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Packing Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter packing details and quality notes..."></textarea>
          </div>
        `;
        break;

      case 'shipped':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Courier Service *</label>
            <select class="form-select" name="courier_service" required>
              <option value="">Select courier service</option>
              <option value="BlueDart">BlueDart</option>
              <option value="DTDC">DTDC</option>
              <option value="FedEx">FedEx</option>
              <option value="Delhivery">Delhivery</option>
              <option value="India Post">India Post</option>
              <option value="Ecom Express">Ecom Express</option>
              <option value="XpressBees">XpressBees</option>
              <option value="Own Delivery">Own Delivery Team</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Tracking Number *</label>
            <input type="text" class="form-control" name="tracking_number" required placeholder="Enter tracking number">
          </div>
          <div class="mb-3">
            <label class="form-label">Shipping Charges</label>
            <input type="number" class="form-control" name="shipping_charges" step="0.01" placeholder="Enter shipping charges">
          </div>
          <div class="mb-3">
            <label class="form-label">Expected Delivery Date</label>
            <input type="date" class="form-control" name="expected_delivery_date" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Shipping Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter shipping details and instructions..."></textarea>
          </div>
        `;
        break;

      case 'out_for_delivery':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Delivery Person</label>
            <input type="text" class="form-control" name="delivery_person" placeholder="Enter delivery person name">
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Person Contact</label>
            <input type="tel" class="form-control" name="delivery_contact" placeholder="Enter contact number">
          </div>
          <div class="mb-3">
            <label class="form-label">Estimated Delivery Time</label>
            <select class="form-select" name="estimated_delivery_time">
              <option value="Within 2 hours">Within 2 hours</option>
              <option value="Within 4 hours">Within 4 hours</option>
              <option value="By end of day">By end of day</option>
              <option value="Next day">Next day</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter delivery instructions and notes..."></textarea>
          </div>
        `;
        break;

      case 'delivered':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Delivered To</label>
            <input type="text" class="form-control" name="delivered_to" required placeholder="Who received the order?">
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Time</label>
            <input type="datetime-local" class="form-control" name="delivery_time" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Customer Satisfaction</label>
            <select class="form-select" name="customer_satisfaction">
              <option value="5">Excellent (5 stars)</option>
              <option value="4">Good (4 stars)</option>
              <option value="3">Average (3 stars)</option>
              <option value="2">Below Average (2 stars)</option>
              <option value="1">Poor (1 star)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter delivery confirmation details and customer feedback..."></textarea>
          </div>
        `;
        break;

      case 'cancelled':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Cancellation Reason *</label>
            <select class="form-select" name="cancellation_reason" required>
              <option value="">Select cancellation reason</option>
              <option value="Customer Request">Customer Request</option>
              <option value="Out of Stock">Out of Stock</option>
              <option value="Payment Issues">Payment Issues</option>
              <option value="Quality Issues">Quality Issues</option>
              <option value="Delivery Issues">Delivery Issues</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Refund Amount</label>
            <input type="number" class="form-control" name="refund_amount" step="0.01" placeholder="Enter refund amount">
          </div>
          <div class="mb-3">
            <label class="form-label">Refund Method</label>
            <select class="form-select" name="refund_method">
              <option value="Original Payment Method">Original Payment Method</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Cash">Cash</option>
              <option value="Store Credit">Store Credit</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Cancellation Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter detailed cancellation reason and any additional information..." required></textarea>
          </div>
        `;
        break;

      case 'returned':
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Return Reason *</label>
            <select class="form-select" name="return_reason" required>
              <option value="">Select return reason</option>
              <option value="Defective Product">Defective Product</option>
              <option value="Wrong Item">Wrong Item Delivered</option>
              <option value="Customer Dissatisfaction">Customer Dissatisfaction</option>
              <option value="Damaged in Transit">Damaged in Transit</option>
              <option value="Late Delivery">Late Delivery</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Return Condition</label>
            <select class="form-select" name="return_condition">
              <option value="Good">Good Condition</option>
              <option value="Slightly Damaged">Slightly Damaged</option>
              <option value="Heavily Damaged">Heavily Damaged</option>
              <option value="Unusable">Unusable</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Refund Amount</label>
            <input type="number" class="form-control" name="refund_amount" step="0.01" placeholder="Enter refund amount">
          </div>
          <div class="mb-3">
            <label class="form-label">Return Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter return processing details..." required></textarea>
          </div>
        `;
        break;

      default:
        fieldsHTML = `
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="transition_notes" rows="3" placeholder="Enter any notes for this stage transition..."></textarea>
          </div>
        `;
    }

    formFields.innerHTML = fieldsHTML;
  }

  // Handle form submission
  document.getElementById('stageTransitionForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = document.getElementById('confirmTransitionBtn');

    // Show loading state
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Processing...';
    submitBtn.disabled = true;

    // Submit form
    fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('stageTransitionModal')).hide();

        // Show success notification
        showNotification('Stage transition completed successfully!', 'success');

        // Reload page to show updated status
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.error || 'Failed to update stage', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('An error occurred while updating the stage', 'error');
    })
    .finally(() => {
      // Reset button
      submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Confirm Transition';
      submitBtn.disabled = false;
    });
  });
});
</script>

<!-- Custom CSS for Booking Stage Progress -->
<style>
/* Ensure table headers are always visible */
.table-light th {
  color: #212529 !important;
  background-color: #f8f9fa !important;
}

/* Ensure badge text is always visible */
.badge.bg-primary {
  background-color: #0d6efd !important;
  color: #fff !important;
}

.badge.bg-secondary {
  background-color: #6c757d !important;
  color: #fff !important;
}

.badge.bg-success {
  background-color: #198754 !important;
  color: #fff !important;
}

.badge.bg-danger {
  background-color: #dc3545 !important;
  color: #fff !important;
}

.badge.bg-warning {
  background-color: #ffc107 !important;
  color: #212529 !important;
}

.badge.bg-info {
  background-color: #0dcaf0 !important;
  color: #212529 !important;
}

/* Add subtle badge styles */
.badge.bg-info-subtle {
  background-color: rgba(13, 202, 240, 0.1) !important;
  color: #0dcaf0 !important;
  border: 1px solid rgba(13, 202, 240, 0.3);
}

.progress-container {
  min-width: 150px;
}

.progress {
  background-color: #f8f9fa;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.progress-bar {
  border-radius: 10px;
  transition: width 0.6s ease;
  position: relative;
  overflow: hidden;
}

.progress-bar::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.badge {
  font-size: 0.75rem;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.table-hover tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.card {
  border: none !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

/* Stage Statistics Cards Hover Effects */
.col-md-2 .card:hover {
  transform: scale(1.05);
  transition: transform 0.2s ease;
}

/* Custom scrollbar for table */
.table-responsive::-webkit-scrollbar {
  height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Real-time status indicator */
.real-time-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.status-dot.status-active {
  background-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  animation: pulse 2s infinite;
}

.status-dot.status-inactive {
  background-color: #6c757d;
}

.status-dot.status-loading {
  background-color: #ffc107;
  animation: blink 1s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(40, 167, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
  }
}

@keyframes blink {
  0%, 50% {
    opacity: 1;
  }
  51%, 100% {
    opacity: 0.3;
  }
}

/* Notification toast styling */
.notification-toast {
  border: none;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Enhanced form switch styling */
.form-check-input:checked {
  background-color: #28a745;
  border-color: #28a745;
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Enhanced pagination info styling */
.badge.bg-primary-subtle {
  background-color: rgba(13, 110, 253, 0.1) !important;
  border: 1px solid rgba(13, 110, 253, 0.2);
}

/* Stage Management Modal Styles */
.bg-gradient-primary {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.bg-gradient-success {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

.stage-management-btn {
  transition: all 0.3s ease;
  border-radius: 8px;
}

.stage-management-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

/* Timeline Styles */
.timeline {
  position: relative;
  padding-left: 2rem;
}

.timeline-item {
  position: relative;
  margin-bottom: 1.5rem;
  padding-left: 2rem;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -1rem;
  top: 2rem;
  width: 2px;
  height: calc(100% + 0.5rem);
  background: #dee2e6;
}

.timeline-item:last-child::before {
  display: none;
}

.timeline-marker {
  position: absolute;
  left: -1.5rem;
  top: 0;
  width: 2rem;
  height: 2rem;
  background: white;
  border: 2px solid #dee2e6;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  transition: all 0.3s ease;
}

.timeline-item.completed .timeline-marker {
  border-color: #28a745;
  background: #28a745;
  color: white;
}

.timeline-item.current .timeline-marker {
  border-color: #007bff;
  background: #007bff;
  color: white;
  transform: scale(1.2);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}

.timeline-content {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  border-left: 3px solid #dee2e6;
  transition: all 0.3s ease;
}

.timeline-item.completed .timeline-content {
  border-left-color: #28a745;
  background: #d4edda;
}

.timeline-item.current .timeline-content {
  border-left-color: #007bff;
  background: #cce7ff;
}

/* Stage Transition Buttons */
.stage-transition-btn {
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 1rem;
  text-align: left;
}

.stage-transition-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
  border-color: #007bff;
}

.stage-transition-btn:active {
  transform: translateY(0);
}

/* Current Stage Card */
.current-stage-card .card {
  border-width: 2px;
  transition: all 0.3s ease;
}

.current-stage-card .card:hover {
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
  transform: translateY(-2px);
}

.stage-icon-large {
  padding: 1rem;
  background: rgba(0, 123, 255, 0.1);
  border-radius: 50%;
  width: 80px;
  height: 80px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Modal Enhancements */
.modal-content {
  border-radius: 15px;
  overflow: hidden;
}

.modal-header {
  border-bottom: none;
  padding: 1.5rem 2rem;
}

.modal-body {
  padding: 2rem;
}

.modal-footer {
  border-top: 1px solid #dee2e6;
  padding: 1rem 2rem;
}

/* Form Field Enhancements */
.form-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.5rem;
}

.form-control, .form-select {
  border-radius: 8px;
  border: 1px solid #ced4da;
  transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Loading State Enhancements */
.spinner-border {
  width: 3rem;
  height: 3rem;
}

/* Button Enhancements */
.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-1px);
}

.btn:active {
  transform: translateY(0);
}

/* Alert Enhancements */
.alert {
  border-radius: 10px;
  border: none;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
  .timeline {
    padding-left: 1rem;
  }

  .timeline-item {
    padding-left: 1.5rem;
  }

  .timeline-marker {
    left: -1rem;
    width: 1.5rem;
    height: 1.5rem;
  }

  .stage-transition-btn {
    padding: 0.8rem;
  }

  .modal-body {
    padding: 1rem;
  }
}

/* Animation for stage transitions */
@keyframes stageTransition {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

.stage-transition-btn {
  animation: stageTransition 0.5s ease-out;
}

/* Enhanced notification positioning */
.notification-toast {
  z-index: 99999;
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
</style>