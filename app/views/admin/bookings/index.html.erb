<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Booking Management</h2>
    <p class="text-muted mb-0">Manage all customer bookings and orders</p>
  </div>
  <div class="d-flex gap-2 align-items-center">
    <!-- Real-time Status -->
    <div class="d-flex align-items-center gap-2">
      <div class="real-time-indicator">
        <span class="status-dot" id="realtimeStatus"></span>
        <small class="text-muted" id="lastUpdated">Last updated: <span id="updateTime">--:--:--</span></small>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
        <label class="form-check-label text-muted" for="autoRefreshToggle">
          Auto-refresh
        </label>
      </div>
    </div>
    <%= link_to new_admin_booking_path, class: "btn btn-primary" do %>
      <i class="bi bi-plus-lg me-1"></i>
      Create New Booking
    <% end %>
  </div>
</div>

<!-- Stage Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Draft</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.draft.count %></h5>
          </div>
          <div class="text-secondary">
            <i class="bi bi-pencil fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Pending</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.ordered_and_delivery_pending.count %></h5>
          </div>
          <div class="text-warning">
            <i class="bi bi-clock fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Processing</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:confirmed, :processing, :packed]).count %></h5>
          </div>
          <div class="text-info">
            <i class="bi bi-gear fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Shipped</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:shipped, :out_for_delivery]).count %></h5>
          </div>
          <div class="text-primary">
            <i class="bi bi-truck fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Delivered</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:delivered, :completed]).count %></h5>
          </div>
          <div class="text-success">
            <i class="bi bi-check-circle fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-1">Issues</h6>
            <h5 class="mb-0"><%= @bookings_for_stats.where(status: [:cancelled, :returned]).count %></h5>
          </div>
          <div class="text-danger">
            <i class="bi bi-exclamation-triangle fs-3"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bookings Table -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Booking List</h5>
      <div class="d-flex gap-2">
        <!-- Stage Filter -->
        <%= form_with url: admin_bookings_path, method: :get, local: true, class: "d-flex gap-2 align-items-center" do |form| %>
          <%= form.select :status,
              options_for_select([
                ['All Stages', ''],
                ['Draft', 'draft'],
                ['Pending Delivery', 'ordered_and_delivery_pending'],
                ['Confirmed', 'confirmed'],
                ['Processing', 'processing'],
                ['Packed', 'packed'],
                ['Shipped', 'shipped'],
                ['Out for Delivery', 'out_for_delivery'],
                ['Delivered', 'delivered'],
                ['Completed', 'completed'],
                ['Cancelled', 'cancelled'],
                ['Returned', 'returned']
              ], params[:status]),
              {},
              {
                class: "form-select",
                style: "width: 180px;",
                onchange: "this.form.submit();"
              } %>

          <!-- Search Input -->
          <div class="position-relative">
            <%= form.text_field :search,
                value: params[:search],
                class: "form-control",
                placeholder: "Search bookings...",
                id: "searchInput",
                style: "width: 250px;" %>
            <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
          </div>

          <!-- Search Button (hidden, form submits automatically) -->
          <%= form.submit "Search", class: "btn btn-outline-primary d-none" %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @bookings.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0 fw-semibold">Booking Details</th>
              <th class="border-0 fw-semibold">Customer</th>
              <th class="border-0 fw-semibold">Items & Amount</th>
              <th class="border-0 fw-semibold">Payment</th>
              <th class="border-0 fw-semibold">Current Stage</th>
              <th class="border-0 fw-semibold">Progress</th>
              <th class="border-0 fw-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @bookings.each do |booking| %>
              <tr>
                <td class="align-middle">
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary-subtle rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-cart text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-0">#<%= booking.booking_number %></h6>
                      <small class="text-muted"><%= booking.created_at.strftime("%d %b %Y") if booking.created_at %></small>
                    </div>
                  </div>
                </td>
                <td class="align-middle">
                  <div>
                    <h6 class="mb-0"><%= booking.customer&.display_name || booking.customer_name %></h6>
                    <% if booking.customer&.mobile || booking.customer_phone %>
                      <small class="text-muted">
                        <i class="bi bi-telephone me-1"></i>
                        <%= booking.customer&.mobile || booking.customer_phone %>
                      </small>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <div>
                    <span class="badge bg-info-subtle text-info">
                      <%= pluralize(booking.booking_items_count, 'item') %>
                    </span>
                    <div class="fw-medium text-success mt-1">
                      â‚¹<%= number_with_delimiter(booking.total_amount || 0) %>
                    </div>
                  </div>
                </td>
                <td class="align-middle">
                  <% payment_class = case booking.payment_status
                                    when 'paid' then 'bg-success-subtle text-success'
                                    when 'unpaid' then 'bg-danger-subtle text-danger'
                                    when 'partially_paid' then 'bg-warning-subtle text-warning'
                                    else 'bg-secondary-subtle text-secondary'
                                    end %>
                  <span class="badge <%= payment_class %>">
                    <%= booking.payment_status&.humanize || 'Unknown' %>
                  </span>
                  <% if booking.payment_method.present? %>
                    <div class="small text-muted mt-1">
                      <i class="bi bi-credit-card me-1"></i>
                      <%= booking.payment_method.humanize %>
                    </div>
                  <% end %>
                </td>
                <td class="align-middle">
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-<%= booking.status_color %> px-3 py-2">
                      <i class="bi <%= booking.status_icon %> me-1"></i>
                      <%= booking.status&.humanize || 'Unknown' %>
                    </span>

                    <% if booking.next_possible_statuses.any? %>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Quick Stage Update">
                          <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li class="dropdown-header">Quick Stage Update</li>
                          <% booking.next_possible_statuses.each do |status| %>
                            <li>
                              <%= link_to update_status_admin_booking_path(booking, status: status),
                                  method: :patch, class: "dropdown-item",
                                  confirm: status == 'cancelled' ? 'Are you sure you want to cancel this order?' : nil do %>
                                <i class="bi bi-arrow-right me-2"></i>
                                <%= status.humanize %>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <div class="progress-container">
                    <%
                      stages = ['draft', 'ordered_and_delivery_pending', 'confirmed', 'processing', 'packed', 'shipped', 'out_for_delivery', 'delivered', 'completed']
                      current_stage_index = stages.index(booking.status) || 0
                      total_stages = stages.length
                      progress_percentage = ((current_stage_index + 1).to_f / total_stages * 100).round(0)

                      # Special handling for cancelled/returned
                      if ['cancelled', 'returned'].include?(booking.status)
                        progress_percentage = 0
                        progress_color = 'bg-danger'
                      else
                        progress_color = case progress_percentage
                                        when 0..20 then 'bg-secondary'
                                        when 21..40 then 'bg-warning'
                                        when 41..60 then 'bg-info'
                                        when 61..80 then 'bg-primary'
                                        else 'bg-success'
                                        end
                      end
                    %>

                    <div class="progress mb-1" style="height: 8px;">
                      <div class="progress-bar <%= progress_color %>"
                           role="progressbar"
                           style="width: <%= progress_percentage %>%"
                           aria-valuenow="<%= progress_percentage %>"
                           aria-valuemin="0"
                           aria-valuemax="100">
                      </div>
                    </div>

                    <div class="d-flex justify-content-between">
                      <small class="text-muted">
                        Stage <%= current_stage_index + 1 %>/9
                      </small>
                      <small class="text-muted">
                        <%= progress_percentage %>%
                      </small>
                    </div>

                    <!-- Next Steps -->
                    <% if booking.next_possible_statuses.any? %>
                      <div class="mt-1">
                        <small class="text-primary">
                          <i class="bi bi-arrow-right me-1"></i>
                          Next: <%= booking.next_possible_statuses.first.humanize %>
                        </small>
                      </div>
                    <% elsif booking.status == 'completed' %>
                      <div class="mt-1">
                        <small class="text-success">
                          <i class="bi bi-check-all me-1"></i>
                          Order Complete
                        </small>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td class="align-middle">
                  <div class="d-flex gap-2 align-items-center">
                    <!-- Primary Stage Management Dropdown -->
                    <div class="dropdown">
                      <button class="btn btn-sm btn-primary dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear-fill me-1"></i>
                        Stage Management
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" style="min-width: 250px;">
                        <li class="dropdown-header bg-primary text-white p-3 mb-0" style="margin: -0.5rem -0.5rem 0.5rem -0.5rem; border-radius: 0.375rem 0.375rem 0 0;">
                          <i class="bi bi-gear-wide-connected me-2"></i>
                          Stage Management for #<%= booking.booking_number %>
                        </li>

                        <% if booking.next_possible_statuses.any? %>
                          <li class="dropdown-header small text-muted">Quick Stage Updates</li>
                          <% booking.next_possible_statuses.each do |status| %>
                            <li>
                              <%= link_to stage_transition_admin_booking_path(booking, target_stage: status),
                                  class: "dropdown-item d-flex align-items-center py-2" do %>
                                <div class="stage-icon me-3">
                                  <i class="bi <%=
                                    case status
                                    when 'confirmed' then 'bi-check-circle text-success'
                                    when 'processing' then 'bi-gear text-warning'
                                    when 'packed' then 'bi-box text-info'
                                    when 'shipped' then 'bi-truck text-primary'
                                    when 'out_for_delivery' then 'bi-geo-alt text-primary'
                                    when 'delivered' then 'bi-house-check text-success'
                                    when 'cancelled' then 'bi-x-circle text-danger'
                                    else 'bi-arrow-right text-secondary'
                                    end %>"></i>
                                </div>
                                <div class="flex-grow-1">
                                  <div class="fw-semibold"><%= status.humanize %></div>
                                  <small class="text-muted">
                                    <%= case status
                                        when 'confirmed' then 'Confirm booking and prepare for processing'
                                        when 'processing' then 'Start processing the order'
                                        when 'packed' then 'Mark as packed and ready for shipment'
                                        when 'shipped' then 'Add tracking details and mark as shipped'
                                        when 'out_for_delivery' then 'Mark as out for delivery'
                                        when 'delivered' then 'Mark as successfully delivered'
                                        when 'cancelled' then 'Cancel this booking'
                                        else 'Update to this stage'
                                        end %>
                                  </small>
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                              <% end %>
                            </li>
                          <% end %>
                        <% else %>
                          <li class="dropdown-item-text text-center py-3 text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            No stage transitions available
                          </li>
                        <% end %>

                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header small text-muted">Advanced Actions</li>
                        <li>
                          <%= link_to admin_booking_path(booking), class: "dropdown-item" do %>
                            <i class="bi bi-eye me-2"></i>
                            View Full Details
                          <% end %>
                        </li>
                        <% if booking.can_return? %>
                          <li>
                            <%= link_to stage_transition_admin_booking_path(booking, target_stage: 'returned'),
                                class: "dropdown-item text-warning" do %>
                              <i class="bi bi-arrow-return-left me-2"></i>
                              Process Return
                            <% end %>
                          </li>
                        <% end %>
                      </ul>
                    </div>

                    <!-- Secondary Actions Dropdown -->
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li class="dropdown-header">
                          <i class="bi bi-tools me-1"></i>Booking Actions
                        </li>
                        <li>
                          <%= link_to edit_admin_booking_path(booking), class: "dropdown-item" do %>
                            <i class="bi bi-pencil me-2"></i>
                            Edit Booking
                          <% end %>
                        </li>

                        <!-- Invoice Actions -->
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">
                          <i class="bi bi-receipt me-1"></i>Invoice Actions
                        </li>

                        <% if booking.invoice_generated? %>
                          <li>
                            <%= link_to invoice_admin_booking_path(booking), class: "dropdown-item", target: "_blank" do %>
                              <i class="bi bi-file-earmark-pdf me-2 text-primary"></i>
                              View Invoice
                            <% end %>
                          </li>
                        <% else %>
                          <li>
                            <%= link_to generate_invoice_admin_booking_path(booking), class: "dropdown-item", method: :patch do %>
                              <i class="bi bi-receipt me-2 text-success"></i>
                              Generate Invoice
                            <% end %>
                          </li>
                        <% end %>

                        <!-- Order Conversion -->
                        <% if booking.order.present? %>
                          <li>
                            <%= link_to admin_order_path(booking.order), class: "dropdown-item" do %>
                              <i class="bi bi-box me-2 text-info"></i>
                              View Order
                            <% end %>
                          </li>
                        <% elsif booking.payment_status_paid? %>
                          <li>
                            <%= link_to convert_to_order_admin_booking_path(booking), class: "dropdown-item", method: :patch do %>
                              <i class="bi bi-arrow-right me-2 text-warning"></i>
                              Convert to Order
                            <% end %>
                          </li>
                        <% end %>

                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <%= link_to admin_booking_path(booking), method: :delete,
                              class: "dropdown-item text-danger",
                              confirm: "Are you sure you want to delete this booking?",
                              data: {
                                confirm: "Are you sure you want to delete booking ##{booking.booking_number}? This action cannot be undone."
                              } do %>
                            <i class="bi bi-trash me-2"></i>
                            Delete Booking
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if respond_to?(:paginate) && @bookings.respond_to?(:total_pages) %>
        <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">
              Showing <%= @bookings.offset_value + 1 %> - <%= [@bookings.offset_value + @bookings.length, @bookings.total_count].min %> of <%= @bookings.total_count %> bookings
              <span class="ms-2 badge bg-primary-subtle text-primary">
                <i class="bi bi-gear me-1"></i>
                <%= @per_page %> per page (from system settings)
              </span>
            </small>
          </div>
          <div>
            <%= paginate @bookings %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-cart-x fs-1 text-muted"></i>
        </div>
        <h5 class="text-muted mb-3">No Bookings Found</h5>
        <p class="text-muted mb-4">Start creating bookings for your customers to manage orders and sales.</p>
        <%= link_to "Create Booking", new_admin_booking_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Real-time data functionality
  let realtimeInterval = null;
  const autoRefreshToggle = document.getElementById('autoRefreshToggle');
  const realtimeStatus = document.getElementById('realtimeStatus');
  const updateTime = document.getElementById('updateTime');

  // Update real-time status indicator
  function updateRealtimeStatus(isActive, isLoading = false) {
    if (isLoading) {
      realtimeStatus.className = 'status-dot status-loading';
    } else if (isActive) {
      realtimeStatus.className = 'status-dot status-active';
    } else {
      realtimeStatus.className = 'status-dot status-inactive';
    }
  }

  // Fetch and update real-time data
  function fetchRealtimeData() {
    updateRealtimeStatus(autoRefreshToggle.checked, true);

    fetch('<%= realtime_data_admin_bookings_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update statistics cards
        updateStatisticsCards(data.stats);

        // Update last updated time
        updateTime.textContent = data.stats.last_updated;

        // Show success notification occasionally
        if (Math.random() < 0.1) { // 10% chance
          showNotification('Data refreshed successfully', 'success', 2000);
        }
      } else {
        console.error('Real-time update failed:', data.error);
        showNotification('Failed to refresh data', 'error', 3000);
      }

      updateRealtimeStatus(autoRefreshToggle.checked, false);
    })
    .catch(error => {
      console.error('Real-time update error:', error);
      updateRealtimeStatus(autoRefreshToggle.checked, false);
      showNotification('Connection error while refreshing data', 'error', 3000);
    });
  }

  // Update statistics cards with new data
  function updateStatisticsCards(stats) {
    const statsMapping = {
      'draft': stats.draft,
      'pending': stats.pending,
      'processing': stats.processing,
      'shipped': stats.shipped,
      'delivered': stats.delivered,
      'issues': stats.issues
    };

    // Update each card with animation
    Object.keys(statsMapping).forEach(key => {
      const cardElements = document.querySelectorAll(`.col-md-2 .card-body`);
      cardElements.forEach(cardBody => {
        const titleElement = cardBody.querySelector('h6');
        const countElement = cardBody.querySelector('h5');

        if (titleElement && countElement) {
          const cardType = titleElement.textContent.toLowerCase();
          const mappedKey = {
            'draft': 'draft',
            'pending': 'pending',
            'processing': 'processing',
            'shipped': 'shipped',
            'delivered': 'delivered',
            'issues': 'issues'
          }[cardType];

          if (mappedKey && statsMapping[mappedKey] !== undefined) {
            const newValue = statsMapping[mappedKey];
            const currentValue = parseInt(countElement.textContent) || 0;

            if (newValue !== currentValue) {
              // Add animation class
              countElement.style.transition = 'all 0.3s ease';
              countElement.style.transform = 'scale(1.1)';
              countElement.style.color = '#007bff';

              // Update value
              setTimeout(() => {
                countElement.textContent = newValue;

                // Reset animation
                setTimeout(() => {
                  countElement.style.transform = 'scale(1)';
                  countElement.style.color = '';
                }, 200);
              }, 100);
            }
          }
        }
      });
    });
  }

  // Show notification
  function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        <span>${message}</span>
      </div>
    `;

    // Position it
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    notification.style.transition = 'all 0.3s ease';

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 10);

    // Animate out and remove
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';

      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, duration);
  }

  // Auto-refresh toggle functionality
  autoRefreshToggle?.addEventListener('change', function() {
    if (this.checked) {
      // Start real-time updates every 30 seconds
      realtimeInterval = setInterval(fetchRealtimeData, 30000);
      updateRealtimeStatus(true);
      fetchRealtimeData(); // Fetch immediately
      showNotification('Real-time updates enabled', 'success', 2000);
    } else {
      // Stop real-time updates
      if (realtimeInterval) {
        clearInterval(realtimeInterval);
        realtimeInterval = null;
      }
      updateRealtimeStatus(false);
      showNotification('Real-time updates disabled', 'info', 2000);
    }
  });

  // Initialize real-time updates if toggle is checked
  if (autoRefreshToggle?.checked) {
    realtimeInterval = setInterval(fetchRealtimeData, 30000);
    updateRealtimeStatus(true);

    // Initial fetch after a short delay
    setTimeout(fetchRealtimeData, 2000);
  }

  // Search functionality
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('tbody tr');

  searchInput?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();

    tableRows.forEach(row => {
      const bookingNumber = row.cells[0]?.textContent.toLowerCase() || '';
      const customerName = row.cells[1]?.textContent.toLowerCase() || '';
      const paymentInfo = row.cells[3]?.textContent.toLowerCase() || '';
      const statusInfo = row.cells[4]?.textContent.toLowerCase() || '';
      const progressInfo = row.cells[5]?.textContent.toLowerCase() || '';

      if (bookingNumber.includes(searchTerm) ||
          customerName.includes(searchTerm) ||
          paymentInfo.includes(searchTerm) ||
          statusInfo.includes(searchTerm) ||
          progressInfo.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Cleanup interval when page is unloaded
  window.addEventListener('beforeunload', function() {
    if (realtimeInterval) {
      clearInterval(realtimeInterval);
    }
  });
});
</script>

<!-- Custom CSS for Booking Stage Progress -->
<style>
.progress-container {
  min-width: 150px;
}

.progress {
  background-color: #f8f9fa;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.progress-bar {
  border-radius: 10px;
  transition: width 0.6s ease;
  position: relative;
  overflow: hidden;
}

.progress-bar::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.badge {
  font-size: 0.75rem;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.table-hover tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.card {
  border: none !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

/* Stage Statistics Cards Hover Effects */
.col-md-2 .card:hover {
  transform: scale(1.05);
  transition: transform 0.2s ease;
}

/* Custom scrollbar for table */
.table-responsive::-webkit-scrollbar {
  height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Real-time status indicator */
.real-time-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.status-dot.status-active {
  background-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  animation: pulse 2s infinite;
}

.status-dot.status-inactive {
  background-color: #6c757d;
}

.status-dot.status-loading {
  background-color: #ffc107;
  animation: blink 1s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(40, 167, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
  }
}

@keyframes blink {
  0%, 50% {
    opacity: 1;
  }
  51%, 100% {
    opacity: 0.3;
  }
}

/* Notification toast styling */
.notification-toast {
  border: none;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Enhanced form switch styling */
.form-check-input:checked {
  background-color: #28a745;
  border-color: #28a745;
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Enhanced pagination info styling */
.badge.bg-primary-subtle {
  background-color: rgba(13, 110, 253, 0.1) !important;
  border: 1px solid rgba(13, 110, 253, 0.2);
}
</style>