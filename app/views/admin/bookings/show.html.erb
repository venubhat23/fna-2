<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Booking Details</h2>
    <p class="text-muted mb-0">
      <span class="badge bg-<%= @booking.status_color %> me-2">
        <i class="bi <%= @booking.status_icon %> me-1"></i>
        <%= @booking.status&.humanize || 'Pending' %>
      </span>
      Booking #<%= @booking.booking_number %>
    </p>
  </div>
  <div class="d-flex gap-2">
    <!-- Invoice Actions -->
    <% if @booking.invoice_generated? %>
      <%= link_to invoice_admin_booking_path(@booking), class: "btn btn-primary", target: "_blank" do %>
        <i class="bi bi-file-earmark-pdf me-1"></i>
        View Invoice
      <% end %>
    <% else %>
      <%= link_to generate_invoice_admin_booking_path(@booking), class: "btn btn-success", method: :patch do %>
        <i class="bi bi-receipt me-1"></i>
        Generate Invoice
      <% end %>
    <% end %>

    <!-- Order Conversion -->
    <% if @booking.order.present? %>
      <%= link_to admin_order_path(@booking.order), class: "btn btn-info" do %>
        <i class="bi bi-box me-1"></i>
        View Order
      <% end %>
    <% elsif @booking.payment_status_paid? %>
      <%= link_to convert_to_order_admin_booking_path(@booking), class: "btn btn-warning", method: :patch do %>
        <i class="bi bi-arrow-right me-1"></i>
        Convert to Order
      <% end %>
    <% end %>

    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        <li>
          <%= link_to edit_admin_booking_path(@booking), class: "dropdown-item" do %>
            <i class="bi bi-pencil me-2"></i>
            Edit Booking
          <% end %>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <%= link_to admin_booking_path(@booking), method: :delete,
              class: "dropdown-item text-danger",
              data: {
                confirm: "Are you sure you want to delete this booking? This action cannot be undone.",
                turbo_method: :delete
              } do %>
            <i class="bi bi-trash me-2"></i>
            Delete Booking
          <% end %>
        </li>
      </ul>
    </div>

    <%= link_to admin_bookings_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Bookings
    <% end %>
  </div>
</div>

<!-- Status Management Section -->
<% if @booking.next_possible_statuses.any? %>
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0 pb-0">
    <div class="d-flex align-items-center justify-content-between">
      <h5 class="mb-0">
        <i class="bi bi-gear text-primary me-2"></i>
        Order Status Management
      </h5>
      <div class="d-flex align-items-center">
        <small class="text-muted me-3">Current Status:</small>
        <span class="badge bg-<%= @booking.status_color %> px-3 py-2">
          <i class="bi <%= @booking.status_icon %> me-1"></i>
          <%= @booking.status.humanize %>
        </span>
      </div>
    </div>
  </div>
  <div class="card-body pt-3">
    <div class="row">
      <div class="col-md-8">
        <h6 class="text-muted mb-3">Update Order Stage:</h6>
        <%= form_with url: update_status_admin_booking_path(@booking), method: :patch, local: true, class: "d-flex gap-3 align-items-end" do |f| %>
          <div class="flex-grow-1">
            <%= f.label :status, "Select Stage:", class: "form-label small text-muted mb-1" %>
            <%= f.select :status,
                options_for_select([
                  ['Draft', 'draft'],
                  ['Ordered & Delivery Pending', 'ordered_and_delivery_pending'],
                  ['Confirmed', 'confirmed'],
                  ['Processing', 'processing'],
                  ['Packed', 'packed'],
                  ['Shipped', 'shipped'],
                  ['Out for Delivery', 'out_for_delivery'],
                  ['Delivered', 'delivered'],
                  ['Completed', 'completed'],
                  ['Cancelled', 'cancelled'],
                  ['Returned', 'returned']
                ].select { |option| @booking.next_possible_statuses.include?(option[1]) || option[1] == @booking.status },
                @booking.status),
                { prompt: "Select next stage..." },
                { class: "form-select", id: "status_select" } %>
          </div>
          <div id="tracking_number_field" style="display: none;">
            <%= f.label :tracking_number, "Tracking Number:", class: "form-label small text-muted mb-1" %>
            <%= f.text_field :tracking_number, placeholder: "Enter tracking number", class: "form-control" %>
          </div>
          <div>
            <%= f.submit "Update Stage", class: "btn btn-primary", id: "update_stage_btn", disabled: true %>
          </div>
        <% end %>
      </div>

      <div class="col-md-4">
        <% if @booking.can_cancel? %>
          <h6 class="text-muted mb-2">Quick Actions:</h6>
          <%= form_with url: cancel_order_admin_booking_path(@booking), method: :patch, local: true, class: "mb-2" do |f| %>
            <%= f.text_field :reason, placeholder: "Cancellation reason (optional)", class: "form-control form-control-sm mb-2" %>
            <%= f.submit "Cancel Order", class: "btn btn-danger btn-sm w-100", confirm: "Are you sure you want to cancel this order?" %>
          <% end %>
        <% end %>

        <% if @booking.out_for_delivery? %>
          <%= link_to mark_delivered_admin_booking_path(@booking), method: :patch,
              class: "btn btn-success btn-sm w-100 mb-2",
              confirm: "Mark this order as delivered?" do %>
            <i class="bi bi-check-circle me-1"></i>
            Mark as Delivered
          <% end %>
        <% end %>

        <% if @booking.delivered? %>
          <%= link_to mark_completed_admin_booking_path(@booking), method: :patch,
              class: "btn btn-primary btn-sm w-100",
              confirm: "Mark this order as completed?" do %>
            <i class="bi bi-check-all me-1"></i>
            Mark as Completed
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<% end %>

<div class="row">
  <!-- Main Booking Information -->
  <div class="col-lg-8">
    <!-- Booking Summary -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Booking Summary</h5>
        <span class="badge bg-<%= @booking.payment_status == 'paid' ? 'success' : @booking.payment_status == 'partially_paid' ? 'warning' : 'danger' %>-subtle text-<%= @booking.payment_status == 'paid' ? 'success' : @booking.payment_status == 'partially_paid' ? 'warning' : 'danger' %>">
          <%= @booking.payment_status&.humanize || 'Unpaid' %>
        </span>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Booking Number</strong>
            <%= @booking.booking_number %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Booking Date</strong>
            <%= @booking.booking_date&.strftime("%B %d, %Y at %I:%M %p") || @booking.created_at&.strftime("%B %d, %Y at %I:%M %p") %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Payment Method</strong>
            <%= @booking.payment_method&.humanize || 'Not specified' %>
          </div>
          <div class="col-md-6">
            <strong class="text-muted d-block">Created By</strong>
            <%= @booking.user&.first_name || 'System' %>
          </div>
          <% if @booking.invoice_generated? %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Invoice Number</strong>
              <span class="text-primary fw-medium"><%= @booking.invoice_number %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Customer Information -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Customer Information</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <strong class="text-muted d-block">Customer Name</strong>
            <%= @booking.customer_name || @booking.customer&.display_name %>
          </div>
          <% if @booking.store.present? %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Store</strong>
              <span class="badge bg-info">
                <i class="bi bi-shop me-1"></i>
                <%= @booking.store.display_name %>
              </span>
            </div>
          <% end %>
          <% if @booking.customer_email.present? %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Email</strong>
              <a href="mailto:<%= @booking.customer_email %>"><%= @booking.customer_email %></a>
            </div>
          <% end %>
          <% if @booking.customer_phone.present? %>
            <div class="col-md-6">
              <strong class="text-muted d-block">Phone</strong>
              <a href="tel:<%= @booking.customer_phone %>"><%= @booking.customer_phone %></a>
            </div>
          <% end %>
          <% if @booking.delivery_address.present? %>
            <div class="col-12">
              <strong class="text-muted d-block">Delivery Address</strong>
              <%= simple_format(@booking.delivery_address) %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Booking Items -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Booking Items</h5>
      </div>
      <div class="card-body p-0">
        <% if @booking_items.any? %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0 fw-semibold">Product</th>
                  <th class="border-0 fw-semibold text-center">Quantity</th>
                  <th class="border-0 fw-semibold text-end">Unit Price</th>
                  <th class="border-0 fw-semibold text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <% @booking_items.each do |item| %>
                  <tr>
                    <td class="align-middle">
                      <div class="d-flex align-items-center">
                        <% if item.product&.main_image %>
                          <div class="me-3">
                            <%= image_tag item.product.main_image, class: "rounded", style: "width: 50px; height: 50px; object-fit: cover;" %>
                          </div>
                        <% else %>
                          <div class="me-3 bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="bi bi-image text-muted"></i>
                          </div>
                        <% end %>
                        <div>
                          <h6 class="mb-1"><%= item.product&.name || 'Product' %></h6>
                          <small class="text-muted">
                            <% if item.product&.category %>
                              <%= item.product.category.name %>
                            <% end %>
                            <% if item.product&.sku %>
                              | SKU: <%= item.product.sku %>
                            <% end %>
                          </small>
                        </div>
                      </div>
                    </td>
                    <td class="align-middle text-center">
                      <span class="fw-medium"><%= item.quantity %></span>
                      <small class="text-muted d-block">pcs</small>
                    </td>
                    <td class="align-middle text-end">
                      <span class="fw-medium">₹<%= number_with_delimiter(item.price&.to_f || 0) %></span>
                    </td>
                    <td class="align-middle text-end">
                      <span class="fw-bold text-success">₹<%= number_with_delimiter((item.quantity * item.price)&.to_f || 0) %></span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-5">
            <i class="bi bi-cart-x fs-1 text-muted d-block mb-3"></i>
            <h6 class="text-muted">No items in this booking</h6>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Notes Section -->
    <% if @booking.notes.present? %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Notes</h5>
        </div>
        <div class="card-body">
          <%= simple_format(@booking.notes) %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Payment Summary -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Payment Summary</h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">Subtotal:</span>
          <span class="fw-medium">₹<%= number_with_delimiter(@booking.subtotal&.to_f || 0) %></span>
        </div>

        <% if @booking.discount_amount.present? && @booking.discount_amount.to_f > 0 %>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Discount:</span>
            <span class="fw-medium text-success">-₹<%= number_with_delimiter(@booking.discount_amount.to_f) %></span>
          </div>
        <% end %>

        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
          <span class="text-muted">Tax (18%):</span>
          <span class="fw-medium">₹<%= number_with_delimiter(@booking.tax_amount&.to_f || 0) %></span>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-bold fs-5">Total:</span>
          <span class="fw-bold fs-5 text-primary">₹<%= number_with_delimiter(@booking.total_amount&.to_f || 0) %></span>
        </div>

        <% if (@booking.cash_received&.to_f || 0) > 0 %>
          <div class="bg-light p-3 rounded">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-muted">Cash Received:</span>
              <span class="fw-medium">₹<%= number_with_delimiter(@booking.cash_received&.to_f || 0) %></span>
            </div>
            <% if @booking.change_amount&.to_f > 0 %>
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Change:</span>
                <span class="fw-medium text-warning">₹<%= number_with_delimiter(@booking.change_amount&.to_f || 0) %></span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Timeline -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">Activity Timeline</h6>
      </div>
      <div class="card-body">
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker bg-success"></div>
            <div class="timeline-content">
              <small class="text-muted">Booking Created</small>
              <div><%= @booking.created_at&.strftime("%B %d, %Y at %I:%M %p") %></div>
            </div>
          </div>

          <% if @booking.invoice_generated? %>
            <div class="timeline-item">
              <div class="timeline-marker bg-primary"></div>
              <div class="timeline-content">
                <small class="text-muted">Invoice Generated</small>
                <div><%= @booking.updated_at&.strftime("%B %d, %Y at %I:%M %p") %></div>
              </div>
            </div>
          <% end %>

          <% if @booking.order.present? %>
            <div class="timeline-item">
              <div class="timeline-marker bg-info"></div>
              <div class="timeline-content">
                <small class="text-muted">Converted to Order</small>
                <div><%= @booking.order.created_at&.strftime("%B %d, %Y at %I:%M %p") %></div>
              </div>
            </div>
          <% end %>

          <% if @booking.updated_at != @booking.created_at %>
            <div class="timeline-item">
              <div class="timeline-marker bg-warning"></div>
              <div class="timeline-content">
                <small class="text-muted">Last Updated</small>
                <div><%= @booking.updated_at&.strftime("%B %d, %Y at %I:%M %p") %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 20px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}

.timeline-item {
  position: relative;
  margin-bottom: 1rem;
}

.timeline-item:last-child {
  margin-bottom: 0;
}

.timeline-marker {
  position: absolute;
  left: -15px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
}

.timeline-content {
  padding-left: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const statusSelect = document.getElementById('status_select');
  const trackingNumberField = document.getElementById('tracking_number_field');
  const updateBtn = document.getElementById('update_stage_btn');
  const currentStatus = '<%= @booking.status %>';

  function toggleTrackingField() {
    if (statusSelect.value === 'shipped') {
      trackingNumberField.style.display = 'block';
    } else {
      trackingNumberField.style.display = 'none';
    }
  }

  function toggleUpdateButton() {
    if (statusSelect.value && statusSelect.value !== currentStatus) {
      updateBtn.disabled = false;
      updateBtn.textContent = 'Update to ' + statusSelect.options[statusSelect.selectedIndex].text;
    } else {
      updateBtn.disabled = true;
      updateBtn.textContent = 'Update Stage';
    }
  }

  statusSelect.addEventListener('change', function() {
    toggleTrackingField();
    toggleUpdateButton();
  });

  // Initialize
  toggleTrackingField();
  toggleUpdateButton();
});
</script>