<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Edit Family Member</h2>
    <p class="text-muted mb-0">Update family member details for <%= @customer.display_name %></p>
  </div>
  <div>
    <%= link_to admin_customer_path(@customer), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>
      Back to Customer
    <% end %>
  </div>
</div>

<%= form_with model: [:admin, @customer, @family_member], local: true, class: "needs-validation", novalidate: true, data: { turbo: false } do |form| %>
  <% if @family_member.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
      <h6>Please correct the following errors:</h6>
      <ul class="mb-0">
        <% @family_member.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent border-0">
      <h5 class="mb-0">Family Member Details</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <%= form.label :first_name, class: "form-label" do %>
            First Name <span class="text-danger">*</span>
          <% end %>
          <%= form.text_field :first_name, class: "form-control", placeholder: "Enter first name", required: true %>
        </div>

        <div class="col-md-4">
          <%= form.label :middle_name, class: "form-label" %>
          <%= form.text_field :middle_name, class: "form-control", placeholder: "Enter middle name" %>
        </div>

        <div class="col-md-4">
          <%= form.label :last_name, class: "form-label" do %>
            Last Name <span class="text-danger">*</span>
          <% end %>
          <%= form.text_field :last_name, class: "form-control", placeholder: "Enter last name", required: true %>
        </div>

        <div class="col-md-6">
          <%= form.label :relationship, class: "form-label" do %>
            Relationship <span class="text-danger">*</span>
          <% end %>
          <%= form.select :relationship,
              options_for_select([
                ['Father', 'father'],
                ['Mother', 'mother'],
                ['Spouse', 'spouse'],
                ['Child', 'child'],
                ['Sibling', 'sibling'],
                ['Other', 'other']
              ], @family_member.relationship),
              { prompt: 'Select Relationship' },
              { class: "form-select", required: true } %>
        </div>

        <div class="col-md-4">
          <%= form.label :birth_date, "Date of Birth", class: "form-label" do %>
            Date of Birth <span class="text-danger">*</span>
          <% end %>
          <%= form.date_field :birth_date, class: "form-control", required: true %>
        </div>

        <div class="col-md-4">
          <%= form.label :age, class: "form-label" %>
          <%= form.number_field :age, class: "form-control", placeholder: "Age will be calculated", readonly: true %>
        </div>

        <div class="col-md-4">
          <%= form.label :gender, class: "form-label" do %>
            Gender <span class="text-danger">*</span>
          <% end %>
          <%= form.select :gender,
              options_for_select([
                ['Male', 'male'],
                ['Female', 'female'],
                ['Other', 'other']
              ], @family_member.gender),
              { prompt: 'Select Gender' },
              { class: "form-select", required: true } %>
        </div>

        <div class="col-md-4">
          <%= form.label :height, class: "form-label" %>
          <%= form.text_field :height, class: "form-control", placeholder: "e.g., 5'8\" or 172 cm" %>
        </div>

        <div class="col-md-4">
          <%= form.label :weight, class: "form-label" %>
          <%= form.text_field :weight, class: "form-control", placeholder: "e.g., 70 kg" %>
        </div>

        <div class="col-md-4">
          <%= form.label :mobile, class: "form-label" %>
          <%= form.telephone_field :mobile, class: "form-control", placeholder: "10-digit mobile number" %>
        </div>

        <div class="col-md-6">
          <%= form.label :pan_no, "PAN Number", class: "form-label" %>
          <%= form.text_field :pan_no, class: "form-control", placeholder: "Enter PAN number" %>
        </div>

        <div class="col-md-12">
          <%= form.label :documents, "Upload Documents", class: "form-label" %>
          <%= form.file_field :documents, multiple: true, class: "form-control", accept: "image/*,application/pdf" %>
          <small class="form-text text-muted">You can upload multiple documents (PDF, JPG, PNG)</small>

          <% if @family_member.documents.attached? %>
            <div class="mt-3">
              <h6>Existing Documents:</h6>
              <div class="list-group">
                <% @family_member.documents.each do |document| %>
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><%= document.filename %></span>
                    <div>
                      <%= link_to "Download", rails_blob_path(document, disposition: "attachment"), class: "btn btn-sm btn-outline-primary" %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="card-footer bg-transparent">
      <div class="d-flex justify-content-end gap-2">
        <%= link_to "Cancel", admin_customer_path(@customer), class: "btn btn-outline-secondary" %>
        <%= form.submit "Update Family Member", class: "btn btn-primary" %>
      </div>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Calculate age when birth date changes
  const birthDateField = document.getElementById('family_member_birth_date');
  const ageField = document.getElementById('family_member_age');

  function calculateAge() {
    if (birthDateField && birthDateField.value && ageField) {
      const birthDate = new Date(birthDateField.value);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();

      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      // Ensure age is not negative
      age = Math.max(0, age);
      ageField.value = age;
    }
  }

  // Calculate age on page load if birth date is already set
  calculateAge();

  // Calculate age when birth date changes
  if (birthDateField) {
    birthDateField.addEventListener('change', calculateAge);
    birthDateField.addEventListener('input', calculateAge);
  }
});
</script>