<% content_for :title, "Shop - Dhanvantri Naturals" %>

<div class="shop-page">
  <!-- Shop Header -->
  <div class="shop-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="page-title">Shop</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <%= link_to customer_dashboard_path, class: "text-decoration-none" do %>
                <i class="fas fa-home me-1"></i>Dashboard
              <% end %>
            </li>
            <li class="breadcrumb-item active">Shop</li>
          </ol>
        </nav>
      </div>
      <div class="search-filters d-flex align-items-center gap-3">
        <%= form_with url: customer_shop_path, method: :get, local: true, class: "search-form d-flex align-items-center gap-2" do |f| %>
          <%= f.text_field :search, value: params[:search], placeholder: "Search products...",
                          class: "form-control search-input" %>
          <%= f.submit "Search", class: "btn btn-primary search-btn" %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Filters Sidebar -->
    <div class="col-lg-3">
      <div class="filters-sidebar">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0">
            <h5 class="mb-0">
              <i class="fas fa-filter me-2 text-primary"></i>
              Filters
            </h5>
          </div>
          <div class="card-body">
            <%= form_with url: customer_shop_path, method: :get, local: true, class: "filters-form" do |f| %>
              <%= f.hidden_field :search, value: params[:search] %>

              <!-- Category Filter -->
              <div class="filter-group mb-4">
                <h6 class="filter-title">Category</h6>
                <div class="category-filters">
                  <div class="form-check">
                    <%= radio_button_tag :category_id, '',
                        params[:category_id].blank?,
                        class: "form-check-input",
                        id: "category_all" %>
                    <label class="form-check-label" for="category_all">
                      All Categories
                    </label>
                  </div>
                  <% @categories.each do |category| %>
                    <div class="form-check">
                      <%= radio_button_tag :category_id, category.id,
                          params[:category_id] == category.id.to_s,
                          class: "form-check-input",
                          id: "category_#{category.id}" %>
                      <label class="form-check-label" for="category_<%= category.id %>">
                        <%= category.name %>
                      </label>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Price Range Filter -->
              <div class="filter-group mb-4">
                <h6 class="filter-title">Price Range</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <%= f.number_field :min_price, value: params[:min_price],
                        placeholder: "Min", class: "form-control form-control-sm" %>
                  </div>
                  <div class="col-6">
                    <%= f.number_field :max_price, value: params[:max_price],
                        placeholder: "Max", class: "form-control form-control-sm" %>
                  </div>
                </div>
              </div>

              <!-- Product Type Filter -->
              <div class="filter-group mb-4">
                <h6 class="filter-title">Product Type</h6>
                <%= f.select :product_type,
                    options_for_select([
                      ['All Types', 'all'],
                      ['Regular', 'regular'],
                      ['Subscription', 'subscription'],
                      ['Occasional', 'occasional']
                    ], params[:product_type] || 'all'),
                    {},
                    { class: "form-select form-select-sm" } %>
              </div>

              <div class="d-grid">
                <%= f.submit "Apply Filters", class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="col-lg-9">
      <!-- Sort and Results Info -->
      <div class="shop-toolbar d-flex justify-content-between align-items-center mb-4">
        <div class="results-info">
          <span class="text-muted">
            Showing <%= @products.count %> of <%= @products.total_count %> products
            <% if @selected_category %>
              in <%= @selected_category.name %>
            <% end %>
            <% if @search_query.present? %>
              for "<%= @search_query %>"
            <% end %>
          </span>
        </div>

        <div class="sort-controls">
          <%= form_with url: customer_shop_path, method: :get, local: true, class: "d-flex align-items-center gap-2" do |f| %>
            <%= f.hidden_field :search, value: params[:search] %>
            <%= f.hidden_field :category_id, value: params[:category_id] %>
            <%= f.hidden_field :min_price, value: params[:min_price] %>
            <%= f.hidden_field :max_price, value: params[:max_price] %>
            <%= f.hidden_field :product_type, value: params[:product_type] %>

            <label class="small text-muted">Sort by:</label>
            <%= f.select :sort,
                options_for_select([
                  ['Default', ''],
                  ['Price: Low to High', 'price_low'],
                  ['Price: High to Low', 'price_high'],
                  ['Name: A to Z', 'name'],
                  ['Newest First', 'newest']
                ], params[:sort]),
                {},
                {
                  class: "form-select form-select-sm",
                  style: "width: 200px;",
                  onchange: "this.form.submit();"
                } %>
          <% end %>
        </div>
      </div>

      <!-- Products Grid -->
      <% if @products.any? %>
        <div class="products-grid">
          <div class="row g-4">
            <% @products.each do |product| %>
              <div class="col-xl-4 col-lg-6 col-md-6 col-sm-6">
                <div class="product-card h-100">
                  <div class="product-image-wrapper">
                    <% if product.image.present? %>
                      <%= image_tag product.image,
                          class: "product-image",
                          alt: product.name %>
                    <% elsif product.image_url.present? %>
                      <img src="<%= product.image_url %>"
                           class="product-image"
                           alt="<%= product.name %>">
                    <% else %>
                      <div class="product-image-placeholder">
                        <i class="fas fa-image"></i>
                      </div>
                    <% end %>

                    <!-- Product Badges -->
                    <% if product.discount_price.present? && product.discount_price > 0 %>
                      <div class="product-badge discount-badge">
                        <%= number_to_percentage(((product.price - product.discount_price) / product.price) * 100, precision: 0) %> OFF
                      </div>
                    <% end %>

                    <% if product.product_type == 'subscription' %>
                      <div class="product-badge subscription-badge">
                        Subscription
                      </div>
                    <% end %>
                  </div>

                  <div class="product-info">
                    <div class="product-category">
                      <%= product.category&.name %>
                    </div>
                    <h6 class="product-name">
                      <%= link_to product.name, customer_shop_product_path(product),
                          class: "text-decoration-none text-dark" %>
                    </h6>

                    <div class="product-pricing">
                      <% if product.discount_price.present? && product.discount_price > 0 %>
                        <span class="current-price">₹<%= number_with_delimiter(product.discount_price.to_i) %></span>
                        <span class="original-price">₹<%= number_with_delimiter(product.price.to_i) %></span>
                      <% else %>
                        <span class="current-price">₹<%= number_with_delimiter(product.price.to_i) %></span>
                      <% end %>
                    </div>

                    <div class="product-actions">
                      <% if product.stock.present? && product.stock > 0 %>
                        <button type="button"
                                class="btn btn-primary add-to-cart-btn"
                                data-product-id="<%= product.id %>"
                                onclick="addToCart(<%= product.id %>)">
                          <i class="fas fa-shopping-cart me-1"></i>
                          Add to Cart
                        </button>
                      <% else %>
                        <button type="button" class="btn btn-secondary" disabled>
                          Out of Stock
                        </button>
                      <% end %>

                      <%= link_to customer_shop_product_path(product),
                          class: "btn btn-outline-primary view-product-btn" do %>
                        <i class="fas fa-eye me-1"></i>
                        View
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Pagination -->
          <% if @products.respond_to?(:current_page) %>
            <div class="d-flex justify-content-center mt-5">
              <%= paginate @products, theme: 'customer' %>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- Empty State -->
        <div class="empty-state text-center py-5">
          <div class="empty-icon mb-3">
            <i class="fas fa-search text-muted"></i>
          </div>
          <h5 class="text-muted">No Products Found</h5>
          <p class="text-muted mb-4">
            <% if @search_query.present? %>
              No products match your search for "<%= @search_query %>".
            <% else %>
              No products are currently available in this category.
            <% end %>
          </p>
          <%= link_to "Clear Filters", customer_shop_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
/* Shop Page Styles */
.shop-page {
  padding: 2rem 0;
}

.shop-header {
  margin-bottom: 2rem;
}

.page-title {
  font-size: 2rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.5rem;
}

.breadcrumb {
  margin-bottom: 0;
  background: none;
  padding: 0;
}

.breadcrumb-item a {
  color: #64748b;
}

.breadcrumb-item.active {
  color: #10b981;
}

.search-form {
  min-width: 300px;
}

.search-input {
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  padding: 10px 16px;
  transition: all 0.2s ease;
}

.search-input:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
}

.search-btn {
  border-radius: 12px;
  padding: 10px 24px;
  font-weight: 500;
}

/* Filters Sidebar */
.filters-sidebar {
  position: sticky;
  top: 100px;
}

.filter-title {
  font-weight: 600;
  color: #374151;
  margin-bottom: 12px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-group {
  border-bottom: 1px solid #f3f4f6;
  padding-bottom: 1rem;
}

.category-filters .form-check {
  margin-bottom: 8px;
}

.form-check-label {
  font-size: 14px;
  color: #4b5563;
  cursor: pointer;
}

/* Shop Toolbar */
.shop-toolbar {
  background: white;
  padding: 1rem;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #f3f4f6;
}

/* Products Grid */
.products-grid .product-card {
  background: white;
  border-radius: 16px;
  border: 1px solid #f3f4f6;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  overflow: hidden;
}

.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  border-color: #10b981;
}

.product-image-wrapper {
  position: relative;
  height: 200px;
  overflow: hidden;
  background: #f8fafc;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.product-card:hover .product-image {
  transform: scale(1.05);
}

.product-image-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-size: 3rem;
  background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
}

.product-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.discount-badge {
  background: #ef4444;
  color: white;
}

.subscription-badge {
  background: #8b5cf6;
  color: white;
  top: 12px;
  left: 12px;
  right: auto;
}

.product-info {
  padding: 1.5rem;
}

.product-category {
  color: #64748b;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.product-name {
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
  line-height: 1.3;
  height: 2.6em;
  overflow: hidden;
}

.product-pricing {
  margin-bottom: 1rem;
}

.current-price {
  font-size: 1.25rem;
  font-weight: 700;
  color: #10b981;
}

.original-price {
  font-size: 1rem;
  color: #9ca3af;
  text-decoration: line-through;
  margin-left: 8px;
}

.product-actions {
  display: flex;
  gap: 8px;
}

.add-to-cart-btn {
  flex: 1;
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
}

.view-product-btn {
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
  padding: 8px 16px;
}

/* Empty State */
.empty-state {
  background: white;
  border-radius: 16px;
  padding: 3rem 2rem;
  border: 1px solid #f3f4f6;
}

.empty-icon i {
  font-size: 4rem;
}

/* Mobile Responsive */
@media (max-width: 991.98px) {
  .filters-sidebar {
    position: static;
    margin-bottom: 2rem;
  }

  .shop-toolbar {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .search-form {
    min-width: 100%;
  }
}

@media (max-width: 576px) {
  .product-actions {
    flex-direction: column;
  }
}
</style>

<script>
// Frontend-only Add to Cart functionality
function addToCart(productId) {
  const btn = document.querySelector(`[data-product-id="${productId}"]`);
  const originalText = btn.innerHTML;

  // Show loading state
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
  btn.disabled = true;

  // Get product information from the button's data attributes
  const productCard = btn.closest('.product-card');
  const productName = productCard.querySelector('.product-name a').textContent.trim();
  const priceElement = productCard.querySelector('.current-price');
  const productPrice = parseFloat(priceElement.textContent.replace('₹', '').replace(/,/g, ''));
  const productImageElement = productCard.querySelector('.product-image');
  const productImage = productImageElement ? productImageElement.src : '';

  // Get existing cart from localStorage
  let cart = JSON.parse(localStorage.getItem('customerCart') || '[]');

  // Check if product already exists in cart
  const existingIndex = cart.findIndex(item => item.id == productId);

  if (existingIndex > -1) {
    // Update quantity
    cart[existingIndex].quantity = parseInt(cart[existingIndex].quantity) + 1;
  } else {
    // Add new item
    cart.push({
      id: productId,
      name: productName,
      price: productPrice,
      quantity: 1,
      image: productImage
    });
  }

  // Save to localStorage
  localStorage.setItem('customerCart', JSON.stringify(cart));

  // Calculate total items
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

  // Update UI
  updateCartCount(totalItems);

  // Show success message
  btn.innerHTML = '<i class="fas fa-check me-1"></i>Added!';
  btn.classList.remove('btn-primary');
  btn.classList.add('btn-success');

  // Reset button after 2 seconds
  setTimeout(() => {
    btn.innerHTML = originalText;
    btn.classList.remove('btn-success');
    btn.classList.add('btn-primary');
    btn.disabled = false;
  }, 2000);

  // Show notification
  showCartNotification('Product added to cart successfully!');
}

// Update cart count in UI
function updateCartCount(count) {
  const cartBadge = document.getElementById('cart-count');
  if (cartBadge) {
    cartBadge.textContent = count;
    cartBadge.style.display = count > 0 ? 'flex' : 'none';
  }

  // Also update any other cart counters
  const cartCounters = document.querySelectorAll('.cart-counter');
  cartCounters.forEach(counter => {
    counter.textContent = count;
    counter.style.display = count > 0 ? 'inline' : 'none';
  });
}

// Show cart notification
function showCartNotification(message) {
  // Create or update notification element
  let notification = document.getElementById('cart-notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'cart-notification';
    notification.className = 'alert alert-success position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    document.body.appendChild(notification);
  }

  notification.innerHTML = `
    <i class="fas fa-check-circle me-2"></i>${message}
    <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
  `;

  // Auto-hide after 3 seconds
  setTimeout(() => {
    if (notification) {
      notification.remove();
    }
  }, 3000);
}

// Filter form auto-submit and initialize cart
document.addEventListener('DOMContentLoaded', function() {
  const filterInputs = document.querySelectorAll('.filters-form input[type="radio"], .filters-form select');
  filterInputs.forEach(input => {
    input.addEventListener('change', function() {
      this.form.submit();
    });
  });

  // Initialize cart counter from localStorage
  const cart = JSON.parse(localStorage.getItem('customerCart') || '[]');
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  updateCartCount(totalItems);
});
</script>