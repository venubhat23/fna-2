<% content_for :title, 'Products' %>

<div class="container py-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1>Our Products</h1>
      <p class="text-muted">Discover fresh and quality products for your daily needs</p>
    </div>
    <div>
      <%= link_to customer_categories_path, class: "btn btn-outline-primary" do %>
        <i class="bi bi-grid-3x3-gap me-2"></i>Browse Categories
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-md-3 mb-4">
      <div class="bg-white rounded shadow-sm p-3">
        <h5 class="mb-3">Filters</h5>

        <%= form_with url: customer_products_path, method: :get, local: true do |f| %>
          <!-- Search -->
          <div class="mb-3">
            <%= f.label :search, "Search Products", class: "form-label fw-semibold" %>
            <%= f.text_field :search, value: params[:search], class: "form-control", placeholder: "Search products..." %>
          </div>

          <!-- Category Filter -->
          <div class="mb-3">
            <%= f.label :category_id, "Category", class: "form-label fw-semibold" %>
            <%= f.select :category_id,
                        options_from_collection_for_select(@categories, :id, :name, params[:category_id]),
                        { prompt: "All Categories" },
                        { class: "form-select" } %>
          </div>

          <!-- Price Range -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Price Range</label>
            <% @price_ranges.each do |range| %>
              <div class="form-check">
                <%= radio_button_tag :price_range, "#{range[:min]}-#{range[:max]}",
                                    params[:min_price] == range[:min].to_s && params[:max_price] == range[:max].to_s,
                                    class: "form-check-input",
                                    onchange: "this.form.elements['min_price'].value='#{range[:min]}'; this.form.elements['max_price'].value='#{range[:max] == Float::INFINITY ? 10000 : range[:max]}'" %>
                <label class="form-check-label" for="price_range_<%= range[:min] %>_<%= range[:max] %>">
                  <%= range[:label] %>
                </label>
              </div>
            <% end %>
            <%= f.hidden_field :min_price, value: params[:min_price] %>
            <%= f.hidden_field :max_price, value: params[:max_price] %>
          </div>

          <!-- Stock Filter -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Availability</label>
            <div class="form-check">
              <%= radio_button_tag :stock_filter, "", params[:stock_filter] == "", class: "form-check-input" %>
              <label class="form-check-label">All Products</label>
            </div>
            <div class="form-check">
              <%= radio_button_tag :stock_filter, "in_stock", params[:stock_filter] == "in_stock", class: "form-check-input" %>
              <label class="form-check-label">In Stock</label>
            </div>
            <div class="form-check">
              <%= radio_button_tag :stock_filter, "out_of_stock", params[:stock_filter] == "out_of_stock", class: "form-check-input" %>
              <label class="form-check-label">Out of Stock</label>
            </div>
          </div>

          <div class="d-grid gap-2">
            <%= f.submit "Apply Filters", class: "btn btn-primary" %>
            <%= link_to "Clear All", customer_products_path, class: "btn btn-outline-secondary" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="col-md-9">
      <!-- Results Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="text-muted mb-0">
          Showing <%= @products.count %> of <%= @products.total_count %> products
        </p>

        <!-- Sort Options -->
        <%= form_with url: customer_products_path, method: :get, local: true, class: "d-flex align-items-center" do |f| %>
          <%= f.hidden_field :search, value: params[:search] %>
          <%= f.hidden_field :category_id, value: params[:category_id] %>
          <%= f.hidden_field :min_price, value: params[:min_price] %>
          <%= f.hidden_field :max_price, value: params[:max_price] %>
          <%= f.hidden_field :stock_filter, value: params[:stock_filter] %>

          <label class="form-label me-2 mb-0">Sort by:</label>
          <%= f.select :sort,
                      [
                        ['Name A-Z', 'name_a_to_z'],
                        ['Name Z-A', 'name_z_to_a'],
                        ['Price: Low to High', 'price_low_to_high'],
                        ['Price: High to Low', 'price_high_to_low'],
                        ['Newest First', 'newest']
                      ],
                      { selected: params[:sort] },
                      { class: "form-select", style: "width: auto;", onchange: "this.form.submit();" } %>
        <% end %>
      </div>

      <!-- Products Grid -->
      <% if @products.any? %>
        <div class="row">
          <% @products.each do |product| %>
            <div class="col-lg-4 col-md-6 mb-4">
              <div class="product-card bg-white rounded shadow-sm h-100">
                <div class="position-relative">
                  <%= link_to customer_product_path(product) do %>
                    <% if product.main_image_url %>
                      <%= image_tag product.main_image_url, class: "card-img-top", style: "height: 250px; object-fit: cover;", alt: product.name %>
                    <% else %>
                      <div class="bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                        <i class="bi bi-image display-4 text-muted"></i>
                      </div>
                    <% end %>
                  <% end %>

                  <!-- Discount Badge -->
                  <% if product.discounted? %>
                    <span class="position-absolute top-0 start-0 badge bg-danger m-2">
                      <%= product.discount_percentage.round %>% OFF
                    </span>
                  <% end %>

                  <!-- Stock Status -->
                  <% unless product.in_stock? %>
                    <span class="position-absolute top-0 end-0 badge bg-secondary m-2">
                      Out of Stock
                    </span>
                  <% else %>
                    <span class="position-absolute top-0 end-0 badge bg-success m-2">
                      <%= product.available_quantity %> left
                    </span>
                  <% end %>

                  <!-- Product Type Badge -->
                  <span class="position-absolute bottom-0 start-0 badge <%= product.product_type_badge_class %> m-2">
                    <i class="<%= product.product_type_icon %> me-1"></i>
                    <%= product.product_type %>
                  </span>
                </div>

                <div class="card-body d-flex flex-column">
                  <h6 class="card-title fw-semibold">
                    <%= link_to product.name, customer_product_path(product), class: "text-decoration-none text-dark" %>
                  </h6>

                  <p class="text-muted small mb-2 flex-grow-1">
                    <%= truncate(product.description, length: 100) %>
                  </p>

                  <!-- Price -->
                  <div class="mb-2">
                    <span class="fw-bold text-success fs-5">₹<%= product.selling_price %></span>
                    <% if product.discounted? %>
                      <span class="text-muted text-decoration-line-through ms-2">₹<%= product.price %></span>
                      <span class="text-success small ms-1">Save ₹<%= product.savings_amount %></span>
                    <% end %>
                  </div>

                  <!-- Reviews -->
                  <% if product.has_reviews? %>
                    <div class="mb-3">
                      <span class="text-warning">
                        <% product.average_rating.floor.times do %>
                          <i class="bi bi-star-fill"></i>
                        <% end %>
                        <% (5 - product.average_rating.floor).times do %>
                          <i class="bi bi-star"></i>
                        <% end %>
                      </span>
                      <small class="text-muted ms-1">
                        <%= product.average_rating %> (<%= product.total_reviews %> reviews)
                      </small>
                    </div>
                  <% end %>

                  <!-- Actions -->
                  <div class="mt-auto">
                    <div class="d-flex gap-2">
                      <%= link_to customer_product_path(product), class: "btn btn-outline-primary btn-sm flex-grow-1" do %>
                        <i class="bi bi-eye me-1"></i>View Details
                      <% end %>

                      <% if product.in_stock? %>
                        <%= form_with url: customer_cart_add_item_path, method: :post, local: true, class: "flex-grow-1" do |f| %>
                          <%= f.hidden_field :product_id, value: product.id %>
                          <%= f.hidden_field :quantity, value: 1 %>
                          <%= f.submit "Add to Cart", class: "btn btn-primary btn-sm w-100" %>
                        <% end %>
                      <% else %>
                        <button class="btn btn-secondary btn-sm flex-grow-1" disabled>Out of Stock</button>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-4">
          <%= paginate @products, theme: 'twitter-bootstrap-5' %>
        </div>

      <% else %>
        <!-- No Products Found -->
        <div class="text-center py-5">
          <i class="bi bi-search display-1 text-muted mb-4"></i>
          <h4>No products found</h4>
          <p class="text-muted">Try adjusting your search criteria or browse our categories.</p>
          <%= link_to "Browse All Categories", customer_categories_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>