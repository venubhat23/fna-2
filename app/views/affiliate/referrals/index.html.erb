<% content_for :page_title, "Referral History" %>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Referral History</h2>
    <p class="text-muted mb-0">Track all your referrals and their status</p>
  </div>
  <div>
    <%= link_to affiliate_refer_path, class: "btn btn-primary" do %>
      <i class="fas fa-user-plus me-1"></i>
      Add New Referral
    <% end %>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Referrals</h6>
            <h3 class="mb-0 text-primary"><%= @stats[:total] %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="fas fa-users text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Pending</h6>
            <h3 class="mb-0 text-warning"><%= @stats[:pending] %></h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="fas fa-clock text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Registered</h6>
            <h3 class="mb-0 text-info"><%= @stats[:registered] %></h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="fas fa-user-check text-info fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Converted</h6>
            <h3 class="mb-0 text-success"><%= @stats[:converted] %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="fas fa-trophy text-success fs-4"></i>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <%= number_with_precision(@stats[:conversion_rate], precision: 1) %>% conversion rate
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <select id="status_filter" class="form-select" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="pending" <%= 'selected' if params[:status] == 'pending' %>>Pending</option>
          <option value="registered" <%= 'selected' if params[:status] == 'registered' %>>Registered</option>
          <option value="converted" <%= 'selected' if params[:status] == 'converted' %>>Converted</option>
        </select>
      </div>
      <div class="col-md-3">
        <%= link_to "Clear Filters", affiliate_referral_history_path, class: "btn btn-outline-secondary" %>
      </div>
    </div>
  </div>
</div>

<script>
function applyFilters() {
  const statusFilter = document.getElementById('status_filter').value;

  const url = new URL(window.location.href);
  url.searchParams.delete('status');

  if (statusFilter) {
    url.searchParams.set('status', statusFilter);
  }

  window.location.href = url.toString();
}
</script>

<!-- Referrals List -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-0">
    <h5 class="mb-0">Referral List</h5>
  </div>
  <div class="card-body p-0">
    <% if @referrals.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-0">Name</th>
              <th class="border-0">Contact</th>
              <th class="border-0">Referral Date</th>
              <th class="border-0">Days Ago</th>
              <th class="border-0">Status</th>
              <th class="border-0">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @referrals.each do |referral| %>
              <tr>
                <td>
                  <div>
                    <h6 class="mb-1"><%= referral.referred_name %></h6>
                    <% if referral.notes.present? %>
                      <small class="text-muted">
                        <i class="fas fa-sticky-note me-1"></i>
                        <%= truncate(referral.notes, length: 50) %>
                      </small>
                    <% end %>
                  </div>
                </td>
                <td>
                  <div>
                    <div class="small">
                      <i class="fas fa-phone text-muted me-1"></i>
                      <%= referral.referred_mobile %>
                    </div>
                    <div class="small">
                      <i class="fas fa-envelope text-muted me-1"></i>
                      <%= referral.referred_email %>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="small">
                    <%= referral.referral_date.strftime('%b %d, %Y') %>
                  </span>
                </td>
                <td>
                  <span class="small text-muted">
                    <%= pluralize(referral.days_since_referral, 'day') %> ago
                  </span>
                </td>
                <td>
                  <span class="badge bg-<%= referral.status_badge_class %>">
                    <%= referral.status_display %>
                  </span>
                  <% if referral.customer.present? %>
                    <div class="small text-success mt-1">
                      <i class="fas fa-link me-1"></i>
                      Linked to customer
                    </div>
                  <% end %>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <%= link_to affiliate_referral_path(referral), class: "btn btn-sm btn-outline-primary", title: "View Details" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>

                    <% if referral.status == 'pending' %>
                      <%= button_to mark_registered_affiliate_referral_path(referral), method: :patch,
                          class: "btn btn-sm btn-outline-info", title: "Mark as Registered",
                          data: { confirm: "Mark this referral as registered?" },
                          form: { style: "display: inline;" } do %>
                        <i class="fas fa-user-check"></i>
                      <% end %>
                    <% end %>

                    <% if referral.status == 'registered' %>
                      <%= button_to mark_converted_affiliate_referral_path(referral), method: :patch,
                          class: "btn btn-sm btn-outline-success", title: "Mark as Converted",
                          data: { confirm: "Mark this referral as converted?" },
                          form: { style: "display: inline;" } do %>
                        <i class="fas fa-trophy"></i>
                      <% end %>
                    <% end %>

                    <% if referral.status == 'pending' %>
                      <%= button_to affiliate_referral_path(referral), method: :delete,
                          class: "btn btn-sm btn-outline-danger", title: "Delete",
                          data: { confirm: "Are you sure you want to delete this referral?" },
                          form: { style: "display: inline;" } do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @referrals.respond_to?(:total_pages) %>
        <div class="card-footer bg-transparent border-0">
          <%= paginate @referrals %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <i class="fas fa-users fs-1 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No referrals found</h5>
        <p class="text-muted mb-3">
          <% if params[:status].present? %>
            No referrals match the selected filters.
            <%= link_to "view all referrals", affiliate_referral_history_path, class: "text-decoration-none" %>.
          <% else %>
            Start by adding your first referral to build your network.
          <% end %>
        </p>
        <%= link_to affiliate_refer_path, class: "btn btn-primary" do %>
          <i class="fas fa-user-plus me-1"></i>
          Add First Referral
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Referral Status Information -->
<div class="card border-0 shadow-sm mt-4">
  <div class="card-header bg-light border-0">
    <h6 class="mb-0 text-primary">
      <i class="fas fa-info-circle me-2"></i>
      Referral Status Guide
    </h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-warning me-2">Pending</span>
          <small>Referral added, waiting for registration</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-info me-2">Registered</span>
          <small>Person has registered/signed up</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-success me-2">Converted</span>
          <small>Completed transaction/became customer</small>
        </div>
      </div>
    </div>
  </div>
</div>