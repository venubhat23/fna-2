<% content_for :page_title, "Dashboard" %>

<!-- Welcome Section -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm bg-primary text-white">
      <div class="card-body">
        <h2 class="h4 mb-1">Welcome back, <%= current_affiliate.display_name %>!</h2>
        <p class="mb-0 opacity-75">Here's an overview of your referral activities</p>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Referrals</h6>
            <h3 class="mb-0 text-primary"><%= @stats[:total_referrals] %></h3>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="fas fa-users text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Pending</h6>
            <h3 class="mb-0 text-warning"><%= @stats[:pending_referrals] %></h3>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="fas fa-clock text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Registered</h6>
            <h3 class="mb-0 text-info"><%= @stats[:registered_referrals] %></h3>
          </div>
          <div class="bg-info bg-opacity-10 rounded p-3">
            <i class="fas fa-user-check text-info fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Converted</h6>
            <h3 class="mb-0 text-success"><%= @stats[:converted_referrals] %></h3>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="fas fa-trophy text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Conversion Rate -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Conversion Rate</h5>
        <h2 class="text-primary mb-0">
          <%= number_with_precision(@stats[:conversion_rate], precision: 1) %>%
        </h2>
        <small class="text-muted">of your referrals have converted</small>
      </div>
    </div>
  </div>
</div>

<!-- Charts and Recent Activity -->
<div class="row">
  <!-- Monthly Referrals Chart -->
  <div class="col-lg-8 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Referral Activity (Last 6 Months)</h5>
      </div>
      <div class="card-body">
        <canvas id="monthlyReferralsChart" style="height: 300px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Recent Referrals -->
  <div class="col-lg-4 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Recent Referrals</h5>
      </div>
      <div class="card-body">
        <% if @recent_referrals.any? %>
          <% @recent_referrals.each do |referral| %>
            <div class="d-flex align-items-center mb-3">
              <div class="bg-light rounded-circle p-2 me-3">
                <i class="fas fa-user text-muted"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1"><%= referral.referred_name %></h6>
                <small class="text-muted">
                  <%= referral.created_at.strftime('%b %d, %Y') %>
                </small>
              </div>
              <span class="badge bg-<%= referral.status_badge_class %>">
                <%= referral.status_display %>
              </span>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-4">
            <i class="fas fa-users text-muted fs-1 mb-3"></i>
            <p class="text-muted mb-0">No referrals yet</p>
            <small>Start referring people to build your network!</small>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= link_to affiliate_refer_path, class: "btn btn-primary btn-lg w-100" do %>
              <i class="fas fa-user-plus me-2"></i>
              Add New Referral
            <% end %>
          </div>
          <div class="col-md-6 mb-3">
            <%= link_to affiliate_referral_history_path, class: "btn btn-outline-primary btn-lg w-100" do %>
              <i class="fas fa-history me-2"></i>
              View All Referrals
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('monthlyReferralsChart').getContext('2d');

  const chartData = <%= raw @monthly_referrals.to_json %>;

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartData.map(d => d.month),
      datasets: [{
        label: 'Total Referrals',
        data: chartData.map(d => d.total),
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        fill: true,
        tension: 0.4
      }, {
        label: 'Converted',
        data: chartData.map(d => d.converted),
        borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });
});
</script>